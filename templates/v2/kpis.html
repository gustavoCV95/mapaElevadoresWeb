{% extends "base.html" %}

{% block title %}KPIs de Manutenção - Sistema de Elevadores TJ/MG{% endblock %}

{% block extra_head %}
<!-- Chart.js -->
{# CORRIGIDO: URLs atualizadas para Chart.js v3.x e seus adaptadores #}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/index.min.js"></script>
{# Opcional: Se precisar de um locale específico para date-fns, pode adicionar aqui. #}
{# Chart.js v3 usa a config global para locale do date-fns adapter. #}
<script>
    // Configura locale global para Chart.js date-fns adapter
    Chart.defaults.plugins.tooltip.usePointStyle = true; // Estilo de tooltip mais moderno
    Chart.defaults.font.family = "'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif";
    Chart.defaults.color = '#333'; // Cor padrão do texto nos grÃ¡ficos
</script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-chart-line"></i> 
            KPIs de Manutenção - Elevadores TJ/MG
        </h1>
    </div>
</div>

{% if erro %}
    <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle"></i> {{ erro }}
    </div>
{% else %}
    <!-- Filtros Avançados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-filter"></i> Filtros</h5>
                    <div>
                        <button class="btn btn-success btn-sm me-2" onclick="aplicarFiltros()">
                            <i class="fas fa-search"></i> Aplicar Filtros
                        </button>
                        <button class="btn btn-secondary btn-sm me-2" onclick="limparFiltrosKPIs()">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                        <button class="btn btn-info btn-sm" onclick="atualizarDados()"> {# Esta função chamarÃ¡ o /v2/kpis/atualizar-kpis #}
                            <i class="fas fa-sync-alt"></i> Atualizar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Primeira linha: Filtros de Data -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-calendar"></i> Data de Início</label>
                            <input type="date" class="form-control" id="data-inicio">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-calendar"></i> Data de Fim</label>
                            <input type="date" class="form-control" id="data-fim">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><i class="fas fa-clock"></i> Período Predefinido</label>
                            <select class="form-select" id="filtro-periodo" onchange="selecionarPeriodoPredefinido()">
                                <option value="">Selecione um período...</option>
                                <option value="ultima-semana">Última Semana</option>
                                <option value="ultimo-mes">Último Mês</option>
                                <option value="ultimos-3-meses">Últimos 3 Meses</option>
                                <option value="ultimos-6-meses">Últimos 6 Meses</option>
                                <option value="ultimo-ano">Último Ano</option>
                                <option value="ultimos-2-anos">Últimos 2 Anos</option>
                                <option value="ultimos-5-anos">Últimos 5 Anos</option>
                                <option value="todo-periodo">Todo o Período</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Segunda linha: Outros filtros -->
                    <div class="row">
                        <!-- Filtro por Status -->
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-tasks"></i> Status</label>
                            <select class="form-select" id="filtro-status">
                                <option value="">Todos os status</option>
                                <option value="Concluída">Concluída</option>
                                <option value="Confirmada">Confirmada</option>
                                <option value="Pendente">Pendente</option> {# NOVO: Adicione Pendente se seu status incluir #}
                            </select>
                        </div>
                        
                        <!-- Filtro por Categoria -->
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-tags"></i> Categoria</label>
                            <select class="form-select" id="filtro-categoria">
                                <option value="">Todas as categorias</option>
                                <!-- Preenchido dinamicamente via JavaScript -->
                            </select>
                        </div>
                        
                        <!-- Filtro por EdifÃ­cio -->
                        <div class="col-md-3"> {# CORRIGIDO: Reduzido para 3 para adicionar Equipamento #}
                            <label class="form-label"><i class="fas fa-building"></i> Edifício</label>
                            <select class="form-select" id="filtro-edificio">
                                <option value="">Todos os edifícios</option>
                                <!-- Preenchido dinamicamente via JavaScript -->
                            </select>
                        </div>

                        <!-- NOVO: Filtro por Elevador (Equipamento) -->
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-elevator"></i> Elevador (Equipamento)</label>
                            <select class="form-select" id="filtro-equipamento">
                                <option value="">Todos os elevadores</option>
                                <!-- Preenchido dinamicamente via JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards de KPIs Principais -->
    <div class="row mb-4" id="kpis-cards">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                    <h3 id="total-chamados">{{ metricas.total_chamados or 0 }}</h3>
                    <p class="mb-0">Total de Chamados</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <h3 id="chamados-concluidos">{{ metricas.chamados_concluidos or 0 }}</h3>
                    <p class="mb-0">Chamados Concluídos</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h3 id="tempo-mediano">{{ "%.1f"|format(metricas.tempo_mediano_reparo or 0) }}h</h3>
                    <p class="mb-0">Tempo Mediano de Reparo</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-percentage fa-2x mb-2"></i>
                    <h3 id="disponibilidade">{{ "%.1f"|format(metricas.disponibilidade or 0) }}%</h3>
                    <p class="mb-0">Taxa de Conclusão</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Indicador de Filtros Ativos -->
    <div class="row mb-3" id="filtros-ativos" style="display: none;">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-filter"></i> 
                <strong>Filtros ativos:</strong> 
                <span id="descricao-filtros"></span>
                <button class="btn btn-sm btn-outline-primary ms-2" onclick="limparFiltrosKPIs()">
                    <i class="fas fa-times"></i> Remover filtros
                </button>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row">
        <!-- Gráfico de Chamados por MÃªs -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> Chamados por Mês</h5>
                    <small class="text-muted">Clique nos pontos para filtrar por mês</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-chamados-mes" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Gráfico de Categorias de Problema -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-pie"></i> Categorias de Problemas</h5>
                    <small class="text-muted">Clique nas fatias para filtrar por categoria</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-categorias" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- GrÃ¡fico de EdifÃ­cios Mais ProblemÃ¡ticos -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Edifícios com Mais Chamados</h5>
                    <small class="text-muted">Clique nas barras para filtrar por edifício</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-edificios" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- GrÃ¡fico de Tempo por Categoria -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-stopwatch"></i> Tempo Mediano por Categoria</h5>
                    <small class="text-muted">Clique nas barras para filtrar por categoria</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-tempo-categoria" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- NOVO: SEÇÃO DE GRÁFICOS DE ELEVADORES -->
    <div class="row">
        <!-- Gráfico de Chamados por Elevador -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-elevator"></i> Chamados por Elevador</h5>
                    <small class="text-muted">Clique nas barras para filtrar por elevador específico</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-chamados-elevador" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- GrÃ¡fico de Tempo Mediano por Elevador -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clock"></i> Tempo Mediano de Atendimento por Elevador</h5>
                    <small class="text-muted">Clique nas barras para filtrar por elevador específico</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-tempo-elevador" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Resumo Filtrado -->
    <div class="row">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-table"></i> Resumo dos Dados Filtrados</h5>
            </div>
            <div class="card-body">
                <div id="loading-resumo" class="text-center" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Carregando dados...
                </div>
                <div id="tabela-resumo">
                    <p class="text-muted text-center">Use os filtros acima ou clique nos grÃ¡ficos para ver dados específicos.</p>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<script>
// Dados para JavaScript, injetados via Jinja2
const dadosKPIsOriginais = {{ metricas|tojson|safe }};
const categoriasUnicas = {{ categorias_unicas|tojson|safe }};
const edificiosUnicos = {{ edificios_unicos|tojson|safe }};
const equipamentosUnicos = {{ equipamentos_unicos|tojson|safe }}; // NOVO

// Variáveis globais que serão acessadas pelo kpis_script.js
let dadosKPIsFiltrados = dadosKPIsOriginais;
let graficos = {};
let filtrosAtivos = {};


console.log('Dados de KPIs recebidos:', dadosKPIsOriginais);
console.log('Categorias Únicas:', categoriasUnicas);
console.log('Edifícios Únicos:', edificiosUnicos);
console.log('Equipamentos Únicos:', equipamentosUnicos); // NOVO

</script>

<!-- Script customizado para os KPIs -->
<script src="{{ url_for('static', filename='js/kpis_v2.js') }}"></script>

{% endblock %}