{% extends "base.html" %}

{# CORRIGIDO: Certifique-se de que hÃ¡ APENAS UMA definição de block title #}
{% block title %}KPIs de Manutenção - Sistema de Elevadores TJ/MG{% endblock %}

{% block extra_head %}
<!-- Chart.js -->
{# CORRIGIDO: URLs atualizadas para Chart.js v3.x e seus adaptadores #}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/index.min.js"></script>
{# Opcional: Se precisar de um locale especÃ­fico para date-fns, pode adicionar aqui. #}
{# Chart.js v3 usa a config global para locale do date-fns adapter. #}
<script>
    // Configura locale global para Chart.js date-fns adapter
    Chart.defaults.plugins.tooltip.usePointStyle = true; // Estilo de tooltip mais moderno
    Chart.defaults.font.family = "'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif";
    Chart.defaults.color = '#333'; // Cor padrão do texto nos grÃ¡ficos
</script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-chart-line"></i> 
            KPIs de Manutenção - Elevadores TJ/MG
        </h1>
    </div>
</div>

{% if erro %}
    <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle"></i> {{ erro }}
    </div>
{% else %}
    <!-- Filtros Avançados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-filter"></i> Filtros</h5>
                    <div>
                        <button class="btn btn-success btn-sm me-2" onclick="aplicarFiltros()">
                            <i class="fas fa-search"></i> Aplicar Filtros
                        </button>
                        <button class="btn btn-secondary btn-sm me-2" onclick="limparFiltrosKPIs()">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                        <button class="btn btn-info btn-sm" onclick="atualizarDados()"> {# Esta função chamarÃ¡ o /v2/kpis/atualizar-kpis #}
                            <i class="fas fa-sync-alt"></i> Atualizar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Primeira linha: Filtros de Data -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-calendar"></i> Data de InÃ­cio</label>
                            <input type="date" class="form-control" id="data-inicio">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-calendar"></i> Data de Fim</label>
                            <input type="date" class="form-control" id="data-fim">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><i class="fas fa-clock"></i> PerÃ­odo Predefinido</label>
                            <select class="form-select" id="filtro-periodo" onchange="selecionarPeriodoPredefinido()">
                                <option value="">Selecione um perÃ­odo...</option>
                                <option value="ultima-semana">Ãšltima Semana</option>
                                <option value="ultimo-mes">Ãšltimo MÃªs</option>
                                <option value="ultimos-3-meses">Ãšltimos 3 Meses</option>
                                <option value="ultimos-6-meses">Ãšltimos 6 Meses</option>
                                <option value="ultimo-ano">Ãšltimo Ano</option>
                                <option value="ultimos-2-anos">Ãšltimos 2 Anos</option>
                                <option value="ultimos-5-anos">Ãšltimos 5 Anos</option>
                                <option value="todo-periodo">Todo o PerÃ­odo</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Segunda linha: Outros filtros -->
                    <div class="row">
                        <!-- Filtro por Status -->
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-tasks"></i> Status</label>
                            <select class="form-select" id="filtro-status">
                                <option value="">Todos os status</option>
                                <option value="ConcluÃ­da">ConcluÃ­da</option>
                                <option value="Confirmada">Confirmada</option>
                                <option value="Pendente">Pendente</option> {# NOVO: Adicione Pendente se seu status incluir #}
                            </select>
                        </div>
                        
                        <!-- Filtro por Categoria -->
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-tags"></i> Categoria</label>
                            <select class="form-select" id="filtro-categoria">
                                <option value="">Todas as categorias</option>
                                <!-- Preenchido dinamicamente via JavaScript -->
                            </select>
                        </div>
                        
                        <!-- Filtro por EdifÃ­cio -->
                        <div class="col-md-3"> {# CORRIGIDO: Reduzido para 3 para adicionar Equipamento #}
                            <label class="form-label"><i class="fas fa-building"></i> EdifÃ­cio</label>
                            <select class="form-select" id="filtro-edificio">
                                <option value="">Todos os edifÃ­cios</option>
                                <!-- Preenchido dinamicamente via JavaScript -->
                            </select>
                        </div>

                        <!-- NOVO: Filtro por Elevador (Equipamento) -->
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-elevator"></i> Elevador (Equipamento)</label>
                            <select class="form-select" id="filtro-equipamento">
                                <option value="">Todos os elevadores</option>
                                <!-- Preenchido dinamicamente via JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards de KPIs Principais -->
    <div class="row mb-4" id="kpis-cards">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                    <h3 id="total-chamados">{{ metricas.total_chamados or 0 }}</h3>
                    <p class="mb-0">Total de Chamados</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <h3 id="chamados-concluidos">{{ metricas.chamados_concluidos or 0 }}</h3>
                    <p class="mb-0">Chamados ConcluÃ­dos</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h3 id="tempo-mediano">{{ "%.1f"|format(metricas.tempo_mediano_reparo or 0) }}h</h3>
                    <p class="mb-0">Tempo Mediano de Reparo</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-percentage fa-2x mb-2"></i>
                    <h3 id="disponibilidade">{{ "%.1f"|format(metricas.disponibilidade or 0) }}%</h3>
                    <p class="mb-0">Taxa de Conclusão</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Indicador de Filtros Ativos -->
    <div class="row mb-3" id="filtros-ativos" style="display: none;">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-filter"></i> 
                <strong>Filtros ativos:</strong> 
                <span id="descricao-filtros"></span>
                <button class="btn btn-sm btn-outline-primary ms-2" onclick="limparFiltrosKPIs()">
                    <i class="fas fa-times"></i> Remover filtros
                </button>
            </div>
        </div>
    </div>

    <!-- GrÃ¡ficos -->
    <div class="row">
        <!-- GrÃ¡fico de Chamados por MÃªs -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> Chamados por MÃªs</h5>
                    <small class="text-muted">Clique nos pontos para filtrar por mÃªs</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-chamados-mes" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- GrÃ¡fico de Categorias de Problema -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-pie"></i> Categorias de Problemas</h5>
                    <small class="text-muted">Clique nas fatias para filtrar por categoria</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-categorias" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- GrÃ¡fico de EdifÃ­cios Mais ProblemÃ¡ticos -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> EdifÃ­cios com Mais Chamados</h5>
                    <small class="text-muted">Clique nas barras para filtrar por edifÃ­cio</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-edificios" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- GrÃ¡fico de Tempo por Categoria -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-stopwatch"></i> Tempo Mediano por Categoria</h5>
                    <small class="text-muted">Clique nas barras para filtrar por categoria</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-tempo-categoria" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- NOVO: SEÃ‡ÃƒO DE GRÃFICOS DE ELEVADORES -->
    <div class="row">
        <!-- GrÃ¡fico de Chamados por Elevador -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-elevator"></i> Chamados por Elevador</h5>
                    <small class="text-muted">Clique nas barras para filtrar por elevador especÃ­fico</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-chamados-elevador" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- GrÃ¡fico de Tempo Mediano por Elevador -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clock"></i> Tempo Mediano de Atendimento por Elevador</h5>
                    <small class="text-muted">Clique nas barras para filtrar por elevador especÃ­fico</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-tempo-elevador" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Resumo Filtrado -->
    <div class="row">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-table"></i> Resumo dos Dados Filtrados</h5>
            </div>
            <div class="card-body">
                <div id="loading-resumo" class="text-center" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Carregando dados...
                </div>
                <div id="tabela-resumo">
                    <p class="text-muted text-center">Use os filtros acima ou clique nos grÃ¡ficos para ver dados especÃ­ficos.</p>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<script>
// Dados para JavaScript
const dadosKPIsOriginais = {{ metricas|tojson|safe }};
let dadosKPIsFiltrados = dadosKPIsOriginais;
let graficos = {};
let filtrosAtivos = {};

// NOVO: VariÃ¡veis para preencher os selects de filtro
const categoriasUnicas = {{ categorias_unicas|tojson|safe }};
const edificiosUnicos = {{ edificios_unicos|tojson|safe }};
const equipamentosUnicos = {{ equipamentos_unicos|tojson|safe }}; // NOVO

console.log('ðŸ“Š Dados de KPIs recebidos:', dadosKPIsOriginais);
console.log('âš™ï¸ Categorias Ãšnicas:', categoriasUnicas);
console.log('âš™ï¸ EdifÃ­cios Ãšnicos:', edificiosUnicos);
console.log('âš™ï¸ Equipamentos Ãšnicos:', equipamentosUnicos); // NOVO


// Inicializa grÃ¡ficos quando a pÃ¡gina carrega
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸ“„ DOM carregado, criando grÃ¡ficos de KPIs...');
    preencherFiltros();
    criarGraficos();
});

function preencherFiltros() {
    // Preenche filtro de categorias
    const selectCategoria = document.getElementById('filtro-categoria');
    categoriasUnicas.forEach(categoria => {
        const option = document.createElement('option');
        option.value = categoria;
        option.textContent = categoria;
        selectCategoria.appendChild(option);
    });
    
    // Preenche filtro de edifÃ­cios
    const selectEdificio = document.getElementById('filtro-edificio');
    edificiosUnicos.forEach(edificio => {
        const option = document.createElement('option');
        option.value = edificio;
        option.textContent = edificio.length > 50 ? edificio.substring(0, 50) + '...' : edificio;
        selectEdificio.appendChild(option);
    });

    // NOVO: Preenche filtro de equipamentos (Elevadores)
    const selectEquipamento = document.getElementById('filtro-equipamento');
    equipamentosUnicos.forEach(equipamento => {
        const option = document.createElement('option');
        option.value = equipamento;
        option.textContent = equipamento;
        selectEquipamento.appendChild(option);
    });
}

// ðŸ“… NOVA FUNÃ‡ÃƒO: Selecionar perÃ­odo predefinido
function selecionarPeriodoPredefinido() {
    const periodo = document.getElementById('filtro-periodo').value;
    
    if (periodo && periodo !== 'todo-periodo') {
        // Limpa datas personalizadas quando seleciona perÃ­odo predefinido
        document.getElementById('data-inicio').value = '';
        document.getElementById('data-fim').value = '';
    }
    
    console.log('ðŸ“… PerÃ­odo predefinido selecionado:', periodo);
}

function criarGraficos() {
    // Destroi grÃ¡ficos existentes
    Object.values(graficos).forEach(grafico => {
        if (grafico) grafico.destroy();
    });
    
    // Cria novos grÃ¡ficos
    criarGraficoChamadosPorMes();
    criarGraficoCategorias();
    criarGraficoEdificios();
    criarGraficoTempoPorCategoria();
    
    // NOVOS GRÃFICOS DE ELEVADORES
    criarGraficoChamadosPorElevador();
    criarGraficoTempoMedianoPorElevador();
}

function criarGraficoChamadosPorMes() {
    const ctx = document.getElementById('grafico-chamados-mes');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.chamados_por_mes || {};
    const labels = Object.keys(dados).sort();
    const values = labels.map(label => dados[label]);
    
    graficos.chamadosMes = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Chamados',
                data: values,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#007bff',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    type: 'time', {# CORRIGIDO: Use escala de tempo para melhor visualização #}
                    time: {
                        unit: 'month',
                        tooltipFormat: 'MMM yyyy'
                    },
                    adapters: {
                        date: {
                            // Certifique-se de que o locale 'pt-BR' estÃ¡ disponÃ­vel para date-fns
                            // Se não estiver funcionando, pode ser necessÃ¡rio importar explicitamente o locale do date-fns
                            // No entanto, Chart.js adapta globalmente, então deve funcionar.
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const mesAno = labels[index];
                    filtrarPorMes(mesAno);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

function criarGraficoCategorias() {
    const ctx = document.getElementById('grafico-categorias');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.categorias_problema || {};
    
    // ðŸ”„ ORDENAÃ‡ÃƒO DECRESCENTE
    const entries = Object.entries(dados).sort((a, b) => b[1] - a[1]);
    const labels = entries.map(entry => entry[0]);
    const values = entries.map(entry => entry[1]);
    
    const cores = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
        '#E0BBE4', '#957DAD', '#D291BC', '#FFC72C'
    ];
    
    graficos.categorias = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: cores.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff',
                hoverBorderWidth: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const categoria = labels[index];
                    filtrarPorCategoria(categoria);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// ðŸ”„ MODIFICADO: GrÃ¡fico de EdifÃ­cios com ordenação decrescente garantida
function criarGraficoEdificios() {
    const ctx = document.getElementById('grafico-edificios');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.chamados_por_edificio || {};
    
    // ðŸ”„ ORDENAÃ‡ÃƒO DECRESCENTE EXPLÃCITA (garantindo que funcione mesmo se backend não ordenar)
    const entries = Object.entries(dados)
        .sort((a, b) => b[1] - a[1])  // Ordena por valor decrescente
        .slice(0, 10); // Top 10
    
    const labels = entries.map(entry => entry[0]);
    const values = entries.map(entry => entry[1]);
    
    console.log('ðŸ¢ Dados de edifÃ­cios ordenados:', entries);
    
    graficos.edificios = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels.map(label => label.length > 20 ? label.substring(0, 20) + '...' : label),
            datasets: [{
                label: 'Chamados',
                data: values,
                backgroundColor: '#28a745',
                borderColor: '#1e7e34',
                borderWidth: 1,
                hoverBackgroundColor: '#34ce57'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const edificio = labels[index];
                    filtrarPorEdificio(edificio);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// ðŸ”„ MODIFICADO: GrÃ¡fico de Tempo por Categoria com ordenação decrescente garantida
function criarGraficoTempoPorCategoria() {
    const ctx = document.getElementById('grafico-tempo-categoria');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.tempo_por_categoria || {};
    
    // ðŸ”„ ORDENAÃ‡ÃƒO DECRESCENTE EXPLÃCITA (garantindo que funcione mesmo se backend não ordenar)
    const entries = Object.entries(dados)
        .sort((a, b) => b[1] - a[1]); // Ordena por valor decrescente
    
    const labels = entries.map(entry => entry[0]);
    const values = entries.map(entry => Math.round(entry[1] * 10) / 10);
    
    console.log('â±ï¸ Dados de tempo por categoria ordenados:', entries);
    
    graficos.tempoCategoria = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tempo Mediano (horas)',
                data: values,
                backgroundColor: '#ffc107',
                borderColor: '#e0a800',
                borderWidth: 1,
                hoverBackgroundColor: '#ffcd39'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + 'h';
                        }
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const categoria = labels[index];
                    filtrarPorCategoria(categoria);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// NOVO: GrÃ¡fico de Chamados por Elevador
function criarGraficoChamadosPorElevador() {
    const ctx = document.getElementById('grafico-chamados-elevador');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.chamados_por_equipamento || {};
    
    // Ordenação decrescente e limitação aos top 15 elevadores
    const entries = Object.entries(dados)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 15); // Top 15 elevadores
    
    const labels = entries.map(entry => String(entry[0]));
    const values = entries.map(entry => entry[1]);
    
    console.log('ðŸ—ï¸ Dados de chamados por elevador ordenados:', entries);
    
    graficos.chamadosElevador = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Chamados',
                data: values,
                backgroundColor: '#007bff',
                borderColor: '#0056b3',
                borderWidth: 1,
                hoverBackgroundColor: '#0056b3'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return 'Elevador: ' + context[0].label;
                        },
                        label: function(context) {
                            return 'Chamados: ' + context.parsed.y;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        font: {
                            size: 10
                        }
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const elevador = String(labels[index]);
                    filtrarPorEquipamento(elevador); {# CORRIGIDO: Chamando filtrarPorEquipamento #}
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// NOVO: GrÃ¡fico de Tempo Mediano por Elevador
function criarGraficoTempoMedianoPorElevador() {
    const ctx = document.getElementById('grafico-tempo-elevador');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.tempo_por_equipamento || {};
    
    // Ordenação decrescente e limitação aos top 15 elevadores
    const entries = Object.entries(dados)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 15); // Top 15 elevadores
    
    const labels = entries.map(entry => String(entry[0]));
    const values = entries.map(entry => Math.round(entry[1] * 10) / 10);
    
    console.log('â° Dados de tempo por elevador ordenados:', entries);
    
    graficos.tempoElevador = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tempo Mediano (horas)',
                data: values,
                backgroundColor: '#17a2b8',
                borderColor: '#138496',
                borderWidth: 1,
                hoverBackgroundColor: '#138496'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return 'Elevador: ' + context[0].label;
                        },
                        label: function(context) {
                            return 'Tempo Mediano: ' + context.parsed.y + 'h';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + 'h';
                        }
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        font: {
                            size: 10
                        }
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const elevador = String(labels[index]);
                    filtrarPorEquipamento(elevador); {# CORRIGIDO: Chamando filtrarPorEquipamento #}
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// FunçÃµes de filtro por clique nos grÃ¡ficos
function filtrarPorMes(mesAno) {
    console.log('ðŸ“… Filtrando por mÃªs:', mesAno);
    // Para filtro por mÃªs, precisamos ajustar data_inicio e data_fim
    const [ano, mes] = mesAno.split('-');
    const dataInicioMes = `${ano}-${mes}-01`;
    const ultimoDiaMes = new Date(ano, parseInt(mes), 0).getDate();
    const dataFimMes = `${ano}-${mes}-${ultimoDiaMes}`;

    document.getElementById('data-inicio').value = dataInicioMes;
    document.getElementById('data-fim').value = dataFimMes;
    document.getElementById('filtro-periodo').value = ''; // Limpa perÃ­odo predefinido

    filtrosAtivos.data_inicio = dataInicioMes;
    filtrosAtivos.data_fim = dataFimMes;
    delete filtrosAtivos.periodo_predefinido;
    delete filtrosAtivos.mes; // Remove filtro de mÃªs para evitar conflito

    aplicarFiltrosInterativos();
}

function filtrarPorCategoria(categoria) {
    console.log('ðŸ·ï¸ Filtrando por categoria:', categoria);
    document.getElementById('filtro-categoria').value = categoria;
    filtrosAtivos.categoria = categoria;
    aplicarFiltrosInterativos();
}

function filtrarPorEdificio(edificio) {
    console.log('ðŸ¢ Filtrando por edifÃ­cio:', edificio);
    document.getElementById('filtro-edificio').value = edificio;
    filtrosAtivos.edificio = edificio;
    aplicarFiltrosInterativos();
}

// NOVO: Filtrar por elevador especÃ­fico (equipamento)
function filtrarPorEquipamento(equipamento) {
    console.log('ðŸ—ï¸ Filtrando por equipamento:', equipamento);
    document.getElementById('filtro-equipamento').value = equipamento;
    filtrosAtivos.equipamento = equipamento;
    aplicarFiltrosInterativos();
}

function aplicarFiltros() {
    const dataInicio = document.getElementById('data-inicio').value;
    const dataFim = document.getElementById('data-fim').value;
    const periodo = document.getElementById('filtro-periodo').value;
    const status = document.getElementById('filtro-status').value;
    const categoria = document.getElementById('filtro-categoria').value;
    const edificio = document.getElementById('filtro-edificio').value;
    const equipamento = document.getElementById('filtro-equipamento').value; {# NOVO #}
    
    console.log('ðŸ” Aplicando filtros:', {
        dataInicio, dataFim, periodo, status, categoria, edificio, equipamento
    });
    
    // ðŸ“… VALIDAÃ‡ÃƒO DE DATAS
    if (dataInicio && dataFim && new Date(dataInicio) > new Date(dataFim)) {
        alert('A data de inÃ­cio não pode ser posterior Ã  data de fim.');
        return;
    }
    
    // MAPEAMENTO CORRETO DOS PARÃ‚METROS
    filtrosAtivos = {
        data_inicio: dataInicio,
        data_fim: dataFim,
        periodo_predefinido: periodo,
        status: status,
        categoria: categoria,
        edificio: edificio,
        equipamento: equipamento {# NOVO #}
    };
    
    // Remove filtros vazios
    Object.keys(filtrosAtivos).forEach(key => {
        if (!filtrosAtivos[key]) {
            delete filtrosAtivos[key];
        }
    });
    
    console.log('ðŸ”§ Filtros ativos apÃ³s limpeza:', filtrosAtivos);
    
    aplicarFiltrosInterativos();
}

function aplicarFiltrosInterativos() {
    console.log('ðŸ” Aplicando filtros interativos:', filtrosAtivos);
    
    // Monta parÃ¢metros para API
    const params = new URLSearchParams();
    Object.keys(filtrosAtivos).forEach(key => {
        if (filtrosAtivos[key]) {
            params.append(key, filtrosAtivos[key]);
        }
    });
    
    // Mostra loading
    const loadingElement = document.getElementById('loading-resumo');
    if (loadingElement) loadingElement.style.display = 'block';
    
    // Faz requisição para API
    fetch('/api/kpis-filtrados?' + params.toString())
        .then(response => {
            if (!response.ok) {
                // Se a resposta não for 2xx, tenta ler como JSON de erro
                return response.json().then(errorData => {
                    throw new Error(errorData.message || 'Erro na API');
                });
            }
            return response.json();
        })
        .then(data => {
            if (loadingElement) loadingElement.style.display = 'none';
            
            if (data.success) {
                // Atualiza dados filtrados
                dadosKPIsFiltrados = data.metricas;
                
                // Atualiza cards
                atualizarCards(data.metricas);
                
                // Recria grÃ¡ficos
                criarGraficos();
                
                // Mostra indicador de filtros ativos
                mostrarFiltrosAtivos();
                
                // Atualiza tabela de resumo
                atualizarTabelaResumo(data.resumo);
            } else {
                alert('Erro ao aplicar filtros: ' + (data.message || 'Erro desconhecido.'));
                console.error('API Error:', data);
            }
        })
        .catch(error => {
            if (loadingElement) loadingElement.style.display = 'none';
            console.error('âŒ Erro ao aplicar filtros:', error);
            alert('Erro na requisição de filtros: ' + error.message + '. Verifique o console para mais detalhes.');
        });
}

function atualizarCards(metricas) {
    document.getElementById('total-chamados').textContent = metricas.total_chamados || 0;
    document.getElementById('chamados-concluidos').textContent = metricas.chamados_concluidos || 0;
    document.getElementById('tempo-mediano').textContent = (metricas.tempo_mediano_reparo || 0).toFixed(1) + 'h';
    document.getElementById('disponibilidade').textContent = (metricas.disponibilidade || 0).toFixed(1) + '%';
}

function mostrarFiltrosAtivos() {
    const filtrosAtivosDiv = document.getElementById('filtros-ativos');
    const descricaoFiltros = document.getElementById('descricao-filtros');
    
    const filtrosTexto = [];
    
    // MELHORIA: Descrição mais clara dos filtros
    const dataInicio = document.getElementById('data-inicio').value;
    const dataFim = document.getElementById('data-fim').value;
    const periodo = document.getElementById('filtro-periodo').value;
    
    if (dataInicio || dataFim) {
        let textoData = 'PerÃ­odo: ';
        if (dataInicio && dataFim) {
            textoData += `${dataInicio} a ${dataFim}`;
        } else if (dataInicio) {
            textoData += `a partir de ${dataInicio}`;
        } else {
            textoData += `atÃ© ${dataFim}`;
        }
        filtrosTexto.push(textoData);
    } else if (periodo) {
        const periodos = {
            'ultima-semana': 'Ãšltima Semana',
            'ultimo-mes': 'Ãšltimo MÃªs',
            'ultimos-3-meses': 'Ãšltimos 3 Meses',
            'ultimos-6-meses': 'Ãšltimos 6 Meses',
            'ultimo-ano': 'Ãšltimo Ano',
            'ultimos-2-anos': 'Ãšltimos 2 Anos',
            'ultimos-5-anos': 'Ãšltimos 5 Anos',
            'todo-periodo': 'Todo o PerÃ­odo'
        };
        filtrosTexto.push(`PerÃ­odo: ${periodos[periodo]}`);
    }
    
    Object.keys(filtrosAtivos).forEach(key => {
        if (filtrosAtivos[key] && !['data_inicio', 'data_fim', 'periodo_predefinido'].includes(key)) {
             const nomesFiltros = {
                'equipamento': 'Elevador', // NOVO
                'categoria': 'Categoria',
                'edificio': 'EdifÃ­cio',
                'status': 'Status'
            };
            const nomeAmigavel = nomesFiltros[key] || key;
            filtrosTexto.push(`${nomeAmigavel}: ${filtrosAtivos[key]}`);
        }
    });
    
    if (filtrosTexto.length > 0) {
        descricaoFiltros.textContent = filtrosTexto.join(' | ');
        filtrosAtivosDiv.style.display = 'block';
    } else {
        filtrosAtivosDiv.style.display = 'none';
    }
}

function atualizarTabelaResumo(resumo) {
    const container = document.getElementById('tabela-resumo');
    if (!resumo || resumo.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">Nenhum dado encontrado com os filtros aplicados.</p>';
        return;
    }
    
    let html = `
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Categoria</th>
                        <th>EdifÃ­cio</th>
                        <th>Equipamento</th> {# NOVO: Coluna adicionada #}
                        <th>Status</th>
                        <th>Data Solicitação</th>
                        <th>Tempo Reparo (h)</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    resumo.slice(0, 20).forEach(item => { // Mostra apenas os primeiros 20
        html += `
            <tr>
                <td><span class="badge bg-secondary">${item.categoria_problema}</span></td>
                <td>${item.edificio}</td>
                <td>${item.equipamento || '-'}</td> {# NOVO: Dados do equipamento #}
                <td><span class="badge ${item.status === 'ConcluÃ­da' ? 'bg-success' : 'bg-warning'}">${item.status}</span></td>
                <td>${item.data_solicitacao}</td>
                <td>${item.tempo_reparo_horas ? item.tempo_reparo_horas.toFixed(1) : '-'}</td> {# CORRIGIDO: Usar tempo_reparo_horas #}
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        ${resumo.length > 20 ? `<p class="text-muted text-center">Mostrando 20 de ${resumo.length} registros</p>` : ''}
    `;
    
    container.innerHTML = html;
}

function limparFiltrosKPIs() {
    // ðŸ“… LIMPA TODOS OS FILTROS (incluindo datas)
    document.getElementById('data-inicio').value = '';
    document.getElementById('data-fim').value = '';
    document.getElementById('filtro-periodo').value = '';
    document.getElementById('filtro-status').value = '';
    document.getElementById('filtro-categoria').value = '';
    document.getElementById('filtro-edificio').value = '';
    document.getElementById('filtro-equipamento').value = ''; {# NOVO #}
    
    // Limpa filtros ativos
    filtrosAtivos = {};
    
    // Restaura dados originais
    dadosKPIsFiltrados = dadosKPIsOriginais;
    
    // Atualiza cards
    atualizarCards(dadosKPIsOriginais);
    
    // Recria grÃ¡ficos
    criarGraficos();
    
    // Esconde indicador de filtros
    document.getElementById('filtros-ativos').style.display = 'none';
    
    // Limpa tabela de resumo
    document.getElementById('tabela-resumo').innerHTML = '<p class="text-muted text-center">Use os filtros acima ou clique nos grÃ¡ficos para ver dados especÃ­ficos.</p>';
    
    console.log('ðŸ§¹ Filtros de KPIs limpos');
}

function atualizarDados() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
    btn.disabled = true;
    
    // Chamada para a API do Blueprint de KPIs para atualizar o cache
    fetch('/v2/kpis/atualizar-kpis', { method: 'POST' })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.message || 'Erro na API');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('Dados de KPIs atualizados!\n' + data.message);
                // ApÃ³s atualizar o cache, recarregar a pÃ¡gina para buscar os novos dados
                location.reload(); 
            } else {
                alert('Erro ao atualizar KPIs: ' + data.message);
            }
        })
        .catch(error => alert('Erro na requisição de atualização de KPIs: ' + error.message))
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

function debugFiltros() {
    console.log('ðŸ” DEBUG - Estado atual dos filtros:');
    console.log('   Data inÃ­cio:', document.getElementById('data-inicio').value);
    console.log('   Data fim:', document.getElementById('data-fim').value);
    console.log('   PerÃ­odo:', document.getElementById('filtro-periodo').value);
    console.log('   Status:', document.getElementById('filtro-status').value);
    console.log('   Categoria:', document.getElementById('filtro-categoria').value);
    console.log('   EdifÃ­cio:', document.getElementById('filtro-edificio').value);
    console.log('   Equipamento:', document.getElementById('filtro-equipamento').value);
    console.log('   Filtros ativos:', filtrosAtivos);
    console.log('   Dados originais:', dadosKPIsOriginais);
    console.log('   Dados filtrados:', dadosKPIsFiltrados);
}

</script>
{% endblock %}
