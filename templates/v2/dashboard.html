{% extends "base.html" %}

{% block title %}Dashboard v2.0 - Sistema de Elevadores TJ/MG{% endblock %}

{% block extra_head %}

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    
    <style>
        body { background-color: #f8f9fa; }
        .navbar-brand { font-weight: bold; }
        .version-badge { 
            background: linear-gradient(45deg, #28a745, #20c997); 
            color: white; 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 12px; 
            margin-left: 10px;
        }
        .card { 
            border: none; 
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); 
            margin-bottom: 1rem; 
        }
        .card-header { 
            background-color: #fff; 
            border-bottom: 1px solid #dee2e6; 
            font-weight: 600; 
        }
        .stats-card { transition: transform 0.2s; }
        .stats-card:hover { transform: translateY(-2px); }
        .map-container { 
            height: 500px; 
            border-radius: 0.375rem; 
            overflow: hidden; 
        }
        .filter-section { 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .comparison-banner {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        /* NOVO: Estilos para estat√≠¬≠sticas detalhadas */
        .stats-list {
            max-height: 200px;
            overflow-y: auto;
            font-size: 14px;
        }
        .stats-list > div {
            padding: 2px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .stats-list > div:last-child {
            border-bottom: none;
        }
        #stats-detalhadas .card-body {
            transition: all 0.3s ease;
        }
    </style>

{% endblock %}

{% block content %}
    <div class="container-fluid mt-3">
        <!-- Banner de Compara√ß√£o -->
        <div class="comparison-banner">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5><i class="fas fa-rocket"></i> Nova Arquitetura Modular</h5>
                    <p class="mb-0">Voc√™ est√° usando a vers√£o 2.0 com arquitetura modular. 
                    Compare com o <a href="http://localhost:5000"  class="text-white"><u>sistema atual</u></a></p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light btn-sm" onclick="atualizarDados()">
                        <i class="fas fa-sync-alt"></i> Atualizar Dados
                    </button>
                </div>
            </div>
        </div>

        {% if erro %}
        <!-- Erro -->
        <div class="alert alert-danger">
            <h4><i class="fas fa-exclamation-triangle"></i> Erro</h4>
            <p>{{ erro }}</p>
            <button class="btn btn-danger" onclick="location.reload()">
                <i class="fas fa-redo"></i> Tentar Novamente
            </button>
        </div>
        {% else %}
        
       <!-- Cards de Estat√≠¬≠sticas -->
        <div class="row mb-4 stats-row" id="stats-cards">
            <div class="col-md-12">
                <div class="d-flex flex-wrap justify-content-between">
                    <div class="flex-fill mx-1">
                        <div class="card stats-card bg-primary text-white">
                            <div class="card-body text-center py-2">
                                <i class="fas fa-building fa-lg mb-1"></i>
                                <h5 id="stat-predios">{{ stats.total_predios if stats else 0 }}</h5>
                                <p class="mb-0 small">Pr√©dios</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-fill mx-1">
                        <div class="card stats-card bg-success text-white">
                            <div class="card-body text-center py-2">
                                <i class="fas fa-elevator fa-lg mb-1"></i>
                                <h5 id="stat-elevadores">{{ stats.total_elevadores if stats else 0 }}</h5>
                                <p class="mb-0 small">Elevadores</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-fill mx-1">
                        <div class="card stats-card bg-info text-white">
                            <div class="card-body text-center py-2">
                                <i class="fas fa-map-marker-alt fa-lg mb-1"></i>
                                <h5 id="stat-cidades">{{ stats.cidades if stats else 0 }}</h5>
                                <p class="mb-0 small">Cidades</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-fill mx-1">
                        <div class="card stats-card bg-secondary text-white">
                            <div class="card-body text-center py-2">
                                <i class="fas fa-map fa-lg mb-1"></i>
                                <h5 id="stat-regioes">{{ stats.regioes if stats else 0 }}</h5>
                                <p class="mb-0 small">Regi√µes</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-fill mx-1">
                        <div class="card stats-card bg-success text-white">
                            <div class="card-body text-center py-2">
                                <i class="fas fa-check-circle fa-lg mb-1"></i>
                                <h5 id="stat-ativos">{{ stats.em_atividade if stats else 0 }}</h5>
                                <p class="mb-0 small">Ativos</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-fill mx-1">
                        <div class="card stats-card bg-warning text-white">
                            <div class="card-body text-center py-2">
                                <i class="fas fa-times-circle fa-lg mb-1"></i>
                                <h5 id="stat-suspensos">{{ stats.elevadores_suspensos if stats else 0 }}</h5>
                                <p class="mb-0 small">Suspensos</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex-fill mx-1">
                        <div class="card stats-card bg-danger text-white">
                             <div class="card-body text-center py-2">
                                <i class="fas fa-exclamation-triangle fa-lg mb-1"></i>
                                 <h5 id="stat-parados">{{ stats.elevadores_parados if stats else 0 }}</h5>
                                 <p class="mb-0 small">Parados</p>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="row">
            <!-- Mapa -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-map-marked-alt"></i> Mapa dos Elevadores</h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="mapa" class="map-container"></div>
                    </div>
                </div>
                
                <!-- NOVO: Estat√≠¬≠sticas Detalhadas (abaixo do mapa, mesma coluna) -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Estat√≠sticas Detalhadas</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Por Tipo -->
                            <div class="col-md-3">
                                <h6><i class="fas fa-building"></i> Por Tipo</h6>
                                <div id="stats-por-tipo" class="stats-list">
                                    {% if stats_detalhadas and stats_detalhadas.por_tipo %}
                                        {% for tipo, quantidade in stats_detalhadas.por_tipo.items() %}
                                        <div class="d-flex justify-content-between">
                                            <span>{{ tipo }}:</span>
                                            <strong>{{ quantidade }}</strong>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted">Carregando...</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Por Regi√£o -->
                            <div class="col-md-3">
                                <h6><i class="fas fa-map"></i> Por Regi√£o</h6>
                                <div id="stats-por-regiao" class="stats-list">
                                    {% if stats_detalhadas and stats_detalhadas.por_regiao %}
                                        {% for regiao, quantidade in stats_detalhadas.por_regiao.items() %}
                                        <div class="d-flex justify-content-between">
                                            <span>{{ regiao }}:</span>
                                            <strong>{{ quantidade }}</strong>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted">Carregando...</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Por Marca -->
                            <div class="col-md-3">
                                <h6><i class="fas fa-tag"></i> Por Marca</h6>
                                <div id="stats-por-marca" class="stats-list">
                                    {% if stats_detalhadas and stats_detalhadas.por_marca %}
                                        {% for marca, quantidade in stats_detalhadas.por_marca.items() %}
                                        <div class="d-flex justify-content-between">
                                            <span>{{ marca }}:</span>
                                            <strong>{{ quantidade }}</strong>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted">Carregando...</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Por Status -->
                            <div class="col-md-3">
                                <h6><i class="fas fa-traffic-light"></i> Por Status</h6>
                                <div id="stats-por-status" class="stats-list">
                                    {% if stats_detalhadas and stats_detalhadas.por_status %}
                                        {% for status, quantidade in stats_detalhadas.por_status.items() %}
                                        <div class="d-flex justify-content-between">
                                            <span class="{% if status == 'Em atividade' %}text-success{% elif status == 'Parados' %}text-danger{% else %}text-warning{% endif %}">
                                                {{ status }}:
                                            </span>
                                            <strong>{{ quantidade }}</strong>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted">Carregando...</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- NOVO: Elevadores Parados (se houver) -->
                        <div class="row mt-4" id="elevadores-parados-section">
                            <div class="col-12">
                                <h6><i class="fas fa-exclamation-triangle text-danger"></i> Elevadores Parados</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>Unidade</th>
                                                <th>Cidade</th>
                                                <th>Tipo</th>
                                                <th>Regi√£o</th>
                                                <th>Parados</th>
                                                <th>Total</th>
                                                <th>Marca</th>
                                            </tr>
                                        </thead>
                                        <tbody id="elevadores-parados-tbody">
                                            <!-- Preenchido via JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros (agora com altura total) -->
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h5><i class="fas fa-filter"></i> Filtros</h5>
                    </div>
                    <div class="card-body">
                        <!-- Contador de Resultados -->
                        <div class="alert alert-info" id="contador-resultados">
                            <strong>Total:</strong> 
                            <span id="total-elevadores-filtro">{{ stats.total_elevadores if stats else 0 }}</span> elevadores em 
                            <span id="total-locais-filtro">{{ stats.total_predios if stats else 0 }}</span> locais
                        </div>

                        <!-- Bot√µes de A√ß√£o -->
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-6">
                                    <button class="btn btn-success btn-sm w-100 mb-2" onclick="aplicarFiltros()">
                                        <i class="fas fa-search"></i> Aplicar
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-info btn-sm w-100 mb-2" onclick="selecionarTodos()">
                                        <i class="fas fa-check-double"></i> Todos
                                    </button>
                                </div>
                            </div>
                            <button class="btn btn-secondary btn-sm w-100" onclick="limparFiltros()">
                                <i class="fas fa-eraser"></i> Limpar Filtros
                            </button>
                        </div>

                        <!-- Filtros por Tipo -->
                        {% if tipos_unicos %}
                        <div class="mb-3">
                            <h6><i class="fas fa-building"></i> Tipo</h6>
                            <div class="filter-section">
                                {% for tipo in tipos_unicos %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           id="check-tipo-{{ loop.index }}" value="{{ tipo }}">
                                    <label class="form-check-label" for="check-tipo-{{ loop.index }}">
                                        {{ tipo }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Filtros por Regi√£o -->
                        {% if regioes_unicas %}
                        <div class="mb-3">
                            <h6><i class="fas fa-map"></i> Regi√£o</h6>
                            <div class="filter-section">
                                {% for regiao in regioes_unicas %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           id="check-regiao-{{ loop.index }}" value="{{ regiao }}">
                                    <label class="form-check-label" for="check-regiao-{{ loop.index }}">
                                        {{ regiao }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- NOVO: Filtros por Marca -->
                        {% if marcas_unicas %}
                        <div class="mb-3">
                            <h6><i class="fas fa-tag"></i> Marca</h6>
                            <div class="filter-section">
                                {% for marca in marcas_unicas %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           id="check-marca-{{ loop.index }}" value="{{ marca }}">
                                    <label class="form-check-label" for="check-marca-{{ loop.index }}">
                                        {{ marca }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- NOVO: Filtros por Empresa -->
                        {% if empresas_unicas %}
                        <div class="mb-3">
                            <h6><i class="fas fa-industry"></i> Empresa</h6>
                            <div class="filter-section">
                                {% for empresa in empresas_unicas %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           id="check-empresa-{{ loop.index }}" value="{{ empresa }}">
                                    <label class="form-check-label" for="check-empresa-{{ loop.index }}">
                                        {{ empresa }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Filtros por Situa√ß√£o -->
                        <div class="mb-3">
                            <h6><i class="fas fa-traffic-light"></i> Situa√ß√£o</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       id="check-situacao-ativos" value="ativos">
                                <label class="form-check-label" for="check-situacao-ativos">
                                    <span class="text-success">üü¢</span> Ativos
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       id="check-situacao-suspensos" value="suspensos">
                                <label class="form-check-label" for="check-situacao-suspensos">
                                    <span class="text-warning">üü°</span> Suspensos
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       id="check-situacao-parados" value="parados">
                                <label class="form-check-label" for="check-situacao-parados">
                                    <span class="text-danger">üî¥</span> Parados
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
{% endblock %}


{% block extra_scripts %}
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
    // Dados iniciais do GeoJSON passados do backend via Jinja2
    const initialGeojsonData = {{ geojson_data | tojson if geojson_data else '{"type": "FeatureCollection", "features": []}' }};
    const initialStats = {{ stats | tojson if stats else '{}' }};
    const initialDetailedStats = {{ stats_detalhadas | tojson if stats_detalhadas else '{}' }};
    
    // Vari√°veis globais para os tipos √∫nicos, regi√µes √∫nicas, etc.
    // O Jinja2 j√° as est√° passando para o template.
    // Para acess√°-las no JS externo, vo√™¬™ pode pass√°-las como no exemplo abaixo,
    // ou fazer chamadas de API para obt√™-las se elas mudarem dinamicamente.
    // Por enquanto, vamos considerar que s√£o carregadas uma vez.
    const uniqueTypes = {{ tipos_unicos | tojson | safe }};
    const uniqueRegions = {{ regioes_unicas | tojson | safe }};
    const uniqueBrands = {{ marcas_unicas | tojson | safe }};
    const uniqueCompanies = {{ empresas_unicas | tojson | safe }};
</script>

<!-- Script customizado para o dashboard v2 -->
<script src="{{ url_for('static', filename='js/dashboard_v2.js') }}"></script>
{% endblock %}