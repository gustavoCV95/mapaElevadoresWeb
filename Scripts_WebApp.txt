
--- InÌcio do cÛdigo: dashboard.html ---
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard v2.0 - Sistema de Elevadores</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    
    <style>
        body { background-color: #f8f9fa; }
        .navbar-brand { font-weight: bold; }
        .version-badge { 
            background: linear-gradient(45deg, #28a745, #20c997); 
            color: white; 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 12px; 
            margin-left: 10px;
        }
        .card { 
            border: none; 
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); 
            margin-bottom: 1rem; 
        }
        .card-header { 
            background-color: #fff; 
            border-bottom: 1px solid #dee2e6; 
            font-weight: 600; 
        }
        .stats-card { transition: transform 0.2s; }
        .stats-card:hover { transform: translateY(-2px); }
        .map-container { 
            height: 500px; 
            border-radius: 0.375rem; 
            overflow: hidden; 
        }
        .filter-section { 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .comparison-banner {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        /* NOVO: Estilos para estat√É¬≠sticas detalhadas */
        .stats-list {
            max-height: 200px;
            overflow-y: auto;
            font-size: 14px;
        }
        .stats-list > div {
            padding: 2px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .stats-list > div:last-child {
            border-bottom: none;
        }
        #stats-detalhadas .card-body {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-building"></i> Sistema de Elevadores
                <span class="version-badge">v2.0 Modular</span>
            </a>
            
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-user"></i> {{ usuario }}
                </span>
                <a class="nav-link" href="{{ url_for('auth.logout') }}">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <!-- Banner de Compara√ß√£o -->
        <div class="comparison-banner">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5><i class="fas fa-rocket"></i> Nova Arquitetura Modular</h5>
                    <p class="mb-0">Voc√™ est√° usando a vers√£o 2.0 com arquitetura modular. 
                    Compare com o <a href="http://localhost:5000"  class="text-white"><u>sistema atual</u></a></p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light btn-sm" onclick="atualizarDados()">
                        <i class="fas fa-sync-alt"></i> Atualizar Dados
                    </button>
                </div>
            </div>
        </div>

        {% if erro %}
        <!-- Erro -->
        <div class="alert alert-danger">
            <h4><i class="fas fa-exclamation-triangle"></i> Erro</h4>
            <p>{{ erro }}</p>
            <button class="btn btn-danger" onclick="location.reload()">
                <i class="fas fa-redo"></i> Tentar Novamente
            </button>
        </div>
        {% else %}
        
       <!-- Cards de Estat√É¬≠sticas -->
        <div class="row mb-4 stats-row" id="stats-cards">
            <div class="col-md-12">
                <div class="d-flex flex-wrap justify-content-between">
                    <div class="flex-fill mx-1">
                        <div class="card stats-card bg-primary text-white">
                            <div class="card-body text-center py-2">
                                <i class="fas fa-building fa-lg mb-1"></i>
                                <h5 id="stat-predios">{{ stats.total_predios if stats else 0 }}</h5>
                                <p class="mb-0 small">Pr√©dios</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-fill mx-1">
                        <div class="card stats-card bg-success text-white">
                            <div class="card-body text-center py-2">
                                <i class="fas fa-elevator fa-lg mb-1"></i>
                                <h5 id="stat-elevadores">{{ stats.total_elevadores if stats else 0 }}</h5>
                                <p class="mb-0 small">Elevadores</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-fill mx-1">
                        <div class="card stats-card bg-info text-white">
                            <div class="card-body text-center py-2">
                                <i class="fas fa-map-marker-alt fa-lg mb-1"></i>
                                <h5 id="stat-cidades">{{ stats.cidades if stats else 0 }}</h5>
                                <p class="mb-0 small">Cidades</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-fill mx-1">
                        <div class="card stats-card bg-secondary text-white">
                            <div class="card-body text-center py-2">
                                <i class="fas fa-map fa-lg mb-1"></i>
                                <h5 id="stat-regioes">{{ stats.regioes if stats else 0 }}</h5>
                                <p class="mb-0 small">Regi√µes</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-fill mx-1">
                        <div class="card stats-card bg-success text-white">
                            <div class="card-body text-center py-2">
                                <i class="fas fa-check-circle fa-lg mb-1"></i>
                                <h5 id="stat-ativos">{{ stats.em_atividade if stats else 0 }}</h5>
                                <p class="mb-0 small">Ativos</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-fill mx-1">
                        <div class="card stats-card bg-warning text-white">
                            <div class="card-body text-center py-2">
                                <i class="fas fa-times-circle fa-lg mb-1"></i>
                                <h5 id="stat-suspensos">{{ stats.elevadores_suspensos if stats else 0 }}</h5>
                                <p class="mb-0 small">Suspensos</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex-fill mx-1">
                        <div class="card stats-card bg-danger text-white">
                             <div class="card-body text-center py-2">
                                <i class="fas fa-exclamation-triangle fa-lg mb-1"></i>
                                 <h5 id="stat-parados">{{ stats.elevadores_parados if stats else 0 }}</h5>
                                 <p class="mb-0 small">Parados</p>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="row">
            <!-- Mapa -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-map-marked-alt"></i> Mapa dos Elevadores</h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="mapa" class="map-container"></div>
                    </div>
                </div>
                
                <!-- NOVO: Estat√≠¬≠sticas Detalhadas (abaixo do mapa, mesma coluna) -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Estat√≠sticas Detalhadas</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Por Tipo -->
                            <div class="col-md-3">
                                <h6><i class="fas fa-building"></i> Por Tipo</h6>
                                <div id="stats-por-tipo" class="stats-list">
                                    {% if stats_detalhadas and stats_detalhadas.por_tipo %}
                                        {% for tipo, quantidade in stats_detalhadas.por_tipo.items() %}
                                        <div class="d-flex justify-content-between">
                                            <span>{{ tipo }}:</span>
                                            <strong>{{ quantidade }}</strong>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted">Carregando...</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Por Regi√£o -->
                            <div class="col-md-3">
                                <h6><i class="fas fa-map"></i> Por Regi√£o</h6>
                                <div id="stats-por-regiao" class="stats-list">
                                    {% if stats_detalhadas and stats_detalhadas.por_regiao %}
                                        {% for regiao, quantidade in stats_detalhadas.por_regiao.items() %}
                                        <div class="d-flex justify-content-between">
                                            <span>{{ regiao }}:</span>
                                            <strong>{{ quantidade }}</strong>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted">Carregando...</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Por Marca -->
                            <div class="col-md-3">
                                <h6><i class="fas fa-tag"></i> Por Marca</h6>
                                <div id="stats-por-marca" class="stats-list">
                                    {% if stats_detalhadas and stats_detalhadas.por_marca %}
                                        {% for marca, quantidade in stats_detalhadas.por_marca.items() %}
                                        <div class="d-flex justify-content-between">
                                            <span>{{ marca }}:</span>
                                            <strong>{{ quantidade }}</strong>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted">Carregando...</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Por Status -->
                            <div class="col-md-3">
                                <h6><i class="fas fa-traffic-light"></i> Por Status</h6>
                                <div id="stats-por-status" class="stats-list">
                                    {% if stats_detalhadas and stats_detalhadas.por_status %}
                                        {% for status, quantidade in stats_detalhadas.por_status.items() %}
                                        <div class="d-flex justify-content-between">
                                            <span class="{% if status == 'Em atividade' %}text-success{% elif status == 'Parados' %}text-danger{% else %}text-warning{% endif %}">
                                                {{ status }}:
                                            </span>
                                            <strong>{{ quantidade }}</strong>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted">Carregando...</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- NOVO: Elevadores Parados (se houver) -->
                        <div class="row mt-4" id="elevadores-parados-section" style="display: none;">
                            <div class="col-12">
                                <h6><i class="fas fa-exclamation-triangle text-danger"></i> Elevadores Parados</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>Unidade</th>
                                                <th>Cidade</th>
                                                <th>Tipo</th>
                                                <th>Regi√£o</th>
                                                <th>Parados</th>
                                                <th>Total</th>
                                                <th>Marca</th>
                                            </tr>
                                        </thead>
                                        <tbody id="elevadores-parados-tbody">
                                            <!-- Preenchido via JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros (agora com altura total) -->
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h5><i class="fas fa-filter"></i> Filtros</h5>
                    </div>
                    <div class="card-body">
                        <!-- Contador de Resultados -->
                        <div class="alert alert-info" id="contador-resultados">
                            <strong>Total:</strong> 
                            <span id="total-elevadores-filtro">{{ stats.total_elevadores if stats else 0 }}</span> elevadores em 
                            <span id="total-locais-filtro">{{ stats.total_predios if stats else 0 }}</span> locais
                        </div>

                        <!-- Bot√É¬µes de A√ß√£o -->
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-6">
                                    <button class="btn btn-success btn-sm w-100 mb-2" onclick="aplicarFiltros()">
                                        <i class="fas fa-search"></i> Aplicar
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-info btn-sm w-100 mb-2" onclick="selecionarTodos()">
                                        <i class="fas fa-check-double"></i> Todos
                                    </button>
                                </div>
                            </div>
                            <button class="btn btn-secondary btn-sm w-100" onclick="limparFiltros()">
                                <i class="fas fa-eraser"></i> Limpar Filtros
                            </button>
                        </div>

                        <!-- Filtros por Tipo -->
                        {% if tipos_unicos %}
                        <div class="mb-3">
                            <h6><i class="fas fa-building"></i> Tipo</h6>
                            <div class="filter-section">
                                {% for tipo in tipos_unicos %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           id="check-tipo-{{ loop.index }}" value="{{ tipo }}">
                                    <label class="form-check-label" for="check-tipo-{{ loop.index }}">
                                        {{ tipo }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Filtros por Regi√£o -->
                        {% if regioes_unicas %}
                        <div class="mb-3">
                            <h6><i class="fas fa-map"></i> Regi√£o</h6>
                            <div class="filter-section">
                                {% for regiao in regioes_unicas %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           id="check-regiao-{{ loop.index }}" value="{{ regiao }}">
                                    <label class="form-check-label" for="check-regiao-{{ loop.index }}">
                                        {{ regiao }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Filtros por Situa√ß√£o -->
                        <div class="mb-3">
                            <h6><i class="fas fa-traffic-light"></i> Situa√ß√£o</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       id="check-situacao-ativos" value="ativos">
                                <label class="form-check-label" for="check-situacao-ativos">
                                    <span class="text-success">√¢‚Äî¬è</span> Ativos
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       id="check-situacao-suspensos" value="suspensos">
                                <label class="form-check-label" for="check-situacao-suspensos">
                                    <span class="text-warning">√¢‚Äî¬è</span> Suspensos
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       id="check-situacao-parados" value="parados">
                                <label class="form-check-label" for="check-situacao-parados">
                                    <span class="text-danger">√¢‚Äî¬è</span> Parados
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
    // Dados iniciais do GeoJSON passados do backend via Jinja2
    const initialGeojsonData = {{ geojson_data | tojson if geojson_data else '{"type": "FeatureCollection", "features": []}' }};
    const initialStats = {{ stats | tojson if stats else '{}' }};
    const initialDetailedStats = {{ stats_detalhadas | tojson if stats_detalhadas else '{}' }};
    // Se houver outras vari√É¬°veis Jinja2 usadas diretamente no JavaScript, passe-as aqui tamb√É¬©m.
    
    // Vari√É¬°veis globais para os tipos √É¬∫nicos, regi√É¬µes √É¬∫nicas, etc.
    // O Jinja2 j√É¬° as est√É¬° passando para o template.
    // Para acess√É¬°-las no JS externo, voc√É¬™ pode pass√É¬°-las como no exemplo abaixo,
    // ou fazer chamadas de API para obt√É¬™-las se elas mudarem dinamicamente.
    // Por enquanto, vamos considerar que s√£o carregadas uma vez.
    const uniqueTypes = {{ tipos_unicos | tojson | safe }};
    const uniqueRegions = {{ regioes_unicas | tojson | safe }};
    const uniqueBrands = {{ marcas_unicas | tojson | safe }};
    const uniqueCompanies = {{ empresas_unicas | tojson | safe }};
</script>

<!-- Script customizado para o dashboard v2 -->
<script src="{{ url_for('static', filename='js/dashboard_v2.js') }}"></script>

</body>
</html>
--- Fim do cÛdigo: dashboard.html ---

--- InÌcio do cÛdigo: kpis.html ---
{% extends "base.html" %}

{# CORRIGIDO: Certifique-se de que h√É¬° APENAS UMA defini√ß√£o de block title #}
{% block title %}KPIs de Manuten√ß√£o - Sistema de Elevadores TJ/MG{% endblock %}

{% block extra_head %}
<!-- Chart.js -->
{# CORRIGIDO: URLs atualizadas para Chart.js v3.x e seus adaptadores #}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/index.min.js"></script>
{# Opcional: Se precisar de um locale espec√É¬≠fico para date-fns, pode adicionar aqui. #}
{# Chart.js v3 usa a config global para locale do date-fns adapter. #}
<script>
    // Configura locale global para Chart.js date-fns adapter
    Chart.defaults.plugins.tooltip.usePointStyle = true; // Estilo de tooltip mais moderno
    Chart.defaults.font.family = "'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif";
    Chart.defaults.color = '#333'; // Cor padr√£o do texto nos gr√É¬°ficos
</script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-chart-line"></i> 
            KPIs de Manuten√ß√£o - Elevadores TJ/MG
        </h1>
    </div>
</div>

{% if erro %}
    <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle"></i> {{ erro }}
    </div>
{% else %}
    <!-- Filtros Avan√ßados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-filter"></i> Filtros</h5>
                    <div>
                        <button class="btn btn-success btn-sm me-2" onclick="aplicarFiltros()">
                            <i class="fas fa-search"></i> Aplicar Filtros
                        </button>
                        <button class="btn btn-secondary btn-sm me-2" onclick="limparFiltrosKPIs()">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                        <button class="btn btn-info btn-sm" onclick="atualizarDados()"> {# Esta fun√ß√£o chamar√É¬° o /v2/kpis/atualizar-kpis #}
                            <i class="fas fa-sync-alt"></i> Atualizar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Primeira linha: Filtros de Data -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-calendar"></i> Data de In√É¬≠cio</label>
                            <input type="date" class="form-control" id="data-inicio">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-calendar"></i> Data de Fim</label>
                            <input type="date" class="form-control" id="data-fim">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><i class="fas fa-clock"></i> Per√É¬≠odo Predefinido</label>
                            <select class="form-select" id="filtro-periodo" onchange="selecionarPeriodoPredefinido()">
                                <option value="">Selecione um per√É¬≠odo...</option>
                                <option value="ultima-semana">√É≈°ltima Semana</option>
                                <option value="ultimo-mes">√É≈°ltimo M√É¬™s</option>
                                <option value="ultimos-3-meses">√É≈°ltimos 3 Meses</option>
                                <option value="ultimos-6-meses">√É≈°ltimos 6 Meses</option>
                                <option value="ultimo-ano">√É≈°ltimo Ano</option>
                                <option value="ultimos-2-anos">√É≈°ltimos 2 Anos</option>
                                <option value="ultimos-5-anos">√É≈°ltimos 5 Anos</option>
                                <option value="todo-periodo">Todo o Per√É¬≠odo</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Segunda linha: Outros filtros -->
                    <div class="row">
                        <!-- Filtro por Status -->
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-tasks"></i> Status</label>
                            <select class="form-select" id="filtro-status">
                                <option value="">Todos os status</option>
                                <option value="Conclu√É¬≠da">Conclu√É¬≠da</option>
                                <option value="Confirmada">Confirmada</option>
                                <option value="Pendente">Pendente</option> {# NOVO: Adicione Pendente se seu status incluir #}
                            </select>
                        </div>
                        
                        <!-- Filtro por Categoria -->
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-tags"></i> Categoria</label>
                            <select class="form-select" id="filtro-categoria">
                                <option value="">Todas as categorias</option>
                                <!-- Preenchido dinamicamente via JavaScript -->
                            </select>
                        </div>
                        
                        <!-- Filtro por Edif√É¬≠cio -->
                        <div class="col-md-3"> {# CORRIGIDO: Reduzido para 3 para adicionar Equipamento #}
                            <label class="form-label"><i class="fas fa-building"></i> Edif√É¬≠cio</label>
                            <select class="form-select" id="filtro-edificio">
                                <option value="">Todos os edif√É¬≠cios</option>
                                <!-- Preenchido dinamicamente via JavaScript -->
                            </select>
                        </div>

                        <!-- NOVO: Filtro por Elevador (Equipamento) -->
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-elevator"></i> Elevador (Equipamento)</label>
                            <select class="form-select" id="filtro-equipamento">
                                <option value="">Todos os elevadores</option>
                                <!-- Preenchido dinamicamente via JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards de KPIs Principais -->
    <div class="row mb-4" id="kpis-cards">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                    <h3 id="total-chamados">{{ metricas.total_chamados or 0 }}</h3>
                    <p class="mb-0">Total de Chamados</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <h3 id="chamados-concluidos">{{ metricas.chamados_concluidos or 0 }}</h3>
                    <p class="mb-0">Chamados Conclu√É¬≠dos</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h3 id="tempo-mediano">{{ "%.1f"|format(metricas.tempo_mediano_reparo or 0) }}h</h3>
                    <p class="mb-0">Tempo Mediano de Reparo</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-percentage fa-2x mb-2"></i>
                    <h3 id="disponibilidade">{{ "%.1f"|format(metricas.disponibilidade or 0) }}%</h3>
                    <p class="mb-0">Taxa de Conclus√£o</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Indicador de Filtros Ativos -->
    <div class="row mb-3" id="filtros-ativos" style="display: none;">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-filter"></i> 
                <strong>Filtros ativos:</strong> 
                <span id="descricao-filtros"></span>
                <button class="btn btn-sm btn-outline-primary ms-2" onclick="limparFiltrosKPIs()">
                    <i class="fas fa-times"></i> Remover filtros
                </button>
            </div>
        </div>
    </div>

    <!-- Gr√É¬°ficos -->
    <div class="row">
        <!-- Gr√É¬°fico de Chamados por M√É¬™s -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> Chamados por M√É¬™s</h5>
                    <small class="text-muted">Clique nos pontos para filtrar por m√É¬™s</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-chamados-mes" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Gr√É¬°fico de Categorias de Problema -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-pie"></i> Categorias de Problemas</h5>
                    <small class="text-muted">Clique nas fatias para filtrar por categoria</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-categorias" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Gr√É¬°fico de Edif√É¬≠cios Mais Problem√É¬°ticos -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Edif√É¬≠cios com Mais Chamados</h5>
                    <small class="text-muted">Clique nas barras para filtrar por edif√É¬≠cio</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-edificios" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Gr√É¬°fico de Tempo por Categoria -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-stopwatch"></i> Tempo Mediano por Categoria</h5>
                    <small class="text-muted">Clique nas barras para filtrar por categoria</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-tempo-categoria" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- NOVO: SE√É‚Ä°√É∆íO DE GR√É¬ÅFICOS DE ELEVADORES -->
    <div class="row">
        <!-- Gr√É¬°fico de Chamados por Elevador -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-elevator"></i> Chamados por Elevador</h5>
                    <small class="text-muted">Clique nas barras para filtrar por elevador espec√É¬≠fico</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-chamados-elevador" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Gr√É¬°fico de Tempo Mediano por Elevador -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clock"></i> Tempo Mediano de Atendimento por Elevador</h5>
                    <small class="text-muted">Clique nas barras para filtrar por elevador espec√É¬≠fico</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-tempo-elevador" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Resumo Filtrado -->
    <div class="row">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-table"></i> Resumo dos Dados Filtrados</h5>
            </div>
            <div class="card-body">
                <div id="loading-resumo" class="text-center" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Carregando dados...
                </div>
                <div id="tabela-resumo">
                    <p class="text-muted text-center">Use os filtros acima ou clique nos gr√É¬°ficos para ver dados espec√É¬≠ficos.</p>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<script>
// Dados para JavaScript
const dadosKPIsOriginais = {{ metricas|tojson|safe }};
let dadosKPIsFiltrados = dadosKPIsOriginais;
let graficos = {};
let filtrosAtivos = {};

// NOVO: Vari√É¬°veis para preencher os selects de filtro
const categoriasUnicas = {{ categorias_unicas|tojson|safe }};
const edificiosUnicos = {{ edificios_unicos|tojson|safe }};
const equipamentosUnicos = {{ equipamentos_unicos|tojson|safe }}; // NOVO

console.log('√∞≈∏‚Äú≈† Dados de KPIs recebidos:', dadosKPIsOriginais);
console.log('√¢≈°‚Ñ¢√Ø¬∏¬è Categorias √É≈°nicas:', categoriasUnicas);
console.log('√¢≈°‚Ñ¢√Ø¬∏¬è Edif√É¬≠cios √É≈°nicos:', edificiosUnicos);
console.log('√¢≈°‚Ñ¢√Ø¬∏¬è Equipamentos √É≈°nicos:', equipamentosUnicos); // NOVO


// Inicializa gr√É¬°ficos quando a p√É¬°gina carrega
document.addEventListener('DOMContentLoaded', function() {
    console.log('√∞≈∏‚Äú‚Äû DOM carregado, criando gr√É¬°ficos de KPIs...');
    preencherFiltros();
    criarGraficos();
});

function preencherFiltros() {
    // Preenche filtro de categorias
    const selectCategoria = document.getElementById('filtro-categoria');
    categoriasUnicas.forEach(categoria => {
        const option = document.createElement('option');
        option.value = categoria;
        option.textContent = categoria;
        selectCategoria.appendChild(option);
    });
    
    // Preenche filtro de edif√É¬≠cios
    const selectEdificio = document.getElementById('filtro-edificio');
    edificiosUnicos.forEach(edificio => {
        const option = document.createElement('option');
        option.value = edificio;
        option.textContent = edificio.length > 50 ? edificio.substring(0, 50) + '...' : edificio;
        selectEdificio.appendChild(option);
    });

    // NOVO: Preenche filtro de equipamentos (Elevadores)
    const selectEquipamento = document.getElementById('filtro-equipamento');
    equipamentosUnicos.forEach(equipamento => {
        const option = document.createElement('option');
        option.value = equipamento;
        option.textContent = equipamento;
        selectEquipamento.appendChild(option);
    });
}

// √∞≈∏‚Äú‚Ä¶ NOVA FUN√É‚Ä°√É∆íO: Selecionar per√É¬≠odo predefinido
function selecionarPeriodoPredefinido() {
    const periodo = document.getElementById('filtro-periodo').value;
    
    if (periodo && periodo !== 'todo-periodo') {
        // Limpa datas personalizadas quando seleciona per√É¬≠odo predefinido
        document.getElementById('data-inicio').value = '';
        document.getElementById('data-fim').value = '';
    }
    
    console.log('√∞≈∏‚Äú‚Ä¶ Per√É¬≠odo predefinido selecionado:', periodo);
}

function criarGraficos() {
    // Destroi gr√É¬°ficos existentes
    Object.values(graficos).forEach(grafico => {
        if (grafico) grafico.destroy();
    });
    
    // Cria novos gr√É¬°ficos
    criarGraficoChamadosPorMes();
    criarGraficoCategorias();
    criarGraficoEdificios();
    criarGraficoTempoPorCategoria();
    
    // NOVOS GR√É¬ÅFICOS DE ELEVADORES
    criarGraficoChamadosPorElevador();
    criarGraficoTempoMedianoPorElevador();
}

function criarGraficoChamadosPorMes() {
    const ctx = document.getElementById('grafico-chamados-mes');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.chamados_por_mes || {};
    const labels = Object.keys(dados).sort();
    const values = labels.map(label => dados[label]);
    
    graficos.chamadosMes = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Chamados',
                data: values,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#007bff',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    type: 'time', {# CORRIGIDO: Use escala de tempo para melhor visualiza√ß√£o #}
                    time: {
                        unit: 'month',
                        tooltipFormat: 'MMM yyyy'
                    },
                    adapters: {
                        date: {
                            // Certifique-se de que o locale 'pt-BR' est√É¬° dispon√É¬≠vel para date-fns
                            // Se n√£o estiver funcionando, pode ser necess√É¬°rio importar explicitamente o locale do date-fns
                            // No entanto, Chart.js adapta globalmente, ent√£o deve funcionar.
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const mesAno = labels[index];
                    filtrarPorMes(mesAno);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

function criarGraficoCategorias() {
    const ctx = document.getElementById('grafico-categorias');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.categorias_problema || {};
    
    // √∞≈∏‚Äù‚Äû ORDENA√É‚Ä°√É∆íO DECRESCENTE
    const entries = Object.entries(dados).sort((a, b) => b[1] - a[1]);
    const labels = entries.map(entry => entry[0]);
    const values = entries.map(entry => entry[1]);
    
    const cores = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
        '#E0BBE4', '#957DAD', '#D291BC', '#FFC72C'
    ];
    
    graficos.categorias = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: cores.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff',
                hoverBorderWidth: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const categoria = labels[index];
                    filtrarPorCategoria(categoria);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// √∞≈∏‚Äù‚Äû MODIFICADO: Gr√É¬°fico de Edif√É¬≠cios com ordena√ß√£o decrescente garantida
function criarGraficoEdificios() {
    const ctx = document.getElementById('grafico-edificios');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.chamados_por_edificio || {};
    
    // √∞≈∏‚Äù‚Äû ORDENA√É‚Ä°√É∆íO DECRESCENTE EXPL√É¬çCITA (garantindo que funcione mesmo se backend n√£o ordenar)
    const entries = Object.entries(dados)
        .sort((a, b) => b[1] - a[1])  // Ordena por valor decrescente
        .slice(0, 10); // Top 10
    
    const labels = entries.map(entry => entry[0]);
    const values = entries.map(entry => entry[1]);
    
    console.log('√∞≈∏¬è¬¢ Dados de edif√É¬≠cios ordenados:', entries);
    
    graficos.edificios = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels.map(label => label.length > 20 ? label.substring(0, 20) + '...' : label),
            datasets: [{
                label: 'Chamados',
                data: values,
                backgroundColor: '#28a745',
                borderColor: '#1e7e34',
                borderWidth: 1,
                hoverBackgroundColor: '#34ce57'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const edificio = labels[index];
                    filtrarPorEdificio(edificio);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// √∞≈∏‚Äù‚Äû MODIFICADO: Gr√É¬°fico de Tempo por Categoria com ordena√ß√£o decrescente garantida
function criarGraficoTempoPorCategoria() {
    const ctx = document.getElementById('grafico-tempo-categoria');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.tempo_por_categoria || {};
    
    // √∞≈∏‚Äù‚Äû ORDENA√É‚Ä°√É∆íO DECRESCENTE EXPL√É¬çCITA (garantindo que funcione mesmo se backend n√£o ordenar)
    const entries = Object.entries(dados)
        .sort((a, b) => b[1] - a[1]); // Ordena por valor decrescente
    
    const labels = entries.map(entry => entry[0]);
    const values = entries.map(entry => Math.round(entry[1] * 10) / 10);
    
    console.log('√¢¬è¬±√Ø¬∏¬è Dados de tempo por categoria ordenados:', entries);
    
    graficos.tempoCategoria = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tempo Mediano (horas)',
                data: values,
                backgroundColor: '#ffc107',
                borderColor: '#e0a800',
                borderWidth: 1,
                hoverBackgroundColor: '#ffcd39'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + 'h';
                        }
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const categoria = labels[index];
                    filtrarPorCategoria(categoria);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// NOVO: Gr√É¬°fico de Chamados por Elevador
function criarGraficoChamadosPorElevador() {
    const ctx = document.getElementById('grafico-chamados-elevador');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.chamados_por_equipamento || {};
    
    // Ordena√ß√£o decrescente e limita√ß√£o aos top 15 elevadores
    const entries = Object.entries(dados)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 15); // Top 15 elevadores
    
    const labels = entries.map(entry => String(entry[0]));
    const values = entries.map(entry => entry[1]);
    
    console.log('√∞≈∏¬è‚Äî√Ø¬∏¬è Dados de chamados por elevador ordenados:', entries);
    
    graficos.chamadosElevador = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Chamados',
                data: values,
                backgroundColor: '#007bff',
                borderColor: '#0056b3',
                borderWidth: 1,
                hoverBackgroundColor: '#0056b3'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return 'Elevador: ' + context[0].label;
                        },
                        label: function(context) {
                            return 'Chamados: ' + context.parsed.y;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        font: {
                            size: 10
                        }
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const elevador = String(labels[index]);
                    filtrarPorEquipamento(elevador); {# CORRIGIDO: Chamando filtrarPorEquipamento #}
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// NOVO: Gr√É¬°fico de Tempo Mediano por Elevador
function criarGraficoTempoMedianoPorElevador() {
    const ctx = document.getElementById('grafico-tempo-elevador');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.tempo_por_equipamento || {};
    
    // Ordena√ß√£o decrescente e limita√ß√£o aos top 15 elevadores
    const entries = Object.entries(dados)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 15); // Top 15 elevadores
    
    const labels = entries.map(entry => String(entry[0]));
    const values = entries.map(entry => Math.round(entry[1] * 10) / 10);
    
    console.log('√¢¬è¬∞ Dados de tempo por elevador ordenados:', entries);
    
    graficos.tempoElevador = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tempo Mediano (horas)',
                data: values,
                backgroundColor: '#17a2b8',
                borderColor: '#138496',
                borderWidth: 1,
                hoverBackgroundColor: '#138496'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return 'Elevador: ' + context[0].label;
                        },
                        label: function(context) {
                            return 'Tempo Mediano: ' + context.parsed.y + 'h';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + 'h';
                        }
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        font: {
                            size: 10
                        }
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const elevador = String(labels[index]);
                    filtrarPorEquipamento(elevador); {# CORRIGIDO: Chamando filtrarPorEquipamento #}
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// Fun√ß√É¬µes de filtro por clique nos gr√É¬°ficos
function filtrarPorMes(mesAno) {
    console.log('√∞≈∏‚Äú‚Ä¶ Filtrando por m√É¬™s:', mesAno);
    // Para filtro por m√É¬™s, precisamos ajustar data_inicio e data_fim
    const [ano, mes] = mesAno.split('-');
    const dataInicioMes = `${ano}-${mes}-01`;
    const ultimoDiaMes = new Date(ano, parseInt(mes), 0).getDate();
    const dataFimMes = `${ano}-${mes}-${ultimoDiaMes}`;

    document.getElementById('data-inicio').value = dataInicioMes;
    document.getElementById('data-fim').value = dataFimMes;
    document.getElementById('filtro-periodo').value = ''; // Limpa per√É¬≠odo predefinido

    filtrosAtivos.data_inicio = dataInicioMes;
    filtrosAtivos.data_fim = dataFimMes;
    delete filtrosAtivos.periodo_predefinido;
    delete filtrosAtivos.mes; // Remove filtro de m√É¬™s para evitar conflito

    aplicarFiltrosInterativos();
}

function filtrarPorCategoria(categoria) {
    console.log('√∞≈∏¬è¬∑√Ø¬∏¬è Filtrando por categoria:', categoria);
    document.getElementById('filtro-categoria').value = categoria;
    filtrosAtivos.categoria = categoria;
    aplicarFiltrosInterativos();
}

function filtrarPorEdificio(edificio) {
    console.log('√∞≈∏¬è¬¢ Filtrando por edif√É¬≠cio:', edificio);
    document.getElementById('filtro-edificio').value = edificio;
    filtrosAtivos.edificio = edificio;
    aplicarFiltrosInterativos();
}

// NOVO: Filtrar por elevador espec√É¬≠fico (equipamento)
function filtrarPorEquipamento(equipamento) {
    console.log('√∞≈∏¬è‚Äî√Ø¬∏¬è Filtrando por equipamento:', equipamento);
    document.getElementById('filtro-equipamento').value = equipamento;
    filtrosAtivos.equipamento = equipamento;
    aplicarFiltrosInterativos();
}

function aplicarFiltros() {
    const dataInicio = document.getElementById('data-inicio').value;
    const dataFim = document.getElementById('data-fim').value;
    const periodo = document.getElementById('filtro-periodo').value;
    const status = document.getElementById('filtro-status').value;
    const categoria = document.getElementById('filtro-categoria').value;
    const edificio = document.getElementById('filtro-edificio').value;
    const equipamento = document.getElementById('filtro-equipamento').value; {# NOVO #}
    
    console.log('√∞≈∏‚Äù¬ç Aplicando filtros:', {
        dataInicio, dataFim, periodo, status, categoria, edificio, equipamento
    });
    
    // √∞≈∏‚Äú‚Ä¶ VALIDA√É‚Ä°√É∆íO DE DATAS
    if (dataInicio && dataFim && new Date(dataInicio) > new Date(dataFim)) {
        alert('A data de in√É¬≠cio n√£o pode ser posterior √É¬† data de fim.');
        return;
    }
    
    // MAPEAMENTO CORRETO DOS PAR√É‚ÄöMETROS
    filtrosAtivos = {
        data_inicio: dataInicio,
        data_fim: dataFim,
        periodo_predefinido: periodo,
        status: status,
        categoria: categoria,
        edificio: edificio,
        equipamento: equipamento {# NOVO #}
    };
    
    // Remove filtros vazios
    Object.keys(filtrosAtivos).forEach(key => {
        if (!filtrosAtivos[key]) {
            delete filtrosAtivos[key];
        }
    });
    
    console.log('√∞≈∏‚Äù¬ß Filtros ativos ap√É¬≥s limpeza:', filtrosAtivos);
    
    aplicarFiltrosInterativos();
}

function aplicarFiltrosInterativos() {
    console.log('√∞≈∏‚Äù¬ç Aplicando filtros interativos:', filtrosAtivos);
    
    // Monta par√É¬¢metros para API
    const params = new URLSearchParams();
    Object.keys(filtrosAtivos).forEach(key => {
        if (filtrosAtivos[key]) {
            params.append(key, filtrosAtivos[key]);
        }
    });
    
    // Mostra loading
    const loadingElement = document.getElementById('loading-resumo');
    if (loadingElement) loadingElement.style.display = 'block';
    
    // Faz requisi√ß√£o para API
    fetch('/api/kpis-filtrados?' + params.toString())
        .then(response => {
            if (!response.ok) {
                // Se a resposta n√£o for 2xx, tenta ler como JSON de erro
                return response.json().then(errorData => {
                    throw new Error(errorData.message || 'Erro na API');
                });
            }
            return response.json();
        })
        .then(data => {
            if (loadingElement) loadingElement.style.display = 'none';
            
            if (data.success) {
                // Atualiza dados filtrados
                dadosKPIsFiltrados = data.metricas;
                
                // Atualiza cards
                atualizarCards(data.metricas);
                
                // Recria gr√É¬°ficos
                criarGraficos();
                
                // Mostra indicador de filtros ativos
                mostrarFiltrosAtivos();
                
                // Atualiza tabela de resumo
                atualizarTabelaResumo(data.resumo);
            } else {
                alert('Erro ao aplicar filtros: ' + (data.message || 'Erro desconhecido.'));
                console.error('API Error:', data);
            }
        })
        .catch(error => {
            if (loadingElement) loadingElement.style.display = 'none';
            console.error('√¢¬ù≈í Erro ao aplicar filtros:', error);
            alert('Erro na requisi√ß√£o de filtros: ' + error.message + '. Verifique o console para mais detalhes.');
        });
}

function atualizarCards(metricas) {
    document.getElementById('total-chamados').textContent = metricas.total_chamados || 0;
    document.getElementById('chamados-concluidos').textContent = metricas.chamados_concluidos || 0;
    document.getElementById('tempo-mediano').textContent = (metricas.tempo_mediano_reparo || 0).toFixed(1) + 'h';
    document.getElementById('disponibilidade').textContent = (metricas.disponibilidade || 0).toFixed(1) + '%';
}

function mostrarFiltrosAtivos() {
    const filtrosAtivosDiv = document.getElementById('filtros-ativos');
    const descricaoFiltros = document.getElementById('descricao-filtros');
    
    const filtrosTexto = [];
    
    // MELHORIA: Descri√ß√£o mais clara dos filtros
    const dataInicio = document.getElementById('data-inicio').value;
    const dataFim = document.getElementById('data-fim').value;
    const periodo = document.getElementById('filtro-periodo').value;
    
    if (dataInicio || dataFim) {
        let textoData = 'Per√É¬≠odo: ';
        if (dataInicio && dataFim) {
            textoData += `${dataInicio} a ${dataFim}`;
        } else if (dataInicio) {
            textoData += `a partir de ${dataInicio}`;
        } else {
            textoData += `at√É¬© ${dataFim}`;
        }
        filtrosTexto.push(textoData);
    } else if (periodo) {
        const periodos = {
            'ultima-semana': '√É≈°ltima Semana',
            'ultimo-mes': '√É≈°ltimo M√É¬™s',
            'ultimos-3-meses': '√É≈°ltimos 3 Meses',
            'ultimos-6-meses': '√É≈°ltimos 6 Meses',
            'ultimo-ano': '√É≈°ltimo Ano',
            'ultimos-2-anos': '√É≈°ltimos 2 Anos',
            'ultimos-5-anos': '√É≈°ltimos 5 Anos',
            'todo-periodo': 'Todo o Per√É¬≠odo'
        };
        filtrosTexto.push(`Per√É¬≠odo: ${periodos[periodo]}`);
    }
    
    Object.keys(filtrosAtivos).forEach(key => {
        if (filtrosAtivos[key] && !['data_inicio', 'data_fim', 'periodo_predefinido'].includes(key)) {
             const nomesFiltros = {
                'equipamento': 'Elevador', // NOVO
                'categoria': 'Categoria',
                'edificio': 'Edif√É¬≠cio',
                'status': 'Status'
            };
            const nomeAmigavel = nomesFiltros[key] || key;
            filtrosTexto.push(`${nomeAmigavel}: ${filtrosAtivos[key]}`);
        }
    });
    
    if (filtrosTexto.length > 0) {
        descricaoFiltros.textContent = filtrosTexto.join(' | ');
        filtrosAtivosDiv.style.display = 'block';
    } else {
        filtrosAtivosDiv.style.display = 'none';
    }
}

function atualizarTabelaResumo(resumo) {
    const container = document.getElementById('tabela-resumo');
    if (!resumo || resumo.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">Nenhum dado encontrado com os filtros aplicados.</p>';
        return;
    }
    
    let html = `
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Categoria</th>
                        <th>Edif√É¬≠cio</th>
                        <th>Equipamento</th> {# NOVO: Coluna adicionada #}
                        <th>Status</th>
                        <th>Data Solicita√ß√£o</th>
                        <th>Tempo Reparo (h)</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    resumo.slice(0, 20).forEach(item => { // Mostra apenas os primeiros 20
        html += `
            <tr>
                <td><span class="badge bg-secondary">${item.categoria_problema}</span></td>
                <td>${item.edificio}</td>
                <td>${item.equipamento || '-'}</td> {# NOVO: Dados do equipamento #}
                <td><span class="badge ${item.status === 'Conclu√É¬≠da' ? 'bg-success' : 'bg-warning'}">${item.status}</span></td>
                <td>${item.data_solicitacao}</td>
                <td>${item.tempo_reparo_horas ? item.tempo_reparo_horas.toFixed(1) : '-'}</td> {# CORRIGIDO: Usar tempo_reparo_horas #}
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        ${resumo.length > 20 ? `<p class="text-muted text-center">Mostrando 20 de ${resumo.length} registros</p>` : ''}
    `;
    
    container.innerHTML = html;
}

function limparFiltrosKPIs() {
    // √∞≈∏‚Äú‚Ä¶ LIMPA TODOS OS FILTROS (incluindo datas)
    document.getElementById('data-inicio').value = '';
    document.getElementById('data-fim').value = '';
    document.getElementById('filtro-periodo').value = '';
    document.getElementById('filtro-status').value = '';
    document.getElementById('filtro-categoria').value = '';
    document.getElementById('filtro-edificio').value = '';
    document.getElementById('filtro-equipamento').value = ''; {# NOVO #}
    
    // Limpa filtros ativos
    filtrosAtivos = {};
    
    // Restaura dados originais
    dadosKPIsFiltrados = dadosKPIsOriginais;
    
    // Atualiza cards
    atualizarCards(dadosKPIsOriginais);
    
    // Recria gr√É¬°ficos
    criarGraficos();
    
    // Esconde indicador de filtros
    document.getElementById('filtros-ativos').style.display = 'none';
    
    // Limpa tabela de resumo
    document.getElementById('tabela-resumo').innerHTML = '<p class="text-muted text-center">Use os filtros acima ou clique nos gr√É¬°ficos para ver dados espec√É¬≠ficos.</p>';
    
    console.log('√∞≈∏¬ß¬π Filtros de KPIs limpos');
}

function atualizarDados() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
    btn.disabled = true;
    
    // Chamada para a API do Blueprint de KPIs para atualizar o cache
    fetch('/v2/kpis/atualizar-kpis', { method: 'POST' })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.message || 'Erro na API');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('Dados de KPIs atualizados!\n' + data.message);
                // Ap√É¬≥s atualizar o cache, recarregar a p√É¬°gina para buscar os novos dados
                location.reload(); 
            } else {
                alert('Erro ao atualizar KPIs: ' + data.message);
            }
        })
        .catch(error => alert('Erro na requisi√ß√£o de atualiza√ß√£o de KPIs: ' + error.message))
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

function debugFiltros() {
    console.log('√∞≈∏‚Äù¬ç DEBUG - Estado atual dos filtros:');
    console.log('   Data in√É¬≠cio:', document.getElementById('data-inicio').value);
    console.log('   Data fim:', document.getElementById('data-fim').value);
    console.log('   Per√É¬≠odo:', document.getElementById('filtro-periodo').value);
    console.log('   Status:', document.getElementById('filtro-status').value);
    console.log('   Categoria:', document.getElementById('filtro-categoria').value);
    console.log('   Edif√É¬≠cio:', document.getElementById('filtro-edificio').value);
    console.log('   Equipamento:', document.getElementById('filtro-equipamento').value);
    console.log('   Filtros ativos:', filtrosAtivos);
    console.log('   Dados originais:', dadosKPIsOriginais);
    console.log('   Dados filtrados:', dadosKPIsFiltrados);
}

</script>
{% endblock %}
--- Fim do cÛdigo: kpis.html ---

--- InÌcio do cÛdigo: base.html ---
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Sistema de Elevadores - TJ/MG{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- CSS customizado -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    {% block extra_head %}{% endblock %}
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard.index') }}">
                <i class="fas fa-building"></i> TJ/MG - Elevadores
            </a>
            
            <div class="navbar-nav ms-auto d-flex align-items-center">
                <a class="nav-link" href="{{ url_for('dashboard.index') }}">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <!-- √∞≈∏‚Ä†‚Ä¢ NOVO BOT√É∆íO KPIs -->
                <a class="nav-link" href="{{ url_for('kpis.index') }}">
                    <i class="fas fa-chart-line"></i> KPIs
                </a>
                <button class="btn btn-outline-light btn-sm ms-2" onclick="atualizarDados()">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
                
                <!-- Informa√ß√É¬µes do usu√É¬°rio logado -->
                {% if usuario_logado %}
                <div class="nav-item dropdown ms-3">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle me-2"></i>
                        <span>{{ usuario_logado }}</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <span class="dropdown-item-text">
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> 
                                    Logado desde {{ login_timestamp[:19] if login_timestamp else 'N/A' }}
                                </small>
                            </span>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}">
                                <i class="fas fa-sign-out-alt"></i> Sair
                            </a>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Mensagens Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'danger' else 'warning' if category == 'warning' else 'info' if category == 'info' else 'success' }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-{{ 'exclamation-triangle' if category in ['danger', 'warning'] else 'info-circle' if category == 'info' else 'check-circle' }}"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Conte√É¬∫do principal -->
    <main class="container-fluid mt-4">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-light text-center py-3 mt-5">
        <div class="container">
            <small class="text-muted">
                Sistema de Mapeamento de Elevadores - Tribunal de Justi√ßa de Minas Gerais
                {% if usuario_logado %}
                    | Usu√É¬°rio: {{ usuario_logado }}
                {% endif %}
            </small>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- √∞≈∏‚Ä†‚Ä¢ JAVASCRIPT GLOBAL PARA FUN√É‚Ä°√É∆íO ATUALIZAR -->
    <script>
    function atualizarDados() {
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
        btn.disabled = true;
        
        // Verifica se estamos na p√É¬°gina de KPIs
        const isKPIsPage = window.location.pathname === '/kpis';
        const endpoint = isKPIsPage ? '/atualizar-kpis' : '/atualizar';
        const tipoAtualizacao = isKPIsPage ? 'KPIs' : 'Dados';
        
        console.log(`√∞≈∏‚Äù‚Äû Atualizando ${tipoAtualizacao} via ${endpoint}`);
        
        fetch(endpoint)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`${tipoAtualizacao} atualizados com sucesso!\n\n${data.message}`);
                    location.reload();
                } else {
                    alert(`Erro ao atualizar ${tipoAtualizacao}:\n${data.message}`);
                }
            })
            .catch(error => {
                console.error('√¢¬ù≈í Erro na requisi√ß√£o:', error);
                alert(`Erro na requisi√ß√£o de ${tipoAtualizacao}. Verifique a conex√£o.`);
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    }
    </script>
    
    {% block extra_scripts %}{% endblock %}
</body>
</html>
--- Fim do cÛdigo: base.html ---

--- InÌcio do cÛdigo: index_nativo.html ---
{% extends "base.html" %}

{% block title %}Dashboard - Sistema de Elevadores TJ/MG{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-building"></i> 
            Sistema de Mapeamento de Elevadores - TJ/MG
        </h1>
    </div>
</div>

{% if erro %}
    <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle"></i> {{ erro }}
    </div>
{% else %}
    <!-- Cards de Estat√É¬≠sticas -->
    <div class="row mb-4 stats-row" id="stats-cards">
        <div class="col-md-2">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-building fa-2x mb-2"></i>
                    <h3 id="stat-predios">{{ stats.total_predios }}</h3>
                    <p class="mb-0">Pr√É¬©dios</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-2">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-elevator fa-2x mb-2"></i>
                    <h3 id="stat-elevadores">{{ stats.total_elevadores }}</h3>
                    <p class="mb-0">Elevadores</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-2">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-map-marker-alt fa-2x mb-2"></i>
                    <h3 id="stat-cidades">{{ stats.cidades }}</h3>
                    <p class="mb-0">Cidades</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-2">
            <div class="card bg-secondary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-map fa-2x mb-2"></i>
                    <h3 id="stat-regioes">{{ stats.regioes }}</h3>
                    <p class="mb-0">Regi√É¬µes</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-2">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <h3 id="stat-ativos">{{ stats.em_atividade }}</h3>
                    <p class="mb-0">Ativos</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-2">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-times-circle fa-2x mb-2"></i>
                    <h3 id="stat-suspensos">{{ stats.suspensos }}</h3>
                    <p class="mb-0">Suspensos</p>
                </div>
            </div>
        </div>

        <div class="col-md-2">
            <div class="card bg-danger text-white">
                 <div class="card-body text-center">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                     <h3 id="stat-parados">{{ stats.elevadores_parados }}</h3>
                     <p class="mb-0">Parados</p>
                 </div>
            </div>
        </div>
    </div>

    <!-- Mapa Nativo -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-map"></i> Mapa Interativo com Filtros</h5>
                    <button class="btn btn-info btn-sm" onclick="atualizarDados()">
                        <i class="fas fa-sync-alt"></i> Atualizar Dados
                    </button>
                </div>
                <div class="card-body p-0" style="position: relative; height: 600px;">
                    <!-- Container do mapa -->
                    <div id="mapa" style="width: 100%; height: 100%;"></div>
                    
                    <!-- Filtros posicionados sobre o mapa -->
                    <div id="filtros-container" style="
                        position: absolute;
                        top: 10px;
                        left: 10px;
                        background: white;
                        padding: 15px;
                        border-radius: 8px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        z-index: 1000;
                        max-width: 300px;
                        max-height: 550px;
                        overflow-y: auto;
                        font-family: Arial, sans-serif;
                        font-size: 14px;
                    ">
                        <h5 style="margin: 0 0 15px 0; color: #333; text-align: center;">√∞≈∏‚Äù¬ç Filtros</h5>

                        <!-- Contador -->
                        <div id="contador-resultados" style="
                            background: #e8f4fd;
                            padding: 10px;
                            border-radius: 6px;
                            margin-bottom: 15px;
                            text-align: center;
                            font-weight: bold;
                            color: #1976d2;
                            border: 2px solid #bbdefb;
                        ">
                            <div>√∞≈∏‚Äú≈† <span id="total-elevadores-filtro">{{ stats.total_elevadores }}</span> elevadores</div>
                            <div style="font-size: 12px; margin-top: 3px;">
                                em <span id="total-locais-filtro">{{ stats.total_predios }}</span> locais
                            </div>
                        </div>

                        <!-- Bot√É¬µes -->
                        <div style="display: flex; gap: 5px; margin-bottom: 15px;">
                            <button onclick="selecionarTodos()" style="
                                flex: 1; padding: 6px; background: #4caf50; color: white;
                                border: none; border-radius: 4px; cursor: pointer;
                                font-size: 12px; font-weight: bold;
                            ">√¢≈ì‚Ä¶ Todos</button>
                            <button onclick="limparFiltros()" style="
                                flex: 1; padding: 6px; background: #f44336; color: white;
                                border: none; border-radius: 4px; cursor: pointer;
                                font-size: 12px; font-weight: bold;
                            ">√∞≈∏‚Äî‚Äò√Ø¬∏¬è Limpar</button>
                        </div>

                        <!-- Filtro por Tipo -->
                        <div style="margin-bottom: 15px; border: 1px solid #e0e0e0; border-radius: 6px; padding: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="font-weight: bold; color: #555;">√∞≈∏‚Äú‚Äπ Tipo</label>
                                <button onclick="toggleCategoria('tipo')" style="background: none; border: none; font-size: 16px; cursor: pointer; color: #666;" id="toggle-tipo">√¢≈æ‚Äì</button>
                            </div>
                            <div id="filtros-tipo" style="max-height: 100px; overflow-y: auto;">
                                {% for tipo in tipos_unicos %}
                                <div style="margin: 5px 0; display: flex; align-items: center;">
                                    <input type="checkbox" id="check-tipo-{{ loop.index }}" value="{{ tipo }}" 
                                           onchange="aplicarFiltros()" style="margin-right: 8px;">
                                    <label for="check-tipo-{{ loop.index }}" style="cursor: pointer; flex: 1; font-size: 13px;">
                                        {{ tipo }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Filtro por Regi√£o -->
                        <div style="margin-bottom: 15px; border: 1px solid #e0e0e0; border-radius: 6px; padding: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="font-weight: bold; color: #555;">√∞≈∏‚Äî¬∫√Ø¬∏¬è Regi√£o</label>
                                <button onclick="toggleCategoria('regiao')" style="background: none; border: none; font-size: 16px; cursor: pointer; color: #666;" id="toggle-regiao">√¢≈æ‚Äì</button>
                            </div>
                            <div id="filtros-regiao" style="max-height: 100px; overflow-y: auto;">
                                {% for regiao in regioes_unicas %}
                                <div style="margin: 5px 0; display: flex; align-items: center;">
                                    <input type="checkbox" id="check-regiao-{{ loop.index }}" value="{{ regiao }}" 
                                           onchange="aplicarFiltros()" style="margin-right: 8px;">
                                    <label for="check-regiao-{{ loop.index }}" style="cursor: pointer; flex: 1; font-size: 13px;">
                                        {{ regiao }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Filtro por Marca -->
                        <div style="margin-bottom: 15px; border: 1px solid #e0e0e0; border-radius: 6px; padding: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="font-weight: bold; color: #555;">√∞≈∏¬è¬≠ Marca</label>
                                <button onclick="toggleCategoria('marca')" style="background: none; border: none; font-size: 16px; cursor: pointer; color: #666;" id="toggle-marca">√¢≈æ‚Äì</button>
                            </div>
                            <div id="filtros-marca" style="max-height: 100px; overflow-y: auto;">
                                {% for marca in marcas_unicas %}
                                <div style="margin: 5px 0; display: flex; align-items: center;">
                                    <input type="checkbox" id="check-marca-{{ loop.index }}" value="{{ marca }}" 
                                           onchange="aplicarFiltros()" style="margin-right: 8px;">
                                    <label for="check-marca-{{ loop.index }}" style="cursor: pointer; flex: 1; font-size: 13px;">
                                        {{ marca }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Filtro por Empresa -->
                        {% if empresas_unicas %}
                        <div style="margin-bottom: 15px; border: 1px solid #e0e0e0; border-radius: 6px; padding: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="font-weight: bold; color: #555;">√∞≈∏¬è¬¢ Empresa</label>
                                <button onclick="toggleCategoria('empresa')" style="background: none; border: none; font-size: 16px; cursor: pointer; color: #666;" id="toggle-empresa">√¢≈æ‚Äì</button>
                            </div>
                            <div id="filtros-empresa" style="max-height: 100px; overflow-y: auto;">
                                {% for empresa in empresas_unicas %}
                                <div style="margin: 5px 0; display: flex; align-items: center;">
                                    <input type="checkbox" id="check-empresa-{{ loop.index }}" value="{{ empresa }}" 
                                           onchange="aplicarFiltros()" style="margin-right: 8px;">
                                    <label for="check-empresa-{{ loop.index }}" style="cursor: pointer; flex: 1; font-size: 13px;">
                                        {{ empresa }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        <!-- Filtro por Situa√ß√£o -->
                        <div style="margin-bottom: 15px; border: 1px solid #e0e0e0; border-radius: 6px; padding: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="font-weight: bold; color: #555;">√¢≈°¬° Situa√ß√£o</label>
                                <button onclick="toggleCategoria('situacao')" style="background: none; border: none; font-size: 16px; cursor: pointer; color: #666;" id="toggle-situacao">√¢≈æ‚Äì</button>
                            </div>
                            <div id="filtros-situacao" style="max-height: 100px; overflow-y: auto;">
                                <div style="margin: 5px 0; display: flex; align-items: center;">
                                    <input type="checkbox" id="check-situacao-1" value="ativos" 
                                           onchange="aplicarFiltros()" style="margin-right: 8px;">
                                    <label for="check-situacao-1" style="cursor: pointer; flex: 1; font-size: 13px;">
                                        √∞≈∏≈∏¬¢ Elevadores Ativos
                                    </label>
                                </div>
                                <div style="margin: 5px 0; display: flex; align-items: center;">
                                    <input type="checkbox" id="check-situacao-2" value="suspensos" 
                                           onchange="aplicarFiltros()" style="margin-right: 8px;">
                                    <label for="check-situacao-2" style="cursor: pointer; flex: 1; font-size: 13px;">
                                        √∞≈∏≈∏¬° Elevadores Suspensos
                                    </label>
                                </div>
                                <div style="margin: 5px 0; display: flex; align-items: center;">
                                    <input type="checkbox" id="check-situacao-3" value="parados" 
                                           onchange="aplicarFiltros()" style="margin-right: 8px;">
                                    <label for="check-situacao-3" style="cursor: pointer; flex: 1; font-size: 13px;">
                                        √∞≈∏‚Äù¬¥ Elevadores Parados
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estat√É¬≠sticas Detalhadas -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Estat√É¬≠sticas Detalhadas</h5>
                </div>
                <div class="card-body">
                    <div id="loading-stats" class="text-center" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Atualizando estat√É¬≠sticas...
                    </div>
                    <div id="stats-detalhadas">
                        <p class="text-muted">Use os filtros no mapa para ver estat√É¬≠sticas espec√É¬≠ficas.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Elevadores Parados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-exclamation-triangle text-danger"></i> Elevadores Parados</h5>
                    <span id="badge-total-parados" class="badge bg-danger">0</span>
                </div>
                <div class="card-body">
                    <div id="loading-elevadores-parados" class="text-center" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Carregando elevadores parados...
                    </div>
                    <div id="lista-elevadores-parados">
                        <p class="text-muted text-center">
                            <i class="fas fa-info-circle"></i> 
                            Use os filtros no mapa para ver elevadores parados espec√É¬≠ficos ou carregue a p√É¬°gina para ver todos.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Dados para JavaScript
const dadosOriginais = {{ geojson_data|safe }};
let dadosFiltrados = dadosOriginais;
let mapa = null;
let layerGroup = null;

console.log('√∞≈∏≈°‚Ç¨ Inicializando mapa nativo...');
console.log('√∞≈∏‚Äú≈† Dados recebidos:', dadosOriginais);

// Armazena valores originais dos stats
window.statsOriginais = {
    'stat-predios': {{ stats.total_predios }},
    'stat-elevadores': {{ stats.total_elevadores }},
    'stat-cidades': {{ stats.cidades }},
    'stat-regioes': {{ stats.regioes }},
    'stat-ativos': {{ stats.em_atividade }},
    'stat-suspensos': {{ stats.suspensos }},
    'stat-parados': {{ stats.elevadores_parados }}
};

// Inicializa o mapa quando a p√É¬°gina carrega
document.addEventListener('DOMContentLoaded', function() {
    console.log('√∞≈∏‚Äú‚Äû DOM carregado, criando mapa...');
    
    // Cria o mapa
    mapa = L.map('mapa').setView([-19.92, -43.92], 6);
    
    // Adiciona tile layer
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '√Ç¬© OpenStreetMap contributors, √Ç¬© CartoDB',
        maxZoom: 19
    }).addTo(mapa);
    
    // Cria grupo de camadas para os marcadores
    layerGroup = L.layerGroup().addTo(mapa);
    
    console.log('√¢≈ì‚Ä¶ Mapa criado com sucesso!');
    
    // Adiciona marcadores iniciais
    adicionarMarcadores(dadosOriginais);
    carregarElevadoresParadosIniciais();
});

// Fun√ß√£o para adicionar marcadores
function adicionarMarcadores(geojson) {
    if (!geojson.features || !layerGroup) {
        console.log('√¢≈°¬†√Ø¬∏¬è Sem features ou layerGroup para adicionar');
        return;
    }
    
    console.log(`√¢≈æ‚Ä¢ Adicionando ${geojson.features.length} marcadores...`);
    
    geojson.features.forEach((feature, index) => {
        const props = feature.properties;
        const coords = feature.geometry.coordinates;
        const latlng = [coords[1], coords[0]]; // Leaflet usa [lat, lng]
        
        // √∞≈∏≈Ω¬® NOVA L√É‚ÄúGICA DE CORES - PRIORIDADE: Parados > Suspensos > Ativos
        let cor = '#6c757d'; // Cinza padr√£o
        
        if (props.temElevadorParado || (props.nElevadorParado && props.nElevadorParado > 0)) {
            cor = '#dc3545'; // √∞≈∏‚Äù¬¥ Vermelho para elevadores parados
        } else if (props.status && props.status.toLowerCase().includes('suspenso')) {
            cor = '#ffc107'; // √∞≈∏≈∏¬° Amarelo para suspensos  
        } else if (props.status && props.status.toLowerCase().includes('atividade')) {
            cor = '#28a745'; // √∞≈∏≈∏¬¢ Verde para ativos
        }
        
        // Define tamanho baseado na quantidade
        const radius = props.qtd_elev >= 5 ? 8 : (props.qtd_elev >= 3 ? 6 : 4);
        
        // Cria o marcador
        const marker = L.circleMarker(latlng, {
            radius: radius,
            fillColor: cor,
            color: cor,
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
        });
        
        // √∞≈∏‚Äú¬ù TOOLTIP ATUALIZADO
        let tooltipText = `${props.cidade} - ${props.tipo}<br/>
            ${props.qtd_elev} elevadores - ${props.marcaLicitacao}<br/>
            ${props.regiao} - ${props.status}`;
        
        if (props.nElevadorParado && props.nElevadorParado > 0) {
            tooltipText += `<br/><strong style="color: #dc3545;">√¢≈°¬†√Ø¬∏¬è ${props.nElevadorParado} parado(s)</strong>`;
        }
        
        marker.bindTooltip(tooltipText, {sticky: true});
        
        // √∞≈∏‚Äú¬ù POPUP ATUALIZADO
        let popupContent = `<div style="font-family: Arial, sans-serif;">
                <h4 style="margin: 0 0 10px 0; color: #333;">${props.unidade}</h4>
                <p><strong>Cidade:</strong> ${props.cidade}</p>
                <p><strong>Endere√ßo:</strong> ${props.endereco}</p>
                <p><strong>Tipo:</strong> ${props.tipo}</p>
                <p><strong>Elevadores:</strong> ${props.qtd_elev}</p>
                <p><strong>Paradas:</strong> ${props.paradas}</p>
                <p><strong>Marca:</strong> ${props.marca}</p>
                <p><strong>Empresa:</strong> ${props.empresa}</p>
                <p><strong>Status:</strong> ${props.status}</p>`;
        
        // √∞≈∏‚Ä†‚Ä¢ ADICIONA INFORMA√É‚Ä°√É‚Ä¢ES DE ELEVADORES PARADOS
        if (props.nElevadorParado && props.nElevadorParado > 0) {
            popupContent += `
                <hr style="margin: 10px 0;">
                <p style="color: #dc3545;"><strong>√¢≈°¬†√Ø¬∏¬è Elevadores Parados:</strong> ${props.nElevadorParado}</p>`;
        }
        if ((props.nElevadorParado && props.nElevadorParado > 0) || props.status && props.status.toLowerCase().includes('suspenso')) {    
            if (props.dataDeParada) {
                popupContent += `<p style="color: #dc3545;"><strong>√∞≈∏‚Äú‚Ä¶ Data da Parada:</strong> ${props.dataDeParada}</p>`;
            }
            
            if (props.previsaoDeRetorno) {
                popupContent += `<p style="color: #dc3545;"><strong>√∞≈∏‚Äù‚Äû Previs√£o de Retorno:</strong> ${props.previsaoDeRetorno}</p>`;
            }
        }
        
        popupContent += '</div>';
        
        marker.bindPopup(popupContent, {maxWidth: 350});
        
        // Adiciona ao grupo de camadas
        layerGroup.addLayer(marker);
        
        if (index < 3) {
            console.log(`√¢≈ì‚Ä¶ Marcador ${index + 1} adicionado: ${props.unidade} (Cor: ${cor})`);
        }
    });
    
    console.log(`√∞≈∏≈Ω‚Ä∞ ${geojson.features.length} marcadores adicionados com sucesso!`);
}

// Fun√ß√£o para obter valores selecionados
function obterSelecionados(categoria) {
    const checkboxes = document.querySelectorAll(`input[id^="check-${categoria}-"]:checked`);
    const valores = Array.from(checkboxes).map(cb => cb.value);
    console.log(`√∞≈∏‚Äù¬ç Filtros selecionados para ${categoria}:`, valores);
    return valores;
}

// Fun√ß√£o para aplicar filtros
// Fun√ß√£o para aplicar filtros - COM SITUA√É‚Ä°√É∆íO
function aplicarFiltros() {
    console.log('√∞≈∏≈Ω¬Ø ========== APLICANDO FILTROS ==========');
    
    const tiposSelecionados = obterSelecionados('tipo');
    const regioesSelecionadas = obterSelecionados('regiao');
    const marcasSelecionadas = obterSelecionados('marca');
    const empresasSelecionadas = obterSelecionados('empresa');
    const situacoesSelecionadas = obterSelecionados('situacao'); // √∞≈∏‚Ä†‚Ä¢ NOVO FILTRO

    console.log('√∞≈∏‚Äú‚Äπ Resumo dos filtros:', {
        tipos: tiposSelecionados,
        regioes: regioesSelecionadas,
        marcas: marcasSelecionadas,
        empresas: empresasSelecionadas,
        situacoes: situacoesSelecionadas // √∞≈∏‚Ä†‚Ä¢ NOVO
    });

    if (!dadosOriginais || !dadosOriginais.features) {
        console.error('√¢¬ù≈í Dados originais n√£o dispon√É¬≠veis');
        return;
    }

    // Filtra os dados
    const featuresOriginal = dadosOriginais.features.length;
    
    dadosFiltrados = {
        ...dadosOriginais,
        features: dadosOriginais.features.filter(feature => {
            const props = feature.properties;
            
            const passaTipo = tiposSelecionados.length === 0 || tiposSelecionados.includes(props.tipo);
            const passaRegiao = regioesSelecionadas.length === 0 || regioesSelecionadas.includes(props.regiao);
            const passaMarca = marcasSelecionadas.length === 0 || marcasSelecionadas.includes(props.marcaLicitacao);
            const passaEmpresa = empresasSelecionadas.length === 0 || empresasSelecionadas.includes(props.empresa);
            
            // √∞≈∏‚Ä†‚Ä¢ NOVA L√É‚ÄúGICA DE FILTRO POR SITUA√É‚Ä°√É∆íO
            let passaSituacao = true;
            if (situacoesSelecionadas.length > 0) {
                passaSituacao = false;
                
                // Verifica cada situa√ß√£o selecionada
                situacoesSelecionadas.forEach(situacao => {
                    if (situacao === 'ativos') {
                        // Ativos: status ativo E sem elevadores parados
                        if (props.status && props.status.toLowerCase().includes('atividade') && 
                            (!props.nElevadorParado || props.nElevadorParado === 0)) {
                            passaSituacao = true;
                        }
                    } else if (situacao === 'suspensos') {
                        // Suspensos: status suspenso
                        if (props.status && props.status.toLowerCase().includes('suspenso')) {
                            passaSituacao = true;
                        }
                    } else if (situacao === 'parados') {
                        // Parados: tem elevadores parados
                        if (props.nElevadorParado && props.nElevadorParado > 0) {
                            passaSituacao = true;
                        }
                    }
                });
            }
            
            return passaTipo && passaRegiao && passaMarca && passaEmpresa && passaSituacao;
        })
    };

    const featuresFiltradas = dadosFiltrados.features.length;
    console.log(`√∞≈∏‚Äú≈† Filtragem conclu√É¬≠da: ${featuresOriginal} √¢‚Ä†‚Äô ${featuresFiltradas} features`);

    // Atualiza o mapa
    atualizarMapa();
    
    // Atualiza contador
    atualizarContadorFiltros();
    
    // Atualiza estat√É¬≠sticas
    atualizarEstatisticasDashboard();
    
    console.log('√¢≈ì‚Ä¶ ========== FILTROS APLICADOS ==========');
}

// Fun√ß√£o para atualizar o mapa
function atualizarMapa() {
    console.log('√∞≈∏‚Äî¬∫√Ø¬∏¬è ========== ATUALIZANDO MAPA ==========');
    
    if (!layerGroup) {
        console.error('√¢¬ù≈í LayerGroup n√£o dispon√É¬≠vel');
        return;
    }

    // Limpa todos os marcadores
    layerGroup.clearLayers();
    console.log('√∞≈∏¬ß¬π Marcadores removidos');

    // Adiciona novos marcadores filtrados
    adicionarMarcadores(dadosFiltrados);
    
    console.log('√¢≈ì‚Ä¶ ========== MAPA ATUALIZADO ==========');
}

// Fun√ß√£o para atualizar contador
function atualizarContadorFiltros() {
    if (!dadosFiltrados.features) return;
    
    const totalElevadores = dadosFiltrados.features.reduce((total, feature) => {
        return total + feature.properties.qtd_elev;
    }, 0);

    const totalLocais = dadosFiltrados.features.length;

    const elemElevadores = document.getElementById('total-elevadores-filtro');
    const elemLocais = document.getElementById('total-locais-filtro');
    
    if (elemElevadores) elemElevadores.textContent = totalElevadores;
    if (elemLocais) elemLocais.textContent = totalLocais;

    const contadorElement = document.getElementById('contador-resultados');
    if (contadorElement) {
        if (totalElevadores === 0) {
            contadorElement.style.background = '#ffebee';
            contadorElement.style.color = '#c62828';
            contadorElement.style.borderColor = '#ef9a9a';
        } else {
            contadorElement.style.background = '#e8f5e8';
            contadorElement.style.color = '#2e7d32';
            contadorElement.style.borderColor = '#a5d6a7';
        }
    }
    
    console.log(`√Ø¬ø¬Ω√Ø¬ø¬Ω Contador atualizado: ${totalElevadores} elevadores em ${totalLocais} locais`);
}

// Fun√ß√£o para atualizar estat√É¬≠sticas da dashboard - COM SITUA√É‚Ä°√É∆íO
function atualizarEstatisticasDashboard() {
    const tiposSelecionados = obterSelecionados('tipo');
    const regioesSelecionadas = obterSelecionados('regiao');
    const marcasSelecionadas = obterSelecionados('marca');
    const empresasSelecionadas = obterSelecionados('empresa');
    const situacoesSelecionadas = obterSelecionados('situacao'); // √∞≈∏‚Ä†‚Ä¢ NOVO

    // Se nenhum filtro ativo, limpa todos os filtros
    if (tiposSelecionados.length === 0 && regioesSelecionadas.length === 0 && 
        marcasSelecionadas.length === 0 && empresasSelecionadas.length === 0 &&
        situacoesSelecionadas.length === 0) { // √∞≈∏‚Ä†‚Ä¢ INCLUIR NOVO FILTRO
        console.log('√¢¬è¬≠√Ø¬∏¬è Nenhum filtro ativo, limpando todos os filtros');
        limparFiltros();
        return;
    }

    // Monta par√É¬¢metros
    const params = new URLSearchParams();
    tiposSelecionados.forEach(tipo => params.append('tipo', tipo));
    regioesSelecionadas.forEach(regiao => params.append('regiao', regiao));
    marcasSelecionadas.forEach(marca => params.append('marca', marca));
    empresasSelecionadas.forEach(empresa => params.append('empresa', empresa));
    situacoesSelecionadas.forEach(situacao => params.append('situacao', situacao)); // √∞≈∏‚Ä†‚Ä¢ NOVO

    console.log('√∞≈∏‚Äú¬° Fazendo requisi√ß√£o para API...');

    // ... resto da fun√ß√£o permanece igual
    // Mostra loading
    const loadingElement = document.getElementById('loading-stats');
    if (loadingElement) loadingElement.style.display = 'block';

    // Faz requisi√ß√£o
    fetch('/api/filtrar?' + params.toString())
        .then(response => response.json())
        .then(data => {
            if (loadingElement) loadingElement.style.display = 'none';
            
            console.log('√∞≈∏‚Äú¬° Resposta da API:', data);
            
            if (data.success) {
                // Atualiza cards
                const elementos = {
                    'stat-predios': data.stats.total_predios,
                    'stat-elevadores': data.stats.total_elevadores,
                    'stat-cidades': data.stats.cidades,
                    'stat-regioes': data.stats.regioes,
                    'stat-ativos': data.stats.em_atividade,
                    'stat-suspensos': data.stats.suspensos,
                    'stat-parados':data.stats.elevadores_parados
                };
                
                for (let id in elementos) {
                    const elem = document.getElementById(id);
                    if (elem) {
                        elem.textContent = elementos[id];
                        console.log(`√∞≈∏‚Äú≈† Card ${id} atualizado para:`, elementos[id]);
                    }
                }
                // √¢≈ì‚Ä¶ Sincroniza contador dos filtros com os mesmos valores da API
                const elemLocaisFiltro = document.getElementById('total-locais-filtro');
                const elemElevadoresFiltro = document.getElementById('total-elevadores-filtro');

                if (elemLocaisFiltro) elemLocaisFiltro.textContent = data.stats.total_predios;
                if (elemElevadoresFiltro) elemElevadoresFiltro.textContent = data.stats.total_elevadores;

                // Atualiza estat√É¬≠sticas detalhadas
                mostrarEstatisticasDetalhadas(data.stats);
                atualizarElevadoresParados();
            }
        })
        .catch(error => {
            if (loadingElement) loadingElement.style.display = 'none';
            console.error('√¢¬ù≈í Erro ao carregar estat√É¬≠sticas:', error);
        });
}

// Fun√ß√£o para mostrar estat√É¬≠sticas detalhadas
function mostrarEstatisticasDetalhadas(stats) {
    const container = document.getElementById('stats-detalhadas');
    if (!container) return;
    
    let html = '<div class="row">';
    
    const categorias = [
        {titulo: 'Por Tipo', dados: stats.por_tipo},
        {titulo: 'Por Regi√£o', dados: stats.por_regiao},
        {titulo: 'Por Marca', dados: stats.por_marca},
        {titulo: 'Por Status', dados: stats.por_status}
    ];
    
    categorias.forEach(categoria => {
        html += `<div class="col-md-3"><h6>${categoria.titulo}</h6><ul class="list-unstyled">`;
        for (let [key, value] of Object.entries(categoria.dados)) {
            html += `<li><strong>${key}:</strong> ${value}</li>`;
        }
        html += '</ul></div>';
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Fun√ß√É¬µes auxiliares
function limparFiltros() {
    console.log('√∞≈∏¬ß¬π Limpando todos os filtros...');
    
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    
    dadosFiltrados = dadosOriginais;
    atualizarMapa();
    atualizarContadorFiltros();
    
    // Restaura valores originais dos cards
    const valoresOriginais = window.statsOriginais || {};
    for (let id in valoresOriginais) {
        const elem = document.getElementById(id);
        if (elem) elem.textContent = valoresOriginais[id];
    }
    
    // √¢≈ì‚Ä¶ Sincroniza contador de filtros com valores originais
    const elemLocaisFiltro = document.getElementById('total-locais-filtro');
    const elemElevadoresFiltro = document.getElementById('total-elevadores-filtro');

    if (elemLocaisFiltro) elemLocaisFiltro.textContent = valoresOriginais['stat-predios'];
    if (elemElevadoresFiltro) elemElevadoresFiltro.textContent = valoresOriginais['stat-elevadores'];

    const statsContainer = document.getElementById('stats-detalhadas');
    if (statsContainer) {
        statsContainer.innerHTML = '<p class="text-muted">Use os filtros no mapa para ver estat√É¬≠sticas espec√É¬≠ficas.</p>';
    }
    
    console.log('√¢≈ì‚Ä¶ Filtros limpos');
    carregarElevadoresParadosIniciais();
}

function selecionarTodos() {
    console.log('√¢≈ì‚Ä¶ Selecionando todos os filtros...');
    
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = true);
    aplicarFiltros();
}

function toggleCategoria(categoria) {
    const div = document.getElementById(`filtros-${categoria}`);
    const button = document.getElementById(`toggle-${categoria}`);

    if (div && button) {
        if (div.style.display === 'none') {
            div.style.display = 'block';
            button.textContent = '√¢≈æ‚Äì';
        } else {
            div.style.display = 'none';
            button.textContent = '√¢≈æ‚Ä¢';
        }
    }
}

function atualizarDados() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
    btn.disabled = true;
    
    // Verifica se estamos na p√É¬°gina de KPIs
    const isKPIsPage = window.location.pathname === '/kpis';
    const endpoint = isKPIsPage ? '/atualizar-kpis' : '/atualizar';
    
    fetch(endpoint)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert((isKPIsPage ? 'KPIs' : 'Dados') + ' atualizados!\n' + data.message);
                location.reload();
            } else {
                alert('Erro: ' + data.message);
            }
        })
        .catch(error => {
            alert('Erro na requisi√ß√£o');
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}
// ========== FUN√É‚Ä°√É‚Ä¢ES PARA ELEVADORES PARADOS ==========

// Fun√ß√£o para carregar elevadores parados iniciais
function carregarElevadoresParadosIniciais() {
    console.log('√∞≈∏‚Äù¬¥ Carregando elevadores parados iniciais...');
    
    if (!dadosOriginais || !dadosOriginais.features) {
        console.log('√¢≈°¬†√Ø¬∏¬è Dados n√£o dispon√É¬≠veis para elevadores parados');
        return;
    }
    
    const elevadoresParados = [];
    
    dadosOriginais.features.forEach(feature => {
        const props = feature.properties;
        if (props.nElevadorParado && props.nElevadorParado > 0) {
            elevadoresParados.push({
                cidade: props.cidade,
                unidade: props.unidade,
                tipo: props.tipo,
                quantidade: props.nElevadorParado,
                empresa: props.empresa,
                dataDeParada: props.dataDeParada,
                previsaoDeRetorno: props.previsaoDeRetorno,
                qtd_total_elevadores: props.qtd_elev
            });
        }
    });
    
    // Ordena por cidade e unidade
    elevadoresParados.sort((a, b) => {
        if (a.cidade !== b.cidade) return a.cidade.localeCompare(b.cidade);
        return a.unidade.localeCompare(b.unidade);
    });
    
    console.log(`√∞≈∏‚Äù¬¥ ${elevadoresParados.length} elevadores parados encontrados inicialmente`);
    
    mostrarElevadoresParados(elevadoresParados);
}

// Fun√ß√£o para atualizar elevadores parados via API
function atualizarElevadoresParados() {
    const tiposSelecionados = obterSelecionados('tipo');
    const regioesSelecionadas = obterSelecionados('regiao');
    const marcasSelecionadas = obterSelecionados('marca');
    const empresasSelecionadas = obterSelecionados('empresa');
    const situacoesSelecionadas = obterSelecionados('situacao');

    // Se nenhum filtro ativo, usa dados iniciais
    if (tiposSelecionados.length === 0 && regioesSelecionadas.length === 0 && 
        marcasSelecionadas.length === 0 && empresasSelecionadas.length === 0 &&
        situacoesSelecionadas.length === 0) {
        console.log('√¢¬è¬≠√Ø¬∏¬è Nenhum filtro ativo, usando dados iniciais de elevadores parados');
        carregarElevadoresParadosIniciais();
        return;
    }

    // Monta par√É¬¢metros
    const params = new URLSearchParams();
    tiposSelecionados.forEach(tipo => params.append('tipo', tipo));
    regioesSelecionadas.forEach(regiao => params.append('regiao', regiao));
    marcasSelecionadas.forEach(marca => params.append('marca', marca));
    empresasSelecionadas.forEach(empresa => params.append('empresa', empresa));
    situacoesSelecionadas.forEach(situacao => params.append('situacao', situacao));

    console.log('√∞≈∏‚Äú¬° Fazendo requisi√ß√£o para API de elevadores parados...');

    // Mostra loading
    const loadingElement = document.getElementById('loading-elevadores-parados');
    if (loadingElement) loadingElement.style.display = 'block';

    // Faz requisi√ß√£o
    fetch('/api/elevadores-parados?' + params.toString())
        .then(response => response.json())
        .then(data => {
            if (loadingElement) loadingElement.style.display = 'none';
            
            console.log('√∞≈∏‚Äú¬° Resposta da API elevadores parados:', data);
            
            if (data.success) {
                mostrarElevadoresParados(data.elevadores_parados);
            }
        })
        .catch(error => {
            if (loadingElement) loadingElement.style.display = 'none';
            console.error('√¢¬ù≈í Erro ao carregar elevadores parados:', error);
        });
}

// Fun√ß√£o para exibir lista de elevadores parados
function mostrarElevadoresParados(elevadoresParados) {
    const container = document.getElementById('lista-elevadores-parados');
    const badge = document.getElementById('badge-total-parados');
    
    if (!container) return;
    
    // Atualiza badge com total
    if (badge) {
        badge.textContent = elevadoresParados.length;
    }
    
    if (elevadoresParados.length === 0) {
        container.innerHTML = `
            <div class="alert alert-success text-center">
                <i class="fas fa-check-circle"></i>
                <strong>√É‚Äútimas not√É¬≠cias!</strong> Nenhum elevador parado encontrado com os filtros aplicados.
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>${elevadoresParados.length} elevador(es) parado(s)</strong> encontrado(s) com os filtros aplicados.
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th><i class="fas fa-map-marker-alt"></i> Cidade</th>
                        <th><i class="fas fa-building"></i> Unidade</th>
                        <th><i class="fas fa-elevator"></i> Tipo</th>
                        <th><i class="fas fa-hashtag"></i> Parados</th>
                        <th><i class="fas fa-industry"></i> Empresa</th>
                        <th><i class="fas fa-calendar-times"></i> Data Parada</th>
                        <th><i class="fas fa-calendar-check"></i> Previs√£o Retorno</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    elevadoresParados.forEach((elevador, index) => {
        const dataParada = elevador.dataDeParada || '<span class="text-muted">-</span>';
        const previsaoRetorno = elevador.previsaoDeRetorno || '<span class="text-muted">-</span>';
        
        // √¢≈ì‚Ä¶ VERS√É∆íO MELHORADA
        const tipoLimpo = elevador.tipo.toLowerCase().trim();
        const badgeColor = tipoLimpo === "montacarga" ? "bg-secondary":
                        tipoLimpo === "passageiro" ? "bg-info":
                        tipoLimpo === "plataforma" ? "bg-success":
                        "bg-primary";
        
        html += `
            <tr>
                <td><strong>${elevador.cidade}</strong></td>
                <td>${elevador.unidade}</td>
                <td>
                    <span class="badge ${badgeColor}">${elevador.tipo}</span>
                </td>
                <td>
                    <span class="badge bg-danger">${elevador.quantidade}</span>
                    <small class="text-muted d-block">de ${elevador.qtd_total_elevadores} total</small>
                </td>
                <td>${elevador.empresa}</td>
                <td>${dataParada}</td>
                <td>${previsaoRetorno}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div class="mt-3">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i>
                Lista atualizada automaticamente conforme os filtros aplicados no mapa.
            </small>
        </div>
    `;
    
    container.innerHTML = html;
    
    console.log(`√¢≈ì‚Ä¶ Lista de elevadores parados atualizada: ${elevadoresParados.length} itens`);
}
</script>
{% endblock %}
--- Fim do cÛdigo: index_nativo.html ---

--- InÌcio do cÛdigo: kpis.html ---
{% extends "base.html" %}

{% block title %}KPIs de Manuten√ß√£o - Sistema de Elevadores TJ/MG{% endblock %}

{% block extra_head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-chart-line"></i> 
            KPIs de Manuten√ß√£o - Elevadores TJ/MG
        </h1>
    </div>
</div>

{% if erro %}
    <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle"></i> {{ erro }}
    </div>
{% else %}
    <!-- Filtros Avan√ßados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-filter"></i> Filtros</h5>
                    <div>
                        <button class="btn btn-success btn-sm me-2" onclick="aplicarFiltros()">
                            <i class="fas fa-search"></i> Aplicar Filtros
                        </button>
                        <button class="btn btn-secondary btn-sm me-2" onclick="limparFiltrosKPIs()">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                        <button class="btn btn-info btn-sm" onclick="atualizarDados()">
                            <i class="fas fa-sync-alt"></i> Atualizar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Primeira linha: Filtros de Data -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-calendar"></i> Data de In√É¬≠cio</label>
                            <input type="date" class="form-control" id="data-inicio">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-calendar"></i> Data de Fim</label>
                            <input type="date" class="form-control" id="data-fim">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><i class="fas fa-clock"></i> Per√É¬≠odo Predefinido</label>
                            <select class="form-select" id="filtro-periodo" onchange="selecionarPeriodoPredefinido()">
                                <option value="">Selecione um per√É¬≠odo...</option>
                                <option value="ultima-semana">√É≈°ltima Semana</option>
                                <option value="ultimo-mes">√É≈°ltimo M√É¬™s</option>
                                <option value="ultimos-3-meses">√É≈°ltimos 3 Meses</option>
                                <option value="ultimos-6-meses">√É≈°ltimos 6 Meses</option>
                                <option value="ultimo-ano">√É≈°ltimo Ano</option>
                                <option value="ultimos-2-anos">√É≈°ltimos 2 Anos</option>
                                <option value="ultimos-5-anos">√É≈°ltimos 5 Anos</option>
                                <option value="todo-periodo">Todo o Per√É¬≠odo</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Segunda linha: Outros filtros -->
                    <div class="row">
                        <!-- Filtro por Status -->
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-tasks"></i> Status</label>
                            <select class="form-select" id="filtro-status">
                                <option value="">Todos os status</option>
                                <option value="Conclu√É¬≠da">Conclu√É¬≠da</option>
                                <option value="Confirmada">Confirmada</option>
                            </select>
                        </div>
                        
                        <!-- Filtro por Categoria -->
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-tags"></i> Categoria</label>
                            <select class="form-select" id="filtro-categoria">
                                <option value="">Todas as categorias</option>
                                <!-- Preenchido dinamicamente via JavaScript -->
                            </select>
                        </div>
                        
                        <!-- Filtro por Edif√É¬≠cio -->
                        <div class="col-md-6">
                            <label class="form-label"><i class="fas fa-building"></i> Edif√É¬≠cio</label>
                            <select class="form-select" id="filtro-edificio">
                                <option value="">Todos os edif√É¬≠cios</option>
                                <!-- Preenchido dinamicamente via JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards de KPIs Principais -->
    <div class="row mb-4" id="kpis-cards">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                    <h3 id="total-chamados">{{ metricas.total_chamados or 0 }}</h3>
                    <p class="mb-0">Total de Chamados</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <h3 id="chamados-concluidos">{{ metricas.chamados_concluidos or 0 }}</h3>
                    <p class="mb-0">Chamados Conclu√É¬≠dos</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h3 id="tempo-mediano">{{ "%.1f"|format(metricas.tempo_mediano_reparo or 0) }}h</h3>
                    <p class="mb-0">Tempo Mediano de Reparo</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-percentage fa-2x mb-2"></i>
                    <h3 id="disponibilidade">{{ "%.1f"|format(metricas.disponibilidade or 0) }}%</h3>
                    <p class="mb-0">Taxa de Conclus√£o</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Indicador de Filtros Ativos -->
    <div class="row mb-3" id="filtros-ativos" style="display: none;">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-filter"></i> 
                <strong>Filtros ativos:</strong> 
                <span id="descricao-filtros"></span>
                <button class="btn btn-sm btn-outline-primary ms-2" onclick="limparFiltrosKPIs()">
                    <i class="fas fa-times"></i> Remover filtros
                </button>
            </div>
        </div>
    </div>

    <!-- Gr√É¬°ficos -->
    <div class="row">
        <!-- Gr√É¬°fico de Chamados por M√É¬™s -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> Chamados por M√É¬™s</h5>
                    <small class="text-muted">Clique nos pontos para filtrar por m√É¬™s</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-chamados-mes" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Gr√É¬°fico de Categorias de Problema -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-pie"></i> Categorias de Problemas</h5>
                    <small class="text-muted">Clique nas fatias para filtrar por categoria</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-categorias" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Gr√É¬°fico de Edif√É¬≠cios Mais Problem√É¬°ticos -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Edif√É¬≠cios com Mais Chamados</h5>
                    <small class="text-muted">Clique nas barras para filtrar por edif√É¬≠cio</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-edificios" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Gr√É¬°fico de Tempo por Categoria -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-stopwatch"></i> Tempo Mediano por Categoria</h5>
                    <small class="text-muted">Clique nas barras para filtrar por categoria</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-tempo-categoria" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- √∞≈∏‚Ä†‚Ä¢ NOVA SE√É‚Ä°√É∆íO: Gr√É¬°ficos de Elevadores -->
    <div class="row">
        <!-- Gr√É¬°fico de Chamados por Elevador -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-elevator"></i> Chamados por Elevador</h5>
                    <small class="text-muted">Clique nas barras para filtrar por elevador espec√É¬≠fico</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-chamados-elevador" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Gr√É¬°fico de Tempo Mediano por Elevador -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clock"></i> Tempo Mediano de Atendimento por Elevador</h5>
                    <small class="text-muted">Clique nas barras para filtrar por elevador espec√É¬≠fico</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-tempo-elevador" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Resumo Filtrado -->
    <div class="row">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-table"></i> Resumo dos Dados Filtrados</h5>
            </div>
            <div class="card-body">
                <div id="loading-resumo" class="text-center" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Carregando dados...
                </div>
                <div id="tabela-resumo">
                    <p class="text-muted text-center">Use os filtros acima ou clique nos gr√É¬°ficos para ver dados espec√É¬≠ficos.</p>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<script>
// Dados para JavaScript
const dadosKPIsOriginais = {{ metricas|tojson|safe }};
let dadosKPIsFiltrados = dadosKPIsOriginais;
let graficos = {};
let filtrosAtivos = {};

console.log('√∞≈∏‚Äú≈† Dados de KPIs recebidos:', dadosKPIsOriginais);

// Inicializa gr√É¬°ficos quando a p√É¬°gina carrega
document.addEventListener('DOMContentLoaded', function() {
    console.log('√∞≈∏‚Äú‚Äû DOM carregado, criando gr√É¬°ficos de KPIs...');
    preencherFiltros();
    criarGraficos();
});

function preencherFiltros() {
    // Preenche filtro de categorias
    const selectCategoria = document.getElementById('filtro-categoria');
    const categorias = Object.keys(dadosKPIsOriginais.categorias_problema || {});
    categorias.forEach(categoria => {
        const option = document.createElement('option');
        option.value = categoria;
        option.textContent = categoria;
        selectCategoria.appendChild(option);
    });
    
    // Preenche filtro de edif√É¬≠cios
    const selectEdificio = document.getElementById('filtro-edificio');
    const edificios = Object.keys(dadosKPIsOriginais.chamados_por_edificio || {});
    edificios.forEach(edificio => {
        const option = document.createElement('option');
        option.value = edificio;
        option.textContent = edificio.length > 50 ? edificio.substring(0, 50) + '...' : edificio;
        selectEdificio.appendChild(option);
    });
}

// √∞≈∏‚Äú‚Ä¶ NOVA FUN√É‚Ä°√É∆íO: Selecionar per√É¬≠odo predefinido
function selecionarPeriodoPredefinido() {
    const periodo = document.getElementById('filtro-periodo').value;
    
    if (periodo && periodo !== 'todo-periodo') {
        // Limpa datas personalizadas quando seleciona per√É¬≠odo predefinido
        document.getElementById('data-inicio').value = '';
        document.getElementById('data-fim').value = '';
    }
    
    console.log('√∞≈∏‚Äú‚Ä¶ Per√É¬≠odo predefinido selecionado:', periodo);
}

function criarGraficos() {
    // Destroi gr√É¬°ficos existentes
    Object.values(graficos).forEach(grafico => {
        if (grafico) grafico.destroy();
    });
    
    // Cria novos gr√É¬°ficos
    criarGraficoChamadosPorMes();
    criarGraficoCategorias();
    criarGraficoEdificios();
    criarGraficoTempoPorCategoria();
    
    // √∞≈∏‚Ä†‚Ä¢ NOVOS GR√É¬ÅFICOS DE ELEVADORES
    criarGraficoChamadosPorElevador();
    criarGraficoTempoMedianoPorElevador();
}

function criarGraficoChamadosPorMes() {
    const ctx = document.getElementById('grafico-chamados-mes');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.chamados_por_mes || {};
    const labels = Object.keys(dados).sort();
    const values = labels.map(label => dados[label]);
    
    graficos.chamadosMes = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Chamados',
                data: values,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#007bff',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const mesAno = labels[index];
                    filtrarPorMes(mesAno);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

function criarGraficoCategorias() {
    const ctx = document.getElementById('grafico-categorias');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.categorias_problema || {};
    
    // √∞≈∏‚Äù‚Äû ORDENA√É‚Ä°√É∆íO DECRESCENTE
    const entries = Object.entries(dados).sort((a, b) => b[1] - a[1]);
    const labels = entries.map(entry => entry[0]);
    const values = entries.map(entry => entry[1]);
    
    const cores = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
    ];
    
    graficos.categorias = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: cores.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff',
                hoverBorderWidth: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const categoria = labels[index];
                    filtrarPorCategoria(categoria);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// √∞≈∏‚Äù‚Äû MODIFICADO: Gr√É¬°fico de Edif√É¬≠cios com ordena√ß√£o decrescente garantida
function criarGraficoEdificios() {
    const ctx = document.getElementById('grafico-edificios');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.chamados_por_edificio || {};
    
    // √∞≈∏‚Äù‚Äû ORDENA√É‚Ä°√É∆íO DECRESCENTE EXPL√É¬çCITA (garantindo que funcione mesmo se backend n√£o ordenar)
    const entries = Object.entries(dados)
        .sort((a, b) => b[1] - a[1])  // Ordena por valor decrescente
        .slice(0, 10); // Top 10
    
    const labels = entries.map(entry => entry[0]);
    const values = entries.map(entry => entry[1]);
    
    console.log('√∞≈∏¬è¬¢ Dados de edif√É¬≠cios ordenados:', entries);
    
    graficos.edificios = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels.map(label => label.length > 20 ? label.substring(0, 20) + '...' : label),
            datasets: [{
                label: 'Chamados',
                data: values,
                backgroundColor: '#28a745',
                borderColor: '#1e7e34',
                borderWidth: 1,
                hoverBackgroundColor: '#34ce57'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const edificio = labels[index];
                    filtrarPorEdificio(edificio);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// √∞≈∏‚Äù‚Äû MODIFICADO: Gr√É¬°fico de Tempo por Categoria com ordena√ß√£o decrescente garantida
function criarGraficoTempoPorCategoria() {
    const ctx = document.getElementById('grafico-tempo-categoria');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.tempo_por_categoria || {};
    
    // √∞≈∏‚Äù‚Äû ORDENA√É‚Ä°√É∆íO DECRESCENTE EXPL√É¬çCITA (garantindo que funcione mesmo se backend n√£o ordenar)
    const entries = Object.entries(dados)
        .sort((a, b) => b[1] - a[1]); // Ordena por valor decrescente
    
    const labels = entries.map(entry => entry[0]);
    const values = entries.map(entry => Math.round(entry[1] * 10) / 10);
    
    console.log('√¢¬è¬±√Ø¬∏¬è Dados de tempo por categoria ordenados:', entries);
    
    graficos.tempoCategoria = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tempo Mediano (horas)',
                data: values,
                backgroundColor: '#ffc107',
                borderColor: '#e0a800',
                borderWidth: 1,
                hoverBackgroundColor: '#ffcd39'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + 'h';
                        }
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const categoria = labels[index];
                    filtrarPorCategoria(categoria);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// √∞≈∏‚Ä†‚Ä¢ NOVO: Gr√É¬°fico de Chamados por Elevador
function criarGraficoChamadosPorElevador() {
    const ctx = document.getElementById('grafico-chamados-elevador');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.chamados_por_equipamento || {};
    
    // Ordena√ß√£o decrescente e limita√ß√£o aos top 15 elevadores
    const entries = Object.entries(dados)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 15); // Top 15 elevadores
    
    const labels = entries.map(entry => String(entry[0]));
    const values = entries.map(entry => entry[1]);
    
    console.log('√∞≈∏¬è‚Äî√Ø¬∏¬è Dados de chamados por elevador ordenados:', entries);
    
    graficos.chamadosElevador = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Chamados',
                data: values,
                backgroundColor: '#007bff',
                borderColor: '#0056b3',
                borderWidth: 1,
                hoverBackgroundColor: '#0056b3'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return 'Elevador: ' + context[0].label;
                        },
                        label: function(context) {
                            return 'Chamados: ' + context.parsed.y;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        font: {
                            size: 10
                        }
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const elevador = String(labels[index]);
                    filtrarPorElevador(elevador);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// √∞≈∏‚Ä†‚Ä¢ NOVO: Gr√É¬°fico de Tempo Mediano por Elevador
function criarGraficoTempoMedianoPorElevador() {
    const ctx = document.getElementById('grafico-tempo-elevador');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.tempo_por_equipamento || {};
    
    // Ordena√ß√£o decrescente e limita√ß√£o aos top 15 elevadores
    const entries = Object.entries(dados)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 15); // Top 15 elevadores
    
    const labels = entries.map(entry => String(entry[0]));
    const values = entries.map(entry => Math.round(entry[1] * 10) / 10);
    
    console.log('√¢¬è¬∞ Dados de tempo por elevador ordenados:', entries);
    
    graficos.tempoElevador = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tempo Mediano (horas)',
                data: values,
                backgroundColor: '#17a2b8',
                borderColor: '#138496',
                borderWidth: 1,
                hoverBackgroundColor: '#138496'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return 'Elevador: ' + context[0].label;
                        },
                        label: function(context) {
                            return 'Tempo Mediano: ' + context.parsed.y + 'h';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + 'h';
                        }
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        font: {
                            size: 10
                        }
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const elevador = String(labels[index]);
                    filtrarPorElevador(elevador);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// Fun√ß√É¬µes de filtro por clique nos gr√É¬°ficos
function filtrarPorMes(mesAno) {
    console.log('√∞≈∏‚Äú‚Ä¶ Filtrando por m√É¬™s:', mesAno);
    filtrosAtivos.mes = mesAno;
    aplicarFiltrosInterativos();
}

function filtrarPorCategoria(categoria) {
    console.log('√∞≈∏¬è¬∑√Ø¬∏¬è Filtrando por categoria:', categoria);
    document.getElementById('filtro-categoria').value = categoria;
    filtrosAtivos.categoria = categoria;
    aplicarFiltrosInterativos();
}

function filtrarPorEdificio(edificio) {
    console.log('√∞≈∏¬è¬¢ Filtrando por edif√É¬≠cio:', edificio);
    document.getElementById('filtro-edificio').value = edificio;
    filtrosAtivos.edificio = edificio;
    aplicarFiltrosInterativos();
}

// √∞≈∏‚Ä†‚Ä¢ NOVA FUN√É‚Ä°√É∆íO: Filtrar por elevador espec√É¬≠fico
function filtrarPorElevador(elevador) {
    console.log('√∞≈∏¬è‚Äî√Ø¬∏¬è Filtrando por elevador:', elevador);
    filtrosAtivos.equipamento = elevador;
    aplicarFiltrosInterativos();
}

function aplicarFiltros() {
    const dataInicio = document.getElementById('data-inicio').value;
    const dataFim = document.getElementById('data-fim').value;
    const periodo = document.getElementById('filtro-periodo').value;
    const status = document.getElementById('filtro-status').value;
    const categoria = document.getElementById('filtro-categoria').value;
    const edificio = document.getElementById('filtro-edificio').value;
    
    console.log('√∞≈∏‚Äù¬ç Aplicando filtros:', {
        dataInicio, dataFim, periodo, status, categoria, edificio
    });
    
    // √∞≈∏‚Äú‚Ä¶ VALIDA√É‚Ä°√É∆íO DE DATAS
    if (dataInicio && dataFim && new Date(dataInicio) > new Date(dataFim)) {
        alert('A data de in√É¬≠cio n√£o pode ser posterior √É¬† data de fim.');
        return;
    }
    
    // √∞≈∏‚Ä†‚Ä¢ MAPEAMENTO CORRETO DOS PAR√É‚ÄöMETROS
    filtrosAtivos = {
        data_inicio: dataInicio,
        data_fim: dataFim,
        periodo_predefinido: periodo,
        status: status,
        categoria: categoria,
        edificio: edificio
    };
    
    // Remove filtros vazios
    Object.keys(filtrosAtivos).forEach(key => {
        if (!filtrosAtivos[key]) {
            delete filtrosAtivos[key];
        }
    });
    
    console.log('√∞≈∏‚Äù¬ß Filtros ativos ap√É¬≥s limpeza:', filtrosAtivos);
    
    aplicarFiltrosInterativos();
}

function aplicarFiltrosInterativos() {
    console.log('√∞≈∏‚Äù¬ç Aplicando filtros:', filtrosAtivos);
    
    // Monta par√É¬¢metros para API
    const params = new URLSearchParams();
    Object.keys(filtrosAtivos).forEach(key => {
        if (filtrosAtivos[key]) {
            params.append(key, filtrosAtivos[key]);
        }
    });
    
    // Mostra loading
    const loadingElement = document.getElementById('loading-resumo');
    if (loadingElement) loadingElement.style.display = 'block';
    
    // Faz requisi√ß√£o para API
    fetch('/api/kpis-filtrados?' + params.toString())
        .then(response => response.json())
        .then(data => {
            if (loadingElement) loadingElement.style.display = 'none';
            
            if (data.success) {
                // Atualiza dados filtrados
                dadosKPIsFiltrados = data.metricas;
                
                // Atualiza cards
                atualizarCards(data.metricas);
                
                // Recria gr√É¬°ficos
                criarGraficos();
                
                // Mostra indicador de filtros ativos
                mostrarFiltrosAtivos();
                
                // Atualiza tabela de resumo
                atualizarTabelaResumo(data.resumo);
            }
        })
        .catch(error => {
            if (loadingElement) loadingElement.style.display = 'none';
            console.error('√¢¬ù≈í Erro ao aplicar filtros:', error);
            alert('Erro ao aplicar filtros. Tente novamente.');
        });
}

function atualizarCards(metricas) {
    document.getElementById('total-chamados').textContent = metricas.total_chamados || 0;
    document.getElementById('chamados-concluidos').textContent = metricas.chamados_concluidos || 0;
    document.getElementById('tempo-mediano').textContent = (metricas.tempo_mediano_reparo || 0).toFixed(1) + 'h';
    document.getElementById('disponibilidade').textContent = (metricas.disponibilidade || 0).toFixed(1) + '%';
}

function mostrarFiltrosAtivos() {
    const filtrosAtivosDiv = document.getElementById('filtros-ativos');
    const descricaoFiltros = document.getElementById('descricao-filtros');
    
    const filtrosTexto = [];
    
    // √∞≈∏‚Äú‚Ä¶ MELHORIA: Descri√ß√£o mais clara dos filtros
    const dataInicio = document.getElementById('data-inicio').value;
    const dataFim = document.getElementById('data-fim').value;
    const periodo = document.getElementById('filtro-periodo').value;
    
    if (dataInicio || dataFim) {
        let textoData = 'Per√É¬≠odo: ';
        if (dataInicio && dataFim) {
            textoData += `${dataInicio} a ${dataFim}`;
        } else if (dataInicio) {
            textoData += `a partir de ${dataInicio}`;
        } else {
            textoData += `at√É¬© ${dataFim}`;
        }
        filtrosTexto.push(textoData);
    } else if (periodo) {
        const periodos = {
            'ultima-semana': '√É≈°ltima Semana',
            'ultimo-mes': '√É≈°ltimo M√É¬™s',
            'ultimos-3-meses': '√É≈°ltimos 3 Meses',
            'ultimos-6-meses': '√É≈°ltimos 6 Meses',
            'ultimo-ano': '√É≈°ltimo Ano',
            'ultimos-2-anos': '√É≈°ltimos 2 Anos',
            'ultimos-5-anos': '√É≈°ltimos 5 Anos',
            'todo-periodo': 'Todo o Per√É¬≠odo'
        };
        filtrosTexto.push(`Per√É¬≠odo: ${periodos[periodo]}`);
    }
    
    Object.keys(filtrosAtivos).forEach(key => {
        if (filtrosAtivos[key] && !['data_inicio', 'data_fim', 'periodo_predefinido'].includes(key)) {
             const nomesFiltros = {
                'equipamento': 'Elevador',
                'categoria': 'Categoria',
                'edificio': 'Edif√É¬≠cio',
                'status': 'Status',
                'mes': 'M√É¬™s'
            };
            const nomeAmigavel = nomesFiltros[key] || key;
            filtrosTexto.push(`${nomeAmigavel}: ${filtrosAtivos[key]}`);
        }
    });
    
    if (filtrosTexto.length > 0) {
        descricaoFiltros.textContent = filtrosTexto.join(' | ');
        filtrosAtivosDiv.style.display = 'block';
    } else {
        filtrosAtivosDiv.style.display = 'none';
    }
}

function atualizarTabelaResumo(resumo) {
    const container = document.getElementById('tabela-resumo');
    if (!resumo || resumo.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">Nenhum dado encontrado com os filtros aplicados.</p>';
        return;
    }
    
    let html = `
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Categoria</th>
                        <th>Edif√É¬≠cio</th>
                        <th>Status</th>
                        <th>Data Solicita√ß√£o</th>
                        <th>Tempo Reparo (h)</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    resumo.slice(0, 20).forEach(item => { // Mostra apenas os primeiros 20
        html += `
            <tr>
                <td><span class="badge bg-secondary">${item.categoria_problema}</span></td>
                <td>${item.edificio}</td>
                <td><span class="badge ${item.status === 'Conclu√É¬≠da' ? 'bg-success' : 'bg-warning'}">${item.status}</span></td>
                <td>${item.data_solicitacao}</td>
                <td>${item.tempo_reparo || '-'}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        ${resumo.length > 20 ? `<p class="text-muted text-center">Mostrando 20 de ${resumo.length} registros</p>` : ''}
    `;
    
    container.innerHTML = html;
}

function limparFiltrosKPIs() {
    // √∞≈∏‚Äú‚Ä¶ LIMPA TODOS OS FILTROS (incluindo datas)
    document.getElementById('data-inicio').value = '';
    document.getElementById('data-fim').value = '';
    document.getElementById('filtro-periodo').value = '';
    document.getElementById('filtro-status').value = '';
    document.getElementById('filtro-categoria').value = '';
    document.getElementById('filtro-edificio').value = '';
    
    // Limpa filtros ativos
    filtrosAtivos = {};
    
    // Restaura dados originais
    dadosKPIsFiltrados = dadosKPIsOriginais;
    
    // Atualiza cards
    atualizarCards(dadosKPIsOriginais);
    
    // Recria gr√É¬°ficos
    criarGraficos();
    
    // Esconde indicador de filtros
    document.getElementById('filtros-ativos').style.display = 'none';
    
    // Limpa tabela de resumo
    document.getElementById('tabela-resumo').innerHTML = '<p class="text-muted text-center">Use os filtros acima ou clique nos gr√É¬°ficos para ver dados espec√É¬≠ficos.</p>';
    
    console.log('√∞≈∏¬ß¬π Filtros de KPIs limpos');
}

function debugFiltros() {
    console.log('√∞≈∏‚Äù¬ç DEBUG - Estado atual dos filtros:');
    console.log('   Data in√É¬≠cio:', document.getElementById('data-inicio').value);
    console.log('   Data fim:', document.getElementById('data-fim').value);
    console.log('   Per√É¬≠odo:', document.getElementById('filtro-periodo').value);
    console.log('   Status:', document.getElementById('filtro-status').value);
    console.log('   Categoria:', document.getElementById('filtro-categoria').value);
    console.log('   Edif√É¬≠cio:', document.getElementById('filtro-edificio').value);
    console.log('   Filtros ativos:', filtrosAtivos);
    console.log('   Dados originais:', dadosKPIsOriginais);
    console.log('   Dados filtrados:', dadosKPIsFiltrados);
}

</script>
{% endblock %}
--- Fim do cÛdigo: kpis.html ---

--- InÌcio do cÛdigo: login.html ---
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Sistema de Elevadores TJ/MG</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- CSS customizado -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .login-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            max-width: 400px;
            width: 100%;
            margin: 20px;
        }
        
        .login-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .login-header i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }
        
        .login-body {
            padding: 2rem;
        }
        
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .btn-login {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.4);
        }
        
        .input-group-text {
            border: 2px solid #e9ecef;
            border-right: none;
            background: #f8f9fa;
            border-radius: 10px 0 0 10px;
        }
        
        .input-group .form-control {
            border-left: none;
            border-radius: 0 10px 10px 0;
        }
        
        .alert {
            border-radius: 10px;
            border: none;
        }
        
        .footer-info {
            background: #f8f9fa;
            padding: 1rem;
            text-align: center;
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .loading {
            display: none;
        }
        
        .btn-login:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <!-- Cabe√ßalho -->
        <div class="login-header">
            <i class="fas fa-building"></i>
            <h3 class="mb-0">TJ/MG</h3>
            <p class="mb-0">Sistema de Elevadores</p>
        </div>
        
        <!-- Corpo do formul√É¬°rio -->
        <div class="login-body">
            <!-- Mensagens Flash -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'danger' else 'warning' if category == 'warning' else 'info' if category == 'info' else 'success' }} alert-dismissible fade show" role="alert">
                            <i class="fas fa-{{ 'exclamation-triangle' if category in ['danger', 'warning'] else 'info-circle' if category == 'info' else 'check-circle' }}"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <!-- Formul√É¬°rio de Login -->
            <form method="POST" id="loginForm">
                <div class="mb-3">
                    <label for="usuario" class="form-label">
                        <i class="fas fa-user"></i> Usu√É¬°rio
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-user"></i>
                        </span>
                        <input type="text" 
                               class="form-control" 
                               id="usuario" 
                               name="usuario" 
                               placeholder="Digite seu usu√É¬°rio"
                               required
                               autocomplete="username">
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="senha" class="form-label">
                        <i class="fas fa-lock"></i> Senha
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-lock"></i>
                        </span>
                        <input type="password" 
                               class="form-control" 
                               id="senha" 
                               name="senha" 
                               placeholder="Digite sua senha"
                               required
                               autocomplete="current-password">
                        <button class="btn btn-outline-secondary" 
                                type="button" 
                                id="togglePassword"
                                style="border-radius: 0 10px 10px 0;">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary btn-login" id="btnLogin">
                    <span class="normal-text">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </span>
                    <span class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Entrando...
                    </span>
                </button>
            </form>
        </div>
        
        <!-- Rodap√É¬© -->
        <div class="footer-info">
            <small>
                <i class="fas fa-shield-alt"></i>
                Acesso restrito - Tribunal de Justi√ßa de Minas Gerais
            </small>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Toggle para mostrar/ocultar senha
        document.getElementById('togglePassword').addEventListener('click', function() {
            const senhaInput = document.getElementById('senha');
            const icon = this.querySelector('i');
            
            if (senhaInput.type === 'password') {
                senhaInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                senhaInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
        
        // Loading no bot√£o de login
        document.getElementById('loginForm').addEventListener('submit', function() {
            const btn = document.getElementById('btnLogin');
            const normalText = btn.querySelector('.normal-text');
            const loadingText = btn.querySelector('.loading');
            
            btn.disabled = true;
            normalText.style.display = 'none';
            loadingText.style.display = 'inline';
        });
        
        // Foco autom√É¬°tico no campo usu√É¬°rio
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('usuario').focus();
        });
        
        // Enter para submeter o formul√É¬°rio
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('loginForm').submit();
            }
        });
    </script>
</body>
</html>
--- Fim do cÛdigo: login.html ---

--- InÌcio do cÛdigo: dashboard_v2.js ---
// dashboard_v2.js

// ========== FASE 5: FILTROS INTERATIVOS ==========

// Vari√É¬°veis globais
let dadosOriginais = initialGeojsonData;
let mapaLeaflet = null;
let marcadoresAtuais = []; // NOVO: Controla marcadores atuais

// Inicializa o mapa
function inicializarMapa() {
    console.log('Inicializando mapa v2.0 com filtros...');
    
    mapaLeaflet = L.map('mapa').setView([-19.92, -43.92], 7);

    console.log('Tamanho interno do mapa Leaflet (mapaLeaflet._size):', mapaLeaflet._size);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '√Ç¬© OpenStreetMap contributors, √Ç¬© CartoDB'
    }).addTo(mapaLeaflet);
    
    adicionarMarcadores(dadosOriginais);
}

// NOVO: Remove todos os marcadores
function limparMarcadores() {
    marcadoresAtuais.forEach(marker => {
        mapaLeaflet.removeLayer(marker);
    });
    marcadoresAtuais = [];
}

// ATUALIZADO: Adiciona marcadores ao mapa
function adicionarMarcadores(geojsonData) {
    // Limpa marcadores existentes
    limparMarcadores();
    
    if (!geojsonData || !geojsonData.features || geojsonData.features.length === 0) {
        console.warn("Nenhum dado GeoJSON ou features para adicionar marcadores.");
        return;
    }    

    // if (!geojsonData || !geojsonData.features) return;
    
    console.log(`Adicionando ${geojsonData.features.length} marcadores...`);


    geojsonData.features.forEach((feature, index) => {
        const props = feature.properties;
        const coords = feature.geometry.coordinates;

        if (!Array.isArray(coords) || coords.length !== 2 || 
            typeof coords[0] !== 'number' || typeof coords[1] !== 'number' || 
            isNaN(coords[0]) || isNaN(coords[1])) 
        {
            console.error(`ERRO: Coordenadas inv√°lidas para feature no √≠ndice ${index}. Pulando este marcador.`);
            console.error('Coordenadas:', coords);
            console.error('Feature completa:', feature);
            // Retorna para pular este marcador problem√°tico e continuar com os outros
            return; 
        }

        const latlng = [coords[1], coords[0]];      

        const marker = L.circleMarker(latlng,{
            radius: props.tamanhoMarcador,
            fillColor: props.corMarcador,
            color: props.corMarcador,
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
        })
        
        // Tooltip
        let tooltipText = `${props.cidade}-${props.tipo}<br/>
        ${props.qtd_elev} elevadores - ${props.marcaLicitacao}<br/>
        ${props.regiao} - ${props.status}`;
        if(props.nElevadorParado && props.nElevadorParado > 0){
            tooltipText += `<br/><strong style="color: ${props.corMarcador ||'#dc3545'};">${props.nElevadorParado} parado(s)</strong>`;
        }
        marker.bindTooltip(tooltipText,{sticky:true});
        
        // Popup
        let popupContent = `<div style="font-family: Arial, sans-serif;">
            <h4 style="margin: 0 0 10px 0; color: #333;">${props.unidade}</h4>
            <p><strong>Cidade:</strong> ${props.cidade}</p>
            <p><strong>Endere√ßo:</strong> ${props.endereco}</p>
            <p><strong>Tipo:</strong> ${props.tipo}</p>
            <p><strong>Elevadores:</strong> ${props.qtd_elev}</p>
            <p><strong>Paradas:</strong> ${props.paradas}</p>
            <p><strong>Marca:</strong> ${props.marca}</p>
            <p><strong>Empresa:</strong> ${props.empresa}</p>
            <p><strong>Status:</strong> <span style="color: ${props.corMarcador};">${props.status}</span></p>`;
        
        if ((props.nElevadorParado && props.nElevadorParado > 0) || props.status && props.status.toLowerCase().includes('suspenso')) {    
            if (props.nElevadorParado && props.nElevadorParado > 0) {
                popupContent += `<hr style="margin: 10px 0;"><p style="color: #dc3545;"><strong>‚ö†Ô∏è Elevadores Parados:</strong> ${props.nElevadorParado}</p>`;
            }
            if (props.dataDeParada) {
                popupContent += `<p style="color: #dc3545;"><strong>üìÖ Data da Parada:</strong> ${props.dataDeParada}</p>`;
            }
            if (props.previsaoDeRetorno) {
                popupContent += `<p style="color: #dc3545;"><strong>üîÑ Previs√£o de Retorno:</strong> ${props.previsaoDeRetorno}</p>`;
            }
        }
        popupContent += '</div>';
        
        marker.bindPopup(popupContent, {maxWidth: 350});
        marker.addTo(mapaLeaflet);
        marcadoresAtuais.push(marker);
    });
}

// NOVO: Aplica filtros E atualiza o mapa
function aplicarFiltros() {
    console.log('√∞≈∏‚Äù¬ç Aplicando filtros v2.0 com atualiza√ß√£o do mapa...');
    
    const tipos = obterSelecionados('tipo');
    const regioes = obterSelecionados('regiao');
    const situacoes = obterSelecionados('situacao');
    
    console.log('Filtros selecionados:', {tipos, regioes, situacoes});
    
    // Mostra loading
    mostrarLoading(true);
    
    const params = new URLSearchParams();
    tipos.forEach(tipo => params.append('tipo', tipo));
    regioes.forEach(regiao => params.append('regiao', regiao));
    situacoes.forEach(situacao => params.append('situacao', situacao));
    
    // NOVO: Chama API que retorna dados filtrados
    fetch(`/v2/api/dados-elevadores-filtrados?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Atualiza estat√É¬≠sticas
                atualizarCards(data.data.stats);
                
                // NOVO: Atualiza estat√É¬≠sticas detalhadas
                if (data.data.stats_detalhadas) {
                    atualizarStatsDetalhadas(data.data.stats_detalhadas);
                }
                
                // NOVO: Atualiza o mapa com dados filtrados
                adicionarMarcadores(data.data.geojson);
                
                // Ajusta zoom se necess√É¬°rio
                if (data.data.geojson.features.length > 0) {
                    ajustarZoomParaDados(data.data.geojson);
                }
                
                console.log('Filtros aplicados e mapa atualizado');
            } else {
                alert('Erro ao aplicar filtros: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro ao aplicar filtros:', error);
            alert('Erro na requisi√ß√£o de filtros');
        })
        .finally(() => {
            mostrarLoading(false);
        });
}

// NOVO: Ajusta zoom para mostrar todos os dados
function ajustarZoomParaDados(geojsonData) {
    if (!geojsonData.features || geojsonData.features.length === 0) return;
    
    const group = new L.featureGroup(marcadoresAtuais);
    mapaLeaflet.fitBounds(group.getBounds(), {padding: [20, 20]});
}

// √¢≈ì‚Ä¶ NOVO: Mostra/esconde loading
function mostrarLoading(mostrar) {
    const btn = document.querySelector('button[onclick="aplicarFiltros()"]');
    if (btn) {
        if (mostrar) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Filtrando...';
            btn.disabled = true;
        } else {
            btn.innerHTML = '<i class="fas fa-search"></i> Aplicar Filtros';
            btn.disabled = false;
        }
    }
}

// Obt√É¬©m valores selecionados
function obterSelecionados(categoria) {
    const checkboxes = document.querySelectorAll(`input[id^="check-${categoria}-"]:checked`);
    return Array.from(checkboxes).map(cb => cb.value);
}

// Atualiza cards de estat√É¬≠sticas
function atualizarCards(stats) {
    const elementos = {
        'stat-predios': stats.total_predios || 0,
        'stat-elevadores': stats.total_elevadores || 0,
        'stat-cidades': stats.cidades || 0,
        'stat-regioes': stats.regioes || 0,
        'stat-ativos': stats.em_atividade || 0,
        'stat-parados': stats.elevadores_parados || 0,
        'stat-suspensos': stats.elevadores_suspensos || 0
    };
    
    for (let id in elementos) {
        const elem = document.getElementById(id);
        if (elem) {
            // √¢≈ì‚Ä¶ NOVO: Anima√ß√£o nos n√É¬∫meros
            animarNumero(elem, parseInt(elem.textContent) || 0, elementos[id]);
        }
    }
    
    // Atualiza contador
    document.getElementById('total-elevadores-filtro').textContent = stats.total_elevadores || 0;
    document.getElementById('total-locais-filtro').textContent = stats.total_predios || 0;
}

// √¢≈ì‚Ä¶ NOVO: Anima√ß√£o de n√É¬∫meros
function animarNumero(elemento, valorInicial, valorFinal) {
    const duracao = 500; // ms
    const passos = 20;
    const incremento = (valorFinal - valorInicial) / passos;
    let valorAtual = valorInicial;
    let passo = 0;
    
    const timer = setInterval(() => {
        passo++;
        valorAtual += incremento;
        
        if (passo >= passos) {
            elemento.textContent = valorFinal;
            clearInterval(timer);
        } else {
            elemento.textContent = Math.round(valorAtual);
        }
    }, duracao / passos);
}

// √¢≈ì‚Ä¶ NOVO: Seleciona todos os filtros
function selecionarTodos() {
    console.log('Selecionando todos os filtros...');
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
    aplicarFiltros(); // Aplica automaticamente
}

// √¢≈ì‚Ä¶ ATUALIZADO: Limpa filtros e restaura dados originais
function limparFiltros() {
    console.log('Limpando filtros e restaurando mapa...');
    
    // Limpa checkboxes
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    
    // Restaura dados originais no mapa
    adicionarMarcadores(dadosOriginais);
    
    // Restaura estat√É¬≠sticas originais
    fetch('/v2/api/dados-elevadores')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                atualizarCards(data.data.stats);
                ajustarZoomParaDados(data.data.geojson);
                atualizarStatsDetalhadas(data.data.stats_detalhadas);
            }
        })
        .catch(error => console.error('Erro ao restaurar dados:', error));
}

// √¢≈ì‚Ä¶ ATUALIZADO: Atualiza estat√É¬≠sticas detalhadas
function atualizarStatsDetalhadas(statsDetalhadas) {
    // Atualiza por tipo
    atualizarListaStats('stats-por-tipo', statsDetalhadas.por_tipo);
    
    // Atualiza por regi√£o
    atualizarListaStats('stats-por-regiao', statsDetalhadas.por_regiao);
    
    // Atualiza por marca
    atualizarListaStats('stats-por-marca', statsDetalhadas.por_marca);
    
    // Atualiza por status
    atualizarListaStatsComCor('stats-por-status', statsDetalhadas.por_status);
    
    // Atualiza elevadores parados
    atualizarElevadoresParados(statsDetalhadas.elevadores_parados);
}

function atualizarListaStats(elementId, dados) {
    const elemento = document.getElementById(elementId);
    if (!elemento || !dados) return;
    
    let html = '';
    for (const [chave, valor] of Object.entries(dados)) {
        html += `<div class="d-flex justify-content-between">
            <span>${chave}:</span>
            <strong>${valor}</strong>
        </div>`;
    }
    
    elemento.innerHTML = html || '<div class="text-muted">Nenhum dado</div>';
}

function atualizarListaStatsComCor(elementId, dados) {
    const elemento = document.getElementById(elementId);
    if (!elemento || !dados) return;
    
    let html = '';
    for (const [chave, valor] of Object.entries(dados)) {
        let classe = '';
        if (chave === 'Em atividade') classe = 'text-success';
        else if (chave === 'Parados') classe = 'text-danger';
        else classe = 'text-warning';
        
        html += `<div class="d-flex justify-content-between">
            <span class="${classe}">${chave}:</span>
            <strong>${valor}</strong>
        </div>`;
    }
    
    elemento.innerHTML = html || '<div class="text-muted">Nenhum dado</div>';
}

function atualizarElevadoresParados(elevadoresParados) {
    const tbody = document.getElementById('elevadores-parados-tbody');
    const section = document.getElementById('elevadores-parados-section');
    
    if (!tbody || !section) return;
    
    if (!elevadoresParados || elevadoresParados.length === 0) {
        section.style.display = 'none';
        return;
    }
    
    section.style.display = 'block';
    
    let html = '';
    elevadoresParados.forEach(elevador => {
        html += `<tr>
            <td>${elevador.unidade}</td>
            <td>${elevador.cidade}</td>
            <td>${elevador.tipo}</td>
            <td>${elevador.regiao}</td>
            <td class="text-danger"><strong>${elevador.quantidade_parada}</strong></td>
            <td>${elevador.total_elevadores}</td>
            <td>${elevador.marca}</td>
        </tr>`;
    });
    
    tbody.innerHTML = html;
}

// NOVO: Aplicar filtros automaticamente quando checkbox muda
function configurarFiltrosAutomaticos() {
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            // Aplica filtros automaticamente ap√É¬≥s 500ms de inatividade
            clearTimeout(window.filtroTimeout);
            window.filtroTimeout = setTimeout(aplicarFiltros, 500);
        });
    });
}

// Atualiza dados
function atualizarDados() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
    btn.disabled = true;
    
    fetch('/v2/atualizar-dados')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Dados atualizados!\n' + data.message);
                location.reload();
            } else {
                alert('Erro: ' + data.message);
            }
        })
        .catch(error => alert('Erro na requisi√ß√£o'))
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

// ATUALIZADO: Inicializa quando a p√°gina carrega
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard v2.0 carregado com filtros interativos');
    const mapaElement = document.getElementById('mapa');
    if (mapaElement) {
        // Verifique as dimens√µes do mapaElement ANTES de inicializar
        console.log('Dimens√µes do elemento #mapa:', mapaElement.offsetWidth, mapaElement.offsetHeight);
        if (mapaElement.offsetWidth === 0 || mapaElement.offsetHeight === 0) {
            console.error('Elemento #mapa est√° com dimens√µes zero. Isso pode causar problemas de renderiza√ß√£o do Leaflet.');
            // Tente for√ßar um pequeno delay para a inicializa√ß√£o do mapa
            setTimeout(function() {
                inicializarMapa();
                configurarFiltrosAutomaticos();
            }, 100); // Pequeno delay
        } else {
            inicializarMapa();
            configurarFiltrosAutomaticos();
        }
    } else {
        console.error('Elemento #mapa n√£o encontrado no DOM!');
    }
});
--- Fim do cÛdigo: dashboard_v2.js ---

--- InÌcio do cÛdigo: filtros_mapa.js ---
    // static/js/filtros_mapa.js - Vers√£o com captura melhorada

    let dadosOriginais = null;
    let dadosFiltrados = null;
    let mapaLeaflet = null;
    let marcadoresOriginais = [];

    console.log('√∞≈∏‚Äù¬ß Script de filtros carregado');

    // Fun√ß√£o para inicializar o sistema de filtros
    function inicializarFiltros(geojsonData) {
        console.log('√∞≈∏≈°‚Ç¨ Inicializando filtros...');
        console.log('√∞≈∏‚Äú≈† Dados recebidos:', geojsonData);
        
        dadosOriginais = geojsonData;
        dadosFiltrados = geojsonData;
        
        if (dadosOriginais && dadosOriginais.features) {
            console.log('√¢≈ì‚Ä¶ Features dispon√É¬≠veis:', dadosOriginais.features.length);
        } else {
            console.error('√¢¬ù≈í Nenhuma feature encontrada nos dados');
            return;
        }
        
        // Captura o mapa Leaflet com m√É¬∫ltiplas estrat√É¬©gias
        capturarMapaLeaflet();
    }

    // Fun√ß√£o para capturar o mapa Leaflet - VERS√É∆íO MELHORADA
    function capturarMapaLeaflet() {
        console.log('√∞≈∏‚Äî¬∫√Ø¬∏¬è Tentando capturar mapa Leaflet com m√É¬∫ltiplas estrat√É¬©gias...');
        
        let tentativas = 0;
        const maxTentativas = 15;
        
        const verificarMapa = () => {
            tentativas++;
            console.log(`√∞≈∏‚Äù¬ç Tentativa ${tentativas}/${maxTentativas} de capturar mapa...`);
            
            // ESTRAT√É‚Ä∞GIA 1: Procurar por vari√É¬°veis map_*
            const mapKeys = Object.keys(window).filter(key => key.startsWith('map_'));
            console.log('√Ø¬ø¬Ω√Ø¬ø¬Ω Chaves map_* encontradas:', mapKeys);
            
            for (let key of mapKeys) {
                const mapInstance = window[key];
                if (mapInstance && mapInstance._container) {
                    mapaLeaflet = mapInstance;
                    console.log('√¢≈ì‚Ä¶ Mapa capturado via map_*:', key);
                    finalizarCaptura();
                    return true;
                }
            }
            
            // ESTRAT√É‚Ä∞GIA 2: Procurar em todas as vari√É¬°veis globais
            for (let key in window) {
                const obj = window[key];
                if (obj && typeof obj === 'object' && obj._container && obj.addLayer) {
                    mapaLeaflet = obj;
                    console.log('√¢≈ì‚Ä¶ Mapa capturado via varredura global:', key);
                    finalizarCaptura();
                    return true;
                }
            }
            
            // ESTRAT√É‚Ä∞GIA 3: Usar DOM + Leaflet API
            const mapContainers = document.querySelectorAll('.folium-map');
            console.log('√Ø¬ø¬Ω√Ø¬ø¬Ω Containers .folium-map encontrados:', mapContainers.length);
            
            for (let container of mapContainers) {
                if (container._leaflet_id && window.L) {
                    // Tenta acessar o mapa via container
                    const maps = window.L._layer ? Object.values(window.L._layer) : [];
                    for (let map of maps) {
                        if (map._container === container) {
                            mapaLeaflet = map;
                            console.log('√¢≈ì‚Ä¶ Mapa capturado via DOM/Leaflet:', container.id);
                            finalizarCaptura();
                            return true;
                        }
                    }
                    
                    // Tenta acessar via _leaflet_id
                    if (window.L && window.L.map && container._leaflet_id) {
                        try {
                            const mapInstance = window.L.map(container);
                            if (mapInstance && mapInstance._container) {
                                mapaLeaflet = mapInstance;
                                console.log('√¢≈ì‚Ä¶ Mapa capturado via L.map()');
                                finalizarCaptura();
                                return true;
                            }
                        } catch (e) {
                            console.log('√¢≈°¬†√Ø¬∏¬è Erro ao tentar L.map():', e.message);
                        }
                    }
                }
            }
            
            // ESTRAT√É‚Ä∞GIA 4: Interceptar cria√ß√£o do mapa
            if (window.L && !window._mapInterceptorAdded) {
                window._mapInterceptorAdded = true;
                const originalMap = window.L.map;
                window.L.map = function(...args) {
                    const mapInstance = originalMap.apply(this, args);
                    console.log('√∞≈∏≈Ω¬Ø Mapa interceptado na cria√ß√£o!');
                    mapaLeaflet = mapInstance;
                    finalizarCaptura();
                    return mapInstance;
                };
            }
            
            // ESTRAT√É‚Ä∞GIA 5: Procurar inst√É¬¢ncias ativas do Leaflet
            if (window.L && window.L.Map) {
                const allMaps = [];
                
                // Tenta encontrar todas as inst√É¬¢ncias de L.Map
                document.querySelectorAll('div').forEach(div => {
                    if (div._leaflet && div._leaflet instanceof window.L.Map) {
                        allMaps.push(div._leaflet);
                    }
                });
                
                if (allMaps.length > 0) {
                    mapaLeaflet = allMaps[0];
                    console.log('√¢≈ì‚Ä¶ Mapa encontrado via inst√É¬¢ncia L.Map');
                    finalizarCaptura();
                    return true;
                }
            }
            
            if (tentativas < maxTentativas) {
                setTimeout(verificarMapa, 1000);
            } else {
                console.error('√¢¬ù≈í N√£o foi poss√É¬≠vel capturar o mapa ap√É¬≥s', maxTentativas, 'tentativas');
                console.log('√∞≈∏‚Äù¬ç Debug - window.L:', window.L);
                console.log('√∞≈∏‚Äù¬ç Debug - document.querySelectorAll(".folium-map"):', document.querySelectorAll('.folium-map'));
                
                // Como √É¬∫ltimo recurso, vamos trabalhar diretamente com o DOM
                usarFallbackDOM();
            }
        };
        
        verificarMapa();
    }

    // Fun√ß√£o para finalizar a captura do mapa
    function finalizarCaptura() {
        if (mapaLeaflet) {
            console.log('√∞≈∏≈Ω‚Ä∞ Mapa capturado com sucesso!');
            console.log('√∞≈∏‚Äú¬ç Container do mapa:', mapaLeaflet._container);
            
            // Salva marcadores originais
            salvarMarcadoresOriginais();
        }
    }

    // Fun√ß√£o FALLBACK - trabalha diretamente com DOM se n√£o conseguir capturar o mapa
    function usarFallbackDOM() {
        console.log('√Ø¬ø¬Ω√Ø¬ø¬Ω Usando fallback DOM...');
        
        // Se n√£o conseguir capturar o mapa, pelo menos atualiza visualmente
        window.atualizarMapaFallback = function() {
            console.log('√∞≈∏‚Äù‚Äû Atualizando mapa via fallback DOM...');
            
            const mapContainer = document.querySelector('.folium-map');
            if (mapContainer) {
                // Cria um overlay com informa√ß√É¬µes dos filtros
                let overlay = document.getElementById('filtro-overlay');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = 'filtro-overlay';
                    overlay.style.cssText = `
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0,0,0,0.8);
                        color: white;
                        padding: 20px;
                        border-radius: 10px;
                        z-index: 10000;
                        text-align: center;
                        font-family: Arial, sans-serif;
                    `;
                    mapContainer.style.position = 'relative';
                    mapContainer.appendChild(overlay);
                }
                
                const totalFiltrados = dadosFiltrados.features ? dadosFiltrados.features.length : 0;
                overlay.innerHTML = `
                    <h4>√∞≈∏‚Äù¬ç Filtros Ativos</h4>
                    <p>${totalFiltrados} locais selecionados</p>
                    <small>Mapa ser√É¬° recarregado automaticamente</small>
                `;
                
                // Remove o overlay ap√É¬≥s 3 segundos
                setTimeout(() => {
                    if (overlay) overlay.remove();
                }, 3000);
            }
        };
    }

    // Fun√ß√£o para salvar refer√É¬™ncias dos marcadores originais
    function salvarMarcadoresOriginais() {
        console.log('√∞≈∏‚Äô¬æ Salvando marcadores originais...');
        
        marcadoresOriginais = [];
        
        if (mapaLeaflet) {
            mapaLeaflet.eachLayer(function(layer) {
                // Ignora tiles e outras camadas n√£o-marcador
                if (layer.feature || layer._latlng || (layer._layers && Object.keys(layer._layers).length > 0)) {
                    marcadoresOriginais.push(layer);
                    console.log('√∞≈∏‚Äô¬æ Marcador salvo:', layer);
                }
            });
            
            console.log(`√¢≈ì‚Ä¶ ${marcadoresOriginais.length} marcadores originais salvos`);
        }
    }

    // Fun√ß√£o para obter valores selecionados
    function obterSelecionados(categoria) {
        const checkboxes = document.querySelectorAll(`input[id^="check-${categoria}-"]:checked`);
        const valores = Array.from(checkboxes).map(cb => cb.value);
        console.log(`√∞≈∏‚Äù¬ç Filtros selecionados para ${categoria}:`, valores);
        return valores;
    }

    // Fun√ß√£o para aplicar filtros - COM SITUA√É‚Ä°√É∆íO
    function aplicarFiltros() {
        console.log('√∞≈∏≈Ω¬Ø ========== APLICANDO FILTROS ==========');
        
        const tiposSelecionados = obterSelecionados('tipo');
        const regioesSelecionadas = obterSelecionados('regiao');
        const marcasSelecionadas = obterSelecionados('marca');
        const empresasSelecionadas = obterSelecionados('empresa');
        const situacoesSelecionadas = obterSelecionados('situacao'); // √∞≈∏‚Ä†‚Ä¢ NOVO FILTRO

        console.log('√∞≈∏‚Äú‚Äπ Resumo dos filtros:', {
            tipos: tiposSelecionados,
            regioes: regioesSelecionadas,
            marcas: marcasSelecionadas,
            empresas: empresasSelecionadas,
            situacoes: situacoesSelecionadas // √∞≈∏‚Ä†‚Ä¢ NOVO
        });

        if (!dadosOriginais || !dadosOriginais.features) {
            console.error('√¢¬ù≈í Dados originais n√£o dispon√É¬≠veis');
            return;
        }

        // Filtra os dados
        const featuresOriginal = dadosOriginais.features.length;
        
        dadosFiltrados = {
            ...dadosOriginais,
            features: dadosOriginais.features.filter(feature => {
                const props = feature.properties;
                
                const passaTipo = tiposSelecionados.length === 0 || tiposSelecionados.includes(props.tipo);
                const passaRegiao = regioesSelecionadas.length === 0 || regioesSelecionadas.includes(props.regiao);
                const passaMarca = marcasSelecionadas.length === 0 || marcasSelecionadas.includes(props.marcaLicitacao);
                const passaEmpresa = empresasSelecionadas.length === 0 || empresasSelecionadas.includes(props.empresa);
                
                // √∞≈∏‚Ä†‚Ä¢ NOVA L√É‚ÄúGICA DE FILTRO POR SITUA√É‚Ä°√É∆íO
                let passaSituacao = true;
                if (situacoesSelecionadas.length > 0) {
                    passaSituacao = false;
                    
                    // Verifica cada situa√ß√£o selecionada
                    situacoesSelecionadas.forEach(situacao => {
                        if (situacao === 'ativos') {
                            // Ativos: status ativo E sem elevadores parados
                            if (props.status && props.status.toLowerCase().includes('atividade') && 
                                (!props.nElevadorParado || props.nElevadorParado === 0)) {
                                passaSituacao = true;
                            }
                        } else if (situacao === 'suspensos') {
                            // Suspensos: status suspenso
                            if (props.status && props.status.toLowerCase().includes('suspenso')) {
                                passaSituacao = true;
                            }
                        } else if (situacao === 'parados') {
                            // Parados: tem elevadores parados
                            if (props.nElevadorParado && props.nElevadorParado > 0) {
                                passaSituacao = true;
                            }
                        }
                    });
                }
                
                return passaTipo && passaRegiao && passaMarca && passaEmpresa && passaSituacao;
            })
        };

        const featuresFiltradas = dadosFiltrados.features.length;
        console.log(`√∞≈∏‚Äú≈† Filtragem conclu√É¬≠da: ${featuresOriginal} √¢‚Ä†‚Äô ${featuresFiltradas} features`);

        // Atualiza o mapa
        atualizarMapa();
        
        // Atualiza contador
        atualizarContadorFiltros();
        
        // Atualiza estat√É¬≠sticas
        atualizarEstatisticasDashboard();
        
        console.log('√¢≈ì‚Ä¶ ========== FILTROS APLICADOS ==========');
    }

    // Fun√ß√£o para criar um marcador
    function criarMarcador(feature) {
        const props = feature.properties;
        const coords = feature.geometry.coordinates;
        const latlng = [coords[1], coords[0]]; // Leaflet usa [lat, lng]
        
        // √∞≈∏≈Ω¬® NOVA L√É‚ÄúGICA DE CORES - PRIORIDADE: Parados > Suspensos > Ativos
        let cor = '#6c757d'; // Cinza padr√£o
        
        if (props.temElevadorParado || (props.nElevadorParado && props.nElevadorParado > 0)) {
            cor = '#dc3545'; // √∞≈∏‚Äù¬¥ Vermelho para elevadores parados
        } else if (props.status && props.status.toLowerCase().includes('suspenso')) {
            cor = '#ffc107'; // √∞≈∏≈∏¬° Amarelo para suspensos (CORRIGIDO)
        } else if (props.status && props.status.toLowerCase().includes('atividade')) {
            cor = '#28a745'; // √∞≈∏≈∏¬¢ Verde para ativos
        }
        
        // Define tamanho baseado na quantidade
        const radius = props.qtd_elev >= 5 ? 10 : (props.qtd_elev >= 3 ? 8 : 6);
        
        // Cria o marcador
        const marker = L.circleMarker(latlng, {
            radius: radius,
            fillColor: cor,
            color: cor,
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
        });
        
        // √∞≈∏‚Äú¬ù TOOLTIP ATUALIZADO
        let tooltipText = `${props.cidade} - ${props.tipo}<br/>
            ${props.qtd_elev} elevadores - ${props.marcaLicitacao}<br/>
            ${props.regiao} - ${props.status}`;
        
        if (props.nElevadorParado && props.nElevadorParado > 0) {
            tooltipText += `<br/><strong style="color: #dc3545;">√¢≈°¬†√Ø¬∏¬è ${props.nElevadorParado} parado(s)</strong>`;
        }

        marker.bindTooltip(tooltipText, {sticky: true});
        
        // √∞≈∏‚Äú¬ù POPUP ATUALIZADO
        let popupContent = `<div style="font-family: Arial, sans-serif;">
                <h4 style="margin: 0 0 10px 0; color: #333;">${props.unidade}</h4>
                <p><strong>Cidade:</strong> ${props.cidade}</p>
                <p><strong>Endere√ßo:</strong> ${props.endereco}</p>
                <p><strong>Tipo:</strong> ${props.tipo}</p>
                <p><strong>Elevadores:</strong> ${props.qtd_elev}</p>
                <p><strong>Paradas:</strong> ${props.paradas}</p>
                <p><strong>Marca:</strong> ${props.marca}</p>
                <p><strong>Empresa:</strong> ${props.empresa}</p>
                <p><strong>Status:</strong> ${props.status}</p>`;
        
        // √∞≈∏‚Ä†‚Ä¢ ADICIONA INFORMA√É‚Ä°√É‚Ä¢ES DE ELEVADORES PARADOS E SUSPENSOS
        
        if ((props.nElevadorParado && props.nElevadorParado > 0)) {
            popupContent += `
                <hr style="margin: 10px 0;">
                <p style="color: #dc3545;"><strong>√¢≈°¬†√Ø¬∏¬è Elevadores Parados:</strong> ${props.nElevadorParado}</p>`;
        }
        if ((props.nElevadorParado && props.nElevadorParado > 0) || props.status && props.status.toLowerCase().includes('suspenso')) {    
            if (props.dataDeParada) {
                popupContent += `<p style="color: #dc3545;"><strong>√∞≈∏‚Äú‚Ä¶ Data da Parada:</strong> ${props.dataDeParada}</p>`;
            }
            
            if (props.previsaoDeRetorno) {
                popupContent += `<p style="color: #dc3545;"><strong>√∞≈∏‚Äù‚Äû Previs√£o de Retorno:</strong> ${props.previsaoDeRetorno}</p>`;
            }
        }
        
        popupContent += '</div>';
        
        marker.bindPopup(popupContent, {maxWidth: 350});
        
        return marker;
    }

    // Fun√ß√£o para atualizar contador
    function atualizarContadorFiltros() {
        if (!dadosFiltrados.features) return;
        
        const totalElevadores = dadosFiltrados.features.reduce((total, feature) => {
            return total + feature.properties.qtd_elev;
        }, 0);

        const totalLocais = dadosFiltrados.features.length;

        const elemElevadores = document.getElementById('total-elevadores-filtro');
        const elemLocais = document.getElementById('total-locais-filtro');
        
        if (elemElevadores) elemElevadores.textContent = totalElevadores;
        if (elemLocais) elemLocais.textContent = totalLocais;

        const contadorElement = document.getElementById('contador-resultados');
        if (contadorElement) {
            if (totalElevadores === 0) {
                contadorElement.style.background = '#ffebee';
                contadorElement.style.color = '#c62828';
                contadorElement.style.borderColor = '#ef9a9a';
            } else {
                contadorElement.style.background = '#e8f5e8';
                contadorElement.style.color = '#2e7d32';
                contadorElement.style.borderColor = '#a5d6a7';
            }
        }
        
        console.log(`√∞≈∏‚Äú≈† Contador atualizado: ${totalElevadores} elevadores em ${totalLocais} locais`);
    }

    // Fun√ß√£o para atualizar estat√É¬≠sticas da dashboard - COM SITUA√É‚Ä°√É∆íO
    function atualizarEstatisticasDashboard() {
        const tiposSelecionados = obterSelecionados('tipo');
        const regioesSelecionadas = obterSelecionados('regiao');
        const marcasSelecionadas = obterSelecionados('marca');
        const empresasSelecionadas = obterSelecionados('empresa');
        const situacoesSelecionadas = obterSelecionados('situacao'); // √∞≈∏‚Ä†‚Ä¢ NOVO

        // Se nenhum filtro ativo, limpa todos os filtros
        if (tiposSelecionados.length === 0 && regioesSelecionadas.length === 0 && 
            marcasSelecionadas.length === 0 && empresasSelecionadas.length === 0 &&
            situacoesSelecionadas.length === 0) { // √∞≈∏‚Ä†‚Ä¢ INCLUIR NOVO FILTRO
            console.log('√¢¬è¬≠√Ø¬∏¬è Nenhum filtro ativo, limpando todos os filtros');
            limparFiltros();
            return;
        }

        // Monta par√É¬¢metros
        const params = new URLSearchParams();
        tiposSelecionados.forEach(tipo => params.append('tipo', tipo));
        regioesSelecionadas.forEach(regiao => params.append('regiao', regiao));
        marcasSelecionadas.forEach(marca => params.append('marca', marca));
        empresasSelecionadas.forEach(empresa => params.append('empresa', empresa));
        situacoesSelecionadas.forEach(situacao => params.append('situacao', situacao)); // √∞≈∏‚Ä†‚Ä¢ NOVO

        console.log('√∞≈∏‚Äú¬° Fazendo requisi√ß√£o para API...');

        // Mostra loading
        const loadingElement = document.getElementById('loading-stats');
        if (loadingElement) loadingElement.style.display = 'block';

        // Faz requisi√ß√£o
        fetch('/api/filtrar?' + params.toString())
            .then(response => response.json())
            .then(data => {
                if (loadingElement) loadingElement.style.display = 'none';
                
                console.log('√∞≈∏‚Äú¬° Resposta da API:', data);
                
                if (data.success) {
                    // Atualiza cards
                    const elementos = {
                        'stat-predios': data.stats.total_predios,
                        'stat-elevadores': data.stats.total_elevadores,
                        'stat-cidades': data.stats.cidades,
                        'stat-regioes': data.stats.regioes,
                        'stat-ativos': data.stats.em_atividade,
                        'stat-suspensos': data.stats.suspensos,
                        'stat-parados': data.stats.elevadores_parados
                    };
                    
                    for (let id in elementos) {
                        const elem = document.getElementById(id);
                        if (elem) {
                            elem.textContent = elementos[id];
                            console.log(`√∞≈∏‚Äú≈† Card ${id} atualizado para:`, elementos[id]);
                        }
                    }

                    // Atualiza estat√É¬≠sticas detalhadas
                    mostrarEstatisticasDetalhadas(data.stats);
                }
            })
            .catch(error => {
                if (loadingElement) loadingElement.style.display = 'none';
                console.error('√¢¬ù≈í Erro ao carregar estat√É¬≠sticas:', error);
            });
    }

    // Fun√ß√£o para mostrar estat√É¬≠sticas detalhadas
    function mostrarEstatisticasDetalhadas(stats) {
        const container = document.getElementById('stats-detalhadas');
        if (!container) return;
        
        let html = '<div class="row">';
        
        const categorias = [
            {titulo: 'Por Tipo', dados: stats.por_tipo},
            {titulo: 'Por Regi√£o', dados: stats.por_regiao},
            {titulo: 'Por Marca', dados: stats.por_marca},
            {titulo: 'Por Status', dados: stats.por_status}
        ];
        
        categorias.forEach(categoria => {
            html += `<div class="col-md-3"><h6>${categoria.titulo}</h6><ul class="list-unstyled">`;
            for (let [key, value] of Object.entries(categoria.dados)) {
                html += `<li><strong>${key}:</strong> ${value}</li>`;
            }
            html += '</ul></div>';
        });
        
        html += '</div>';
        container.innerHTML = html;
    }

    // Fun√ß√É¬µes auxiliares
    function limparFiltros() {
        console.log('√∞≈∏¬ß¬π Limpando todos os filtros...');
        
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
        
        dadosFiltrados = dadosOriginais;
        atualizarMapa();
        atualizarContadorFiltros();
        
        // Restaura valores originais dos cards
        const valoresOriginais = window.statsOriginais || {};
        for (let id in valoresOriginais) {
            const elem = document.getElementById(id);
            if (elem) elem.textContent = valoresOriginais[id];
        }
        
        const statsContainer = document.getElementById('stats-detalhadas');
        if (statsContainer) {
            statsContainer.innerHTML = '<p class="text-muted">Use os filtros no mapa para ver estat√É¬≠sticas espec√É¬≠ficas.</p>';
        }
        
        console.log('√¢≈ì‚Ä¶ Filtros limpos');
    }

    function selecionarTodos() {
        console.log('√¢≈ì‚Ä¶ Selecionando todos os filtros...');
        
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = true);
        aplicarFiltros();
    }

    function toggleCategoria(categoria) {
        const div = document.getElementById(`filtros-${categoria}`);
        const button = document.getElementById(`toggle-${categoria}`);

        if (div && button) {
            if (div.style.display === 'none') {
                div.style.display = 'block';
                button.textContent = '√¢≈æ‚Äì';
            } else {
                div.style.display = 'none';
                button.textContent = '√¢≈æ‚Ä¢';
            }
        }
    }

    function atualizarDados() {
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
        btn.disabled = true;
        
        fetch('/atualizar')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Dados atualizados!\n' + data.message);
                    location.reload();
                } else {
                    alert('Erro: ' + data.message);
                }
            })
            .catch(error => {
                alert('Erro na requisi√ß√£o');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    }

    // Adiciona event listener para debug quando a p√É¬°gina carrega
    document.addEventListener('DOMContentLoaded', function() {
        console.log('√Ø¬ø¬Ω√Ø¬ø¬Ω DOM carregado, aguardando inicializa√ß√£o...');
    });
--- Fim do cÛdigo: filtros_mapa.js ---

--- InÌcio do cÛdigo: elevators.py ---
# app/api/elevators.py
from flask import Blueprint, jsonify, request
# Importa√É¬ß√É¬µes antigas: from app.utils.decorators import login_required, api_response
# Nova importa√É¬ß√É¬£o:
from app.utils.auth_decorators import api_auth_required # Agora inclui autentica√É¬ß√É¬£o E padroniza√É¬ß√É¬£o JSON

from app.services.sheets_service import SheetsService
from app.services.data_processor import DataProcessor
from app.services.stats_service import StatsService

elevators_api_bp = Blueprint('elevators_api', __name__)

@elevators_api_bp.route('/filtrar')
@api_auth_required # Substitui @login_required e @api_response
def api_filtrar():
    """API para filtrar dados de elevadores"""
    tipos = request.args.getlist('tipo')
    regioes = request.args.getlist('regiao')
    marcas = request.args.getlist('marca')
    empresas = request.args.getlist('empresa')
    situacoes = request.args.getlist('situacao')
    
    sheets_service = SheetsService()
    data_processor = DataProcessor()
    
    dados_raw = sheets_service.obter_dados_elevadores()
    processed_data = data_processor.process_elevators_data(dados_raw)
    
    elevators_filtered = data_processor.apply_filters(
        processed_data['registros_processados'],
        tipos=tipos,
        regioes=regioes,
        marcas=marcas,
        empresas=empresas,
        situacoes=situacoes
    )
    
    stats = StatsService.calculate_elevator_stats(elevators_filtered)
    stats_by_category = StatsService.group_by_category(elevators_filtered)
    stats.update(stats_by_category)
    
    # Retorna um dicion√É¬°rio, que api_auth_required (via json_response) ir√É¬° converter para JSON e lidar com erros
    return {
        'success': True,
        'stats': stats,
        'total_registros': len(elevators_filtered)
    }

@elevators_api_bp.route('/elevadores-parados')
@api_auth_required # Substitui @login_required e @api_response
def api_elevadores_parados():
    """API para obter elevadores parados"""
    # (Sua implementa√É¬ß√É¬£o atual era 'pass', adicionei um retorno de exemplo)
    # L√É¬≥gica para filtrar elevadores parados aqui
    return {
        'success': True,
        'message': 'Dados de elevadores parados (implementa√É¬ß√É¬£o espec√É¬≠fica pendente).'
    }
--- Fim do cÛdigo: elevators.py ---

--- InÌcio do cÛdigo: kpis.py ---
# app/api/kpis.py
from flask import Blueprint, jsonify, request, current_app
from app.utils.auth_decorators import api_auth_required
from app.services.sheets_service import SheetsService
from app.services.data_processor import DataProcessor
from app.blueprints.kpis import obter_kpis_cached # Importa a fun√É¬ß√É¬£o de cache do Blueprint UI
from datetime import datetime, timedelta
import pytz

kpis_api_bp = Blueprint('kpis_api', __name__)

@kpis_api_bp.route('/kpis-filtrados')
@api_auth_required
def api_kpis_filtrados():
    """API para obter dados de KPIs filtrados."""
    start_time = datetime.now()
    
    try:
        # Obt√É¬©m a lista completa de objetos KPI do cache
        all_kpis, _ = obter_kpis_cached()
        
        # Extrai par√É¬¢metros de filtro da requisi√É¬ß√É¬£o
        data_inicio_str = request.args.get('data_inicio')
        data_fim_str = request.args.get('data_fim')
        periodo_predefinido = request.args.get('periodo_predefinido')
        status_filtro = request.args.get('status')
        categoria_filtro = request.args.get('categoria')
        edificio_filtro = request.args.get('edificio')
        equipamento_filtro = request.args.get('equipamento')

        # Converte strings de data para objetos datetime (ajustado para BRT)
        brt = pytz.timezone("America/Sao_Paulo")
        data_inicio = None
        data_fim = None

        if data_inicio_str:
            data_inicio = brt.localize(datetime.strptime(data_inicio_str, '%Y-%m-%d'))
        if data_fim_str:
            data_fim = brt.localize(datetime.strptime(data_fim_str, '%Y-%m-%d')) + timedelta(days=1, seconds=-1) # Inclui o dia todo

        # Aplica per√É¬≠odo predefinido se n√É¬£o houver datas espec√É¬≠ficas
        if periodo_predefinido and not (data_inicio_str or data_fim_str):
            hoje = brt.localize(datetime.now())
            if periodo_predefinido == 'ultima-semana':
                data_inicio = hoje - timedelta(weeks=1)
            elif periodo_predefinido == 'ultimo-mes':
                data_inicio = hoje - timedelta(days=30)
            elif periodo_predefinido == 'ultimos-3-meses':
                data_inicio = hoje - timedelta(days=90)
            elif periodo_predefinido == 'ultimos-6-meses':
                data_inicio = hoje - timedelta(days=180)
            elif periodo_predefinido == 'ultimo-ano':
                data_inicio = hoje - timedelta(days=365)
            elif periodo_predefinido == 'ultimos-2-anos':
                data_inicio = hoje - timedelta(days=730)
            elif periodo_predefinido == 'ultimos-5-anos':
                data_inicio = hoje - timedelta(days=1825)
            # 'todo-periodo' n√É¬£o requer ajuste de data

            # Garante que data_fim esteja definida para filtros predefinidos
            if data_inicio and not data_fim:
                data_fim = hoje # At√É¬© hoje

        # Cria um DataProcessor para aplicar os filtros
        data_processor = DataProcessor()
        
        # Filtra a lista de objetos KPI
        kpis_filtrados = data_processor.apply_kpi_filters(
            all_kpis,
            data_inicio=data_inicio,
            data_fim=data_fim,
            status=status_filtro,
            categoria=categoria_filtro,
            edificio=edificio_filtro,
            equipamento=equipamento_filtro
        )
        
        # Calcula as m√É¬©tricas dos KPIs filtrados
        metricas_filtradas = data_processor._calculate_kpi_metrics(kpis_filtrados)
        
        # Prepara um resumo para a tabela (se necess√É¬°rio, os 20 primeiros, como no JS)
        resumo_tabela = [kpi.to_dict() for kpi in kpis_filtrados[:20]]

        elapsed_time = (datetime.now() - start_time).total_seconds()
        print(f"√¢≈ì‚Ä¶ KPIs: Filtros aplicados em {elapsed_time:.2f}s: {len(kpis_filtrados)} KPIs.")
        
        return {
            'success': True,
            'metricas': metricas_filtradas,
            'resumo': resumo_tabela,
            'total_kpis': len(kpis_filtrados),
            'performance': {
                'tempo_processamento': f"{elapsed_time:.2f}s",
                'fonte_dados': 'cache'
            }
        }
    except ValueError as ve:
        current_app.logger.warning(f"Erro de valida√É¬ß√É¬£o na API de KPIs: {ve}")
        return {'success': False, 'message': str(ve)}, 400
    except Exception as e:
        current_app.logger.exception(f"Erro na API de KPIs: {e}")
        return {'success': False, 'message': 'Ocorreu um erro interno ao processar os KPIs.'}, 500
--- Fim do cÛdigo: kpis.py ---

--- InÌcio do cÛdigo: __init__.py ---
# app/api/__init__.py
"""M√≥dulo de APIs REST"""
--- Fim do cÛdigo: __init__.py ---

--- InÌcio do cÛdigo: auth.py ---
# app/blueprints/auth.py
from flask import Blueprint, render_template, render_template_string, request, redirect, url_for, flash, jsonify, session
from app.services.auth_service import AuthService
from app.utils.auth_decorators import json_response, api_auth_required

auth_bp = Blueprint('auth', __name__, url_prefix='/v2/auth')

@auth_bp.route('/login', methods=['GET', 'POST'])
def login():
    """P√É¬°gina de login da nova arquitetura"""
    if request.method == 'POST':
        if request.is_json:
            return handle_login_api()
        else:
            return handle_login_form()
    
    return render_template_string(LOGIN_TEMPLATE)

def handle_login_form():
    """Processa login via formul√É¬°rio"""
    usuario = request.form.get('usuario', '').strip()
    senha = request.form.get('senha', '')
    ip_cliente = request.environ.get('REMOTE_ADDR', 'unknown')
    
    if not usuario or not senha:
        flash('Usu√°rio e senha s√£o obrigat√≥rios.', 'danger')
        return render_template_string(LOGIN_TEMPLATE)
    
    sucesso, mensagem = AuthService.authenticate(usuario, senha, ip_cliente)
    
    if sucesso:
        flash(mensagem, 'success')
        next_page = request.args.get('next')
        return redirect(next_page) if next_page else redirect(url_for('dashboard.index')) # Redireciona para o novo dashboard
    else:
        flash(mensagem, 'danger')
        return render_template_string(LOGIN_TEMPLATE)

# Agora usa o novo json_response (n√É¬£o exige autentica√É¬ß√É¬£o, mas padroniza a sa√É¬≠da JSON)
@json_response 
def handle_login_api():
    """Processa login via API"""
    data = request.get_json()
    usuario = data.get('usuario', '').strip()
    senha = data.get('senha', '')
    ip_cliente = request.environ.get('REMOTE_ADDR', 'unknown')
    
    if not usuario or not senha:
        return {'success': False, 'message': 'Usu√°rio e senha s√£o obrigat√≥rios.'}, 400
    
    sucesso, mensagem = AuthService.authenticate(usuario, senha, ip_cliente)
    
    if sucesso:
        return {
            'success': True, 
            'message': mensagem,
            'user': AuthService.get_current_user(),
            'redirect': url_for('dashboard.index') # Redireciona para o novo dashboard
        }
    else:
        return {'success': False, 'message': mensagem}, 401

@auth_bp.route('/logout')
def logout():
    """Logout da nova arquitetura"""
    mensagem = AuthService.logout()
    
    if request.is_json:
        # Usa json_response aqui tamb√É¬©m, pois √É¬© uma API de logout que deve ter sa√É¬≠da padronizada
        return json_response(lambda: {'success': True, 'message': mensagem})()
    else:
        flash(mensagem, 'info')
        return redirect(url_for('auth.login'))

@auth_bp.route('/dashboard')
# Este endpoint agora ser√É¬° protegido pelo login_required_v2
# Importante: o `auth.py` original n√É¬£o tinha prote√É¬ß√É¬£o, mas o `dashboard.py` j√É¬° tem.
# Se este √É¬© um dashboard tempor√É¬°rio que ser√É¬° substitu√É¬≠do, esta rota deve ser deprecada.
# Por consist√É¬™ncia, sugiro proteg√É¬™-la com login_required_v2 se ainda estiver em uso.
# No entanto, a descri√É¬ß√É¬£o sugere que `app/blueprints/dashboard.py` √É¬© o dashboard principal.
# Vou assumir que este `auth_bp.route('/dashboard')` ser√É¬° removido no futuro,
# e o dashboard real √É¬© em `app/blueprints/dashboard.py` (que j√É¬° usa `login_required_v2`).
# Se voc√É¬™ decidir mant√É¬™-lo, adicione: `@login_required_v2`.
def dashboard():
    """Dashboard tempor√É¬°rio da nova arquitetura"""
    if not AuthService.is_authenticated():
        if request.is_json:
            return jsonify({'success': False, 'message': 'N√É¬£o autenticado'}), 401
        else:
            flash('Voc√É¬™ precisa fazer login.', 'warning')
            return redirect(url_for('auth.login'))
    
    return render_template_string(DASHBOARD_TEMPLATE, 
                                usuario=AuthService.get_current_user())

@auth_bp.route('/status')
@api_auth_required # Agora protegida e com sa√É¬≠da JSON padronizada
def auth_status():
    """Status da autentica√É¬ß√É¬£o (API)"""
    # Retorna um dicion√É¬°rio, que api_auth_required (via json_response) ir√É¬° converter para JSON e lidar com erros
    return {
        'authenticated': AuthService.is_authenticated(),
        'user': AuthService.get_current_user(),
        'session_data': {
            'login_timestamp': session.get('login_timestamp'),
            'permanent': session.permanent
        }
    }

# ========== TEMPLATES INLINE (tempor√É¬°rios) ==========

LOGIN_TEMPLATE = """
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Nova Arquitetura</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; }
        .login-container { background: white; border-radius: 15px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); max-width: 400px; width: 100%; margin: 20px; }
        .login-header { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 2rem; text-align: center; border-radius: 15px 15px 0 0; }
        .version-badge { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container d-flex justify-content-center">
        <div class="login-container">
            <div class="login-header position-relative">
                <div class="version-badge">v2.0</div>
                <i class="fas fa-building fa-3x mb-3"></i>
                <h3>Nova Arquitetura</h3>
                <p class="mb-0">Sistema Modular</p>
            </div>
            
            <div class="p-4">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'danger' else 'warning' if category == 'warning' else 'success' }} alert-dismissible fade show">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <form method="POST">
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-user"></i> Usu√°rio</label>
                        <input type="text" class="form-control" name="usuario" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-lock"></i> Senha</label>
                        <input type="password" class="form-control" name="senha" required>
                    </div>
                    
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </button>
                </form>
                
                <hr>
                <div class="text-center">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Sistema atual: <a href="http://localhost:5000/login" >localhost:5000</a>
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
"""

DASHBOARD_TEMPLATE = """
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Nova Arquitetura</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-building"></i> Nova Arquitetura v2.0
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-user"></i> {{ usuario }}
                </span>
                <a class="nav-link" href="{{ url_for('auth.logout') }}">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="alert alert-success">
                    <h4><i class="fas fa-check-circle"></i> Autentica√É¬ß√É¬£o Funcionando!</h4>
                    <p>Bem-vindo ao dashboard da nova arquitetura modular.</p>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> Informa√É¬ß√É¬µes da Sess√É¬£o</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Usu√É¬°rio:</strong> {{ usuario }}</p>
                        <p><strong>Sistema:</strong> Nova Arquitetura v2.0</p>
                        <p><strong>Fase:</strong> 3 - Autentica√É¬ß√É¬£o Modular</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-link"></i> Links √É≈°teis</h5>
                    </div>
                    <div class="card-body">
                        <p><a href="http://localhost:5000"  class="btn btn-primary btn-sm">
                            <i class="fas fa-external-link-alt"></i> Sistema Atual
                        </a></p>
                        <p><a href="{{ url_for('test.status') }}" class="btn btn-info btn-sm">
                            <i class="fas fa-cog"></i> Status do Sistema
                        </a></p>
                        <p><a href="{{ url_for('auth.auth_status') }}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-shield-alt"></i> Status da Auth
                        </a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
"""
--- Fim do cÛdigo: auth.py ---

--- InÌcio do cÛdigo: dashboard.py ---
# app/blueprints/dashboard.py
from flask import Blueprint, render_template, jsonify, request, current_app
from app.utils.auth_decorators import login_required_v2, api_auth_required # Importa api_auth_required
from app.services.sheets_service import SheetsService
from app.services.data_processor import DataProcessor
from app.services.auth_service import AuthService
from app.models.elevator import Elevator
from typing import List
import time

dashboard_bp = Blueprint('dashboard', __name__, url_prefix='/v2')

# √¢≈ì‚Ä¶ CACHE GLOBAL PARA DADOS PROCESSADOS
_dados_cache = {
    'dados_raw': None,
    'processed_data': None,
    'elevators': None,
    'timestamp': None
}

def obter_dados_cached():
    """Obt√É¬©m dados com cache inteligente"""
    global _dados_cache
    
    # Verifica se cache √É¬© v√É¬°lido (5 minutos)
    cache_valido = (
        _dados_cache['timestamp'] and 
        (time.time() - _dados_cache['timestamp']) < 300
    )
    
    if cache_valido and _dados_cache['elevators']:
        print("√∞≈∏‚Äú¬¶ Usando dados do cache")
        return _dados_cache['elevators'], _dados_cache['processed_data']
    
    # Recarrega dados
    print("√∞≈∏‚Äù‚Äû Recarregando dados (cache expirado)")
    planilha_url = current_app.config.get('PLANILHA_URL')
    if not planilha_url:
        raise ValueError("URL da planilha n√É¬£o configurada")
    
    sheets_service = SheetsService()
    data_processor = DataProcessor()
    
    dados_raw = sheets_service.obter_dados_elevadores(planilha_url)
    if dados_raw.empty:
        raise ValueError("Nenhum dado encontrado")
    
    processed_data = data_processor.process_elevators_data(dados_raw)
    elevators = [Elevator.from_dict(props) for props in processed_data['registros_processados']]
    
    # Atualiza cache
    _dados_cache.update({
        'dados_raw': dados_raw,
        'processed_data': processed_data,
        'elevators': elevators,
        'timestamp': time.time()
    })
    
    print(f"√¢≈ì‚Ä¶ Cache atualizado: {len(elevators)} elevadores")
    return elevators, processed_data


@dashboard_bp.route('/')
@dashboard_bp.route('/dashboard')
@login_required_v2 # Este √É¬© um endpoint de UI (renderiza HTML), ent√É¬£o login_required_v2 √É¬© apropriado.
def index():
    """Dashboard principal da nova arquitetura"""
    try:
        print("√∞≈∏‚Äú≈† Carregando dashboard...")
        elevators, processed_data = obter_dados_cached()
        
        data_processor = DataProcessor()
        stats = data_processor.calculate_stats(elevators)
        stats_detalhadas = calcular_estatisticas_detalhadas(elevators)
        
        print(f"√¢≈ì‚Ä¶ Dashboard carregado: {len(elevators)} elevadores, {stats['total_predios']} pr√É¬©dios")
        
        return render_template('v2/dashboard.html',
                             geojson_data=processed_data['geojson_data'],
                             stats=stats,
                             stats_detalhadas=stats_detalhadas,
                             tipos_unicos=processed_data['tipos_unicos'],
                             regioes_unicas=processed_data['regioes_unicas'],
                             marcas_unicas=processed_data['marcas_unicas'],
                             empresas_unicas=processed_data['empresas_unicas'],
                             usuario=AuthService.get_current_user(),
                             total_elevadores=len(elevators))
                             
    except Exception as e:
        print(f"√¢¬ù≈í Erro no dashboard: {e}")
        import traceback
        traceback.print_exc()
        
        return render_template('v2/dashboard.html',
                             erro=f"Erro interno: {str(e)}",
                             usuario=AuthService.get_current_user())

@dashboard_bp.route('/api/dados-elevadores-filtrados')
@api_auth_required # Este √É¬© um endpoint de API, ent√É¬£o api_auth_required √É¬© mais apropriado.
def api_dados_elevadores_filtrados():
    """API OTIMIZADA para obter dados filtrados"""
    start_time = time.time()
    
    elevators, processed_data = obter_dados_cached()
    
    tipos = request.args.getlist('tipo')
    regioes = request.args.getlist('regiao')
    marcas = request.args.getlist('marca')
    empresas = request.args.getlist('empresa')
    situacoes = request.args.getlist('situacao')
    
    print(f"√∞≈∏‚Äù¬ç API Filtros: tipos={tipos}, regioes={regioes}, situacoes={situacoes}")
    
    data_processor = DataProcessor()
    elevators_filtered = data_processor.apply_filters(
        elevators,
        tipos=tipos,
        regioes=regioes,
        marcas=marcas,
        empresas=empresas,
        situacoes=situacoes
    )
    
    stats = data_processor.calculate_stats(elevators_filtered)
    stats_detalhadas = calcular_estatisticas_detalhadas(elevators_filtered)
    
    geojson_filtrado = criar_geojson_manual(elevators_filtered)
    
    elapsed_time = time.time() - start_time
    print(f"√¢≈ì‚Ä¶ Filtros aplicados em {elapsed_time:.2f}s: {len(elevators_filtered)} elevadores")
    
    # Retorna um dicion√É¬°rio, que api_auth_required (via json_response) ir√É¬° converter para JSON e lidar com erros
    return {
        'success': True,
        'data': {
            'geojson': geojson_filtrado,
            'stats': stats,
            'stats_detalhadas': stats_detalhadas,
            'total_registros': len(elevators_filtered),
            'performance': {
                'tempo_processamento': f"{elapsed_time:.2f}s",
                'fonte_dados': 'cache'
            }
        }
    }
    
@dashboard_bp.route('/api/dados-elevadores')
@api_auth_required # Este √É¬© um endpoint de API, ent√É¬£o api_auth_required √É¬© mais apropriado.
def api_dados_elevadores():
    """
    API para obter TODOS os dados de elevadores (sem filtros)
    NOVA ROTA para suportar bot√É¬£o "Limpar Filtros"
    """
    start_time = time.time()
    print("√∞≈∏‚Äù‚Äû API: Carregando todos os dados (sem filtros)...")
    
    elevators, processed_data = obter_dados_cached()
    
    data_processor = DataProcessor()
    stats = data_processor.calculate_stats(elevators)
    stats_detalhadas = calcular_estatisticas_detalhadas(elevators)
    
    elapsed_time = time.time() - start_time
    print(f"√¢≈ì‚Ä¶ Todos os dados carregados em {elapsed_time:.2f}s: {len(elevators)} elevadores")
    
    # Retorna um dicion√É¬°rio, que api_auth_required (via json_response) ir√É¬° converter para JSON e lidar com erros
    return {
        'success': True,
        'data': {
            'geojson': processed_data['geojson_data'],
            'stats': stats,
            'stats_detalhadas': stats_detalhadas,
            'total_registros': len(elevators),
            'performance': {
                'tempo_processamento': f"{elapsed_time:.2f}s",
                'fonte_dados': 'cache'
            }
        }
    }
    
@dashboard_bp.route('/atualizar-dados', methods=['POST', 'GET'])
@api_auth_required # Este √É¬© um endpoint de API, ent√É¬£o api_auth_required √É¬© mais apropriado.
def atualizar_dados():
    """Atualiza cache de dados for√É¬ßadamente"""
    global _dados_cache
    
    _dados_cache = {
        'dados_raw': None,
        'processed_data': None,
        'elevators': None,
        'timestamp': None
    }
    
    elevators, processed_data = obter_dados_cached()
    
    # Retorna um dicion√É¬°rio, que api_auth_required (via json_response) ir√É¬° converter para JSON e lidar com erros
    return {
        'success': True,
        'message': f'Cache limpo e dados atualizados! {len(elevators)} registros processados.',
        'timestamp': time.strftime('%Y-%m-%d %H:%M:%S')
    }

def calcular_estatisticas_detalhadas(elevators):
    """
    Calcula estat√É¬≠sticas detalhadas CORRIGIDO
    IMPORTANTE: Usa a mesma l√É¬≥gica do calculate_stats para consist√É¬™ncia
    """
    from collections import defaultdict
    
    if not elevators:
        return {
            'por_tipo': {},
            'por_regiao': {},
            'por_marca': {},
            'por_status': {},
            'elevadores_parados': []
        }
    
    # √¢≈ì‚Ä¶ DETECTA TIPO DE FILTRO (mesma l√É¬≥gica do calculate_stats)
    filtro_parados = all(e.tem_elevador_parado for e in elevators)
    filtro_suspensos = all(e.status == 'Suspenso' for e in elevators)
    filtro_ativos = all(e.status == 'Em atividade' and not e.tem_elevador_parado for e in elevators)
    
    stats = {
        'por_tipo': defaultdict(int),
        'por_regiao': defaultdict(int),
        'por_marca': defaultdict(int),
        'por_status': defaultdict(int),
        'elevadores_parados': []
    }
    
    if filtro_parados:
        # √¢≈ì‚Ä¶ FILTRO "PARADOS": Conta APENAS os parados
        for elevator in elevators:
            # Por tipo/regi√É¬£o/marca: conta apenas elevadores parados
            stats['por_tipo'][elevator.tipo] += elevator.n_elevador_parado
            stats['por_regiao'][elevator.regiao] += elevator.n_elevador_parado
            stats['por_marca'][elevator.marca_licitacao] += elevator.n_elevador_parado
            
            # Por status: apenas parados
            stats['por_status']['Parados'] += elevator.n_elevador_parado
            
            # Detalhes dos elevadores parados
            stats['elevadores_parados'].append({
                'unidade': elevator.unidade,
                'cidade': elevator.cidade,
                'tipo': elevator.tipo,
                'regiao': elevator.regiao,
                'quantidade_parada': elevator.n_elevador_parado,
                'total_elevadores': elevator.quantidade,
                'marca': elevator.marca_licitacao
            })
            
    elif filtro_suspensos:
        # √¢≈ì‚Ä¶ FILTRO "SUSPENSOS": Conta APENAS os suspensos
        for elevator in elevators:
            stats['por_tipo'][elevator.tipo] += elevator.quantidade
            stats['por_regiao'][elevator.regiao] += elevator.quantidade
            stats['por_marca'][elevator.marca_licitacao] += elevator.quantidade
            stats['por_status']['Suspensos'] += elevator.quantidade
            
    elif filtro_ativos:
        # √¢≈ì‚Ä¶ FILTRO "ATIVOS": Conta APENAS os ativos
        for elevator in elevators:
            stats['por_tipo'][elevator.tipo] += elevator.quantidade
            stats['por_regiao'][elevator.regiao] += elevator.quantidade
            stats['por_marca'][elevator.marca_licitacao] += elevator.quantidade
            stats['por_status']['Em atividade'] += elevator.quantidade
            
    else:
        # √¢≈ì‚Ä¶ SEM FILTRO ou FILTRO MISTO: L√É¬≥gica completa
        for elevator in elevators:
            # Por tipo/regi√É¬£o/marca: soma total de elevadores
            stats['por_tipo'][elevator.tipo] += elevator.quantidade
            stats['por_regiao'][elevator.regiao] += elevator.quantidade
            stats['por_marca'][elevator.marca_licitacao] += elevator.quantidade
            
            # Por status: l√É¬≥gica completa
            if elevator.status == 'Suspenso':
                stats['por_status']['Suspensos'] += elevator.quantidade
            elif elevator.tem_elevador_parado:
                stats['por_status']['Parados'] += elevator.n_elevador_parado
                ativos_deste_predio = elevator.quantidade - elevator.n_elevador_parado
                stats['por_status']['Em atividade'] += ativos_deste_predio
                
                # Detalhes dos elevadores parados
                stats['elevadores_parados'].append({
                    'unidade': elevator.unidade,
                    'cidade': elevator.cidade,
                    'tipo': elevator.tipo,
                    'regiao': elevator.regiao,
                    'quantidade_parada': elevator.n_elevador_parado,
                    'total_elevadores': elevator.quantidade,
                    'marca': elevator.marca_licitacao
                })
            else:
                stats['por_status']['Em atividade'] += elevator.quantidade
    
    # Converte para dict normal e ordena
    for categoria in ['por_tipo', 'por_regiao', 'por_marca']:
        stats[categoria] = dict(sorted(stats[categoria].items(), key=lambda x: x[1], reverse=True))
    
    # Status mant√É¬©m ordem espec√É¬≠fica
    stats['por_status'] = dict(stats['por_status'])
    
    print(f"√∞≈∏‚Äú≈† Stats detalhadas: {dict(stats['por_status'])}")
    
    return stats

@dashboard_bp.route('/atualizar-dados', methods=['POST', 'GET'])
@login_required_v2
def atualizar_dados():
    """Atualiza cache de dados for√É¬ßadamente"""
    try:
        global _dados_cache
        
        # √¢≈ì‚Ä¶ OTIMIZA√É‚Ä°√É∆íO: Limpa cache para for√É¬ßar reload
        _dados_cache = {
            'dados_raw': None,
            'processed_data': None,
            'elevators': None,
            'timestamp': None
        }
        
        # For√É¬ßa nova obten√É¬ß√É¬£o
        elevators, processed_data = obter_dados_cached()
        
        return jsonify({
            'success': True,
            'message': f'Cache limpo e dados atualizados! {len(elevators)} registros processados.',
            'timestamp': time.strftime('%Y-%m-%d %H:%M:%S')
        })
        
    except Exception as e:
        print(f"√¢¬ù≈í Erro ao atualizar dados: {e}")
        return jsonify({
            'success': False,
            'message': f'Erro interno: {str(e)}'
        })

def criar_geojson_manual(elevators: List[Elevator]):
    """Cria GeoJSON otimizado"""
    features = []
    
    for elevator in elevators:
        if hasattr(elevator, 'latitude') and hasattr(elevator, 'longitude'):
            try:
                lat = float(elevator.latitude)
                lng = float(elevator.longitude)
                
                # Pula coordenadas inv√É¬°lidas
                if lat == 0 or lng == 0:
                    continue
                    
                feature = elevator.to_geojson_feature()

                # Adicione uma valida√É¬ß√É¬£o extra caso to_geojson_feature retorne None por algum motivo
                if feature:
                    features.append(feature)

            except (ValueError, TypeError):
                continue
    
    return {
        "type": "FeatureCollection",
        "features": features
    }
--- Fim do cÛdigo: dashboard.py ---

--- InÌcio do cÛdigo: kpis.py ---
# app/blueprints/kpis.py
from flask import Blueprint, render_template, current_app, jsonify, request
from app.utils.auth_decorators import login_required_v2, api_auth_required # Importamos os decoradores da v2
from app.services.sheets_service import SheetsService
from app.services.data_processor import DataProcessor
from app.services.auth_service import AuthService
from datetime import datetime
import time
import pytz # Para fusos hor√É¬°rios

kpis_bp = Blueprint('kpis', __name__, url_prefix='/v2/kpis')

# √¢≈ì‚Ä¶ CACHE GLOBAL PARA DADOS RAW DE KPIS
_kpi_dados_cache = {
    'dados_raw': None,
    'kpis_processed_list': None, # Lista de objetos KPI processados
    'metricas_calculadas': None, # M√É¬©tricas gerais calculadas a partir de todos os KPIs
    'timestamp': None
}

def obter_kpis_cached():
    """Obt√É¬©m dados de KPIs com cache inteligente."""
    global _kpi_dados_cache
    
    # Verifica se cache √É¬© v√É¬°lido (5 minutos)
    # Converta para o fuso hor√É¬°rio BRT para compara√É¬ß√É¬µes de tempo, se necess√É¬°rio
    brt = pytz.timezone("America/Sao_Paulo")
    
    cache_valido = (
        _kpi_dados_cache['timestamp'] and 
        (time.time() - _kpi_dados_cache['timestamp']) < 300 # 5 minutos
    )
    
    if cache_valido and _kpi_dados_cache['kpis_processed_list']:
        print("√∞≈∏‚Äú¬¶ KPIs: Usando dados do cache")
        return _kpi_dados_cache['kpis_processed_list'], _kpi_dados_cache['metricas_calculadas']
    
    # Recarrega dados
    print("√∞≈∏‚Äù‚Äû KPIs: Recarregando dados (cache expirado)")
    planilha_kpis_url = current_app.config.get('PLANILHA_KPIS_URL')
    if not planilha_kpis_url:
        raise ValueError("√¢¬ù≈í PLANILHA_KPIS_URL deve ser definida como vari√É¬°vel de ambiente")
    
    sheets_service = SheetsService()
    data_processor = DataProcessor()
    
    dados_raw = sheets_service.obter_dados_kpis(planilha_kpis_url)
    if dados_raw.empty:
        raise ValueError("√¢¬ù≈í Nenhum dado de KPIs encontrado")
    
    # process_kpis_data agora retorna List[KPI]
    kpis_processed_list = data_processor.process_kpis_data(dados_raw) 
    # _calculate_kpi_metrics espera uma List[KPI]
    metricas_calculadas = data_processor._calculate_kpi_metrics(kpis_processed_list) 
    
    # Atualiza cache
    _kpi_dados_cache.update({
        'dados_raw': dados_raw,
        'kpis_processed_list': kpis_processed_list,
        'metricas_calculadas': metricas_calculadas,
        'timestamp': time.time()
    })
    
    print(f"√¢≈ì‚Ä¶ KPIs: Cache atualizado com {len(kpis_processed_list)} registros.")
    return kpis_processed_list, metricas_calculadas

@kpis_bp.route('/')
@login_required_v2
def index():
    """Dashboard principal de KPIs"""
    try:
        print("√∞≈∏‚Äú≈† KPIs: Carregando dashboard...")
        
        # Apenas chamamos obter_kpis_cached. N√É¬£o precisamos da lista completa aqui,
        # apenas das m√É¬©tricas iniciais para popular os cards e filtros.
        _, metricas_iniciais = obter_kpis_cached() 
        
        # Obter listas √É¬∫nicas para preencher filtros, como categorias e edif√É¬≠cios
        # Podemos pegar isso das metricas_iniciais ou processar a lista completa de KPIs.
        # Para evitar processamento extra na UI, vamos extrair dos kpis_processed_list
        kpis_list, _ = obter_kpis_cached() # Obtem a lista completa para filtros
        
        categorias_unicas = sorted(list(set(k.categoria_problema for k in kpis_list if k.categoria_problema)))
        edificios_unicos = sorted(list(set(k.edificio for k in kpis_list if k.edificio)))
        equipamentos_unicos = sorted(list(set(k.equipamento for k in kpis_list if k.equipamento)))

        print(f"√¢≈ì‚Ä¶ KPIs: Dashboard carregado. Total chamados: {metricas_iniciais.get('total_chamados', 0)}")
        
        return render_template('v2/kpis.html',
                             metricas=metricas_iniciais,
                             categorias_unicas=categorias_unicas,
                             edificios_unicos=edificios_unicos,
                             equipamentos_unicos=equipamentos_unicos,
                             usuario=AuthService.get_current_user())
                             
    except Exception as e:
        print(f"√¢¬ù≈í KPIs: Erro no dashboard: {e}")
        current_app.logger.exception(f"Erro ao carregar dashboard de KPIs: {e}") # Usando o logger
        return render_template('v2/kpis.html',
                             erro=f"Erro interno ao carregar KPIs: {str(e)}",
                             usuario=AuthService.get_current_user())

@kpis_bp.route('/atualizar-kpis', methods=['POST', 'GET'])
@api_auth_required # Protege e padroniza a resposta para esta API
def atualizar_dados_kpis():
    """Atualiza cache de dados de KPIs for√É¬ßadamente."""
    global _kpi_dados_cache
    
    # Limpa cache para for√É¬ßar reload
    _kpi_dados_cache = {
        'dados_raw': None,
        'kpis_processed_list': None,
        'metricas_calculadas': None,
        'timestamp': None
    }
    
    # For√É¬ßa nova obten√É¬ß√É¬£o
    try:
        kpis_list, _ = obter_kpis_cached()
        return {
            'success': True,
            'message': f'Cache de KPIs limpo e dados atualizados! {len(kpis_list)} registros processados.',
            'timestamp': datetime.now(pytz.timezone("America/Sao_Paulo")).strftime('%Y-%m-%d %H:%M:%S')
        }
    except Exception as e:
        current_app.logger.exception(f"Erro ao atualizar cache de KPIs: {e}")
        return {
            'success': False,
            'message': f'Erro interno ao atualizar KPIs: {str(e)}'
        }, 500
--- Fim do cÛdigo: kpis.py ---

--- InÌcio do cÛdigo: test.py ---
# app/blueprints/test.py
"""
Blueprint de teste - VERS√É∆íO CORRIGIDA COM PREFIXO
"""
from flask import Blueprint, jsonify
from datetime import datetime

# Cria o blueprint
test_bp = Blueprint('test', __name__)

@test_bp.route('/')
def index():
    """P√É¬°gina inicial tempor√É¬°ria"""
    return jsonify({
        'message': 'Nova arquitetura funcionando!',
        'timestamp': datetime.now().isoformat(),
        'routes_available': [
            '/ (esta p√É¬°gina)',
            '/test/health',
            '/test/config',
            '/test/services/models',
            '/test/services/data-processor',
            '/test/services/auth-service'
        ]
    })

# √¢≈ì‚Ä¶ MUDAN√É‚Ä°A: Adicionar prefixo /test/ nas rotas
@test_bp.route('/test/health')
def health_check():
    """Health check"""
    return jsonify({
        'status': 'OK',
        'message': 'Health check passou!',
        'timestamp': datetime.now().isoformat(),
        'version': '2.0-corrigido'
    })

@test_bp.route('/test/config')
def test_config():
    """Teste de config"""
    from flask import current_app
    return jsonify({
        'status': 'OK',
        'debug': current_app.config.get('DEBUG'),
        'secret_key_set': bool(current_app.config.get('SECRET_KEY')),
        'cache_active': hasattr(current_app, 'cache_service')
    })

# √¢≈ì‚Ä¶ ROTA ADICIONAL: Status geral
@test_bp.route('/test/status')
def status():
    """Status completo da aplica√É¬ß√É¬£o"""
    from flask import current_app
    
    # Lista todas as rotas
    routes = []
    with current_app.app_context():
        for rule in current_app.url_map.iter_rules():
            if not rule.rule.startswith('/static'):
                routes.append({
                    'rule': rule.rule,
                    'methods': list(rule.methods - {'HEAD', 'OPTIONS'}),
                    'endpoint': rule.endpoint
                })
    
    return jsonify({
        'status': 'OK',
        'message': 'Aplica√É¬ß√É¬£o funcionando perfeitamente!',
        'timestamp': datetime.now().isoformat(),
        'version': '2.0-fase2',
        'blueprints': list(current_app.blueprints.keys()),
        'routes': routes,
        'config': {
            'debug': current_app.config.get('DEBUG'),
            'cache_timeout': current_app.config.get('CACHE_TIMEOUT'),
            'users_count': len(current_app.config.get('USUARIOS_AUTORIZADOS', {}))
        }
    })
--- Fim do cÛdigo: test.py ---

--- InÌcio do cÛdigo: test_auth.py ---
# app/blueprints/test_auth.py
from flask import Blueprint, jsonify, request, session
from app.services.auth_service import AuthService
from app.utils.auth_decorators import login_required_v2, api_auth_required, json_response # Importa json_response

test_auth_bp = Blueprint('test_auth', __name__, url_prefix='/test/auth')

@test_auth_bp.route('/debug-session')
@api_auth_required # Protege este endpoint que revela informa√É¬ß√É¬µes de sess√É¬£o e padroniza a sa√É¬≠da JSON
def debug_session():
    """Debug completo da sess√É¬£o"""
    # Retorna um dicion√É¬°rio, api_auth_required (via json_response) ir√É¬° jsonify
    return {
        'session_data': dict(session),
        'session_keys': list(session.keys()),
        'usuario_logado': session.get('usuario_logado'),
        'auth_v2': session.get('auth_v2'),
        'login_timestamp': session.get('login_timestamp'),
        'session_permanent': session.permanent,
        'is_authenticated': AuthService.is_authenticated(),
        'current_user': AuthService.get_current_user()
    }

@test_auth_bp.route('/public')
@json_response # Endpoint p√É¬∫blico, mas que deve ter resposta JSON padronizada
def public_endpoint():
    """Endpoint p√É¬∫blico (sem autentica√É¬ß√É¬£o)"""
    # Retorna um dicion√É¬°rio, json_response ir√É¬° jsonify
    return {
        'status': 'OK',
        'message': 'Endpoint p√É¬∫blico funcionando',
        'authenticated': AuthService.is_authenticated(),
        'user': AuthService.get_current_user() if AuthService.is_authenticated() else None,
        'session_info': {
            'has_usuario_logado': 'usuario_logado' in session,
            'has_auth_v2': 'auth_v2' in session,
            'session_keys': list(session.keys())
        }
    }

@test_auth_bp.route('/protected')
@login_required_v2 # Endpoint protegido de UI (embora retorne JSON, o prop√É¬≥sito do teste √É¬© UI-like protection)
def protected_endpoint():
    """Endpoint protegido (com autentica√É¬ß√É¬£o)"""
    return jsonify({ # J√É¬° retorna jsonify, ent√É¬£o json_response n√É¬£o √É¬© estritamente necess√É¬°rio aqui se login_required_v2 cuida apenas do auth.
        'status': 'OK',
        'message': 'Endpoint protegido acessado com sucesso!',
        'user': AuthService.get_current_user(),
        'session_info': {
            'login_timestamp': session.get('login_timestamp'),
            'permanent': session.permanent,
            'auth_v2': session.get('auth_v2')
        }
    })

@test_auth_bp.route('/api-protected')
@api_auth_required # J√É¬° usa e est√É¬° correto.
def api_protected_endpoint():
    """Endpoint de API protegido"""
    # Retorna um dicion√É¬°rio, api_auth_required (via json_response) ir√É¬° jsonify
    return {
        'success': True,
        'message': 'API protegida acessada com sucesso!',
        'user': AuthService.get_current_user(),
        'timestamp': session.get('login_timestamp')
    }

@test_auth_bp.route('/login-test', methods=['POST'])
@json_response # Endpoint de API para login, n√É¬£o protegido por auth_required (pois √É¬© o login), mas precisa de JSON padronizado
def login_test():
    """Endpoint para testar login via API"""
    if not request.is_json:
        return {'success': False, 'message': 'JSON required'}, 400 # json_response ir√É¬° jsonify
    
    data = request.get_json()
    usuario = data.get('usuario')
    senha = data.get('senha')
    ip_cliente = request.environ.get('REMOTE_ADDR', 'test')
    
    print(f"√∞≈∏‚Äù‚Äò Tentativa de login: {usuario}")
    
    sucesso, mensagem = AuthService.authenticate(usuario, senha, ip_cliente)
    
    print(f"√∞≈∏‚Äù‚Äò Resultado do login: {sucesso}")
    
    # Retorna um dicion√É¬°rio, json_response ir√É¬° jsonify
    return {
        'success': sucesso,
        'message': mensagem,
        'user': AuthService.get_current_user() if sucesso else None,
        'session_after_login': {
            'usuario_logado': session.get('usuario_logado'),
            'auth_v2': session.get('auth_v2'),
            'session_keys': list(session.keys())
        }
    }

@test_auth_bp.route('/logout-test', methods=['POST'])
@json_response # Endpoint de API para logout, n√É¬£o protegido por auth_required, mas precisa de JSON padronizado
def logout_test():
    """Endpoint para testar logout via API"""
    print(f"√∞≈∏≈°¬™ Tentativa de logout")
    mensagem = AuthService.logout()
    
    # Retorna um dicion√É¬°rio, json_response ir√É¬° jsonify
    return {
        'success': True,
        'message': mensagem,
        'session_after_logout': {
            'session_keys': list(session.keys()),
            'is_authenticated': AuthService.is_authenticated()
        }
    }

@test_auth_bp.route('/session-info')
@api_auth_required # Este endpoint revela informa√É¬ß√É¬µes de sess√É¬£o, ent√É¬£o deve ser protegido.
def session_info():
    """Informa√É¬ß√É¬µes da sess√É¬£o atual"""
    # Retorna um dicion√É¬°rio, api_auth_required (via json_response) ir√É¬° jsonify
    return {
        'session_data': dict(session),
        'authenticated': AuthService.is_authenticated(),
        'user': AuthService.get_current_user(),
        'session_permanent': session.permanent
    }
--- Fim do cÛdigo: test_auth.py ---

--- InÌcio do cÛdigo: test_services.py ---
# app/blueprints/test_services.py
"""
Blueprint para testar os novos servi√É¬ßos
"""
from flask import Blueprint, jsonify
from app.services.data_processor import DataProcessor
from app.services.auth_service import AuthService
from app.models.elevator import Elevator
from app.models.kpi import KPI
import pandas as pd

test_services_bp = Blueprint('test_services', __name__)

@test_services_bp.route('/models')
def test_models():
    """Testa os models"""
    try:
        # Testa Elevator
        elevator_data = {
            'cidade': 'Belo Horizonte',
            'unidade': 'F√É¬≥rum Central',
            'endereco': 'Rua Teste, 123',
            'endereco_completo': 'Rua Teste, 123 - Centro',
            'tipo': 'Passageiro',
            'quantidade': 3,
            'marca': 'Atlas',
            'marca_licitacao': 'Atlas Schindler',
            'paradas': 10,
            'regiao': 'Metropolitana',
            'status': 'Em atividade',
            'empresa': 'Empresa Teste',
            'latitude': -19.92,
            'longitude': -43.92,
            'n_elevador_parado': 1
        }
        
        elevator = Elevator(**elevator_data)
        
        return jsonify({
            'status': 'OK',
            'elevator_test': {
                'tem_parado': elevator.tem_elevador_parado,
                'esta_suspenso': elevator.esta_suspenso,
                'elevadores_ativos': elevator.elevadores_ativos,
                'cor_marcador': elevator.cor_marcador,
                'geojson': elevator.to_geojson_feature()
            }
        })
    except Exception as e:
        return jsonify({'status': 'ERROR', 'message': str(e)}), 500

@test_services_bp.route('/data-processor')
def test_data_processor():
    """Testa o DataProcessor"""
    try:
        # Cria dados de teste
        test_data = pd.DataFrame([
            {
                'cidade': 'Belo Horizonte',
                'unidade': 'F√É¬≥rum Central',
                'endereco': 'Rua Teste, 123',
                'enderecoCompleto': 'Rua Teste, 123 - Centro',
                'tipo': 'Passageiro',
                'quantidade': 3,
                'marca': 'Atlas',
                'marcaLicitacao': 'Atlas Schindler',
                'paradas': 10,
                'regiao': 'Metropolitana',
                'status': 'Em atividade',
                'empresa': 'Empresa Teste',
                'latitude': '-19.92',
                'longitude': '-43.92',
                'NElevadorParado': 1
            }
        ])
        
        processor = DataProcessor()
        result = processor.process_elevators_data(test_data)
        
        return jsonify({
            'status': 'OK',
            'processed_count': len(result['elevators']),
            'geojson_features': len(result['geojson_data']['features']),
            'compatibility_count': len(result['registros_processados'])
        })
    except Exception as e:
        return jsonify({'status': 'ERROR', 'message': str(e)}), 500

@test_services_bp.route('/auth-service')
def test_auth_service():
    """Testa o AuthService (sem fazer login real)"""
    try:
        # Testa apenas se o servi√É¬ßo est√É¬° funcionando
        is_auth = AuthService.is_authenticated()
        current_user = AuthService.get_current_user()
        
        return jsonify({
            'status': 'OK',
            'is_authenticated': is_auth,
            'current_user': current_user,
            'service_loaded': True
        })
    except Exception as e:
        return jsonify({'status': 'ERROR', 'message': str(e)}), 500
--- Fim do cÛdigo: test_services.py ---

--- InÌcio do cÛdigo: __init__.py ---
# app/api/blueprints.py
"""
Blueprints da aplica√É¬ß√É¬£o
"""
# Importa todos os blueprints para garantir que sejam registrados
from .test import test_bp
from .test_services import test_services_bp

__all__ = ['test_bp', 'test_services_bp']
--- Fim do cÛdigo: __init__.py ---

--- InÌcio do cÛdigo: base.py ---
# app/config/base.py
import os
from datetime import timedelta
from werkzeug.security import generate_password_hash

class BaseConfig:
    """Configura√É¬ß√É¬µes base compartilhadas entre ambientes"""
    
    # Configura√É¬ß√É¬µes Flask
    SECRET_KEY = os.environ.get('FLASK_SECRET_KEY')
    PERMANENT_SESSION_LIFETIME = timedelta(hours=1)
    
    # URLs das planilhas - USANDO VARI√É¬ÅVEIS DE AMBIENTE
    PLANILHA_URL = os.environ.get('PLANILHA_URL')
    PLANILHA_KPIS_URL = os.environ.get('PLANILHA_KPIS_URL')
    
    # Cache
    CACHE_TIMEOUT = int(os.environ.get('CACHE_TIMEOUT', '300'))  # 5 minutos
    
    # Seguran√É¬ßa
    MAX_TENTATIVAS_LOGIN = int(os.environ.get('MAX_TENTATIVAS_LOGIN', '5'))
    BLOQUEIO_TEMPO = int(os.environ.get('BLOQUEIO_TEMPO', '900'))  # 15 minutos
    
    def __init__(self):
        """Inicializa configura√É¬ß√É¬µes que dependem de m√É¬©todos"""
        self.USUARIOS_AUTORIZADOS = self._get_usuarios_autorizados()
        
        # √¢≈ì‚Ä¶ VALIDA√É‚Ä°√É∆íO DAS URLs OBRIGAT√É‚ÄúRIAS
        if not self.PLANILHA_URL:
            raise ValueError("√¢¬ù≈í PLANILHA_URL deve ser definida como vari√É¬°vel de ambiente")
        if not self.PLANILHA_KPIS_URL:
            raise ValueError("√¢¬ù≈í PLANILHA_KPIS_URL deve ser definida como vari√É¬°vel de ambiente")
    
    def _get_usuarios_autorizados(self):
        """Carrega usu√É¬°rios das vari√É¬°veis de ambiente"""
        usuarios = {}
        
        # Formato: USUARIO_1=nome:senha, USUARIO_2=nome:senha, etc.
        for i in range(1, 11):  # Suporta at√É¬© 10 usu√É¬°rios
            user_env = os.environ.get(f'USUARIO_{i}')
            if user_env and ':' in user_env:
                nome, senha = user_env.split(':', 1)
                usuarios[nome] = generate_password_hash(senha)
        
        # Fallback para desenvolvimento
        if not usuarios:
            usuarios = {
                'admin': generate_password_hash('admin123'),
                'usuario': generate_password_hash('senha123')
            }
            
        print(f"√∞≈∏‚Äù¬ê {len(usuarios)} usu√É¬°rio(s) carregado(s)")
        return usuarios
    
    @classmethod
    def listar_usuarios(cls):
        """Lista usu√É¬°rios cadastrados (para debug)"""
        instance = cls()
        usuarios = instance.USUARIOS_AUTORIZADOS
        for usuario in usuarios.keys():
            print(f"   - {usuario}")
--- Fim do cÛdigo: base.py ---

--- InÌcio do cÛdigo: development.py ---
# app/config/development.py
from .base import BaseConfig

class DevelopmentConfig(BaseConfig):
    """Configura√ß√µes para ambiente de desenvolvimento"""
    
    DEBUG = True
    TESTING = False
    
    def __init__(self):
        super().__init__()
        # Cache mais curto em desenvolvimento
        self.CACHE_TIMEOUT = 60  # 1 minuto
        
        # Logs mais verbosos
        self.LOG_LEVEL = 'DEBUG'
    
    @classmethod
    def listar_usuarios(cls):
        """Sobrescreve para mostrar informa√ß√µes de desenvolvimento"""
        print("üîß AMBIENTE DE DESENVOLVIMENTO")
        instance = cls()
        usuarios = instance.USUARIOS_AUTORIZADOS
        for usuario in usuarios.keys():
            print(f"   - {usuario}")
        print("   üí° Senhas padr√£o: admin123, senha123")
--- Fim do cÛdigo: development.py ---

--- InÌcio do cÛdigo: production.py ---
# app/config/production.py
from .base import BaseConfig

class ProductionConfig(BaseConfig):
    """Configura√ß√µes para ambiente de produ√ß√£o"""
    
    DEBUG = False
    TESTING = False
    
    def __init__(self):
        super().__init__()
        # Cache mais longo em produ√ß√£o
        self.CACHE_TIMEOUT = 600  # 10 minutos
        
        # Logs menos verbosos
        self.LOG_LEVEL = 'INFO'
        
        # Seguran√ßa refor√ßada
        self.MAX_TENTATIVAS_LOGIN = 3
        self.BLOQUEIO_TEMPO = 1800  # 30 minutos
    
    @classmethod
    def listar_usuarios(cls):
        """Sobrescreve para n√£o mostrar informa√ß√µes sens√≠veis"""
        instance = cls()
        usuarios = instance.USUARIOS_AUTORIZADOS
        print("üîí AMBIENTE DE PRODU√á√ÉO")
        print(f"   üë• {len(usuarios)} usu√°rio(s) carregado(s)")
--- Fim do cÛdigo: production.py ---

--- InÌcio do cÛdigo: __init__.py ---
# app/config/__init__.py
import os

# ‚úÖ CARREGA .env ANTES DE TUDO
try:
    from dotenv import load_dotenv
    load_dotenv()
    print("‚úÖ Arquivo .env carregado com sucesso")
except ImportError:
    print("‚ö†Ô∏è python-dotenv n√£o instalado, usando apenas vari√°veis do sistema")

from .base import BaseConfig
from .development import DevelopmentConfig
from .production import ProductionConfig

def get_config():
    """Retorna a configura√ß√£o baseada no ambiente"""
    env = os.environ.get('FLASK_ENV', 'development')
    
    if env == 'production':
        return ProductionConfig()
    else:
        return DevelopmentConfig()

# Para compatibilidade com o c√≥digo atual
Config = get_config()
--- Fim do cÛdigo: __init__.py ---

--- InÌcio do cÛdigo: elevator.py ---
#app/models/elevator.py
"""
Modelo para representar um elevador
"""
from dataclasses import dataclass, asdict
from typing import Optional, Dict, Any

@dataclass
class Elevator:
    """Modelo para representar um elevador"""
    cidade: str
    unidade: str
    endereco: str
    endereco_completo: str
    tipo: str
    quantidade: int
    marca: str
    marca_licitacao: str
    paradas: int
    regiao: str
    status: str
    empresa: str
    latitude: float
    longitude: float
    n_elevador_parado: int = 0
    data_de_parada: Optional[str] = None
    previsao_de_retorno: Optional[str] = None
    
    @property
    def tem_elevador_parado(self) -> bool:
        """Verifica se h√É¬° elevadores parados"""
        return self.n_elevador_parado > 0
    
    @property
    def esta_suspenso(self) -> bool:
        """Verifica se est√É¬° suspenso"""
        return 'suspenso' in self.status.lower()
    
    @property
    def elevadores_ativos(self) -> int:
        """Calcula elevadores ativos"""
        if self.esta_suspenso:
            return 0
        return max(0, self.quantidade - self.n_elevador_parado)
    
    @property
    def cor_marcador(self) -> str:
        """Define cor do marcador baseado no status"""
        if self.tem_elevador_parado:
            return '#dc3545'  # Vermelho para parados
        elif self.esta_suspenso:
            return '#ffc107'  # Amarelo para suspensos
        elif 'atividade' in self.status.lower():
            return '#28a745'  # Verde para ativos
        return '#6c757d'  # Cinza padr√É¬£o
    
    @property
    def tamanho_marcador(self) -> int:
        """Define tamanho do marcador baseado na quantidade"""
        if self.quantidade >= 5:
            return 10
        elif self.quantidade >= 3:
            return 8
        return 6
    
    def to_dict(self) -> Dict[str, Any]:
        output_dict = asdict(self)
        
        keys_to_remove = [
            'quantidade',
            'endereco_completo',
            'marca_licitacao',
            'n_elevador_parado',
            'data_de_parada',
            'previsao_de_retorno',
            # REMOVA AQUI 'cor_marcador' e 'tamanho_marcador'
            'cor_marcador',      # <-- REMOVER
            'tamanho_marcador',  # <-- REMOVER
        ]
        for key in keys_to_remove:
            output_dict.pop(key, None)

        output_dict.update({
            'qtd_elev': self.quantidade,
            'enderecoCompleto': self.endereco_completo,
            'marcaLicitacao': self.marca_licitacao,
            'nElevadorParado': self.n_elevador_parado,
            'dataDeParada': self.data_de_parada,
            'previsaoDeRetorno': self.previsao_de_retorno,
            'temElevadorParado': self.tem_elevador_parado,
            # ADICIONE AQUI AS VERS√ïES EM CAMELCASE das propriedades
            'corMarcador': self.cor_marcador,      # <-- ADICIONAR
            'tamanhoMarcador': self.tamanho_marcador # <-- ADICIONAR
        })
        return output_dict
    
    def to_geojson_feature(self) -> Dict[str, Any]:
        """Converte para feature GeoJSON"""
        return {
            "type": "Feature",
            "geometry": {
                "type": "Point",
                "coordinates": [self.longitude, self.latitude]
            },
            "properties": self.to_dict()
        }
    
    @classmethod
    def from_dict(cls, data: Dict[str, Any]) -> 'Elevator':
        """Cria inst√É¬¢ncia a partir de dicion√É¬°rio"""
        # Mapeia campos com nomes diferentes
        field_mapping = {
            'qtd_elev': 'quantidade',
            'enderecoCompleto': 'endereco_completo',
            'marcaLicitacao': 'marca_licitacao',
            'nElevadorParado': 'n_elevador_parado',
            'dataDeParada': 'data_de_parada',
            'previsaoDeRetorno': 'previsao_de_retorno',
            'NElevadorParado': 'n_elevador_parado',
            'DataDeParada': 'data_de_parada',
            'PrevisaoDeRetorno': 'previsao_de_retorno'
        }
        
        # Normaliza os dados
        normalized_data = {}
        for key, value in data.items():
            new_key = field_mapping.get(key, key)
            normalized_data[new_key] = value
        
        # Remove campos que n√É¬£o existem no modelo
        valid_fields = {f.name for f in cls.__dataclass_fields__.values()}
        filtered_data = {k: v for k, v in normalized_data.items() if k in valid_fields}
        
        return cls(**filtered_data)
--- Fim do cÛdigo: elevator.py ---

--- InÌcio do cÛdigo: kpi.py ---
#app/models/kpi.py
"""
Modelo para representar um KPI de manuten√É¬ß√É¬£o
"""
from dataclasses import dataclass, asdict
from datetime import datetime
from typing import Optional, Dict, Any
import pandas as pd

@dataclass
class KPI:
    """Modelo para representar um KPI de manuten√É¬ß√É¬£o"""
    edificio: str
    categoria_problema: str
    status: str
    data_solicitacao: datetime
    data_conclusao: Optional[datetime] = None
    equipamento: Optional[str] = None
    
    @property
    def tempo_reparo_horas(self) -> Optional[float]:
        """Calcula tempo de reparo em horas"""
        if self.data_conclusao and self.data_solicitacao:
            return (self.data_conclusao - self.data_solicitacao).total_seconds() / 3600
        return None
    
    @property
    def esta_concluido(self) -> bool:
        """Verifica se est√É¬° conclu√É¬≠do"""
        return self.status.lower() == 'conclu√É¬≠da'
    
    @property
    def mes_ano(self) -> str:
        """Retorna per√É¬≠odo m√É¬™s/ano"""
        return self.data_solicitacao.strftime('%Y-%m')
    
    def to_dict(self) -> Dict[str, Any]:
        """Converte para dicion√É¬°rio"""
        data = asdict(self)
        # Converte datas para string para JSON
        if self.data_solicitacao:
            data['data_solicitacao'] = self.data_solicitacao.isoformat()
        if self.data_conclusao:
            data['data_conclusao'] = self.data_conclusao.isoformat()
        return data
    
    @classmethod
    def from_dict(cls, data: Dict[str, Any]) -> 'KPI':
        """Cria inst√É¬¢ncia a partir de dicion√É¬°rio"""
        # Converte strings de data para datetime
        if isinstance(data.get('data_solicitacao'), str):
            try:
                data['data_solicitacao'] = pd.to_datetime(data['data_solicitacao'])
            except:
                data['data_solicitacao'] = datetime.now()
        
        if isinstance(data.get('data_conclusao'), str):
            try:
                data['data_conclusao'] = pd.to_datetime(data['data_conclusao'])
            except:
                data['data_conclusao'] = None
        
        # Remove campos que n√É¬£o existem no modelo
        valid_fields = {f.name for f in cls.__dataclass_fields__.values()}
        filtered_data = {k: v for k, v in data.items() if k in valid_fields}
        
        return cls(**filtered_data)
--- Fim do cÛdigo: kpi.py ---

--- InÌcio do cÛdigo: __init__.py ---
#app/models/__init__.py

"""
Models da aplica√ß√£o
"""
from .elevator import Elevator
from .kpi import KPI

__all__ = ['Elevator', 'KPI']
--- Fim do cÛdigo: __init__.py ---

--- InÌcio do cÛdigo: auth_service.py ---
# app/services/auth_service.py
"""
Servi√ßo de autentica√ß√£o - VERS√É∆íO CORRIGIDA
"""
from datetime import datetime, timedelta
from flask import current_app, session
from werkzeug.security import check_password_hash
from typing import Tuple
import pytz

class AuthService:
    """Servi√ßo de autentica√ß√£o"""
    
    @staticmethod
    def authenticate(usuario: str, senha: str, ip_cliente: str) -> Tuple[bool, str]:
        """
        Autentica usu√É¬°rio
        Returns: (sucesso, mensagem)
        """
        from app.utils.auth_helpers import (
            verificar_tentativas_login, 
            registrar_tentativa_login,
            limpar_tentativas_login
        )
        
        # Verifica tentativas
        pode_tentar, bloqueado_ate = verificar_tentativas_login(ip_cliente)
        if not pode_tentar:
            tempo_restante = int((bloqueado_ate - datetime.now()).seconds / 60)
            return False, f'Muitas tentativas. Tente em {tempo_restante} minutos.'
        
        # Valida credenciais
        usuarios_autorizados = current_app.config['USUARIOS_AUTORIZADOS']
        if usuario in usuarios_autorizados:
            if check_password_hash(usuarios_autorizados[usuario], senha):
                # Login bem-sucedido
                limpar_tentativas_login(ip_cliente)
                AuthService.create_session(usuario)
                return True, f'Bem-vindo, {usuario}!'
            else:
                registrar_tentativa_login(ip_cliente)
                return False, 'Usu√É¬°rio ou senha incorretos.'
        else:
            registrar_tentativa_login(ip_cliente)
            return False, 'Usu√É¬°rio ou senha incorretos.'
    
    @staticmethod
    def create_session(usuario: str):
        """Cria sess√£o do usu√É¬°rio"""
        session['usuario_logado'] = usuario
        session['auth_v2'] = True  # √¢≈ì‚Ä¶ NOVO: Flag espec√É¬≠fica para v2
        brt = pytz.timezone("America/Sao_Paulo")
        session['login_timestamp'] = datetime.now(brt).isoformat()
        session.permanent = True
        print(f"√∞≈∏‚Äù‚Äò Sess√£o criada para {usuario} - auth_v2: {session.get('auth_v2')}")
    
    @staticmethod
    def logout() -> str:
        """Faz logout do usu√É¬°rio"""
        usuario = session.get('usuario_logado', 'Usu√É¬°rio')
        print(f"√∞≈∏≈°¬™ Logout do usu√É¬°rio: {usuario}")
        session.clear()
        return f'Logout realizado. At√É¬© logo, {usuario}!'
    
    @staticmethod
    def is_authenticated() -> bool:
        """
        Verifica se usu√É¬°rio est√É¬° autenticado
        √¢≈ì‚Ä¶ CORRIGIDO: Verifica√ß√£o mais robusta
        """
        # Verifica se tem usu√É¬°rio logado E flag auth_v2
        has_user = 'usuario_logado' in session and session.get('usuario_logado')
        has_auth_flag = session.get('auth_v2', False)
        
        is_auth = has_user and has_auth_flag
        
        print(f"√∞≈∏‚Äù¬ç Verificando autentica√ß√£o:")
        print(f"   - usuario_logado: {session.get('usuario_logado')}")
        print(f"   - auth_v2 flag: {session.get('auth_v2')}")
        print(f"   - is_authenticated: {is_auth}")
        
        return is_auth
    
    @staticmethod
    def get_current_user() -> str:
        """Retorna usu√É¬°rio atual"""
        if AuthService.is_authenticated():
            return session.get('usuario_logado', '')
        return ''
--- Fim do cÛdigo: auth_service.py ---

--- InÌcio do cÛdigo: cache_service.py ---
# app/services/cache_service.py
import time
from datetime import datetime
from flask import current_app

class CacheService:
    def __init__(self, default_expiration=300):
        """Inicializa o servi√ßo de cache com um tempo de expira√ß√£o padr√£o de 5 minutos."""
        self.cache = {}
        self.default_expiration = default_expiration

    def set(self, key, value, expiration=None):
        """Armazena um valor no cache com a chave especificada."""
        if expiration is None:
            expiration = self.default_expiration
            
        self.cache[key] = {
            'value': value,
            'timestamp': time.time(),
            'expiration': expiration
        }
        print(f"√∞≈∏‚Äú¬¶ Cache SET: {key} (expira em {expiration}s)")

    def get(self, key):
        """Recupera um valor do cache se ainda for v√É¬°lido."""
        if key in self.cache:
            entry = self.cache[key]
            age = time.time() - entry['timestamp']
            
            if age < entry['expiration']:
                print(f"√∞≈∏‚Äú¬¶ Cache HIT: {key} (idade: {age:.1f}s)")
                return entry['value']
            else:
                # Expirado
                print(f"√∞≈∏‚Äú¬¶ Cache EXPIRED: {key} (idade: {age:.1f}s)")
                del self.cache[key]
        
        print(f"√Ø¬ø¬Ω√Ø¬ø¬Ω Cache MISS: {key}")
        return None

    def delete(self, key):
        """Remove uma chave espec√É¬≠fica do cache."""
        if key in self.cache:
            del self.cache[key]
            print(f"√∞≈∏‚Äú¬¶ Cache DELETE: {key}")

    def clear(self):
        """Limpa todo o cache."""
        keys_count = len(self.cache)
        self.cache.clear()
        print(f"√Ø¬ø¬Ω√Ø¬ø¬Ω Cache CLEAR: {keys_count} chaves removidas")

    def get_stats(self):
        """Retorna estat√É¬≠sticas do cache."""
        now = time.time()
        active_keys = []
        expired_keys = []
        
        for key, entry in self.cache.items():
            age = now - entry['timestamp']
            if age < entry['expiration']:
                active_keys.append({
                    'key': key,
                    'age': age,
                    'expires_in': entry['expiration'] - age
                })
            else:
                expired_keys.append(key)
        
        # Remove chaves expiradas
        for key in expired_keys:
            del self.cache[key]
        
        return {
            'active_keys': len(active_keys),
            'expired_keys_removed': len(expired_keys),
            'keys_detail': active_keys
        }

    def is_expired(self, key):
        """Verifica se uma chave espec√É¬≠fica est√É¬° expirada."""
        if key not in self.cache:
            return True
        
        entry = self.cache[key]
        age = time.time() - entry['timestamp']
        return age >= entry['expiration']
--- Fim do cÛdigo: cache_service.py ---

--- InÌcio do cÛdigo: data_processor.py ---
# app/services/data_processor.py
"""
Processador de dados refatorado com models
"""
import pandas as pd
from datetime import datetime, timedelta
from typing import List, Dict, Any, Tuple
from app.utils.helpers import safe_int, safe_str, safe_float, validate_coordinates
from app.models.elevator import Elevator
from app.models.kpi import KPI

class DataProcessor:
    def __init__(self, data=None):
        """Inicializa o processador com os dados brutos."""
        self.raw_data = data
        self.processed_data = None

    def process_elevators_data(self, data: pd.DataFrame) -> Dict[str, Any]:
        """
        Processa dados de elevadores para o mapa
        MANT√É‚Ä∞M COMPATIBILIDADE com c√É¬≥digo atual
        """
        elevators = []
        registros_processados = []
        
        print(f"√∞≈∏‚Äî¬∫√Ø¬∏¬è Processando {len(data)} registros para o mapa...")
        
        for idx, row in data.iterrows():
            try:
                # Valida coordenadas
                lat_str = safe_str(row.get('latitude', '')).strip()
                lon_str = safe_str(row.get('longitude', '')).strip()
                
                if not lat_str or not lon_str or lat_str == 'nan' or lon_str == 'nan':
                    continue
                
                is_valid, lat, lon = validate_coordinates(lat_str, lon_str)
                if not is_valid:
                    continue
                
                # Cria modelo Elevator
                elevator_data = {
                    'cidade': safe_str(row.get('cidade')),
                    'unidade': safe_str(row.get('unidade')),
                    'endereco': safe_str(row.get('endereco')),
                    'endereco_completo': safe_str(row.get('enderecoCompleto')),
                    'tipo': safe_str(row.get('tipo')),
                    'quantidade': safe_int(row.get('quantidade')),
                    'marca': safe_str(row.get('marca')),
                    'marca_licitacao': safe_str(row.get('marcaLicitacao', row.get('marca', ''))),
                    'paradas': safe_int(row.get('paradas')),
                    'regiao': safe_str(row.get('regiao')),
                    'status': safe_str(row.get('status')),
                    'empresa': safe_str(row.get('empresa', 'N/A')),
                    'latitude': lat,
                    'longitude': lon,
                    'n_elevador_parado': safe_int(row.get('NElevadorParado', 0)),
                    'data_de_parada': safe_str(row.get('DataDeParada')),
                    'previsao_de_retorno': safe_str(row.get('PrevisaoDeRetorno'))
                }
                
                elevator = Elevator(**elevator_data)
                elevators.append(elevator)
                
                # MANT√É‚Ä∞M COMPATIBILIDADE: converte de volta para dict
                registro_processado = elevator.to_dict()
                registros_processados.append(registro_processado)
                
            except Exception as e:
                print(f"√¢¬ù≈í Erro ao processar registro {idx}: {e}")
                continue
        
        print(f"√¢≈ì‚Ä¶ {len(elevators)} elevators processados")
        
        if elevators:
            # Cria GeoJSON usando os models
            features = [elevator.to_geojson_feature() for elevator in elevators]
            geojson_data = {
                "type": "FeatureCollection",
                "features": features
            }
            
            # Extrai listas √É¬∫nicas
            tipos_unicos = sorted(list(set([e.tipo for e in elevators])))
            regioes_unicas = sorted(list(set([e.regiao for e in elevators])))
            marcas_unicas = sorted(list(set([e.marca_licitacao for e in elevators])))
            empresas_unicas = sorted(list(set([e.empresa for e in elevators if e.empresa != 'N/A'])))
            predios_unicos = sorted(list(set([e.endereco_completo for e in elevators])))
            
            return {
                'geojson_data': geojson_data,
                'registros_processados': registros_processados,  # COMPATIBILIDADE
                'elevators': elevators,  # NOVO: lista de models
                'tipos_unicos': tipos_unicos,
                'regioes_unicas': regioes_unicas,
                'marcas_unicas': marcas_unicas,
                'empresas_unicas': empresas_unicas,
                'predios_unicos': predios_unicos
            }
        
        return {
            'geojson_data': {"type": "FeatureCollection", "features": []},
            'registros_processados': [],
            'elevators': [],
            'tipos_unicos': [],
            'regioes_unicas': [],
            'marcas_unicas': [],
            'empresas_unicas': [],
            'predios_unicos': []
        }

    def process_kpis_data(self, data: pd.DataFrame) -> Dict[str, Any]:
        """
        Processa dados de KPIs e calcula m√É¬©tricas
        NOVA IMPLEMENTA√É‚Ä°√É∆íO com models
        """
        if data.empty:
            return {}
        
        print(f"√∞≈∏‚Äú≈† Processando {len(data)} registros de KPIs...")
        
        kpis = []
        
        for idx, row in data.iterrows():
            try:
                # Converte datas
                data_solicitacao = None
                data_conclusao = None
                
                try:
                    data_solicitacao = pd.to_datetime(
                        row['data_solicitacao'], 
                        format='%d/%m/%Y %H:%M:%S', 
                        errors='coerce'
                    )
                except:
                    data_solicitacao = pd.to_datetime(row['data_solicitacao'], errors='coerce')
                
                try:
                    data_conclusao = pd.to_datetime(
                        row['data_conclusao'], 
                        format='%d/%m/%Y %H:%M:%S', 
                        errors='coerce'
                    )
                except:
                    data_conclusao = pd.to_datetime(row['data_conclusao'], errors='coerce')
                
                if pd.isna(data_solicitacao):
                    continue
                
                kpi_data = {
                    'edificio': safe_str(row.get('edificio')),
                    'categoria_problema': safe_str(row.get('categoria_problema')),
                    'status': safe_str(row.get('status')),
                    'data_solicitacao': data_solicitacao,
                    'data_conclusao': data_conclusao if not pd.isna(data_conclusao) else None,
                    'equipamento': safe_str(row.get('equipamento'))
                }
                
                kpi = KPI(**kpi_data)
                kpis.append(kpi)
                
            except Exception as e:
                print(f"√¢¬ù≈í Erro ao processar KPI {idx}: {e}")
                continue
        
        # Calcula m√É¬©tricas usando os models
        return kpis
    
    def _calculate_kpi_metrics(self, kpis: List[KPI]) -> Dict[str, Any]:
        """Calcula m√É¬©tricas dos KPIs usando models"""
        if not kpis:
            return {}
        
        concluidos = [kpi for kpi in kpis if kpi.esta_concluido]
        
        # M√É¬©tricas principais
        metricas = {
            'total_chamados': len(kpis),
            'chamados_concluidos': len(concluidos),
            'chamados_pendentes': len(kpis) - len(concluidos),
            'tempo_mediano_reparo': 0,
            'disponibilidade': (len(concluidos) / len(kpis) * 100) if kpis else 0,
        }
        
        # Tempo mediano de reparo
        tempos_reparo = [kpi.tempo_reparo_horas for kpi in concluidos if kpi.tempo_reparo_horas is not None]
        if tempos_reparo:
            import statistics
            metricas['tempo_mediano_reparo'] = statistics.median(tempos_reparo)
        
        # Chamados por m√É¬™s
        chamados_por_mes = {}
        for kpi in kpis:
            mes = kpi.mes_ano
            chamados_por_mes[mes] = chamados_por_mes.get(mes, 0) + 1
        metricas['chamados_por_mes'] = chamados_por_mes
        
        # Chamados por edif√É¬≠cio
        chamados_por_edificio = {}
        for kpi in kpis:
            edificio = kpi.edificio
            chamados_por_edificio[edificio] = chamados_por_edificio.get(edificio, 0) + 1
        
        # Ordena e pega top 15
        chamados_por_edificio = dict(
            sorted(chamados_por_edificio.items(), key=lambda x: x[1], reverse=True)[:15]
        )
        metricas['chamados_por_edificio'] = chamados_por_edificio
        
        # Categorias de problema
        categorias_problema = {}
        for kpi in kpis:
            categoria = kpi.categoria_problema
            categorias_problema[categoria] = categorias_problema.get(categoria, 0) + 1
        metricas['categorias_problema'] = categorias_problema
        
        # Tempo por categoria
        tempo_por_categoria = {}
        for categoria in categorias_problema.keys():
            tempos_categoria = [
                kpi.tempo_reparo_horas for kpi in concluidos 
                if kpi.categoria_problema == categoria and kpi.tempo_reparo_horas is not None
            ]
            if tempos_categoria:
                import statistics
                tempo_por_categoria[categoria] = statistics.median(tempos_categoria)
        
        # Ordena por tempo decrescente
        tempo_por_categoria = dict(
            sorted(tempo_por_categoria.items(), key=lambda x: x[1], reverse=True)
        )
        metricas['tempo_por_categoria'] = tempo_por_categoria
        
        # Chamados por equipamento
        chamados_por_equipamento = {}
        for kpi in kpis:
            if kpi.equipamento:
                equipamento = str(kpi.equipamento)
                chamados_por_equipamento[equipamento] = chamados_por_equipamento.get(equipamento, 0) + 1
        
        # Ordena e pega top 20
        chamados_por_equipamento = dict(
            sorted(chamados_por_equipamento.items(), key=lambda x: x[1], reverse=True)[:20]
        )
        metricas['chamados_por_equipamento'] = chamados_por_equipamento
        
        # Tempo por equipamento
        tempo_por_equipamento = {}
        for equipamento in chamados_por_equipamento.keys():
            tempos_equipamento = [
                kpi.tempo_reparo_horas for kpi in concluidos 
                if str(kpi.equipamento) == equipamento and kpi.tempo_reparo_horas is not None
            ]
            if tempos_equipamento:
                import statistics
                tempo_por_equipamento[equipamento] = statistics.median(tempos_equipamento)
        
        # Ordena por tempo decrescente
        tempo_por_equipamento = dict(
            sorted(tempo_por_equipamento.items(), key=lambda x: x[1], reverse=True)[:20]
        )
        metricas['tempo_por_equipamento'] = tempo_por_equipamento
        
        print(f"√¢≈ì‚Ä¶ M√É¬©tricas processadas: {len(metricas)} categorias")
        return metricas

    def apply_filters(self, elevators: List[Elevator], tipos=None, regioes=None, 
                    marcas=None, empresas=None, situacoes=None) -> List[Elevator]:
        """
        Aplica filtros aos elevadores
        CORRIGIDO: L√É¬≥gica baseada na an√É¬°lise da planilha real
        """
        filtered = elevators.copy()
        
        if tipos:
            filtered = [e for e in filtered if e.tipo in tipos]
        
        if regioes:
            filtered = [e for e in filtered if e.regiao in regioes]
        
        if marcas:
            filtered = [e for e in filtered if e.marca_licitacao in marcas]
        
        if empresas:
            filtered = [e for e in filtered if e.empresa in empresas]
        
        if situacoes:
            situacao_filtered = []
            for situacao in situacoes:
                if situacao == 'suspensos':
                    # Pr√É¬©dios com status "Suspenso"
                    situacao_filtered.extend([e for e in filtered if e.status == 'Suspenso'])
                elif situacao == 'parados':
                    # √¢≈ì‚Ä¶ CORRIGIDO: Pr√É¬©dios que t√É¬™m elevadores parados (NElevadorParado > 0)
                    situacao_filtered.extend([e for e in filtered if e.tem_elevador_parado])
                elif situacao == 'ativos':
                    # √¢≈ì‚Ä¶ CORRIGIDO: Pr√É¬©dios com status "Em atividade" E sem elevadores parados
                    situacao_filtered.extend([e for e in filtered if e.status == 'Em atividade' and not e.tem_elevador_parado])
            
            # Remove duplicatas mantendo ordem
            seen = set()
            filtered = []
            for e in situacao_filtered:
                if e.endereco_completo not in seen:
                    seen.add(e.endereco_completo)
                    filtered.append(e)
        
        print(f"√∞≈∏‚Äù¬ç Filtros aplicados: {len(elevators)} -> {len(filtered)} elevadores")
        if situacoes:
            print(f"   Situa√ß√É¬µes filtradas: {situacoes}")
            for situacao in situacoes:
                count = sum(1 for e in filtered if (
                    (situacao == 'suspensos' and e.status == 'Suspenso') or
                    (situacao == 'parados' and e.tem_elevador_parado) or
                    (situacao == 'ativos' and e.status == 'Em atividade' and not e.tem_elevador_parado)
                ))
                print(f"   {situacao}: {count} elevadores")
        
        return filtered

    def apply_kpi_filters(self, kpis: List['KPI'], data_inicio: datetime = None, data_fim: datetime = None, 
                          status: str = None, categoria: str = None, edificio: str = None, 
                          equipamento: str = None) -> List['KPI']:
        """
        Aplica filtros a uma lista de objetos KPI.
        """
        filtered_kpis = kpis
        
        if data_inicio:
            filtered_kpis = [k for k in filtered_kpis if k.data_solicitacao >= data_inicio]
        
        if data_fim:
            filtered_kpis = [k for k in filtered_kpis if k.data_solicitacao <= data_fim]
        
        if status:
            filtered_kpis = [k for k in filtered_kpis if k.status.lower() == status.lower()]
            
        if categoria:
            filtered_kpis = [k for k in filtered_kpis if k.categoria_problema.lower() == categoria.lower()]
            
        if edificio:
            filtered_kpis = [k for k in filtered_kpis if k.edificio.lower() == edificio.lower()]

        if equipamento:
            # Garante que 'equipamento' seja string para compara√ß√£o, caso o model retorne outro tipo
            filtered_kpis = [k for k in filtered_kpis if str(k.equipamento).lower() == equipamento.lower()]
        
        print(f"√∞≈∏‚Äù¬ç KPIs: Filtros aplicados resultaram em {len(filtered_kpis)} KPIs.")
        return filtered_kpis

    def calculate_stats(self, elevators: List[Elevator]) -> Dict[str, Any]:
        """
        Calcula estat√É¬≠sticas dos elevadores
        CORRIGIDO: Quando filtrado por "parados", conta apenas os parados
        """
        if not elevators:
            return {
                'total_elevadores': 0,
                'total_predios': 0,
                'cidades': 0,
                'regioes': 0,
                'em_atividade': 0,
                'elevadores_suspensos': 0,
                'elevadores_parados': 0
            }
        
        # √¢≈ì‚Ä¶ VERIFICAR SE √É‚Ä∞ UM FILTRO ESPEC√É¬çFICO
        # Se todos os elevators t√É¬™m parados, √É¬© filtro "parados"
        filtro_parados = all(e.tem_elevador_parado for e in elevators)
        filtro_suspensos = all(e.status == 'Suspenso' for e in elevators)
        filtro_ativos = all(e.status == 'Em atividade' and not e.tem_elevador_parado for e in elevators)
        
        total_elevadores = 0
        elevadores_suspensos = 0
        elevadores_parados = 0
        elevadores_ativos = 0
        
        if filtro_parados:
            # √¢≈ì‚Ä¶ FILTRO "PARADOS": Conta APENAS os parados
            for elevator in elevators:
                elevadores_parados += elevator.n_elevador_parado
            total_elevadores = elevadores_parados
            
        elif filtro_suspensos:
            # √¢≈ì‚Ä¶ FILTRO "SUSPENSOS": Conta APENAS os suspensos
            for elevator in elevators:
                elevadores_suspensos += elevator.quantidade
            total_elevadores = elevadores_suspensos
            
        elif filtro_ativos:
            # √¢≈ì‚Ä¶ FILTRO "ATIVOS": Conta APENAS os ativos
            for elevator in elevators:
                elevadores_ativos += elevator.quantidade
            total_elevadores = elevadores_ativos
            
        else:
            # √¢≈ì‚Ä¶ SEM FILTRO ou FILTRO MISTO: L√É¬≥gica completa
            for elevator in elevators:
                total_elevadores += elevator.quantidade
                
                if elevator.status == 'Suspenso':
                    elevadores_suspensos += elevator.quantidade
                elif elevator.tem_elevador_parado:
                    elevadores_parados += elevator.n_elevador_parado
                    elevadores_ativos += (elevator.quantidade - elevator.n_elevador_parado)
                else:
                    elevadores_ativos += elevator.quantidade
        
        stats = {
            'total_elevadores': total_elevadores,
            'total_predios': len(set(e.endereco_completo for e in elevators)),
            'cidades': len(set(e.cidade for e in elevators)),
            'regioes': len(set(e.regiao for e in elevators)),
            'em_atividade': elevadores_ativos,
            'elevadores_suspensos': elevadores_suspensos,
            'elevadores_parados': elevadores_parados
        }
        
        print(f"√∞≈∏‚Äú≈† Stats calculados: Total={total_elevadores}, Ativos={elevadores_ativos}, Suspensos={elevadores_suspensos}, Parados={elevadores_parados}")
        
        return stats
--- Fim do cÛdigo: data_processor.py ---

--- InÌcio do cÛdigo: sheets_service.py ---
# app/services/sheets_service.py
from sheets_api import SheetsAPI

class SheetsService:
    """Servi√ßo para intera√ß√£o com Google Sheets usando a API existente"""
    
    def __init__(self):
        self.sheets_api = SheetsAPI()
    
    def obter_dados_elevadores(self, planilha_url):
        """Obt√É¬©m dados de elevadores da planilha"""
        print(f"√∞≈∏‚Äù‚Äî Tentando acessar: {planilha_url}")
        return self.sheets_api.obter_dados_elevadores(planilha_url)
    
    def obter_dados_kpis(self, planilha_url):
        """Obt√É¬©m dados de KPIs da planilha"""
        print(f"√∞≈∏‚Äù‚Äî Tentando acessar KPIs: {planilha_url}")
        return self.sheets_api.obter_dados_kpis(planilha_url)
    
    def get_sheet_data(self, url, range_name='A1:Z1000'):
        """M√É¬©todo gen√É¬©rico para obter dados de planilha"""
        # Usa o m√É¬©todo apropriado baseado no contexto
        return self.sheets_api.obter_dados_elevadores(url)
    
    def update_sheet_data(self, url, range_name, values):
        """Atualiza dados na planilha (funcionalidade futura)"""
        print(f"√¢≈°¬†√Ø¬∏¬è Funcionalidade de atualiza√ß√£o n√£o implementada ainda")
        return None
--- Fim do cÛdigo: sheets_service.py ---

--- InÌcio do cÛdigo: stats_service.py ---
# app/services/stats_service.py
from typing import List, Dict, Any
from app.models.elevator import Elevator
from collections import defaultdict

class StatsService:
    """Servi√ßo para c√É¬°lculo de estat√É¬≠sticas"""
    
    @staticmethod
    def calculate_elevator_stats(elevators: List[Elevator]) -> Dict[str, Any]:
        """Calcula estat√É¬≠sticas dos elevadores"""
        total_elevadores = sum(e.quantidade for e in elevators)
        elevadores_suspensos = sum(e.quantidade for e in elevators if e.esta_suspenso)
        elevadores_parados = sum(e.n_elevador_parado for e in elevators)
        elevadores_ativos = total_elevadores - elevadores_suspensos - elevadores_parados
        
        return {
            'total_elevadores': total_elevadores,
            'total_predios': len(set(e.endereco_completo for e in elevators)),
            'cidades': len(set(e.cidade for e in elevators)),
            'regioes': len(set(e.regiao for e in elevators)),
            'em_atividade': elevadores_ativos,
            'suspensos': elevadores_suspensos,
            'elevadores_parados': elevadores_parados
        }
    
    @staticmethod
    def group_by_category(elevators: List[Elevator]) -> Dict[str, Dict[str, int]]:
        """Agrupa elevadores por categoria"""
        stats = {
            'por_tipo': defaultdict(int),
            'por_regiao': defaultdict(int),
            'por_marca': defaultdict(int),
            'por_status': defaultdict(int)
        }
        
        for elevator in elevators:
            stats['por_tipo'][elevator.tipo] += elevator.quantidade
            stats['por_regiao'][elevator.regiao] += elevator.quantidade
            stats['por_marca'][elevator.marca_licitacao] += elevator.quantidade
            
            if elevator.esta_suspenso:
                stats['por_status']['Suspenso'] += elevator.quantidade
            else:
                stats['por_status']['Em atividade'] += elevator.elevadores_ativos
                if elevator.tem_elevador_parado:
                    stats['por_status']['Parados'] += elevator.n_elevador_parado
        
        return {k: dict(v) for k, v in stats.items()}
--- Fim do cÛdigo: stats_service.py ---

--- InÌcio do cÛdigo: __init__.py ---
# app/services/__init__.py
"""M√≥dulo de servi√ßos de neg√≥cio"""

from .sheets_service import SheetsService
from .cache_service import CacheService
from .data_processor import DataProcessor

__all__ = [
    'SheetsService',
    'CacheService', 
    'DataProcessor'
]
--- Fim do cÛdigo: __init__.py ---

--- InÌcio do cÛdigo: auth_decorators.py ---
# app/utils/auth_decorators.py
from functools import wraps
from flask import session, flash, redirect, url_for, request, jsonify
from app.services.auth_service import AuthService
import traceback # Importa para logging de erros detalhado

# NOVO: Decorador para padronizar respostas JSON e tratamento de erros para qualquer API
def json_response(f):
    """Decorator para padronizar respostas de API e tratamento de erros."""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        try:
            result = f(*args, **kwargs)
            if isinstance(result, dict):
                return jsonify(result)
            # Se a fun√ß√£o j√É¬° retornar um objeto Response (como jsonify), apenas o retorna.
            return result
        except Exception as e:
            # Loga o traceback completo para depura√ß√£o
            print(f"√¢¬ù≈í Erro na API em {f.__name__}: {e}")
            traceback.print_exc()
            return jsonify({
                'success': False,
                'error': str(e),
                'message': 'Ocorreu um erro interno na API.' # Mensagem amig√É¬°vel para o usu√É¬°rio
            }), 500
    return decorated_function

# Modificado: api_auth_required agora inclui a funcionalidade de json_response
def api_auth_required(f):
    """
    Decorator espec√É¬≠fico para APIs que requer autentica√ß√£o e padroniza a resposta JSON.
    """
    @wraps(f)
    def decorated_function(*args, **kwargs):
        print(f"√∞≈∏‚Äù‚Äô API Auth check para {request.endpoint}")
        
        is_authenticated = AuthService.is_authenticated()
        print(f"√∞≈∏‚Äù¬ç API Auth resultado: {is_authenticated}")
        
        if not is_authenticated:
            # Retorna uma resposta JSON padronizada para falha de autentica√ß√£o
            return jsonify({
                'success': False,
                'error': 'Authentication required',
                'message': 'Autentica√ß√£o necess√É¬°ria para acessar este recurso.',
                'code': 'AUTH_REQUIRED',
                'login_url': url_for('auth.login'), # URL de login da v2
                'debug_info': {
                    'session_keys': list(session.keys()),
                    'usuario_logado': session.get('usuario_logado'),
                    'auth_v2': session.get('auth_v2')
                }
            }), 401
        
        # Se autenticado, aplica a l√É¬≥gica de json_response ao resultado da fun√ß√£o
        # Isso garante a padroniza√ß√£o JSON e tratamento de erros para respostas bem-sucedidas.
        return json_response(f)(*args, **kwargs)
    return decorated_function

# Os decoradores login_required_v2 e admin_required_v2 (se existir) permanecem inalterados,
# pois s√£o projetados principalmente para rotas de UI que retornam HTML ou redirecionam.

# Mantenha os decoradores existentes abaixo, que s√£o para UI:
def login_required_v2(f):
    """
    Decorator para autentica√ß√£o da nova arquitetura - VERS√É∆íO FINAL
    """
    @wraps(f)
    def decorated_function(*args, **kwargs):
        print(f"√Ø¬ø¬Ω√Ø¬ø¬Ω Verificando autentica√ß√£o para {request.endpoint}")
        print(f"√∞≈∏‚Äù¬ç Request path: {request.path}")
        print(f"√∞≈∏‚Äù¬ç Request headers: {dict(request.headers)}")
        print(f"√Ø¬ø¬Ω√Ø¬ø¬Ω Is JSON: {request.is_json}")
        print(f"√Ø¬ø¬Ω√Ø¬ø¬Ω Content-Type: {request.content_type}")
        print(f"√∞≈∏‚Äù¬ç Accept: {request.headers.get('Accept', '')}")
        
        is_authenticated = AuthService.is_authenticated()
        print(f"√∞≈∏‚Äù¬ç Resultado da verifica√ß√£o: {is_authenticated}")
        
        if not is_authenticated:
            print(f"√¢¬ù≈í Usu√É¬°rio n√£o autenticado, bloqueando acesso")
            
            is_api_request = (
                request.is_json or 
                request.path.startswith('/api/') or
                request.path.startswith('/test/auth/') or  # Nossos endpoints de teste
                'application/json' in request.headers.get('Accept', '') or
                'application/json' in request.headers.get('Content-Type', '')
            )
            
            print(f"√∞≈∏‚Äù¬ç √É‚Ä∞ requisi√ß√£o de API: {is_api_request}")
            
            if is_api_request:
                return jsonify({
                    'success': False,
                    'message': 'Autentica√ß√£o necess√É¬°ria',
                    'login_url': url_for('auth.login'),
                    'debug_info': {
                        'session_keys': list(session.keys()),
                        'usuario_logado': session.get('usuario_logado'),
                        'auth_v2': session.get('auth_v2')
                    }
                }), 401
            else:
                flash('Voc√É¬™ precisa fazer login para acessar esta p√É¬°gina.', 'warning')
                return redirect(url_for('auth.login', next=request.url))
        
        print(f"√¢≈ì‚Ä¶ Usu√É¬°rio autenticado, permitindo acesso")
        return f(*args, **kwargs)
    return decorated_function

def admin_required_v2(f):
    """
    Decorator para verificar se √É¬© admin (futuro)
    """
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not AuthService.is_authenticated():
            if request.is_json or 'application/json' in request.headers.get('Accept', ''):
                return jsonify({'success': False, 'message': 'Autentica√ß√£o necess√É¬°ria'}), 401
            else:
                flash('Acesso negado.', 'danger')
                return redirect(url_for('auth.login'))
        
        # TODO: Implementar l√É¬≥gica de verifica√ß√£o de admin
        # Por enquanto, apenas garante que esteja autenticado
        
        return f(*args, **kwargs)
    return decorated_function
--- Fim do cÛdigo: auth_decorators.py ---

--- InÌcio do cÛdigo: auth_helpers.py ---
# app/utils/auth_helpers.py
from datetime import datetime, timedelta
from flask import current_app

# Cache para controle de tentativas de login
tentativas_login = {}

def verificar_tentativas_login(ip):
    """Verifica se o IP n√£o excedeu o limite de tentativas"""
    agora = datetime.now()
    
    if ip in tentativas_login:
        tentativas = tentativas_login[ip]
        
        # Remove tentativas antigas (mais de BLOQUEIO_TEMPO segundos)
        tentativas['historico'] = [
            t for t in tentativas['historico'] 
            if (agora - t).seconds < current_app.config['BLOQUEIO_TEMPO']
        ]
        
        # Verifica se excedeu o limite
        if len(tentativas['historico']) >= current_app.config['MAX_TENTATIVAS_LOGIN']:
            return False, tentativas['historico'][0] + timedelta(seconds=current_app.config['BLOQUEIO_TEMPO'])
    
    return True, None

def registrar_tentativa_login(ip):
    """Registra uma tentativa de login falhada"""
    agora = datetime.now()
    
    if ip not in tentativas_login:
        tentativas_login[ip] = {'historico': []}
    
    tentativas_login[ip]['historico'].append(agora)

def limpar_tentativas_login(ip):
    """Limpa tentativas de login para um IP espec√É¬≠fico"""
    if ip in tentativas_login:
        del tentativas_login[ip]

def get_tempo_restante_bloqueio(ip):
    """Retorna tempo restante de bloqueio em minutos"""
    if ip not in tentativas_login:
        return 0
    
    agora = datetime.now()
    tentativas = tentativas_login[ip]
    
    if tentativas['historico']:
        ultimo_bloqueio = tentativas['historico'][0] + timedelta(seconds=current_app.config['BLOQUEIO_TEMPO'])
        if ultimo_bloqueio > agora:
            return int((ultimo_bloqueio - agora).seconds / 60)
    
    return 0
--- Fim do cÛdigo: auth_helpers.py ---

--- InÌcio do cÛdigo: helpers.py ---
# app/utils/helpers.py
from datetime import datetime, timedelta
from flask import current_app
import pandas as pd

def format_datetime(value, format='%Y-%m-%d %H:%M:%S'):
    """Formata um objeto datetime para uma string"""
    if not value:
        return ''
    return value.strftime(format)

def is_valid_email(email):
    """Valida se o email fornecido tem um formato v√É¬°lido"""
    import re
    pattern = r'^[\w\.-]+@[\w\.-]+\.\w+'
    return re.match(pattern, email) is not None

def safe_int(value, default=0):
    """Converte valor para int de forma segura"""
    try:
        return int(value) if pd.notna(value) else default
    except (ValueError, TypeError):
        return default

def safe_float(value, default=0.0):
    """Converte valor para float de forma segura"""
    try:
        return float(value) if pd.notna(value) else default
    except (ValueError, TypeError):
        return default

def safe_str(value, default=''):
    """Converte valor para string de forma segura"""
    try:
        return str(value) if pd.notna(value) else default
    except (ValueError, TypeError):
        return default

def validate_coordinates(lat, lon):
    """Valida se as coordenadas s√£o v√É¬°lidas"""
    try:
        lat_float = float(lat)
        lon_float = float(lon)
        
        # Valida range geral
        if not (-90 <= lat_float <= 90 and -180 <= lon_float <= 180):
            return False, None, None
        
        # Valida range do Brasil
        if not (-35 <= lat_float <= 5 and -75 <= lon_float <= -30):
            return False, None, None
            
        return True, lat_float, lon_float
    except (ValueError, TypeError):
        return False, None, None

def calculate_time_difference(start_date, end_date, unit='hours'):
    """Calcula diferen√ßa entre duas datas"""
    if not start_date or not end_date:
        return None
    
    try:
        diff = end_date - start_date
        
        if unit == 'hours':
            return diff.total_seconds() / 3600
        elif unit == 'days':
            return diff.days
        elif unit == 'minutes':
            return diff.total_seconds() / 60
        else:
            return diff.total_seconds()
    except:
        return None
--- Fim do cÛdigo: helpers.py ---

--- InÌcio do cÛdigo: __init__.py ---
# app/utils/__init__.py
"""M√É¬≥dulo de utilit√É¬°rios e helpers"""

# AGORA IMPORTAMOS OS NOVOS DECORADORES DA V2
from .auth_decorators import login_required_v2, admin_required_v2, api_auth_required, json_response

from .helpers import (
    format_datetime, 
    is_valid_email, 
    safe_int, 
    safe_float, 
    safe_str,
    validate_coordinates,
    calculate_time_difference
)
from .auth_helpers import (
    verificar_tentativas_login,
    registrar_tentativa_login,
    limpar_tentativas_login,
    get_tempo_restante_bloqueio
)

__all__ = [
    # Decorators V2
    'login_required_v2', # NOVO: Decorador para rotas de UI
    'admin_required_v2', # NOVO: Decorador para rotas de admin (futuro)
    'api_auth_required', # NOVO: Decorador para APIs protegidas
    'json_response',     # NOVO: Decorador para padronizar respostas JSON
    
    # Helpers
    'format_datetime',
    'is_valid_email',
    'safe_int',
    'safe_float', 
    'safe_str',
    'validate_coordinates',
    'calculate_time_difference',
    
    # Auth helpers
    'verificar_tentativas_login',
    'registrar_tentativa_login',
    'limpar_tentativas_login',
    'get_tempo_restante_bloqueio'
]
--- Fim do cÛdigo: __init__.py ---

--- InÌcio do cÛdigo: factory.py ---
# app/factory.py
from flask import Flask
from flask_caching import Cache
import os

# Importa as configura√ß√É¬µes do seu aplicativo
from app.config import get_config
# Importa o CacheService
from app.services.cache_service import CacheService # Adicionado import

cache = Cache()

def create_app():
    """Factory para criar inst√É¬¢ncia da aplica√ß√£o Flask"""
    print("√∞≈∏¬è‚Äî√Ø¬∏¬è Criando aplica√ß√£o (Fase 4)...")
    
    template_dir = os.path.abspath(os.path.join(os.path.dirname(__file__), '..', 'templates'))
    static_dir = os.path.abspath(os.path.join(os.path.dirname(__file__), '..', 'static'))
    
    print(f"√∞≈∏‚Äú¬Å Template dir: {template_dir}")
    print(f"√∞≈∏‚Äú¬Å Static dir: {static_dir}")
    
    app = Flask(__name__, 
                template_folder=template_dir,
                static_folder=static_dir)
    
    print("√¢≈°‚Ñ¢√Ø¬∏¬è Carregando configura√ß√£o...")
    config = get_config()
    app.config.from_object(config)
    
    app.config['SESSION_PERMANENT'] = True
    
    if not app.config.get('SECRET_KEY'):
        app.config['SECRET_KEY'] = 'dev-key-for-testing'
    
    planilha_url = app.config.get('PLANILHA_URL')
    if planilha_url:
        print(f"√¢≈ì‚Ä¶ PLANILHA_URL configurada: {planilha_url[:50]}...")
    else:
        print("√¢≈°¬†√Ø¬∏¬è PLANILHA_URL n√£o configurada - dashboard pode n√£o funcionar")
    
    print(f"DEBUG mode: {app.config.get('DEBUG', False)}")
    
    print("Inicializando extens√É¬µes...")
    init_extensions(app)
    
    print("Registrando blueprints...")
    register_blueprints(app) # Chama a fun√ß√£o que registra TODOS os blueprints
    
    print("Registrando context processors...")
    register_context_processors(app)
    
    print("√¢≈ì‚Ä¶ Aplica√ß√£o criada com sucesso (Fase 4)!")
    return app

# A fun√ß√£o get_config j√É¬° estava OK no seu factory.py
def get_config():
    """Obt√É¬©m configura√ß√£o"""
    try:
        from app.config import get_config as get_app_config
        return get_app_config()
    except ImportError as e:
        print(f"√¢≈°¬†√Ø¬∏¬è Erro ao importar config: {e}")
        class MinimalConfig:
            DEBUG = True
            SECRET_KEY = 'dev-key-minimal'
            CACHE_TIMEOUT = 300
            USUARIOS_AUTORIZADOS = {}
            SESSION_PERMANENT = True
            PERMANENT_SESSION_LIFETIME = 3600
            PLANILHA_URL = None
            PLANILHA_KPIS_URL = None # Adicionado para evitar erro se kpis_api_bp for ativado
        return MinimalConfig()

def init_extensions(app):
    """Inicializa extens√É¬µes"""
    cache.init_app(app)
    try:
        if not hasattr(app, 'cache_service'):
            app.cache_service = CacheService(app.config.get('CACHE_TIMEOUT', 300))
        print("√¢≈ì‚Ä¶ Cache service inicializado")
    except Exception as e:
        print(f"√¢≈°¬†√Ø¬∏¬è Erro ao inicializar cache: {e}")

# CORRIGIDO: Registro de TODOS os Blueprints
def register_blueprints(app):
    """Registra todos os blueprints"""
    blueprints_registered = 0
    
    # BLUEPRINTS (app/blueprints)
    try:
        from app.blueprints.test import test_bp
        app.register_blueprint(test_bp)
        blueprints_registered += 1
        print("√¢≈ì‚Ä¶ Blueprint 'test' registrado")
    except Exception as e:
        print(f"√¢¬ù≈í Erro ao registrar blueprint 'test': {e}")
    
    try:
        from app.blueprints.test_services import test_services_bp
        app.register_blueprint(test_services_bp, url_prefix='/test/services')
        blueprints_registered += 1
        print("√¢≈ì‚Ä¶ Blueprint 'test_services' registrado")
    except Exception as e:
        print(f"√¢¬ù≈í Erro ao registrar blueprint 'test_services': {e}")
    
    try:
        from app.blueprints.auth import auth_bp
        app.register_blueprint(auth_bp)
        blueprints_registered += 1
        print("√¢≈ì‚Ä¶ Blueprint 'auth' registrado")
    except Exception as e:
        print(f"√¢¬ù≈í Erro ao registrar blueprint 'auth': {e}")
    
    try:
        from app.blueprints.test_auth import test_auth_bp
        app.register_blueprint(test_auth_bp)
        blueprints_registered += 1
        print("√¢≈ì‚Ä¶ Blueprint 'test_auth' registrado")
    except Exception as e:
        print(f"√¢¬ù≈í Erro ao registrar blueprint 'test_auth': {e}")
    
    try:
        from app.blueprints.dashboard import dashboard_bp
        app.register_blueprint(dashboard_bp)
        blueprints_registered += 1
        print("√¢≈ì‚Ä¶ Blueprint 'dashboard' registrado")
    except Exception as e:
        print(f"√¢¬ù≈í Erro ao registrar blueprint 'dashboard': {e}")

    # BLUEPRINTS DE API (app/api) - ADICIONADOS AQUI
    try:
        from app.api.elevators import elevators_api_bp
        app.register_blueprint(elevators_api_bp, url_prefix='/api')
        blueprints_registered += 1
        print("√¢≈ì‚Ä¶ Blueprint 'elevators_api' registrado")
    except Exception as e:
        print(f"√¢¬ù≈í Erro ao registrar blueprint 'elevators_api': {e}")

    # BLUEPRINT DE KPIS (UI)
    try:
        from app.blueprints.kpis import kpis_bp
        app.register_blueprint(kpis_bp) # Sem prefixo, usa o url_prefix definido no Blueprint (/v2/kpis)
        blueprints_registered += 1
        print("√¢≈ì‚Ä¶ Blueprint 'kpis' (UI) registrado")
    except Exception as e:
        print(f"√¢¬ù≈í Erro ao registrar blueprint 'kpis' (UI): {e}")

    # BLUEPRINT DE KPIS (API)
    try:
        from app.api.kpis import kpis_api_bp
        app.register_blueprint(kpis_api_bp, url_prefix='/api') # Registra a API de KPIs sob /api
        blueprints_registered += 1
        print("√¢≈ì‚Ä¶ Blueprint 'kpis_api' registrado")
    except Exception as e:
        print(f"√¢¬ù≈í Erro ao registrar blueprint 'kpis_api': {e}")
    
    print(f"√∞≈∏‚Äú≈† Total de blueprints registrados: {blueprints_registered}")

# A fun√ß√£o register_context_processors j√É¬° estava OK no seu factory.py
def register_context_processors(app):
    """Context processors globais"""
    @app.context_processor
    def inject_user_info():
        from flask import session
        return {
            'usuario_logado': session.get('usuario_logado'),
            'login_timestamp': session.get('login_timestamp')
        }
    print("√¢≈ì‚Ä¶ Context processors registrados")
--- Fim do cÛdigo: factory.py ---

--- InÌcio do cÛdigo: __init__.py ---
# app/__init__.py
# Este arquivo agora pode ficar quase vazio, ou apenas importar a fun√ß√£o f√É¬°brica
# para que 'from app import create_app' funcione.
from .factory import create_app 
--- Fim do cÛdigo: __init__.py ---

--- InÌcio do cÛdigo: app_new.py ---
"""
Nova aplica√ß√£o usando Application Factory - VERS√ÉO DEBUG
"""
from app.factory import create_app

print("üöÄ Iniciando app_new.py...")

try:
    app = create_app()
    print("‚úÖ App criada com sucesso")
    
    # Lista rotas para debug
    print("\nüìã ROTAS DISPON√çVEIS:")
    with app.app_context():
        for rule in app.url_map.iter_rules():
            print(f"   {list(rule.methods)} {rule.rule}")
    
    if __name__ == '__main__':
        print("\nüöÄ Iniciando servidor na porta 5001...")
        print("üîó Acesse: http://localhost:5001/")
        print("üîó Health: http://localhost:5001/test/health")
        app.run(debug=True, port=5001, host='127.0.0.1')
        
except Exception as e:
    print(f"‚ùå Erro cr√≠tico: {e}")
    import traceback
    traceback.print_exc()
--- Fim do cÛdigo: app_new.py ---

--- InÌcio do cÛdigo: sheets_api.py ---
import gspread
from google.oauth2.service_account import Credentials
import pandas as pd
import json

class SheetsAPI:
    def __init__(self, credenciais_path='credenciais.json'):
        try:
            # Mostra o email de servi√ßo para verifica√ß√£o
            with open(credenciais_path, 'r') as f:
                creds_data = json.load(f)
                print(f"üîë Email de servi√ßo: {creds_data['client_email']}")
            
            # Configura√ß√£o das credenciais
            scope = [
                'https://spreadsheets.google.com/feeds',
                'https://www.googleapis.com/auth/drive'
            ]
            
            creds = Credentials.from_service_account_file(
                credenciais_path, scopes=scope
            )
            self.client = gspread.authorize(creds)
            print("‚úÖ Autentica√ß√£o realizada com sucesso!")
            
        except Exception as e:
            print(f"‚ùå Erro na autentica√ß√£o: {e}")
            raise
    
    def testar_conexao(self):
        """Testa se consegue listar planilhas"""
        try:
            planilhas = self.client.list_spreadsheet_files()
            print(f"üìä Planilhas acess√≠veis: {len(planilhas)}")
            for p in planilhas[:3]:  # Mostra apenas as 3 primeiras
                print(f"   - {p['name']}")
            return True
        except Exception as e:
            print(f"‚ùå Erro ao listar planilhas: {e}")
            return False
    
    def obter_dados_elevadores(self, planilha_url):
        """Obt√©m dados da planilha do Google Sheets"""
        try:
            print(f"üîó Tentando acessar: {planilha_url}")
            
            # Abre a planilha pela URL
            sheet = self.client.open_by_url(planilha_url)
            print(f"üìã Planilha aberta: {sheet.title}")
            
            # Lista as abas dispon√≠veis
            worksheets = sheet.worksheets()
            print(f"üìë Abas encontradas: {[w.title for w in worksheets]}")
            
            # Pega a primeira aba
            worksheet = worksheets[0]
            print(f"üìÑ Usando aba: {worksheet.title}")
            
            # Obt√©m os dados
            dados = worksheet.get_all_records()
            print(f"üìä Registros encontrados: {len(dados)}")
            
            if len(dados) > 0:
                print(f"üîç Colunas: {list(dados[0].keys())}")
            
            df = pd.DataFrame(dados)
            return df
            
        except gspread.exceptions.SpreadsheetNotFound:
            print("‚ùå Planilha n√£o encontrada. Verifique a URL e permiss√µes.")
            return pd.DataFrame()
        except gspread.exceptions.APIError as e:
            print(f"‚ùå Erro da API: {e}")
            print("üí° Dicas:")
            print("   - Verifique se a planilha foi compartilhada com o email de servi√ßo")
            print("   - Confirme se a URL est√° correta")
            print("   - Tente aguardar alguns minutos e tente novamente")
            return pd.DataFrame()
        except Exception as e:
            print(f"‚ùå Erro inesperado: {e}")
            return pd.DataFrame()

    def obter_dados_kpis(self, planilha_url):
        """Obt√©m dados de KPIs de manuten√ß√£o da planilha do Google Sheets"""
        try:
            print(f"üîó Tentando acessar planilha de KPIs: {planilha_url}")
            
            # Abre a planilha pela URL
            sheet = self.client.open_by_url(planilha_url)
            print(f"üìã Planilha de KPIs aberta: {sheet.title}")
            
            # Lista as abas dispon√≠veis
            worksheets = sheet.worksheets()
            print(f"ÔøΩÔøΩ Abas encontradas: {[w.title for w in worksheets]}")
            
            # Pega a primeira aba
            worksheet = worksheets[0]
            print(f"üìÑ Usando aba: {worksheet.title}")
            
            # Obt√©m os dados
            dados = worksheet.get_all_records()
            print(f"üìä Registros de KPIs encontrados: {len(dados)}")
            
            if len(dados) > 0:
                print(f"üîç Colunas KPIs: {list(dados[0].keys())}")
            
            df = pd.DataFrame(dados)
            return df
            
        except gspread.exceptions.SpreadsheetNotFound:
            print("‚ùå Planilha de KPIs n√£o encontrada. Verifique a URL e permiss√µes.")
            return pd.DataFrame()
        except gspread.exceptions.APIError as e:
            print(f"‚ùå Erro da API ao acessar KPIs: {e}")
            return pd.DataFrame()
        except Exception as e:
            print(f"‚ùå Erro inesperado ao acessar KPIs: {e}")
            return pd.DataFrame()

# Teste da conex√£o
if __name__ == "__main__":
    print("üöÄ Iniciando teste da API...")
    
    try:
        api = SheetsAPI()
        
        # Primeiro, testa a conex√£o geral
        if api.testar_conexao():
            print("\n" + "="*50)
            print("‚úÖ Conex√£o com Google Sheets funcionando!")
            print("="*50)
            
            # Agora testa com sua planilha espec√≠fica
            url_planilha = input("\nüìù Cole a URL da sua planilha aqui: ").strip()
            
            if url_planilha and url_planilha != "SUA_URL_DA_PLANILHA_AQUI":
                print(f"\nüîÑ Testando acesso √† planilha...")
                dados = api.obter_dados_elevadores(url_planilha)
                
                if not dados.empty:
                    print(f"\nüéâ SUCESSO! Dados carregados:")
                    print(f"   - {len(dados)} registros")
                    print(f"   - {len(dados.columns)} colunas")
                    print(f"\nüìã Primeiras 3 linhas:")
                    print(dados.head(3))
                else:
                    print("\n‚ùå Nenhum dado foi carregado.")
            else:
                print("\n‚ö†Ô∏è  URL n√£o fornecida. Teste manual necess√°rio.")
        else:
            print("\n‚ùå Falha na conex√£o b√°sica com Google Sheets.")
            
    except Exception as e:
        print(f"\nüí• Erro cr√≠tico: {e}")
--- Fim do cÛdigo: sheets_api.py ---

--- InÌcio do cÛdigo: dashboard.html ---
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard v2.0 - Sistema de Elevadores</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    
    <style>
        body { background-color: #f8f9fa; }
        .navbar-brand { font-weight: bold; }
        .version-badge { 
            background: linear-gradient(45deg, #28a745, #20c997); 
            color: white; 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 12px; 
            margin-left: 10px;
        }
        .card { 
            border: none; 
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); 
            margin-bottom: 1rem; 
        }
        .card-header { 
            background-color: #fff; 
            border-bottom: 1px solid #dee2e6; 
            font-weight: 600; 
        }
        .stats-card { transition: transform 0.2s; }
        .stats-card:hover { transform: translateY(-2px); }
        .map-container { 
            height: 500px; 
            border-radius: 0.375rem; 
            overflow: hidden; 
        }
        .filter-section { 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .comparison-banner {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        /* NOVO: Estilos para estat√É¬≠sticas detalhadas */
        .stats-list {
            max-height: 200px;
            overflow-y: auto;
            font-size: 14px;
        }
        .stats-list > div {
            padding: 2px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .stats-list > div:last-child {
            border-bottom: none;
        }
        #stats-detalhadas .card-body {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-building"></i> Sistema de Elevadores
                <span class="version-badge">v2.0 Modular</span>
            </a>
            
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-user"></i> {{ usuario }}
                </span>
                <a class="nav-link" href="{{ url_for('auth.logout') }}">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <!-- Banner de Compara√ß√£o -->
        <div class="comparison-banner">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5><i class="fas fa-rocket"></i> Nova Arquitetura Modular</h5>
                    <p class="mb-0">Voc√™ est√° usando a vers√£o 2.0 com arquitetura modular. 
                    Compare com o <a href="http://localhost:5000"  class="text-white"><u>sistema atual</u></a></p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light btn-sm" onclick="atualizarDados()">
                        <i class="fas fa-sync-alt"></i> Atualizar Dados
                    </button>
                </div>
            </div>
        </div>

        {% if erro %}
        <!-- Erro -->
        <div class="alert alert-danger">
            <h4><i class="fas fa-exclamation-triangle"></i> Erro</h4>
            <p>{{ erro }}</p>
            <button class="btn btn-danger" onclick="location.reload()">
                <i class="fas fa-redo"></i> Tentar Novamente
            </button>
        </div>
        {% else %}
        
       <!-- Cards de Estat√É¬≠sticas -->
        <div class="row mb-4 stats-row" id="stats-cards">
            <div class="col-md-12">
                <div class="d-flex flex-wrap justify-content-between">
                    <div class="flex-fill mx-1">
                        <div class="card stats-card bg-primary text-white">
                            <div class="card-body text-center py-2">
                                <i class="fas fa-building fa-lg mb-1"></i>
                                <h5 id="stat-predios">{{ stats.total_predios if stats else 0 }}</h5>
                                <p class="mb-0 small">Pr√©dios</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-fill mx-1">
                        <div class="card stats-card bg-success text-white">
                            <div class="card-body text-center py-2">
                                <i class="fas fa-elevator fa-lg mb-1"></i>
                                <h5 id="stat-elevadores">{{ stats.total_elevadores if stats else 0 }}</h5>
                                <p class="mb-0 small">Elevadores</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-fill mx-1">
                        <div class="card stats-card bg-info text-white">
                            <div class="card-body text-center py-2">
                                <i class="fas fa-map-marker-alt fa-lg mb-1"></i>
                                <h5 id="stat-cidades">{{ stats.cidades if stats else 0 }}</h5>
                                <p class="mb-0 small">Cidades</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-fill mx-1">
                        <div class="card stats-card bg-secondary text-white">
                            <div class="card-body text-center py-2">
                                <i class="fas fa-map fa-lg mb-1"></i>
                                <h5 id="stat-regioes">{{ stats.regioes if stats else 0 }}</h5>
                                <p class="mb-0 small">Regi√µes</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-fill mx-1">
                        <div class="card stats-card bg-success text-white">
                            <div class="card-body text-center py-2">
                                <i class="fas fa-check-circle fa-lg mb-1"></i>
                                <h5 id="stat-ativos">{{ stats.em_atividade if stats else 0 }}</h5>
                                <p class="mb-0 small">Ativos</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-fill mx-1">
                        <div class="card stats-card bg-warning text-white">
                            <div class="card-body text-center py-2">
                                <i class="fas fa-times-circle fa-lg mb-1"></i>
                                <h5 id="stat-suspensos">{{ stats.elevadores_suspensos if stats else 0 }}</h5>
                                <p class="mb-0 small">Suspensos</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex-fill mx-1">
                        <div class="card stats-card bg-danger text-white">
                             <div class="card-body text-center py-2">
                                <i class="fas fa-exclamation-triangle fa-lg mb-1"></i>
                                 <h5 id="stat-parados">{{ stats.elevadores_parados if stats else 0 }}</h5>
                                 <p class="mb-0 small">Parados</p>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="row">
            <!-- Mapa -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-map-marked-alt"></i> Mapa dos Elevadores</h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="mapa" class="map-container"></div>
                    </div>
                </div>
                
                <!-- NOVO: Estat√≠¬≠sticas Detalhadas (abaixo do mapa, mesma coluna) -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Estat√≠sticas Detalhadas</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Por Tipo -->
                            <div class="col-md-3">
                                <h6><i class="fas fa-building"></i> Por Tipo</h6>
                                <div id="stats-por-tipo" class="stats-list">
                                    {% if stats_detalhadas and stats_detalhadas.por_tipo %}
                                        {% for tipo, quantidade in stats_detalhadas.por_tipo.items() %}
                                        <div class="d-flex justify-content-between">
                                            <span>{{ tipo }}:</span>
                                            <strong>{{ quantidade }}</strong>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted">Carregando...</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Por Regi√£o -->
                            <div class="col-md-3">
                                <h6><i class="fas fa-map"></i> Por Regi√£o</h6>
                                <div id="stats-por-regiao" class="stats-list">
                                    {% if stats_detalhadas and stats_detalhadas.por_regiao %}
                                        {% for regiao, quantidade in stats_detalhadas.por_regiao.items() %}
                                        <div class="d-flex justify-content-between">
                                            <span>{{ regiao }}:</span>
                                            <strong>{{ quantidade }}</strong>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted">Carregando...</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Por Marca -->
                            <div class="col-md-3">
                                <h6><i class="fas fa-tag"></i> Por Marca</h6>
                                <div id="stats-por-marca" class="stats-list">
                                    {% if stats_detalhadas and stats_detalhadas.por_marca %}
                                        {% for marca, quantidade in stats_detalhadas.por_marca.items() %}
                                        <div class="d-flex justify-content-between">
                                            <span>{{ marca }}:</span>
                                            <strong>{{ quantidade }}</strong>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted">Carregando...</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Por Status -->
                            <div class="col-md-3">
                                <h6><i class="fas fa-traffic-light"></i> Por Status</h6>
                                <div id="stats-por-status" class="stats-list">
                                    {% if stats_detalhadas and stats_detalhadas.por_status %}
                                        {% for status, quantidade in stats_detalhadas.por_status.items() %}
                                        <div class="d-flex justify-content-between">
                                            <span class="{% if status == 'Em atividade' %}text-success{% elif status == 'Parados' %}text-danger{% else %}text-warning{% endif %}">
                                                {{ status }}:
                                            </span>
                                            <strong>{{ quantidade }}</strong>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted">Carregando...</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- NOVO: Elevadores Parados (se houver) -->
                        <div class="row mt-4" id="elevadores-parados-section" style="display: none;">
                            <div class="col-12">
                                <h6><i class="fas fa-exclamation-triangle text-danger"></i> Elevadores Parados</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>Unidade</th>
                                                <th>Cidade</th>
                                                <th>Tipo</th>
                                                <th>Regi√£o</th>
                                                <th>Parados</th>
                                                <th>Total</th>
                                                <th>Marca</th>
                                            </tr>
                                        </thead>
                                        <tbody id="elevadores-parados-tbody">
                                            <!-- Preenchido via JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros (agora com altura total) -->
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h5><i class="fas fa-filter"></i> Filtros</h5>
                    </div>
                    <div class="card-body">
                        <!-- Contador de Resultados -->
                        <div class="alert alert-info" id="contador-resultados">
                            <strong>Total:</strong> 
                            <span id="total-elevadores-filtro">{{ stats.total_elevadores if stats else 0 }}</span> elevadores em 
                            <span id="total-locais-filtro">{{ stats.total_predios if stats else 0 }}</span> locais
                        </div>

                        <!-- Bot√É¬µes de A√ß√£o -->
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-6">
                                    <button class="btn btn-success btn-sm w-100 mb-2" onclick="aplicarFiltros()">
                                        <i class="fas fa-search"></i> Aplicar
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-info btn-sm w-100 mb-2" onclick="selecionarTodos()">
                                        <i class="fas fa-check-double"></i> Todos
                                    </button>
                                </div>
                            </div>
                            <button class="btn btn-secondary btn-sm w-100" onclick="limparFiltros()">
                                <i class="fas fa-eraser"></i> Limpar Filtros
                            </button>
                        </div>

                        <!-- Filtros por Tipo -->
                        {% if tipos_unicos %}
                        <div class="mb-3">
                            <h6><i class="fas fa-building"></i> Tipo</h6>
                            <div class="filter-section">
                                {% for tipo in tipos_unicos %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           id="check-tipo-{{ loop.index }}" value="{{ tipo }}">
                                    <label class="form-check-label" for="check-tipo-{{ loop.index }}">
                                        {{ tipo }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Filtros por Regi√£o -->
                        {% if regioes_unicas %}
                        <div class="mb-3">
                            <h6><i class="fas fa-map"></i> Regi√£o</h6>
                            <div class="filter-section">
                                {% for regiao in regioes_unicas %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           id="check-regiao-{{ loop.index }}" value="{{ regiao }}">
                                    <label class="form-check-label" for="check-regiao-{{ loop.index }}">
                                        {{ regiao }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Filtros por Situa√ß√£o -->
                        <div class="mb-3">
                            <h6><i class="fas fa-traffic-light"></i> Situa√ß√£o</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       id="check-situacao-ativos" value="ativos">
                                <label class="form-check-label" for="check-situacao-ativos">
                                    <span class="text-success">√¢‚Äî¬è</span> Ativos
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       id="check-situacao-suspensos" value="suspensos">
                                <label class="form-check-label" for="check-situacao-suspensos">
                                    <span class="text-warning">√¢‚Äî¬è</span> Suspensos
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       id="check-situacao-parados" value="parados">
                                <label class="form-check-label" for="check-situacao-parados">
                                    <span class="text-danger">√¢‚Äî¬è</span> Parados
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
    // Dados iniciais do GeoJSON passados do backend via Jinja2
    const initialGeojsonData = {{ geojson_data | tojson if geojson_data else '{"type": "FeatureCollection", "features": []}' }};
    const initialStats = {{ stats | tojson if stats else '{}' }};
    const initialDetailedStats = {{ stats_detalhadas | tojson if stats_detalhadas else '{}' }};
    // Se houver outras vari√É¬°veis Jinja2 usadas diretamente no JavaScript, passe-as aqui tamb√É¬©m.
    
    // Vari√É¬°veis globais para os tipos √É¬∫nicos, regi√É¬µes √É¬∫nicas, etc.
    // O Jinja2 j√É¬° as est√É¬° passando para o template.
    // Para acess√É¬°-las no JS externo, voc√É¬™ pode pass√É¬°-las como no exemplo abaixo,
    // ou fazer chamadas de API para obt√É¬™-las se elas mudarem dinamicamente.
    // Por enquanto, vamos considerar que s√£o carregadas uma vez.
    const uniqueTypes = {{ tipos_unicos | tojson | safe }};
    const uniqueRegions = {{ regioes_unicas | tojson | safe }};
    const uniqueBrands = {{ marcas_unicas | tojson | safe }};
    const uniqueCompanies = {{ empresas_unicas | tojson | safe }};
</script>

<!-- Script customizado para o dashboard v2 -->
<script src="{{ url_for('static', filename='js/dashboard_v2.js') }}"></script>

</body>
</html>
--- Fim do cÛdigo: dashboard.html ---

--- InÌcio do cÛdigo: kpis.html ---
{% extends "base.html" %}

{# CORRIGIDO: Certifique-se de que h√É¬° APENAS UMA defini√ß√£o de block title #}
{% block title %}KPIs de Manuten√ß√£o - Sistema de Elevadores TJ/MG{% endblock %}

{% block extra_head %}
<!-- Chart.js -->
{# CORRIGIDO: URLs atualizadas para Chart.js v3.x e seus adaptadores #}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/index.min.js"></script>
{# Opcional: Se precisar de um locale espec√É¬≠fico para date-fns, pode adicionar aqui. #}
{# Chart.js v3 usa a config global para locale do date-fns adapter. #}
<script>
    // Configura locale global para Chart.js date-fns adapter
    Chart.defaults.plugins.tooltip.usePointStyle = true; // Estilo de tooltip mais moderno
    Chart.defaults.font.family = "'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif";
    Chart.defaults.color = '#333'; // Cor padr√£o do texto nos gr√É¬°ficos
</script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-chart-line"></i> 
            KPIs de Manuten√ß√£o - Elevadores TJ/MG
        </h1>
    </div>
</div>

{% if erro %}
    <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle"></i> {{ erro }}
    </div>
{% else %}
    <!-- Filtros Avan√ßados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-filter"></i> Filtros</h5>
                    <div>
                        <button class="btn btn-success btn-sm me-2" onclick="aplicarFiltros()">
                            <i class="fas fa-search"></i> Aplicar Filtros
                        </button>
                        <button class="btn btn-secondary btn-sm me-2" onclick="limparFiltrosKPIs()">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                        <button class="btn btn-info btn-sm" onclick="atualizarDados()"> {# Esta fun√ß√£o chamar√É¬° o /v2/kpis/atualizar-kpis #}
                            <i class="fas fa-sync-alt"></i> Atualizar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Primeira linha: Filtros de Data -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-calendar"></i> Data de In√É¬≠cio</label>
                            <input type="date" class="form-control" id="data-inicio">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-calendar"></i> Data de Fim</label>
                            <input type="date" class="form-control" id="data-fim">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><i class="fas fa-clock"></i> Per√É¬≠odo Predefinido</label>
                            <select class="form-select" id="filtro-periodo" onchange="selecionarPeriodoPredefinido()">
                                <option value="">Selecione um per√É¬≠odo...</option>
                                <option value="ultima-semana">√É≈°ltima Semana</option>
                                <option value="ultimo-mes">√É≈°ltimo M√É¬™s</option>
                                <option value="ultimos-3-meses">√É≈°ltimos 3 Meses</option>
                                <option value="ultimos-6-meses">√É≈°ltimos 6 Meses</option>
                                <option value="ultimo-ano">√É≈°ltimo Ano</option>
                                <option value="ultimos-2-anos">√É≈°ltimos 2 Anos</option>
                                <option value="ultimos-5-anos">√É≈°ltimos 5 Anos</option>
                                <option value="todo-periodo">Todo o Per√É¬≠odo</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Segunda linha: Outros filtros -->
                    <div class="row">
                        <!-- Filtro por Status -->
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-tasks"></i> Status</label>
                            <select class="form-select" id="filtro-status">
                                <option value="">Todos os status</option>
                                <option value="Conclu√É¬≠da">Conclu√É¬≠da</option>
                                <option value="Confirmada">Confirmada</option>
                                <option value="Pendente">Pendente</option> {# NOVO: Adicione Pendente se seu status incluir #}
                            </select>
                        </div>
                        
                        <!-- Filtro por Categoria -->
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-tags"></i> Categoria</label>
                            <select class="form-select" id="filtro-categoria">
                                <option value="">Todas as categorias</option>
                                <!-- Preenchido dinamicamente via JavaScript -->
                            </select>
                        </div>
                        
                        <!-- Filtro por Edif√É¬≠cio -->
                        <div class="col-md-3"> {# CORRIGIDO: Reduzido para 3 para adicionar Equipamento #}
                            <label class="form-label"><i class="fas fa-building"></i> Edif√É¬≠cio</label>
                            <select class="form-select" id="filtro-edificio">
                                <option value="">Todos os edif√É¬≠cios</option>
                                <!-- Preenchido dinamicamente via JavaScript -->
                            </select>
                        </div>

                        <!-- NOVO: Filtro por Elevador (Equipamento) -->
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-elevator"></i> Elevador (Equipamento)</label>
                            <select class="form-select" id="filtro-equipamento">
                                <option value="">Todos os elevadores</option>
                                <!-- Preenchido dinamicamente via JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards de KPIs Principais -->
    <div class="row mb-4" id="kpis-cards">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                    <h3 id="total-chamados">{{ metricas.total_chamados or 0 }}</h3>
                    <p class="mb-0">Total de Chamados</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <h3 id="chamados-concluidos">{{ metricas.chamados_concluidos or 0 }}</h3>
                    <p class="mb-0">Chamados Conclu√É¬≠dos</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h3 id="tempo-mediano">{{ "%.1f"|format(metricas.tempo_mediano_reparo or 0) }}h</h3>
                    <p class="mb-0">Tempo Mediano de Reparo</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-percentage fa-2x mb-2"></i>
                    <h3 id="disponibilidade">{{ "%.1f"|format(metricas.disponibilidade or 0) }}%</h3>
                    <p class="mb-0">Taxa de Conclus√£o</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Indicador de Filtros Ativos -->
    <div class="row mb-3" id="filtros-ativos" style="display: none;">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-filter"></i> 
                <strong>Filtros ativos:</strong> 
                <span id="descricao-filtros"></span>
                <button class="btn btn-sm btn-outline-primary ms-2" onclick="limparFiltrosKPIs()">
                    <i class="fas fa-times"></i> Remover filtros
                </button>
            </div>
        </div>
    </div>

    <!-- Gr√É¬°ficos -->
    <div class="row">
        <!-- Gr√É¬°fico de Chamados por M√É¬™s -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> Chamados por M√É¬™s</h5>
                    <small class="text-muted">Clique nos pontos para filtrar por m√É¬™s</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-chamados-mes" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Gr√É¬°fico de Categorias de Problema -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-pie"></i> Categorias de Problemas</h5>
                    <small class="text-muted">Clique nas fatias para filtrar por categoria</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-categorias" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Gr√É¬°fico de Edif√É¬≠cios Mais Problem√É¬°ticos -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Edif√É¬≠cios com Mais Chamados</h5>
                    <small class="text-muted">Clique nas barras para filtrar por edif√É¬≠cio</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-edificios" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Gr√É¬°fico de Tempo por Categoria -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-stopwatch"></i> Tempo Mediano por Categoria</h5>
                    <small class="text-muted">Clique nas barras para filtrar por categoria</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-tempo-categoria" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- NOVO: SE√É‚Ä°√É∆íO DE GR√É¬ÅFICOS DE ELEVADORES -->
    <div class="row">
        <!-- Gr√É¬°fico de Chamados por Elevador -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-elevator"></i> Chamados por Elevador</h5>
                    <small class="text-muted">Clique nas barras para filtrar por elevador espec√É¬≠fico</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-chamados-elevador" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Gr√É¬°fico de Tempo Mediano por Elevador -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clock"></i> Tempo Mediano de Atendimento por Elevador</h5>
                    <small class="text-muted">Clique nas barras para filtrar por elevador espec√É¬≠fico</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-tempo-elevador" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Resumo Filtrado -->
    <div class="row">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-table"></i> Resumo dos Dados Filtrados</h5>
            </div>
            <div class="card-body">
                <div id="loading-resumo" class="text-center" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Carregando dados...
                </div>
                <div id="tabela-resumo">
                    <p class="text-muted text-center">Use os filtros acima ou clique nos gr√É¬°ficos para ver dados espec√É¬≠ficos.</p>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<script>
// Dados para JavaScript
const dadosKPIsOriginais = {{ metricas|tojson|safe }};
let dadosKPIsFiltrados = dadosKPIsOriginais;
let graficos = {};
let filtrosAtivos = {};

// NOVO: Vari√É¬°veis para preencher os selects de filtro
const categoriasUnicas = {{ categorias_unicas|tojson|safe }};
const edificiosUnicos = {{ edificios_unicos|tojson|safe }};
const equipamentosUnicos = {{ equipamentos_unicos|tojson|safe }}; // NOVO

console.log('√∞≈∏‚Äú≈† Dados de KPIs recebidos:', dadosKPIsOriginais);
console.log('√¢≈°‚Ñ¢√Ø¬∏¬è Categorias √É≈°nicas:', categoriasUnicas);
console.log('√¢≈°‚Ñ¢√Ø¬∏¬è Edif√É¬≠cios √É≈°nicos:', edificiosUnicos);
console.log('√¢≈°‚Ñ¢√Ø¬∏¬è Equipamentos √É≈°nicos:', equipamentosUnicos); // NOVO


// Inicializa gr√É¬°ficos quando a p√É¬°gina carrega
document.addEventListener('DOMContentLoaded', function() {
    console.log('√∞≈∏‚Äú‚Äû DOM carregado, criando gr√É¬°ficos de KPIs...');
    preencherFiltros();
    criarGraficos();
});

function preencherFiltros() {
    // Preenche filtro de categorias
    const selectCategoria = document.getElementById('filtro-categoria');
    categoriasUnicas.forEach(categoria => {
        const option = document.createElement('option');
        option.value = categoria;
        option.textContent = categoria;
        selectCategoria.appendChild(option);
    });
    
    // Preenche filtro de edif√É¬≠cios
    const selectEdificio = document.getElementById('filtro-edificio');
    edificiosUnicos.forEach(edificio => {
        const option = document.createElement('option');
        option.value = edificio;
        option.textContent = edificio.length > 50 ? edificio.substring(0, 50) + '...' : edificio;
        selectEdificio.appendChild(option);
    });

    // NOVO: Preenche filtro de equipamentos (Elevadores)
    const selectEquipamento = document.getElementById('filtro-equipamento');
    equipamentosUnicos.forEach(equipamento => {
        const option = document.createElement('option');
        option.value = equipamento;
        option.textContent = equipamento;
        selectEquipamento.appendChild(option);
    });
}

// √∞≈∏‚Äú‚Ä¶ NOVA FUN√É‚Ä°√É∆íO: Selecionar per√É¬≠odo predefinido
function selecionarPeriodoPredefinido() {
    const periodo = document.getElementById('filtro-periodo').value;
    
    if (periodo && periodo !== 'todo-periodo') {
        // Limpa datas personalizadas quando seleciona per√É¬≠odo predefinido
        document.getElementById('data-inicio').value = '';
        document.getElementById('data-fim').value = '';
    }
    
    console.log('√∞≈∏‚Äú‚Ä¶ Per√É¬≠odo predefinido selecionado:', periodo);
}

function criarGraficos() {
    // Destroi gr√É¬°ficos existentes
    Object.values(graficos).forEach(grafico => {
        if (grafico) grafico.destroy();
    });
    
    // Cria novos gr√É¬°ficos
    criarGraficoChamadosPorMes();
    criarGraficoCategorias();
    criarGraficoEdificios();
    criarGraficoTempoPorCategoria();
    
    // NOVOS GR√É¬ÅFICOS DE ELEVADORES
    criarGraficoChamadosPorElevador();
    criarGraficoTempoMedianoPorElevador();
}

function criarGraficoChamadosPorMes() {
    const ctx = document.getElementById('grafico-chamados-mes');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.chamados_por_mes || {};
    const labels = Object.keys(dados).sort();
    const values = labels.map(label => dados[label]);
    
    graficos.chamadosMes = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Chamados',
                data: values,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#007bff',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    type: 'time', {# CORRIGIDO: Use escala de tempo para melhor visualiza√ß√£o #}
                    time: {
                        unit: 'month',
                        tooltipFormat: 'MMM yyyy'
                    },
                    adapters: {
                        date: {
                            // Certifique-se de que o locale 'pt-BR' est√É¬° dispon√É¬≠vel para date-fns
                            // Se n√£o estiver funcionando, pode ser necess√É¬°rio importar explicitamente o locale do date-fns
                            // No entanto, Chart.js adapta globalmente, ent√£o deve funcionar.
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const mesAno = labels[index];
                    filtrarPorMes(mesAno);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

function criarGraficoCategorias() {
    const ctx = document.getElementById('grafico-categorias');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.categorias_problema || {};
    
    // √∞≈∏‚Äù‚Äû ORDENA√É‚Ä°√É∆íO DECRESCENTE
    const entries = Object.entries(dados).sort((a, b) => b[1] - a[1]);
    const labels = entries.map(entry => entry[0]);
    const values = entries.map(entry => entry[1]);
    
    const cores = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
        '#E0BBE4', '#957DAD', '#D291BC', '#FFC72C'
    ];
    
    graficos.categorias = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: cores.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff',
                hoverBorderWidth: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const categoria = labels[index];
                    filtrarPorCategoria(categoria);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// √∞≈∏‚Äù‚Äû MODIFICADO: Gr√É¬°fico de Edif√É¬≠cios com ordena√ß√£o decrescente garantida
function criarGraficoEdificios() {
    const ctx = document.getElementById('grafico-edificios');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.chamados_por_edificio || {};
    
    // √∞≈∏‚Äù‚Äû ORDENA√É‚Ä°√É∆íO DECRESCENTE EXPL√É¬çCITA (garantindo que funcione mesmo se backend n√£o ordenar)
    const entries = Object.entries(dados)
        .sort((a, b) => b[1] - a[1])  // Ordena por valor decrescente
        .slice(0, 10); // Top 10
    
    const labels = entries.map(entry => entry[0]);
    const values = entries.map(entry => entry[1]);
    
    console.log('√∞≈∏¬è¬¢ Dados de edif√É¬≠cios ordenados:', entries);
    
    graficos.edificios = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels.map(label => label.length > 20 ? label.substring(0, 20) + '...' : label),
            datasets: [{
                label: 'Chamados',
                data: values,
                backgroundColor: '#28a745',
                borderColor: '#1e7e34',
                borderWidth: 1,
                hoverBackgroundColor: '#34ce57'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const edificio = labels[index];
                    filtrarPorEdificio(edificio);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// √∞≈∏‚Äù‚Äû MODIFICADO: Gr√É¬°fico de Tempo por Categoria com ordena√ß√£o decrescente garantida
function criarGraficoTempoPorCategoria() {
    const ctx = document.getElementById('grafico-tempo-categoria');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.tempo_por_categoria || {};
    
    // √∞≈∏‚Äù‚Äû ORDENA√É‚Ä°√É∆íO DECRESCENTE EXPL√É¬çCITA (garantindo que funcione mesmo se backend n√£o ordenar)
    const entries = Object.entries(dados)
        .sort((a, b) => b[1] - a[1]); // Ordena por valor decrescente
    
    const labels = entries.map(entry => entry[0]);
    const values = entries.map(entry => Math.round(entry[1] * 10) / 10);
    
    console.log('√¢¬è¬±√Ø¬∏¬è Dados de tempo por categoria ordenados:', entries);
    
    graficos.tempoCategoria = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tempo Mediano (horas)',
                data: values,
                backgroundColor: '#ffc107',
                borderColor: '#e0a800',
                borderWidth: 1,
                hoverBackgroundColor: '#ffcd39'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + 'h';
                        }
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const categoria = labels[index];
                    filtrarPorCategoria(categoria);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// NOVO: Gr√É¬°fico de Chamados por Elevador
function criarGraficoChamadosPorElevador() {
    const ctx = document.getElementById('grafico-chamados-elevador');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.chamados_por_equipamento || {};
    
    // Ordena√ß√£o decrescente e limita√ß√£o aos top 15 elevadores
    const entries = Object.entries(dados)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 15); // Top 15 elevadores
    
    const labels = entries.map(entry => String(entry[0]));
    const values = entries.map(entry => entry[1]);
    
    console.log('√∞≈∏¬è‚Äî√Ø¬∏¬è Dados de chamados por elevador ordenados:', entries);
    
    graficos.chamadosElevador = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Chamados',
                data: values,
                backgroundColor: '#007bff',
                borderColor: '#0056b3',
                borderWidth: 1,
                hoverBackgroundColor: '#0056b3'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return 'Elevador: ' + context[0].label;
                        },
                        label: function(context) {
                            return 'Chamados: ' + context.parsed.y;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        font: {
                            size: 10
                        }
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const elevador = String(labels[index]);
                    filtrarPorEquipamento(elevador); {# CORRIGIDO: Chamando filtrarPorEquipamento #}
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// NOVO: Gr√É¬°fico de Tempo Mediano por Elevador
function criarGraficoTempoMedianoPorElevador() {
    const ctx = document.getElementById('grafico-tempo-elevador');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.tempo_por_equipamento || {};
    
    // Ordena√ß√£o decrescente e limita√ß√£o aos top 15 elevadores
    const entries = Object.entries(dados)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 15); // Top 15 elevadores
    
    const labels = entries.map(entry => String(entry[0]));
    const values = entries.map(entry => Math.round(entry[1] * 10) / 10);
    
    console.log('√¢¬è¬∞ Dados de tempo por elevador ordenados:', entries);
    
    graficos.tempoElevador = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tempo Mediano (horas)',
                data: values,
                backgroundColor: '#17a2b8',
                borderColor: '#138496',
                borderWidth: 1,
                hoverBackgroundColor: '#138496'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return 'Elevador: ' + context[0].label;
                        },
                        label: function(context) {
                            return 'Tempo Mediano: ' + context.parsed.y + 'h';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + 'h';
                        }
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        font: {
                            size: 10
                        }
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const elevador = String(labels[index]);
                    filtrarPorEquipamento(elevador); {# CORRIGIDO: Chamando filtrarPorEquipamento #}
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// Fun√ß√É¬µes de filtro por clique nos gr√É¬°ficos
function filtrarPorMes(mesAno) {
    console.log('√∞≈∏‚Äú‚Ä¶ Filtrando por m√É¬™s:', mesAno);
    // Para filtro por m√É¬™s, precisamos ajustar data_inicio e data_fim
    const [ano, mes] = mesAno.split('-');
    const dataInicioMes = `${ano}-${mes}-01`;
    const ultimoDiaMes = new Date(ano, parseInt(mes), 0).getDate();
    const dataFimMes = `${ano}-${mes}-${ultimoDiaMes}`;

    document.getElementById('data-inicio').value = dataInicioMes;
    document.getElementById('data-fim').value = dataFimMes;
    document.getElementById('filtro-periodo').value = ''; // Limpa per√É¬≠odo predefinido

    filtrosAtivos.data_inicio = dataInicioMes;
    filtrosAtivos.data_fim = dataFimMes;
    delete filtrosAtivos.periodo_predefinido;
    delete filtrosAtivos.mes; // Remove filtro de m√É¬™s para evitar conflito

    aplicarFiltrosInterativos();
}

function filtrarPorCategoria(categoria) {
    console.log('√∞≈∏¬è¬∑√Ø¬∏¬è Filtrando por categoria:', categoria);
    document.getElementById('filtro-categoria').value = categoria;
    filtrosAtivos.categoria = categoria;
    aplicarFiltrosInterativos();
}

function filtrarPorEdificio(edificio) {
    console.log('√∞≈∏¬è¬¢ Filtrando por edif√É¬≠cio:', edificio);
    document.getElementById('filtro-edificio').value = edificio;
    filtrosAtivos.edificio = edificio;
    aplicarFiltrosInterativos();
}

// NOVO: Filtrar por elevador espec√É¬≠fico (equipamento)
function filtrarPorEquipamento(equipamento) {
    console.log('√∞≈∏¬è‚Äî√Ø¬∏¬è Filtrando por equipamento:', equipamento);
    document.getElementById('filtro-equipamento').value = equipamento;
    filtrosAtivos.equipamento = equipamento;
    aplicarFiltrosInterativos();
}

function aplicarFiltros() {
    const dataInicio = document.getElementById('data-inicio').value;
    const dataFim = document.getElementById('data-fim').value;
    const periodo = document.getElementById('filtro-periodo').value;
    const status = document.getElementById('filtro-status').value;
    const categoria = document.getElementById('filtro-categoria').value;
    const edificio = document.getElementById('filtro-edificio').value;
    const equipamento = document.getElementById('filtro-equipamento').value; {# NOVO #}
    
    console.log('√∞≈∏‚Äù¬ç Aplicando filtros:', {
        dataInicio, dataFim, periodo, status, categoria, edificio, equipamento
    });
    
    // √∞≈∏‚Äú‚Ä¶ VALIDA√É‚Ä°√É∆íO DE DATAS
    if (dataInicio && dataFim && new Date(dataInicio) > new Date(dataFim)) {
        alert('A data de in√É¬≠cio n√£o pode ser posterior √É¬† data de fim.');
        return;
    }
    
    // MAPEAMENTO CORRETO DOS PAR√É‚ÄöMETROS
    filtrosAtivos = {
        data_inicio: dataInicio,
        data_fim: dataFim,
        periodo_predefinido: periodo,
        status: status,
        categoria: categoria,
        edificio: edificio,
        equipamento: equipamento {# NOVO #}
    };
    
    // Remove filtros vazios
    Object.keys(filtrosAtivos).forEach(key => {
        if (!filtrosAtivos[key]) {
            delete filtrosAtivos[key];
        }
    });
    
    console.log('√∞≈∏‚Äù¬ß Filtros ativos ap√É¬≥s limpeza:', filtrosAtivos);
    
    aplicarFiltrosInterativos();
}

function aplicarFiltrosInterativos() {
    console.log('√∞≈∏‚Äù¬ç Aplicando filtros interativos:', filtrosAtivos);
    
    // Monta par√É¬¢metros para API
    const params = new URLSearchParams();
    Object.keys(filtrosAtivos).forEach(key => {
        if (filtrosAtivos[key]) {
            params.append(key, filtrosAtivos[key]);
        }
    });
    
    // Mostra loading
    const loadingElement = document.getElementById('loading-resumo');
    if (loadingElement) loadingElement.style.display = 'block';
    
    // Faz requisi√ß√£o para API
    fetch('/api/kpis-filtrados?' + params.toString())
        .then(response => {
            if (!response.ok) {
                // Se a resposta n√£o for 2xx, tenta ler como JSON de erro
                return response.json().then(errorData => {
                    throw new Error(errorData.message || 'Erro na API');
                });
            }
            return response.json();
        })
        .then(data => {
            if (loadingElement) loadingElement.style.display = 'none';
            
            if (data.success) {
                // Atualiza dados filtrados
                dadosKPIsFiltrados = data.metricas;
                
                // Atualiza cards
                atualizarCards(data.metricas);
                
                // Recria gr√É¬°ficos
                criarGraficos();
                
                // Mostra indicador de filtros ativos
                mostrarFiltrosAtivos();
                
                // Atualiza tabela de resumo
                atualizarTabelaResumo(data.resumo);
            } else {
                alert('Erro ao aplicar filtros: ' + (data.message || 'Erro desconhecido.'));
                console.error('API Error:', data);
            }
        })
        .catch(error => {
            if (loadingElement) loadingElement.style.display = 'none';
            console.error('√¢¬ù≈í Erro ao aplicar filtros:', error);
            alert('Erro na requisi√ß√£o de filtros: ' + error.message + '. Verifique o console para mais detalhes.');
        });
}

function atualizarCards(metricas) {
    document.getElementById('total-chamados').textContent = metricas.total_chamados || 0;
    document.getElementById('chamados-concluidos').textContent = metricas.chamados_concluidos || 0;
    document.getElementById('tempo-mediano').textContent = (metricas.tempo_mediano_reparo || 0).toFixed(1) + 'h';
    document.getElementById('disponibilidade').textContent = (metricas.disponibilidade || 0).toFixed(1) + '%';
}

function mostrarFiltrosAtivos() {
    const filtrosAtivosDiv = document.getElementById('filtros-ativos');
    const descricaoFiltros = document.getElementById('descricao-filtros');
    
    const filtrosTexto = [];
    
    // MELHORIA: Descri√ß√£o mais clara dos filtros
    const dataInicio = document.getElementById('data-inicio').value;
    const dataFim = document.getElementById('data-fim').value;
    const periodo = document.getElementById('filtro-periodo').value;
    
    if (dataInicio || dataFim) {
        let textoData = 'Per√É¬≠odo: ';
        if (dataInicio && dataFim) {
            textoData += `${dataInicio} a ${dataFim}`;
        } else if (dataInicio) {
            textoData += `a partir de ${dataInicio}`;
        } else {
            textoData += `at√É¬© ${dataFim}`;
        }
        filtrosTexto.push(textoData);
    } else if (periodo) {
        const periodos = {
            'ultima-semana': '√É≈°ltima Semana',
            'ultimo-mes': '√É≈°ltimo M√É¬™s',
            'ultimos-3-meses': '√É≈°ltimos 3 Meses',
            'ultimos-6-meses': '√É≈°ltimos 6 Meses',
            'ultimo-ano': '√É≈°ltimo Ano',
            'ultimos-2-anos': '√É≈°ltimos 2 Anos',
            'ultimos-5-anos': '√É≈°ltimos 5 Anos',
            'todo-periodo': 'Todo o Per√É¬≠odo'
        };
        filtrosTexto.push(`Per√É¬≠odo: ${periodos[periodo]}`);
    }
    
    Object.keys(filtrosAtivos).forEach(key => {
        if (filtrosAtivos[key] && !['data_inicio', 'data_fim', 'periodo_predefinido'].includes(key)) {
             const nomesFiltros = {
                'equipamento': 'Elevador', // NOVO
                'categoria': 'Categoria',
                'edificio': 'Edif√É¬≠cio',
                'status': 'Status'
            };
            const nomeAmigavel = nomesFiltros[key] || key;
            filtrosTexto.push(`${nomeAmigavel}: ${filtrosAtivos[key]}`);
        }
    });
    
    if (filtrosTexto.length > 0) {
        descricaoFiltros.textContent = filtrosTexto.join(' | ');
        filtrosAtivosDiv.style.display = 'block';
    } else {
        filtrosAtivosDiv.style.display = 'none';
    }
}

function atualizarTabelaResumo(resumo) {
    const container = document.getElementById('tabela-resumo');
    if (!resumo || resumo.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">Nenhum dado encontrado com os filtros aplicados.</p>';
        return;
    }
    
    let html = `
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Categoria</th>
                        <th>Edif√É¬≠cio</th>
                        <th>Equipamento</th> {# NOVO: Coluna adicionada #}
                        <th>Status</th>
                        <th>Data Solicita√ß√£o</th>
                        <th>Tempo Reparo (h)</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    resumo.slice(0, 20).forEach(item => { // Mostra apenas os primeiros 20
        html += `
            <tr>
                <td><span class="badge bg-secondary">${item.categoria_problema}</span></td>
                <td>${item.edificio}</td>
                <td>${item.equipamento || '-'}</td> {# NOVO: Dados do equipamento #}
                <td><span class="badge ${item.status === 'Conclu√É¬≠da' ? 'bg-success' : 'bg-warning'}">${item.status}</span></td>
                <td>${item.data_solicitacao}</td>
                <td>${item.tempo_reparo_horas ? item.tempo_reparo_horas.toFixed(1) : '-'}</td> {# CORRIGIDO: Usar tempo_reparo_horas #}
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        ${resumo.length > 20 ? `<p class="text-muted text-center">Mostrando 20 de ${resumo.length} registros</p>` : ''}
    `;
    
    container.innerHTML = html;
}

function limparFiltrosKPIs() {
    // √∞≈∏‚Äú‚Ä¶ LIMPA TODOS OS FILTROS (incluindo datas)
    document.getElementById('data-inicio').value = '';
    document.getElementById('data-fim').value = '';
    document.getElementById('filtro-periodo').value = '';
    document.getElementById('filtro-status').value = '';
    document.getElementById('filtro-categoria').value = '';
    document.getElementById('filtro-edificio').value = '';
    document.getElementById('filtro-equipamento').value = ''; {# NOVO #}
    
    // Limpa filtros ativos
    filtrosAtivos = {};
    
    // Restaura dados originais
    dadosKPIsFiltrados = dadosKPIsOriginais;
    
    // Atualiza cards
    atualizarCards(dadosKPIsOriginais);
    
    // Recria gr√É¬°ficos
    criarGraficos();
    
    // Esconde indicador de filtros
    document.getElementById('filtros-ativos').style.display = 'none';
    
    // Limpa tabela de resumo
    document.getElementById('tabela-resumo').innerHTML = '<p class="text-muted text-center">Use os filtros acima ou clique nos gr√É¬°ficos para ver dados espec√É¬≠ficos.</p>';
    
    console.log('√∞≈∏¬ß¬π Filtros de KPIs limpos');
}

function atualizarDados() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
    btn.disabled = true;
    
    // Chamada para a API do Blueprint de KPIs para atualizar o cache
    fetch('/v2/kpis/atualizar-kpis', { method: 'POST' })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.message || 'Erro na API');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('Dados de KPIs atualizados!\n' + data.message);
                // Ap√É¬≥s atualizar o cache, recarregar a p√É¬°gina para buscar os novos dados
                location.reload(); 
            } else {
                alert('Erro ao atualizar KPIs: ' + data.message);
            }
        })
        .catch(error => alert('Erro na requisi√ß√£o de atualiza√ß√£o de KPIs: ' + error.message))
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

function debugFiltros() {
    console.log('√∞≈∏‚Äù¬ç DEBUG - Estado atual dos filtros:');
    console.log('   Data in√É¬≠cio:', document.getElementById('data-inicio').value);
    console.log('   Data fim:', document.getElementById('data-fim').value);
    console.log('   Per√É¬≠odo:', document.getElementById('filtro-periodo').value);
    console.log('   Status:', document.getElementById('filtro-status').value);
    console.log('   Categoria:', document.getElementById('filtro-categoria').value);
    console.log('   Edif√É¬≠cio:', document.getElementById('filtro-edificio').value);
    console.log('   Equipamento:', document.getElementById('filtro-equipamento').value);
    console.log('   Filtros ativos:', filtrosAtivos);
    console.log('   Dados originais:', dadosKPIsOriginais);
    console.log('   Dados filtrados:', dadosKPIsFiltrados);
}

</script>
{% endblock %}
--- Fim do cÛdigo: kpis.html ---

--- InÌcio do cÛdigo: base.html ---
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Sistema de Elevadores - TJ/MG{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- CSS customizado -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    {% block extra_head %}{% endblock %}
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard.index') }}">
                <i class="fas fa-building"></i> TJ/MG - Elevadores
            </a>
            
            <div class="navbar-nav ms-auto d-flex align-items-center">
                <a class="nav-link" href="{{ url_for('dashboard.index') }}">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <!-- √∞≈∏‚Ä†‚Ä¢ NOVO BOT√É∆íO KPIs -->
                <a class="nav-link" href="{{ url_for('kpis.index') }}">
                    <i class="fas fa-chart-line"></i> KPIs
                </a>
                <button class="btn btn-outline-light btn-sm ms-2" onclick="atualizarDados()">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
                
                <!-- Informa√ß√É¬µes do usu√É¬°rio logado -->
                {% if usuario_logado %}
                <div class="nav-item dropdown ms-3">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle me-2"></i>
                        <span>{{ usuario_logado }}</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <span class="dropdown-item-text">
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> 
                                    Logado desde {{ login_timestamp[:19] if login_timestamp else 'N/A' }}
                                </small>
                            </span>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}">
                                <i class="fas fa-sign-out-alt"></i> Sair
                            </a>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Mensagens Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'danger' else 'warning' if category == 'warning' else 'info' if category == 'info' else 'success' }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-{{ 'exclamation-triangle' if category in ['danger', 'warning'] else 'info-circle' if category == 'info' else 'check-circle' }}"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Conte√É¬∫do principal -->
    <main class="container-fluid mt-4">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-light text-center py-3 mt-5">
        <div class="container">
            <small class="text-muted">
                Sistema de Mapeamento de Elevadores - Tribunal de Justi√ßa de Minas Gerais
                {% if usuario_logado %}
                    | Usu√É¬°rio: {{ usuario_logado }}
                {% endif %}
            </small>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- √∞≈∏‚Ä†‚Ä¢ JAVASCRIPT GLOBAL PARA FUN√É‚Ä°√É∆íO ATUALIZAR -->
    <script>
    function atualizarDados() {
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
        btn.disabled = true;
        
        // Verifica se estamos na p√É¬°gina de KPIs
        const isKPIsPage = window.location.pathname === '/kpis';
        const endpoint = isKPIsPage ? '/atualizar-kpis' : '/atualizar';
        const tipoAtualizacao = isKPIsPage ? 'KPIs' : 'Dados';
        
        console.log(`√∞≈∏‚Äù‚Äû Atualizando ${tipoAtualizacao} via ${endpoint}`);
        
        fetch(endpoint)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`${tipoAtualizacao} atualizados com sucesso!\n\n${data.message}`);
                    location.reload();
                } else {
                    alert(`Erro ao atualizar ${tipoAtualizacao}:\n${data.message}`);
                }
            })
            .catch(error => {
                console.error('√¢¬ù≈í Erro na requisi√ß√£o:', error);
                alert(`Erro na requisi√ß√£o de ${tipoAtualizacao}. Verifique a conex√£o.`);
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    }
    </script>
    
    {% block extra_scripts %}{% endblock %}
</body>
</html>
--- Fim do cÛdigo: base.html ---

--- InÌcio do cÛdigo: index_nativo.html ---
{% extends "base.html" %}

{% block title %}Dashboard - Sistema de Elevadores TJ/MG{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-building"></i> 
            Sistema de Mapeamento de Elevadores - TJ/MG
        </h1>
    </div>
</div>

{% if erro %}
    <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle"></i> {{ erro }}
    </div>
{% else %}
    <!-- Cards de Estat√É¬≠sticas -->
    <div class="row mb-4 stats-row" id="stats-cards">
        <div class="col-md-2">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-building fa-2x mb-2"></i>
                    <h3 id="stat-predios">{{ stats.total_predios }}</h3>
                    <p class="mb-0">Pr√É¬©dios</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-2">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-elevator fa-2x mb-2"></i>
                    <h3 id="stat-elevadores">{{ stats.total_elevadores }}</h3>
                    <p class="mb-0">Elevadores</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-2">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-map-marker-alt fa-2x mb-2"></i>
                    <h3 id="stat-cidades">{{ stats.cidades }}</h3>
                    <p class="mb-0">Cidades</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-2">
            <div class="card bg-secondary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-map fa-2x mb-2"></i>
                    <h3 id="stat-regioes">{{ stats.regioes }}</h3>
                    <p class="mb-0">Regi√É¬µes</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-2">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <h3 id="stat-ativos">{{ stats.em_atividade }}</h3>
                    <p class="mb-0">Ativos</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-2">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-times-circle fa-2x mb-2"></i>
                    <h3 id="stat-suspensos">{{ stats.suspensos }}</h3>
                    <p class="mb-0">Suspensos</p>
                </div>
            </div>
        </div>

        <div class="col-md-2">
            <div class="card bg-danger text-white">
                 <div class="card-body text-center">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                     <h3 id="stat-parados">{{ stats.elevadores_parados }}</h3>
                     <p class="mb-0">Parados</p>
                 </div>
            </div>
        </div>
    </div>

    <!-- Mapa Nativo -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-map"></i> Mapa Interativo com Filtros</h5>
                    <button class="btn btn-info btn-sm" onclick="atualizarDados()">
                        <i class="fas fa-sync-alt"></i> Atualizar Dados
                    </button>
                </div>
                <div class="card-body p-0" style="position: relative; height: 600px;">
                    <!-- Container do mapa -->
                    <div id="mapa" style="width: 100%; height: 100%;"></div>
                    
                    <!-- Filtros posicionados sobre o mapa -->
                    <div id="filtros-container" style="
                        position: absolute;
                        top: 10px;
                        left: 10px;
                        background: white;
                        padding: 15px;
                        border-radius: 8px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        z-index: 1000;
                        max-width: 300px;
                        max-height: 550px;
                        overflow-y: auto;
                        font-family: Arial, sans-serif;
                        font-size: 14px;
                    ">
                        <h5 style="margin: 0 0 15px 0; color: #333; text-align: center;">√∞≈∏‚Äù¬ç Filtros</h5>

                        <!-- Contador -->
                        <div id="contador-resultados" style="
                            background: #e8f4fd;
                            padding: 10px;
                            border-radius: 6px;
                            margin-bottom: 15px;
                            text-align: center;
                            font-weight: bold;
                            color: #1976d2;
                            border: 2px solid #bbdefb;
                        ">
                            <div>√∞≈∏‚Äú≈† <span id="total-elevadores-filtro">{{ stats.total_elevadores }}</span> elevadores</div>
                            <div style="font-size: 12px; margin-top: 3px;">
                                em <span id="total-locais-filtro">{{ stats.total_predios }}</span> locais
                            </div>
                        </div>

                        <!-- Bot√É¬µes -->
                        <div style="display: flex; gap: 5px; margin-bottom: 15px;">
                            <button onclick="selecionarTodos()" style="
                                flex: 1; padding: 6px; background: #4caf50; color: white;
                                border: none; border-radius: 4px; cursor: pointer;
                                font-size: 12px; font-weight: bold;
                            ">√¢≈ì‚Ä¶ Todos</button>
                            <button onclick="limparFiltros()" style="
                                flex: 1; padding: 6px; background: #f44336; color: white;
                                border: none; border-radius: 4px; cursor: pointer;
                                font-size: 12px; font-weight: bold;
                            ">√∞≈∏‚Äî‚Äò√Ø¬∏¬è Limpar</button>
                        </div>

                        <!-- Filtro por Tipo -->
                        <div style="margin-bottom: 15px; border: 1px solid #e0e0e0; border-radius: 6px; padding: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="font-weight: bold; color: #555;">√∞≈∏‚Äú‚Äπ Tipo</label>
                                <button onclick="toggleCategoria('tipo')" style="background: none; border: none; font-size: 16px; cursor: pointer; color: #666;" id="toggle-tipo">√¢≈æ‚Äì</button>
                            </div>
                            <div id="filtros-tipo" style="max-height: 100px; overflow-y: auto;">
                                {% for tipo in tipos_unicos %}
                                <div style="margin: 5px 0; display: flex; align-items: center;">
                                    <input type="checkbox" id="check-tipo-{{ loop.index }}" value="{{ tipo }}" 
                                           onchange="aplicarFiltros()" style="margin-right: 8px;">
                                    <label for="check-tipo-{{ loop.index }}" style="cursor: pointer; flex: 1; font-size: 13px;">
                                        {{ tipo }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Filtro por Regi√£o -->
                        <div style="margin-bottom: 15px; border: 1px solid #e0e0e0; border-radius: 6px; padding: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="font-weight: bold; color: #555;">√∞≈∏‚Äî¬∫√Ø¬∏¬è Regi√£o</label>
                                <button onclick="toggleCategoria('regiao')" style="background: none; border: none; font-size: 16px; cursor: pointer; color: #666;" id="toggle-regiao">√¢≈æ‚Äì</button>
                            </div>
                            <div id="filtros-regiao" style="max-height: 100px; overflow-y: auto;">
                                {% for regiao in regioes_unicas %}
                                <div style="margin: 5px 0; display: flex; align-items: center;">
                                    <input type="checkbox" id="check-regiao-{{ loop.index }}" value="{{ regiao }}" 
                                           onchange="aplicarFiltros()" style="margin-right: 8px;">
                                    <label for="check-regiao-{{ loop.index }}" style="cursor: pointer; flex: 1; font-size: 13px;">
                                        {{ regiao }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Filtro por Marca -->
                        <div style="margin-bottom: 15px; border: 1px solid #e0e0e0; border-radius: 6px; padding: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="font-weight: bold; color: #555;">√∞≈∏¬è¬≠ Marca</label>
                                <button onclick="toggleCategoria('marca')" style="background: none; border: none; font-size: 16px; cursor: pointer; color: #666;" id="toggle-marca">√¢≈æ‚Äì</button>
                            </div>
                            <div id="filtros-marca" style="max-height: 100px; overflow-y: auto;">
                                {% for marca in marcas_unicas %}
                                <div style="margin: 5px 0; display: flex; align-items: center;">
                                    <input type="checkbox" id="check-marca-{{ loop.index }}" value="{{ marca }}" 
                                           onchange="aplicarFiltros()" style="margin-right: 8px;">
                                    <label for="check-marca-{{ loop.index }}" style="cursor: pointer; flex: 1; font-size: 13px;">
                                        {{ marca }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Filtro por Empresa -->
                        {% if empresas_unicas %}
                        <div style="margin-bottom: 15px; border: 1px solid #e0e0e0; border-radius: 6px; padding: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="font-weight: bold; color: #555;">√∞≈∏¬è¬¢ Empresa</label>
                                <button onclick="toggleCategoria('empresa')" style="background: none; border: none; font-size: 16px; cursor: pointer; color: #666;" id="toggle-empresa">√¢≈æ‚Äì</button>
                            </div>
                            <div id="filtros-empresa" style="max-height: 100px; overflow-y: auto;">
                                {% for empresa in empresas_unicas %}
                                <div style="margin: 5px 0; display: flex; align-items: center;">
                                    <input type="checkbox" id="check-empresa-{{ loop.index }}" value="{{ empresa }}" 
                                           onchange="aplicarFiltros()" style="margin-right: 8px;">
                                    <label for="check-empresa-{{ loop.index }}" style="cursor: pointer; flex: 1; font-size: 13px;">
                                        {{ empresa }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        <!-- Filtro por Situa√ß√£o -->
                        <div style="margin-bottom: 15px; border: 1px solid #e0e0e0; border-radius: 6px; padding: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="font-weight: bold; color: #555;">√¢≈°¬° Situa√ß√£o</label>
                                <button onclick="toggleCategoria('situacao')" style="background: none; border: none; font-size: 16px; cursor: pointer; color: #666;" id="toggle-situacao">√¢≈æ‚Äì</button>
                            </div>
                            <div id="filtros-situacao" style="max-height: 100px; overflow-y: auto;">
                                <div style="margin: 5px 0; display: flex; align-items: center;">
                                    <input type="checkbox" id="check-situacao-1" value="ativos" 
                                           onchange="aplicarFiltros()" style="margin-right: 8px;">
                                    <label for="check-situacao-1" style="cursor: pointer; flex: 1; font-size: 13px;">
                                        √∞≈∏≈∏¬¢ Elevadores Ativos
                                    </label>
                                </div>
                                <div style="margin: 5px 0; display: flex; align-items: center;">
                                    <input type="checkbox" id="check-situacao-2" value="suspensos" 
                                           onchange="aplicarFiltros()" style="margin-right: 8px;">
                                    <label for="check-situacao-2" style="cursor: pointer; flex: 1; font-size: 13px;">
                                        √∞≈∏≈∏¬° Elevadores Suspensos
                                    </label>
                                </div>
                                <div style="margin: 5px 0; display: flex; align-items: center;">
                                    <input type="checkbox" id="check-situacao-3" value="parados" 
                                           onchange="aplicarFiltros()" style="margin-right: 8px;">
                                    <label for="check-situacao-3" style="cursor: pointer; flex: 1; font-size: 13px;">
                                        √∞≈∏‚Äù¬¥ Elevadores Parados
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estat√É¬≠sticas Detalhadas -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Estat√É¬≠sticas Detalhadas</h5>
                </div>
                <div class="card-body">
                    <div id="loading-stats" class="text-center" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Atualizando estat√É¬≠sticas...
                    </div>
                    <div id="stats-detalhadas">
                        <p class="text-muted">Use os filtros no mapa para ver estat√É¬≠sticas espec√É¬≠ficas.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Elevadores Parados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-exclamation-triangle text-danger"></i> Elevadores Parados</h5>
                    <span id="badge-total-parados" class="badge bg-danger">0</span>
                </div>
                <div class="card-body">
                    <div id="loading-elevadores-parados" class="text-center" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Carregando elevadores parados...
                    </div>
                    <div id="lista-elevadores-parados">
                        <p class="text-muted text-center">
                            <i class="fas fa-info-circle"></i> 
                            Use os filtros no mapa para ver elevadores parados espec√É¬≠ficos ou carregue a p√É¬°gina para ver todos.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Dados para JavaScript
const dadosOriginais = {{ geojson_data|safe }};
let dadosFiltrados = dadosOriginais;
let mapa = null;
let layerGroup = null;

console.log('√∞≈∏≈°‚Ç¨ Inicializando mapa nativo...');
console.log('√∞≈∏‚Äú≈† Dados recebidos:', dadosOriginais);

// Armazena valores originais dos stats
window.statsOriginais = {
    'stat-predios': {{ stats.total_predios }},
    'stat-elevadores': {{ stats.total_elevadores }},
    'stat-cidades': {{ stats.cidades }},
    'stat-regioes': {{ stats.regioes }},
    'stat-ativos': {{ stats.em_atividade }},
    'stat-suspensos': {{ stats.suspensos }},
    'stat-parados': {{ stats.elevadores_parados }}
};

// Inicializa o mapa quando a p√É¬°gina carrega
document.addEventListener('DOMContentLoaded', function() {
    console.log('√∞≈∏‚Äú‚Äû DOM carregado, criando mapa...');
    
    // Cria o mapa
    mapa = L.map('mapa').setView([-19.92, -43.92], 6);
    
    // Adiciona tile layer
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '√Ç¬© OpenStreetMap contributors, √Ç¬© CartoDB',
        maxZoom: 19
    }).addTo(mapa);
    
    // Cria grupo de camadas para os marcadores
    layerGroup = L.layerGroup().addTo(mapa);
    
    console.log('√¢≈ì‚Ä¶ Mapa criado com sucesso!');
    
    // Adiciona marcadores iniciais
    adicionarMarcadores(dadosOriginais);
    carregarElevadoresParadosIniciais();
});

// Fun√ß√£o para adicionar marcadores
function adicionarMarcadores(geojson) {
    if (!geojson.features || !layerGroup) {
        console.log('√¢≈°¬†√Ø¬∏¬è Sem features ou layerGroup para adicionar');
        return;
    }
    
    console.log(`√¢≈æ‚Ä¢ Adicionando ${geojson.features.length} marcadores...`);
    
    geojson.features.forEach((feature, index) => {
        const props = feature.properties;
        const coords = feature.geometry.coordinates;
        const latlng = [coords[1], coords[0]]; // Leaflet usa [lat, lng]
        
        // √∞≈∏≈Ω¬® NOVA L√É‚ÄúGICA DE CORES - PRIORIDADE: Parados > Suspensos > Ativos
        let cor = '#6c757d'; // Cinza padr√£o
        
        if (props.temElevadorParado || (props.nElevadorParado && props.nElevadorParado > 0)) {
            cor = '#dc3545'; // √∞≈∏‚Äù¬¥ Vermelho para elevadores parados
        } else if (props.status && props.status.toLowerCase().includes('suspenso')) {
            cor = '#ffc107'; // √∞≈∏≈∏¬° Amarelo para suspensos  
        } else if (props.status && props.status.toLowerCase().includes('atividade')) {
            cor = '#28a745'; // √∞≈∏≈∏¬¢ Verde para ativos
        }
        
        // Define tamanho baseado na quantidade
        const radius = props.qtd_elev >= 5 ? 8 : (props.qtd_elev >= 3 ? 6 : 4);
        
        // Cria o marcador
        const marker = L.circleMarker(latlng, {
            radius: radius,
            fillColor: cor,
            color: cor,
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
        });
        
        // √∞≈∏‚Äú¬ù TOOLTIP ATUALIZADO
        let tooltipText = `${props.cidade} - ${props.tipo}<br/>
            ${props.qtd_elev} elevadores - ${props.marcaLicitacao}<br/>
            ${props.regiao} - ${props.status}`;
        
        if (props.nElevadorParado && props.nElevadorParado > 0) {
            tooltipText += `<br/><strong style="color: #dc3545;">√¢≈°¬†√Ø¬∏¬è ${props.nElevadorParado} parado(s)</strong>`;
        }
        
        marker.bindTooltip(tooltipText, {sticky: true});
        
        // √∞≈∏‚Äú¬ù POPUP ATUALIZADO
        let popupContent = `<div style="font-family: Arial, sans-serif;">
                <h4 style="margin: 0 0 10px 0; color: #333;">${props.unidade}</h4>
                <p><strong>Cidade:</strong> ${props.cidade}</p>
                <p><strong>Endere√ßo:</strong> ${props.endereco}</p>
                <p><strong>Tipo:</strong> ${props.tipo}</p>
                <p><strong>Elevadores:</strong> ${props.qtd_elev}</p>
                <p><strong>Paradas:</strong> ${props.paradas}</p>
                <p><strong>Marca:</strong> ${props.marca}</p>
                <p><strong>Empresa:</strong> ${props.empresa}</p>
                <p><strong>Status:</strong> ${props.status}</p>`;
        
        // √∞≈∏‚Ä†‚Ä¢ ADICIONA INFORMA√É‚Ä°√É‚Ä¢ES DE ELEVADORES PARADOS
        if (props.nElevadorParado && props.nElevadorParado > 0) {
            popupContent += `
                <hr style="margin: 10px 0;">
                <p style="color: #dc3545;"><strong>√¢≈°¬†√Ø¬∏¬è Elevadores Parados:</strong> ${props.nElevadorParado}</p>`;
        }
        if ((props.nElevadorParado && props.nElevadorParado > 0) || props.status && props.status.toLowerCase().includes('suspenso')) {    
            if (props.dataDeParada) {
                popupContent += `<p style="color: #dc3545;"><strong>√∞≈∏‚Äú‚Ä¶ Data da Parada:</strong> ${props.dataDeParada}</p>`;
            }
            
            if (props.previsaoDeRetorno) {
                popupContent += `<p style="color: #dc3545;"><strong>√∞≈∏‚Äù‚Äû Previs√£o de Retorno:</strong> ${props.previsaoDeRetorno}</p>`;
            }
        }
        
        popupContent += '</div>';
        
        marker.bindPopup(popupContent, {maxWidth: 350});
        
        // Adiciona ao grupo de camadas
        layerGroup.addLayer(marker);
        
        if (index < 3) {
            console.log(`√¢≈ì‚Ä¶ Marcador ${index + 1} adicionado: ${props.unidade} (Cor: ${cor})`);
        }
    });
    
    console.log(`√∞≈∏≈Ω‚Ä∞ ${geojson.features.length} marcadores adicionados com sucesso!`);
}

// Fun√ß√£o para obter valores selecionados
function obterSelecionados(categoria) {
    const checkboxes = document.querySelectorAll(`input[id^="check-${categoria}-"]:checked`);
    const valores = Array.from(checkboxes).map(cb => cb.value);
    console.log(`√∞≈∏‚Äù¬ç Filtros selecionados para ${categoria}:`, valores);
    return valores;
}

// Fun√ß√£o para aplicar filtros
// Fun√ß√£o para aplicar filtros - COM SITUA√É‚Ä°√É∆íO
function aplicarFiltros() {
    console.log('√∞≈∏≈Ω¬Ø ========== APLICANDO FILTROS ==========');
    
    const tiposSelecionados = obterSelecionados('tipo');
    const regioesSelecionadas = obterSelecionados('regiao');
    const marcasSelecionadas = obterSelecionados('marca');
    const empresasSelecionadas = obterSelecionados('empresa');
    const situacoesSelecionadas = obterSelecionados('situacao'); // √∞≈∏‚Ä†‚Ä¢ NOVO FILTRO

    console.log('√∞≈∏‚Äú‚Äπ Resumo dos filtros:', {
        tipos: tiposSelecionados,
        regioes: regioesSelecionadas,
        marcas: marcasSelecionadas,
        empresas: empresasSelecionadas,
        situacoes: situacoesSelecionadas // √∞≈∏‚Ä†‚Ä¢ NOVO
    });

    if (!dadosOriginais || !dadosOriginais.features) {
        console.error('√¢¬ù≈í Dados originais n√£o dispon√É¬≠veis');
        return;
    }

    // Filtra os dados
    const featuresOriginal = dadosOriginais.features.length;
    
    dadosFiltrados = {
        ...dadosOriginais,
        features: dadosOriginais.features.filter(feature => {
            const props = feature.properties;
            
            const passaTipo = tiposSelecionados.length === 0 || tiposSelecionados.includes(props.tipo);
            const passaRegiao = regioesSelecionadas.length === 0 || regioesSelecionadas.includes(props.regiao);
            const passaMarca = marcasSelecionadas.length === 0 || marcasSelecionadas.includes(props.marcaLicitacao);
            const passaEmpresa = empresasSelecionadas.length === 0 || empresasSelecionadas.includes(props.empresa);
            
            // √∞≈∏‚Ä†‚Ä¢ NOVA L√É‚ÄúGICA DE FILTRO POR SITUA√É‚Ä°√É∆íO
            let passaSituacao = true;
            if (situacoesSelecionadas.length > 0) {
                passaSituacao = false;
                
                // Verifica cada situa√ß√£o selecionada
                situacoesSelecionadas.forEach(situacao => {
                    if (situacao === 'ativos') {
                        // Ativos: status ativo E sem elevadores parados
                        if (props.status && props.status.toLowerCase().includes('atividade') && 
                            (!props.nElevadorParado || props.nElevadorParado === 0)) {
                            passaSituacao = true;
                        }
                    } else if (situacao === 'suspensos') {
                        // Suspensos: status suspenso
                        if (props.status && props.status.toLowerCase().includes('suspenso')) {
                            passaSituacao = true;
                        }
                    } else if (situacao === 'parados') {
                        // Parados: tem elevadores parados
                        if (props.nElevadorParado && props.nElevadorParado > 0) {
                            passaSituacao = true;
                        }
                    }
                });
            }
            
            return passaTipo && passaRegiao && passaMarca && passaEmpresa && passaSituacao;
        })
    };

    const featuresFiltradas = dadosFiltrados.features.length;
    console.log(`√∞≈∏‚Äú≈† Filtragem conclu√É¬≠da: ${featuresOriginal} √¢‚Ä†‚Äô ${featuresFiltradas} features`);

    // Atualiza o mapa
    atualizarMapa();
    
    // Atualiza contador
    atualizarContadorFiltros();
    
    // Atualiza estat√É¬≠sticas
    atualizarEstatisticasDashboard();
    
    console.log('√¢≈ì‚Ä¶ ========== FILTROS APLICADOS ==========');
}

// Fun√ß√£o para atualizar o mapa
function atualizarMapa() {
    console.log('√∞≈∏‚Äî¬∫√Ø¬∏¬è ========== ATUALIZANDO MAPA ==========');
    
    if (!layerGroup) {
        console.error('√¢¬ù≈í LayerGroup n√£o dispon√É¬≠vel');
        return;
    }

    // Limpa todos os marcadores
    layerGroup.clearLayers();
    console.log('√∞≈∏¬ß¬π Marcadores removidos');

    // Adiciona novos marcadores filtrados
    adicionarMarcadores(dadosFiltrados);
    
    console.log('√¢≈ì‚Ä¶ ========== MAPA ATUALIZADO ==========');
}

// Fun√ß√£o para atualizar contador
function atualizarContadorFiltros() {
    if (!dadosFiltrados.features) return;
    
    const totalElevadores = dadosFiltrados.features.reduce((total, feature) => {
        return total + feature.properties.qtd_elev;
    }, 0);

    const totalLocais = dadosFiltrados.features.length;

    const elemElevadores = document.getElementById('total-elevadores-filtro');
    const elemLocais = document.getElementById('total-locais-filtro');
    
    if (elemElevadores) elemElevadores.textContent = totalElevadores;
    if (elemLocais) elemLocais.textContent = totalLocais;

    const contadorElement = document.getElementById('contador-resultados');
    if (contadorElement) {
        if (totalElevadores === 0) {
            contadorElement.style.background = '#ffebee';
            contadorElement.style.color = '#c62828';
            contadorElement.style.borderColor = '#ef9a9a';
        } else {
            contadorElement.style.background = '#e8f5e8';
            contadorElement.style.color = '#2e7d32';
            contadorElement.style.borderColor = '#a5d6a7';
        }
    }
    
    console.log(`√Ø¬ø¬Ω√Ø¬ø¬Ω Contador atualizado: ${totalElevadores} elevadores em ${totalLocais} locais`);
}

// Fun√ß√£o para atualizar estat√É¬≠sticas da dashboard - COM SITUA√É‚Ä°√É∆íO
function atualizarEstatisticasDashboard() {
    const tiposSelecionados = obterSelecionados('tipo');
    const regioesSelecionadas = obterSelecionados('regiao');
    const marcasSelecionadas = obterSelecionados('marca');
    const empresasSelecionadas = obterSelecionados('empresa');
    const situacoesSelecionadas = obterSelecionados('situacao'); // √∞≈∏‚Ä†‚Ä¢ NOVO

    // Se nenhum filtro ativo, limpa todos os filtros
    if (tiposSelecionados.length === 0 && regioesSelecionadas.length === 0 && 
        marcasSelecionadas.length === 0 && empresasSelecionadas.length === 0 &&
        situacoesSelecionadas.length === 0) { // √∞≈∏‚Ä†‚Ä¢ INCLUIR NOVO FILTRO
        console.log('√¢¬è¬≠√Ø¬∏¬è Nenhum filtro ativo, limpando todos os filtros');
        limparFiltros();
        return;
    }

    // Monta par√É¬¢metros
    const params = new URLSearchParams();
    tiposSelecionados.forEach(tipo => params.append('tipo', tipo));
    regioesSelecionadas.forEach(regiao => params.append('regiao', regiao));
    marcasSelecionadas.forEach(marca => params.append('marca', marca));
    empresasSelecionadas.forEach(empresa => params.append('empresa', empresa));
    situacoesSelecionadas.forEach(situacao => params.append('situacao', situacao)); // √∞≈∏‚Ä†‚Ä¢ NOVO

    console.log('√∞≈∏‚Äú¬° Fazendo requisi√ß√£o para API...');

    // ... resto da fun√ß√£o permanece igual
    // Mostra loading
    const loadingElement = document.getElementById('loading-stats');
    if (loadingElement) loadingElement.style.display = 'block';

    // Faz requisi√ß√£o
    fetch('/api/filtrar?' + params.toString())
        .then(response => response.json())
        .then(data => {
            if (loadingElement) loadingElement.style.display = 'none';
            
            console.log('√∞≈∏‚Äú¬° Resposta da API:', data);
            
            if (data.success) {
                // Atualiza cards
                const elementos = {
                    'stat-predios': data.stats.total_predios,
                    'stat-elevadores': data.stats.total_elevadores,
                    'stat-cidades': data.stats.cidades,
                    'stat-regioes': data.stats.regioes,
                    'stat-ativos': data.stats.em_atividade,
                    'stat-suspensos': data.stats.suspensos,
                    'stat-parados':data.stats.elevadores_parados
                };
                
                for (let id in elementos) {
                    const elem = document.getElementById(id);
                    if (elem) {
                        elem.textContent = elementos[id];
                        console.log(`√∞≈∏‚Äú≈† Card ${id} atualizado para:`, elementos[id]);
                    }
                }
                // √¢≈ì‚Ä¶ Sincroniza contador dos filtros com os mesmos valores da API
                const elemLocaisFiltro = document.getElementById('total-locais-filtro');
                const elemElevadoresFiltro = document.getElementById('total-elevadores-filtro');

                if (elemLocaisFiltro) elemLocaisFiltro.textContent = data.stats.total_predios;
                if (elemElevadoresFiltro) elemElevadoresFiltro.textContent = data.stats.total_elevadores;

                // Atualiza estat√É¬≠sticas detalhadas
                mostrarEstatisticasDetalhadas(data.stats);
                atualizarElevadoresParados();
            }
        })
        .catch(error => {
            if (loadingElement) loadingElement.style.display = 'none';
            console.error('√¢¬ù≈í Erro ao carregar estat√É¬≠sticas:', error);
        });
}

// Fun√ß√£o para mostrar estat√É¬≠sticas detalhadas
function mostrarEstatisticasDetalhadas(stats) {
    const container = document.getElementById('stats-detalhadas');
    if (!container) return;
    
    let html = '<div class="row">';
    
    const categorias = [
        {titulo: 'Por Tipo', dados: stats.por_tipo},
        {titulo: 'Por Regi√£o', dados: stats.por_regiao},
        {titulo: 'Por Marca', dados: stats.por_marca},
        {titulo: 'Por Status', dados: stats.por_status}
    ];
    
    categorias.forEach(categoria => {
        html += `<div class="col-md-3"><h6>${categoria.titulo}</h6><ul class="list-unstyled">`;
        for (let [key, value] of Object.entries(categoria.dados)) {
            html += `<li><strong>${key}:</strong> ${value}</li>`;
        }
        html += '</ul></div>';
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Fun√ß√É¬µes auxiliares
function limparFiltros() {
    console.log('√∞≈∏¬ß¬π Limpando todos os filtros...');
    
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    
    dadosFiltrados = dadosOriginais;
    atualizarMapa();
    atualizarContadorFiltros();
    
    // Restaura valores originais dos cards
    const valoresOriginais = window.statsOriginais || {};
    for (let id in valoresOriginais) {
        const elem = document.getElementById(id);
        if (elem) elem.textContent = valoresOriginais[id];
    }
    
    // √¢≈ì‚Ä¶ Sincroniza contador de filtros com valores originais
    const elemLocaisFiltro = document.getElementById('total-locais-filtro');
    const elemElevadoresFiltro = document.getElementById('total-elevadores-filtro');

    if (elemLocaisFiltro) elemLocaisFiltro.textContent = valoresOriginais['stat-predios'];
    if (elemElevadoresFiltro) elemElevadoresFiltro.textContent = valoresOriginais['stat-elevadores'];

    const statsContainer = document.getElementById('stats-detalhadas');
    if (statsContainer) {
        statsContainer.innerHTML = '<p class="text-muted">Use os filtros no mapa para ver estat√É¬≠sticas espec√É¬≠ficas.</p>';
    }
    
    console.log('√¢≈ì‚Ä¶ Filtros limpos');
    carregarElevadoresParadosIniciais();
}

function selecionarTodos() {
    console.log('√¢≈ì‚Ä¶ Selecionando todos os filtros...');
    
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = true);
    aplicarFiltros();
}

function toggleCategoria(categoria) {
    const div = document.getElementById(`filtros-${categoria}`);
    const button = document.getElementById(`toggle-${categoria}`);

    if (div && button) {
        if (div.style.display === 'none') {
            div.style.display = 'block';
            button.textContent = '√¢≈æ‚Äì';
        } else {
            div.style.display = 'none';
            button.textContent = '√¢≈æ‚Ä¢';
        }
    }
}

function atualizarDados() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
    btn.disabled = true;
    
    // Verifica se estamos na p√É¬°gina de KPIs
    const isKPIsPage = window.location.pathname === '/kpis';
    const endpoint = isKPIsPage ? '/atualizar-kpis' : '/atualizar';
    
    fetch(endpoint)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert((isKPIsPage ? 'KPIs' : 'Dados') + ' atualizados!\n' + data.message);
                location.reload();
            } else {
                alert('Erro: ' + data.message);
            }
        })
        .catch(error => {
            alert('Erro na requisi√ß√£o');
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}
// ========== FUN√É‚Ä°√É‚Ä¢ES PARA ELEVADORES PARADOS ==========

// Fun√ß√£o para carregar elevadores parados iniciais
function carregarElevadoresParadosIniciais() {
    console.log('√∞≈∏‚Äù¬¥ Carregando elevadores parados iniciais...');
    
    if (!dadosOriginais || !dadosOriginais.features) {
        console.log('√¢≈°¬†√Ø¬∏¬è Dados n√£o dispon√É¬≠veis para elevadores parados');
        return;
    }
    
    const elevadoresParados = [];
    
    dadosOriginais.features.forEach(feature => {
        const props = feature.properties;
        if (props.nElevadorParado && props.nElevadorParado > 0) {
            elevadoresParados.push({
                cidade: props.cidade,
                unidade: props.unidade,
                tipo: props.tipo,
                quantidade: props.nElevadorParado,
                empresa: props.empresa,
                dataDeParada: props.dataDeParada,
                previsaoDeRetorno: props.previsaoDeRetorno,
                qtd_total_elevadores: props.qtd_elev
            });
        }
    });
    
    // Ordena por cidade e unidade
    elevadoresParados.sort((a, b) => {
        if (a.cidade !== b.cidade) return a.cidade.localeCompare(b.cidade);
        return a.unidade.localeCompare(b.unidade);
    });
    
    console.log(`√∞≈∏‚Äù¬¥ ${elevadoresParados.length} elevadores parados encontrados inicialmente`);
    
    mostrarElevadoresParados(elevadoresParados);
}

// Fun√ß√£o para atualizar elevadores parados via API
function atualizarElevadoresParados() {
    const tiposSelecionados = obterSelecionados('tipo');
    const regioesSelecionadas = obterSelecionados('regiao');
    const marcasSelecionadas = obterSelecionados('marca');
    const empresasSelecionadas = obterSelecionados('empresa');
    const situacoesSelecionadas = obterSelecionados('situacao');

    // Se nenhum filtro ativo, usa dados iniciais
    if (tiposSelecionados.length === 0 && regioesSelecionadas.length === 0 && 
        marcasSelecionadas.length === 0 && empresasSelecionadas.length === 0 &&
        situacoesSelecionadas.length === 0) {
        console.log('√¢¬è¬≠√Ø¬∏¬è Nenhum filtro ativo, usando dados iniciais de elevadores parados');
        carregarElevadoresParadosIniciais();
        return;
    }

    // Monta par√É¬¢metros
    const params = new URLSearchParams();
    tiposSelecionados.forEach(tipo => params.append('tipo', tipo));
    regioesSelecionadas.forEach(regiao => params.append('regiao', regiao));
    marcasSelecionadas.forEach(marca => params.append('marca', marca));
    empresasSelecionadas.forEach(empresa => params.append('empresa', empresa));
    situacoesSelecionadas.forEach(situacao => params.append('situacao', situacao));

    console.log('√∞≈∏‚Äú¬° Fazendo requisi√ß√£o para API de elevadores parados...');

    // Mostra loading
    const loadingElement = document.getElementById('loading-elevadores-parados');
    if (loadingElement) loadingElement.style.display = 'block';

    // Faz requisi√ß√£o
    fetch('/api/elevadores-parados?' + params.toString())
        .then(response => response.json())
        .then(data => {
            if (loadingElement) loadingElement.style.display = 'none';
            
            console.log('√∞≈∏‚Äú¬° Resposta da API elevadores parados:', data);
            
            if (data.success) {
                mostrarElevadoresParados(data.elevadores_parados);
            }
        })
        .catch(error => {
            if (loadingElement) loadingElement.style.display = 'none';
            console.error('√¢¬ù≈í Erro ao carregar elevadores parados:', error);
        });
}

// Fun√ß√£o para exibir lista de elevadores parados
function mostrarElevadoresParados(elevadoresParados) {
    const container = document.getElementById('lista-elevadores-parados');
    const badge = document.getElementById('badge-total-parados');
    
    if (!container) return;
    
    // Atualiza badge com total
    if (badge) {
        badge.textContent = elevadoresParados.length;
    }
    
    if (elevadoresParados.length === 0) {
        container.innerHTML = `
            <div class="alert alert-success text-center">
                <i class="fas fa-check-circle"></i>
                <strong>√É‚Äútimas not√É¬≠cias!</strong> Nenhum elevador parado encontrado com os filtros aplicados.
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>${elevadoresParados.length} elevador(es) parado(s)</strong> encontrado(s) com os filtros aplicados.
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th><i class="fas fa-map-marker-alt"></i> Cidade</th>
                        <th><i class="fas fa-building"></i> Unidade</th>
                        <th><i class="fas fa-elevator"></i> Tipo</th>
                        <th><i class="fas fa-hashtag"></i> Parados</th>
                        <th><i class="fas fa-industry"></i> Empresa</th>
                        <th><i class="fas fa-calendar-times"></i> Data Parada</th>
                        <th><i class="fas fa-calendar-check"></i> Previs√£o Retorno</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    elevadoresParados.forEach((elevador, index) => {
        const dataParada = elevador.dataDeParada || '<span class="text-muted">-</span>';
        const previsaoRetorno = elevador.previsaoDeRetorno || '<span class="text-muted">-</span>';
        
        // √¢≈ì‚Ä¶ VERS√É∆íO MELHORADA
        const tipoLimpo = elevador.tipo.toLowerCase().trim();
        const badgeColor = tipoLimpo === "montacarga" ? "bg-secondary":
                        tipoLimpo === "passageiro" ? "bg-info":
                        tipoLimpo === "plataforma" ? "bg-success":
                        "bg-primary";
        
        html += `
            <tr>
                <td><strong>${elevador.cidade}</strong></td>
                <td>${elevador.unidade}</td>
                <td>
                    <span class="badge ${badgeColor}">${elevador.tipo}</span>
                </td>
                <td>
                    <span class="badge bg-danger">${elevador.quantidade}</span>
                    <small class="text-muted d-block">de ${elevador.qtd_total_elevadores} total</small>
                </td>
                <td>${elevador.empresa}</td>
                <td>${dataParada}</td>
                <td>${previsaoRetorno}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div class="mt-3">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i>
                Lista atualizada automaticamente conforme os filtros aplicados no mapa.
            </small>
        </div>
    `;
    
    container.innerHTML = html;
    
    console.log(`√¢≈ì‚Ä¶ Lista de elevadores parados atualizada: ${elevadoresParados.length} itens`);
}
</script>
{% endblock %}
--- Fim do cÛdigo: index_nativo.html ---

--- InÌcio do cÛdigo: kpis.html ---
{% extends "base.html" %}

{% block title %}KPIs de Manuten√ß√£o - Sistema de Elevadores TJ/MG{% endblock %}

{% block extra_head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-chart-line"></i> 
            KPIs de Manuten√ß√£o - Elevadores TJ/MG
        </h1>
    </div>
</div>

{% if erro %}
    <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle"></i> {{ erro }}
    </div>
{% else %}
    <!-- Filtros Avan√ßados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-filter"></i> Filtros</h5>
                    <div>
                        <button class="btn btn-success btn-sm me-2" onclick="aplicarFiltros()">
                            <i class="fas fa-search"></i> Aplicar Filtros
                        </button>
                        <button class="btn btn-secondary btn-sm me-2" onclick="limparFiltrosKPIs()">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                        <button class="btn btn-info btn-sm" onclick="atualizarDados()">
                            <i class="fas fa-sync-alt"></i> Atualizar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Primeira linha: Filtros de Data -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-calendar"></i> Data de In√É¬≠cio</label>
                            <input type="date" class="form-control" id="data-inicio">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-calendar"></i> Data de Fim</label>
                            <input type="date" class="form-control" id="data-fim">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><i class="fas fa-clock"></i> Per√É¬≠odo Predefinido</label>
                            <select class="form-select" id="filtro-periodo" onchange="selecionarPeriodoPredefinido()">
                                <option value="">Selecione um per√É¬≠odo...</option>
                                <option value="ultima-semana">√É≈°ltima Semana</option>
                                <option value="ultimo-mes">√É≈°ltimo M√É¬™s</option>
                                <option value="ultimos-3-meses">√É≈°ltimos 3 Meses</option>
                                <option value="ultimos-6-meses">√É≈°ltimos 6 Meses</option>
                                <option value="ultimo-ano">√É≈°ltimo Ano</option>
                                <option value="ultimos-2-anos">√É≈°ltimos 2 Anos</option>
                                <option value="ultimos-5-anos">√É≈°ltimos 5 Anos</option>
                                <option value="todo-periodo">Todo o Per√É¬≠odo</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Segunda linha: Outros filtros -->
                    <div class="row">
                        <!-- Filtro por Status -->
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-tasks"></i> Status</label>
                            <select class="form-select" id="filtro-status">
                                <option value="">Todos os status</option>
                                <option value="Conclu√É¬≠da">Conclu√É¬≠da</option>
                                <option value="Confirmada">Confirmada</option>
                            </select>
                        </div>
                        
                        <!-- Filtro por Categoria -->
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-tags"></i> Categoria</label>
                            <select class="form-select" id="filtro-categoria">
                                <option value="">Todas as categorias</option>
                                <!-- Preenchido dinamicamente via JavaScript -->
                            </select>
                        </div>
                        
                        <!-- Filtro por Edif√É¬≠cio -->
                        <div class="col-md-6">
                            <label class="form-label"><i class="fas fa-building"></i> Edif√É¬≠cio</label>
                            <select class="form-select" id="filtro-edificio">
                                <option value="">Todos os edif√É¬≠cios</option>
                                <!-- Preenchido dinamicamente via JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards de KPIs Principais -->
    <div class="row mb-4" id="kpis-cards">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                    <h3 id="total-chamados">{{ metricas.total_chamados or 0 }}</h3>
                    <p class="mb-0">Total de Chamados</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <h3 id="chamados-concluidos">{{ metricas.chamados_concluidos or 0 }}</h3>
                    <p class="mb-0">Chamados Conclu√É¬≠dos</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h3 id="tempo-mediano">{{ "%.1f"|format(metricas.tempo_mediano_reparo or 0) }}h</h3>
                    <p class="mb-0">Tempo Mediano de Reparo</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-percentage fa-2x mb-2"></i>
                    <h3 id="disponibilidade">{{ "%.1f"|format(metricas.disponibilidade or 0) }}%</h3>
                    <p class="mb-0">Taxa de Conclus√£o</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Indicador de Filtros Ativos -->
    <div class="row mb-3" id="filtros-ativos" style="display: none;">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-filter"></i> 
                <strong>Filtros ativos:</strong> 
                <span id="descricao-filtros"></span>
                <button class="btn btn-sm btn-outline-primary ms-2" onclick="limparFiltrosKPIs()">
                    <i class="fas fa-times"></i> Remover filtros
                </button>
            </div>
        </div>
    </div>

    <!-- Gr√É¬°ficos -->
    <div class="row">
        <!-- Gr√É¬°fico de Chamados por M√É¬™s -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> Chamados por M√É¬™s</h5>
                    <small class="text-muted">Clique nos pontos para filtrar por m√É¬™s</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-chamados-mes" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Gr√É¬°fico de Categorias de Problema -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-pie"></i> Categorias de Problemas</h5>
                    <small class="text-muted">Clique nas fatias para filtrar por categoria</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-categorias" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Gr√É¬°fico de Edif√É¬≠cios Mais Problem√É¬°ticos -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Edif√É¬≠cios com Mais Chamados</h5>
                    <small class="text-muted">Clique nas barras para filtrar por edif√É¬≠cio</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-edificios" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Gr√É¬°fico de Tempo por Categoria -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-stopwatch"></i> Tempo Mediano por Categoria</h5>
                    <small class="text-muted">Clique nas barras para filtrar por categoria</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-tempo-categoria" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- √∞≈∏‚Ä†‚Ä¢ NOVA SE√É‚Ä°√É∆íO: Gr√É¬°ficos de Elevadores -->
    <div class="row">
        <!-- Gr√É¬°fico de Chamados por Elevador -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-elevator"></i> Chamados por Elevador</h5>
                    <small class="text-muted">Clique nas barras para filtrar por elevador espec√É¬≠fico</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-chamados-elevador" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Gr√É¬°fico de Tempo Mediano por Elevador -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clock"></i> Tempo Mediano de Atendimento por Elevador</h5>
                    <small class="text-muted">Clique nas barras para filtrar por elevador espec√É¬≠fico</small>
                </div>
                <div class="card-body">
                    <canvas id="grafico-tempo-elevador" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Resumo Filtrado -->
    <div class="row">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-table"></i> Resumo dos Dados Filtrados</h5>
            </div>
            <div class="card-body">
                <div id="loading-resumo" class="text-center" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Carregando dados...
                </div>
                <div id="tabela-resumo">
                    <p class="text-muted text-center">Use os filtros acima ou clique nos gr√É¬°ficos para ver dados espec√É¬≠ficos.</p>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<script>
// Dados para JavaScript
const dadosKPIsOriginais = {{ metricas|tojson|safe }};
let dadosKPIsFiltrados = dadosKPIsOriginais;
let graficos = {};
let filtrosAtivos = {};

console.log('√∞≈∏‚Äú≈† Dados de KPIs recebidos:', dadosKPIsOriginais);

// Inicializa gr√É¬°ficos quando a p√É¬°gina carrega
document.addEventListener('DOMContentLoaded', function() {
    console.log('√∞≈∏‚Äú‚Äû DOM carregado, criando gr√É¬°ficos de KPIs...');
    preencherFiltros();
    criarGraficos();
});

function preencherFiltros() {
    // Preenche filtro de categorias
    const selectCategoria = document.getElementById('filtro-categoria');
    const categorias = Object.keys(dadosKPIsOriginais.categorias_problema || {});
    categorias.forEach(categoria => {
        const option = document.createElement('option');
        option.value = categoria;
        option.textContent = categoria;
        selectCategoria.appendChild(option);
    });
    
    // Preenche filtro de edif√É¬≠cios
    const selectEdificio = document.getElementById('filtro-edificio');
    const edificios = Object.keys(dadosKPIsOriginais.chamados_por_edificio || {});
    edificios.forEach(edificio => {
        const option = document.createElement('option');
        option.value = edificio;
        option.textContent = edificio.length > 50 ? edificio.substring(0, 50) + '...' : edificio;
        selectEdificio.appendChild(option);
    });
}

// √∞≈∏‚Äú‚Ä¶ NOVA FUN√É‚Ä°√É∆íO: Selecionar per√É¬≠odo predefinido
function selecionarPeriodoPredefinido() {
    const periodo = document.getElementById('filtro-periodo').value;
    
    if (periodo && periodo !== 'todo-periodo') {
        // Limpa datas personalizadas quando seleciona per√É¬≠odo predefinido
        document.getElementById('data-inicio').value = '';
        document.getElementById('data-fim').value = '';
    }
    
    console.log('√∞≈∏‚Äú‚Ä¶ Per√É¬≠odo predefinido selecionado:', periodo);
}

function criarGraficos() {
    // Destroi gr√É¬°ficos existentes
    Object.values(graficos).forEach(grafico => {
        if (grafico) grafico.destroy();
    });
    
    // Cria novos gr√É¬°ficos
    criarGraficoChamadosPorMes();
    criarGraficoCategorias();
    criarGraficoEdificios();
    criarGraficoTempoPorCategoria();
    
    // √∞≈∏‚Ä†‚Ä¢ NOVOS GR√É¬ÅFICOS DE ELEVADORES
    criarGraficoChamadosPorElevador();
    criarGraficoTempoMedianoPorElevador();
}

function criarGraficoChamadosPorMes() {
    const ctx = document.getElementById('grafico-chamados-mes');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.chamados_por_mes || {};
    const labels = Object.keys(dados).sort();
    const values = labels.map(label => dados[label]);
    
    graficos.chamadosMes = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Chamados',
                data: values,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#007bff',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const mesAno = labels[index];
                    filtrarPorMes(mesAno);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

function criarGraficoCategorias() {
    const ctx = document.getElementById('grafico-categorias');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.categorias_problema || {};
    
    // √∞≈∏‚Äù‚Äû ORDENA√É‚Ä°√É∆íO DECRESCENTE
    const entries = Object.entries(dados).sort((a, b) => b[1] - a[1]);
    const labels = entries.map(entry => entry[0]);
    const values = entries.map(entry => entry[1]);
    
    const cores = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
    ];
    
    graficos.categorias = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: cores.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff',
                hoverBorderWidth: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const categoria = labels[index];
                    filtrarPorCategoria(categoria);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// √∞≈∏‚Äù‚Äû MODIFICADO: Gr√É¬°fico de Edif√É¬≠cios com ordena√ß√£o decrescente garantida
function criarGraficoEdificios() {
    const ctx = document.getElementById('grafico-edificios');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.chamados_por_edificio || {};
    
    // √∞≈∏‚Äù‚Äû ORDENA√É‚Ä°√É∆íO DECRESCENTE EXPL√É¬çCITA (garantindo que funcione mesmo se backend n√£o ordenar)
    const entries = Object.entries(dados)
        .sort((a, b) => b[1] - a[1])  // Ordena por valor decrescente
        .slice(0, 10); // Top 10
    
    const labels = entries.map(entry => entry[0]);
    const values = entries.map(entry => entry[1]);
    
    console.log('√∞≈∏¬è¬¢ Dados de edif√É¬≠cios ordenados:', entries);
    
    graficos.edificios = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels.map(label => label.length > 20 ? label.substring(0, 20) + '...' : label),
            datasets: [{
                label: 'Chamados',
                data: values,
                backgroundColor: '#28a745',
                borderColor: '#1e7e34',
                borderWidth: 1,
                hoverBackgroundColor: '#34ce57'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const edificio = labels[index];
                    filtrarPorEdificio(edificio);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// √∞≈∏‚Äù‚Äû MODIFICADO: Gr√É¬°fico de Tempo por Categoria com ordena√ß√£o decrescente garantida
function criarGraficoTempoPorCategoria() {
    const ctx = document.getElementById('grafico-tempo-categoria');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.tempo_por_categoria || {};
    
    // √∞≈∏‚Äù‚Äû ORDENA√É‚Ä°√É∆íO DECRESCENTE EXPL√É¬çCITA (garantindo que funcione mesmo se backend n√£o ordenar)
    const entries = Object.entries(dados)
        .sort((a, b) => b[1] - a[1]); // Ordena por valor decrescente
    
    const labels = entries.map(entry => entry[0]);
    const values = entries.map(entry => Math.round(entry[1] * 10) / 10);
    
    console.log('√¢¬è¬±√Ø¬∏¬è Dados de tempo por categoria ordenados:', entries);
    
    graficos.tempoCategoria = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tempo Mediano (horas)',
                data: values,
                backgroundColor: '#ffc107',
                borderColor: '#e0a800',
                borderWidth: 1,
                hoverBackgroundColor: '#ffcd39'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + 'h';
                        }
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const categoria = labels[index];
                    filtrarPorCategoria(categoria);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// √∞≈∏‚Ä†‚Ä¢ NOVO: Gr√É¬°fico de Chamados por Elevador
function criarGraficoChamadosPorElevador() {
    const ctx = document.getElementById('grafico-chamados-elevador');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.chamados_por_equipamento || {};
    
    // Ordena√ß√£o decrescente e limita√ß√£o aos top 15 elevadores
    const entries = Object.entries(dados)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 15); // Top 15 elevadores
    
    const labels = entries.map(entry => String(entry[0]));
    const values = entries.map(entry => entry[1]);
    
    console.log('√∞≈∏¬è‚Äî√Ø¬∏¬è Dados de chamados por elevador ordenados:', entries);
    
    graficos.chamadosElevador = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Chamados',
                data: values,
                backgroundColor: '#007bff',
                borderColor: '#0056b3',
                borderWidth: 1,
                hoverBackgroundColor: '#0056b3'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return 'Elevador: ' + context[0].label;
                        },
                        label: function(context) {
                            return 'Chamados: ' + context.parsed.y;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        font: {
                            size: 10
                        }
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const elevador = String(labels[index]);
                    filtrarPorElevador(elevador);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// √∞≈∏‚Ä†‚Ä¢ NOVO: Gr√É¬°fico de Tempo Mediano por Elevador
function criarGraficoTempoMedianoPorElevador() {
    const ctx = document.getElementById('grafico-tempo-elevador');
    if (!ctx) return;
    
    const dados = dadosKPIsFiltrados.tempo_por_equipamento || {};
    
    // Ordena√ß√£o decrescente e limita√ß√£o aos top 15 elevadores
    const entries = Object.entries(dados)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 15); // Top 15 elevadores
    
    const labels = entries.map(entry => String(entry[0]));
    const values = entries.map(entry => Math.round(entry[1] * 10) / 10);
    
    console.log('√¢¬è¬∞ Dados de tempo por elevador ordenados:', entries);
    
    graficos.tempoElevador = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tempo Mediano (horas)',
                data: values,
                backgroundColor: '#17a2b8',
                borderColor: '#138496',
                borderWidth: 1,
                hoverBackgroundColor: '#138496'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return 'Elevador: ' + context[0].label;
                        },
                        label: function(context) {
                            return 'Tempo Mediano: ' + context.parsed.y + 'h';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + 'h';
                        }
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        font: {
                            size: 10
                        }
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const elevador = String(labels[index]);
                    filtrarPorElevador(elevador);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// Fun√ß√É¬µes de filtro por clique nos gr√É¬°ficos
function filtrarPorMes(mesAno) {
    console.log('√∞≈∏‚Äú‚Ä¶ Filtrando por m√É¬™s:', mesAno);
    filtrosAtivos.mes = mesAno;
    aplicarFiltrosInterativos();
}

function filtrarPorCategoria(categoria) {
    console.log('√∞≈∏¬è¬∑√Ø¬∏¬è Filtrando por categoria:', categoria);
    document.getElementById('filtro-categoria').value = categoria;
    filtrosAtivos.categoria = categoria;
    aplicarFiltrosInterativos();
}

function filtrarPorEdificio(edificio) {
    console.log('√∞≈∏¬è¬¢ Filtrando por edif√É¬≠cio:', edificio);
    document.getElementById('filtro-edificio').value = edificio;
    filtrosAtivos.edificio = edificio;
    aplicarFiltrosInterativos();
}

// √∞≈∏‚Ä†‚Ä¢ NOVA FUN√É‚Ä°√É∆íO: Filtrar por elevador espec√É¬≠fico
function filtrarPorElevador(elevador) {
    console.log('√∞≈∏¬è‚Äî√Ø¬∏¬è Filtrando por elevador:', elevador);
    filtrosAtivos.equipamento = elevador;
    aplicarFiltrosInterativos();
}

function aplicarFiltros() {
    const dataInicio = document.getElementById('data-inicio').value;
    const dataFim = document.getElementById('data-fim').value;
    const periodo = document.getElementById('filtro-periodo').value;
    const status = document.getElementById('filtro-status').value;
    const categoria = document.getElementById('filtro-categoria').value;
    const edificio = document.getElementById('filtro-edificio').value;
    
    console.log('√∞≈∏‚Äù¬ç Aplicando filtros:', {
        dataInicio, dataFim, periodo, status, categoria, edificio
    });
    
    // √∞≈∏‚Äú‚Ä¶ VALIDA√É‚Ä°√É∆íO DE DATAS
    if (dataInicio && dataFim && new Date(dataInicio) > new Date(dataFim)) {
        alert('A data de in√É¬≠cio n√£o pode ser posterior √É¬† data de fim.');
        return;
    }
    
    // √∞≈∏‚Ä†‚Ä¢ MAPEAMENTO CORRETO DOS PAR√É‚ÄöMETROS
    filtrosAtivos = {
        data_inicio: dataInicio,
        data_fim: dataFim,
        periodo_predefinido: periodo,
        status: status,
        categoria: categoria,
        edificio: edificio
    };
    
    // Remove filtros vazios
    Object.keys(filtrosAtivos).forEach(key => {
        if (!filtrosAtivos[key]) {
            delete filtrosAtivos[key];
        }
    });
    
    console.log('√∞≈∏‚Äù¬ß Filtros ativos ap√É¬≥s limpeza:', filtrosAtivos);
    
    aplicarFiltrosInterativos();
}

function aplicarFiltrosInterativos() {
    console.log('√∞≈∏‚Äù¬ç Aplicando filtros:', filtrosAtivos);
    
    // Monta par√É¬¢metros para API
    const params = new URLSearchParams();
    Object.keys(filtrosAtivos).forEach(key => {
        if (filtrosAtivos[key]) {
            params.append(key, filtrosAtivos[key]);
        }
    });
    
    // Mostra loading
    const loadingElement = document.getElementById('loading-resumo');
    if (loadingElement) loadingElement.style.display = 'block';
    
    // Faz requisi√ß√£o para API
    fetch('/api/kpis-filtrados?' + params.toString())
        .then(response => response.json())
        .then(data => {
            if (loadingElement) loadingElement.style.display = 'none';
            
            if (data.success) {
                // Atualiza dados filtrados
                dadosKPIsFiltrados = data.metricas;
                
                // Atualiza cards
                atualizarCards(data.metricas);
                
                // Recria gr√É¬°ficos
                criarGraficos();
                
                // Mostra indicador de filtros ativos
                mostrarFiltrosAtivos();
                
                // Atualiza tabela de resumo
                atualizarTabelaResumo(data.resumo);
            }
        })
        .catch(error => {
            if (loadingElement) loadingElement.style.display = 'none';
            console.error('√¢¬ù≈í Erro ao aplicar filtros:', error);
            alert('Erro ao aplicar filtros. Tente novamente.');
        });
}

function atualizarCards(metricas) {
    document.getElementById('total-chamados').textContent = metricas.total_chamados || 0;
    document.getElementById('chamados-concluidos').textContent = metricas.chamados_concluidos || 0;
    document.getElementById('tempo-mediano').textContent = (metricas.tempo_mediano_reparo || 0).toFixed(1) + 'h';
    document.getElementById('disponibilidade').textContent = (metricas.disponibilidade || 0).toFixed(1) + '%';
}

function mostrarFiltrosAtivos() {
    const filtrosAtivosDiv = document.getElementById('filtros-ativos');
    const descricaoFiltros = document.getElementById('descricao-filtros');
    
    const filtrosTexto = [];
    
    // √∞≈∏‚Äú‚Ä¶ MELHORIA: Descri√ß√£o mais clara dos filtros
    const dataInicio = document.getElementById('data-inicio').value;
    const dataFim = document.getElementById('data-fim').value;
    const periodo = document.getElementById('filtro-periodo').value;
    
    if (dataInicio || dataFim) {
        let textoData = 'Per√É¬≠odo: ';
        if (dataInicio && dataFim) {
            textoData += `${dataInicio} a ${dataFim}`;
        } else if (dataInicio) {
            textoData += `a partir de ${dataInicio}`;
        } else {
            textoData += `at√É¬© ${dataFim}`;
        }
        filtrosTexto.push(textoData);
    } else if (periodo) {
        const periodos = {
            'ultima-semana': '√É≈°ltima Semana',
            'ultimo-mes': '√É≈°ltimo M√É¬™s',
            'ultimos-3-meses': '√É≈°ltimos 3 Meses',
            'ultimos-6-meses': '√É≈°ltimos 6 Meses',
            'ultimo-ano': '√É≈°ltimo Ano',
            'ultimos-2-anos': '√É≈°ltimos 2 Anos',
            'ultimos-5-anos': '√É≈°ltimos 5 Anos',
            'todo-periodo': 'Todo o Per√É¬≠odo'
        };
        filtrosTexto.push(`Per√É¬≠odo: ${periodos[periodo]}`);
    }
    
    Object.keys(filtrosAtivos).forEach(key => {
        if (filtrosAtivos[key] && !['data_inicio', 'data_fim', 'periodo_predefinido'].includes(key)) {
             const nomesFiltros = {
                'equipamento': 'Elevador',
                'categoria': 'Categoria',
                'edificio': 'Edif√É¬≠cio',
                'status': 'Status',
                'mes': 'M√É¬™s'
            };
            const nomeAmigavel = nomesFiltros[key] || key;
            filtrosTexto.push(`${nomeAmigavel}: ${filtrosAtivos[key]}`);
        }
    });
    
    if (filtrosTexto.length > 0) {
        descricaoFiltros.textContent = filtrosTexto.join(' | ');
        filtrosAtivosDiv.style.display = 'block';
    } else {
        filtrosAtivosDiv.style.display = 'none';
    }
}

function atualizarTabelaResumo(resumo) {
    const container = document.getElementById('tabela-resumo');
    if (!resumo || resumo.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">Nenhum dado encontrado com os filtros aplicados.</p>';
        return;
    }
    
    let html = `
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Categoria</th>
                        <th>Edif√É¬≠cio</th>
                        <th>Status</th>
                        <th>Data Solicita√ß√£o</th>
                        <th>Tempo Reparo (h)</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    resumo.slice(0, 20).forEach(item => { // Mostra apenas os primeiros 20
        html += `
            <tr>
                <td><span class="badge bg-secondary">${item.categoria_problema}</span></td>
                <td>${item.edificio}</td>
                <td><span class="badge ${item.status === 'Conclu√É¬≠da' ? 'bg-success' : 'bg-warning'}">${item.status}</span></td>
                <td>${item.data_solicitacao}</td>
                <td>${item.tempo_reparo || '-'}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        ${resumo.length > 20 ? `<p class="text-muted text-center">Mostrando 20 de ${resumo.length} registros</p>` : ''}
    `;
    
    container.innerHTML = html;
}

function limparFiltrosKPIs() {
    // √∞≈∏‚Äú‚Ä¶ LIMPA TODOS OS FILTROS (incluindo datas)
    document.getElementById('data-inicio').value = '';
    document.getElementById('data-fim').value = '';
    document.getElementById('filtro-periodo').value = '';
    document.getElementById('filtro-status').value = '';
    document.getElementById('filtro-categoria').value = '';
    document.getElementById('filtro-edificio').value = '';
    
    // Limpa filtros ativos
    filtrosAtivos = {};
    
    // Restaura dados originais
    dadosKPIsFiltrados = dadosKPIsOriginais;
    
    // Atualiza cards
    atualizarCards(dadosKPIsOriginais);
    
    // Recria gr√É¬°ficos
    criarGraficos();
    
    // Esconde indicador de filtros
    document.getElementById('filtros-ativos').style.display = 'none';
    
    // Limpa tabela de resumo
    document.getElementById('tabela-resumo').innerHTML = '<p class="text-muted text-center">Use os filtros acima ou clique nos gr√É¬°ficos para ver dados espec√É¬≠ficos.</p>';
    
    console.log('√∞≈∏¬ß¬π Filtros de KPIs limpos');
}

function debugFiltros() {
    console.log('√∞≈∏‚Äù¬ç DEBUG - Estado atual dos filtros:');
    console.log('   Data in√É¬≠cio:', document.getElementById('data-inicio').value);
    console.log('   Data fim:', document.getElementById('data-fim').value);
    console.log('   Per√É¬≠odo:', document.getElementById('filtro-periodo').value);
    console.log('   Status:', document.getElementById('filtro-status').value);
    console.log('   Categoria:', document.getElementById('filtro-categoria').value);
    console.log('   Edif√É¬≠cio:', document.getElementById('filtro-edificio').value);
    console.log('   Filtros ativos:', filtrosAtivos);
    console.log('   Dados originais:', dadosKPIsOriginais);
    console.log('   Dados filtrados:', dadosKPIsFiltrados);
}

</script>
{% endblock %}
--- Fim do cÛdigo: kpis.html ---

--- InÌcio do cÛdigo: login.html ---
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Sistema de Elevadores TJ/MG</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- CSS customizado -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .login-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            max-width: 400px;
            width: 100%;
            margin: 20px;
        }
        
        .login-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .login-header i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }
        
        .login-body {
            padding: 2rem;
        }
        
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .btn-login {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.4);
        }
        
        .input-group-text {
            border: 2px solid #e9ecef;
            border-right: none;
            background: #f8f9fa;
            border-radius: 10px 0 0 10px;
        }
        
        .input-group .form-control {
            border-left: none;
            border-radius: 0 10px 10px 0;
        }
        
        .alert {
            border-radius: 10px;
            border: none;
        }
        
        .footer-info {
            background: #f8f9fa;
            padding: 1rem;
            text-align: center;
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .loading {
            display: none;
        }
        
        .btn-login:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <!-- Cabe√ßalho -->
        <div class="login-header">
            <i class="fas fa-building"></i>
            <h3 class="mb-0">TJ/MG</h3>
            <p class="mb-0">Sistema de Elevadores</p>
        </div>
        
        <!-- Corpo do formul√É¬°rio -->
        <div class="login-body">
            <!-- Mensagens Flash -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'danger' else 'warning' if category == 'warning' else 'info' if category == 'info' else 'success' }} alert-dismissible fade show" role="alert">
                            <i class="fas fa-{{ 'exclamation-triangle' if category in ['danger', 'warning'] else 'info-circle' if category == 'info' else 'check-circle' }}"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <!-- Formul√É¬°rio de Login -->
            <form method="POST" id="loginForm">
                <div class="mb-3">
                    <label for="usuario" class="form-label">
                        <i class="fas fa-user"></i> Usu√É¬°rio
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-user"></i>
                        </span>
                        <input type="text" 
                               class="form-control" 
                               id="usuario" 
                               name="usuario" 
                               placeholder="Digite seu usu√É¬°rio"
                               required
                               autocomplete="username">
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="senha" class="form-label">
                        <i class="fas fa-lock"></i> Senha
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-lock"></i>
                        </span>
                        <input type="password" 
                               class="form-control" 
                               id="senha" 
                               name="senha" 
                               placeholder="Digite sua senha"
                               required
                               autocomplete="current-password">
                        <button class="btn btn-outline-secondary" 
                                type="button" 
                                id="togglePassword"
                                style="border-radius: 0 10px 10px 0;">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary btn-login" id="btnLogin">
                    <span class="normal-text">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </span>
                    <span class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Entrando...
                    </span>
                </button>
            </form>
        </div>
        
        <!-- Rodap√É¬© -->
        <div class="footer-info">
            <small>
                <i class="fas fa-shield-alt"></i>
                Acesso restrito - Tribunal de Justi√ßa de Minas Gerais
            </small>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Toggle para mostrar/ocultar senha
        document.getElementById('togglePassword').addEventListener('click', function() {
            const senhaInput = document.getElementById('senha');
            const icon = this.querySelector('i');
            
            if (senhaInput.type === 'password') {
                senhaInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                senhaInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
        
        // Loading no bot√£o de login
        document.getElementById('loginForm').addEventListener('submit', function() {
            const btn = document.getElementById('btnLogin');
            const normalText = btn.querySelector('.normal-text');
            const loadingText = btn.querySelector('.loading');
            
            btn.disabled = true;
            normalText.style.display = 'none';
            loadingText.style.display = 'inline';
        });
        
        // Foco autom√É¬°tico no campo usu√É¬°rio
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('usuario').focus();
        });
        
        // Enter para submeter o formul√É¬°rio
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('loginForm').submit();
            }
        });
    </script>
</body>
</html>
--- Fim do cÛdigo: login.html ---

--- InÌcio do cÛdigo: dashboard_v2.js ---
// dashboard_v2.js

// ========== FASE 5: FILTROS INTERATIVOS ==========

// Vari√É¬°veis globais
let dadosOriginais = initialGeojsonData;
let mapaLeaflet = null;
let marcadoresAtuais = []; // NOVO: Controla marcadores atuais

// Inicializa o mapa
function inicializarMapa() {
    console.log('Inicializando mapa v2.0 com filtros...');
    
    mapaLeaflet = L.map('mapa').setView([-19.92, -43.92], 7);

    console.log('Tamanho interno do mapa Leaflet (mapaLeaflet._size):', mapaLeaflet._size);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '√Ç¬© OpenStreetMap contributors, √Ç¬© CartoDB'
    }).addTo(mapaLeaflet);
    
    adicionarMarcadores(dadosOriginais);
}

// NOVO: Remove todos os marcadores
function limparMarcadores() {
    marcadoresAtuais.forEach(marker => {
        mapaLeaflet.removeLayer(marker);
    });
    marcadoresAtuais = [];
}

// ATUALIZADO: Adiciona marcadores ao mapa
function adicionarMarcadores(geojsonData) {
    // Limpa marcadores existentes
    limparMarcadores();
    
    if (!geojsonData || !geojsonData.features || geojsonData.features.length === 0) {
        console.warn("Nenhum dado GeoJSON ou features para adicionar marcadores.");
        return;
    }    

    // if (!geojsonData || !geojsonData.features) return;
    
    console.log(`Adicionando ${geojsonData.features.length} marcadores...`);


    geojsonData.features.forEach((feature, index) => {
        const props = feature.properties;
        const coords = feature.geometry.coordinates;

        if (!Array.isArray(coords) || coords.length !== 2 || 
            typeof coords[0] !== 'number' || typeof coords[1] !== 'number' || 
            isNaN(coords[0]) || isNaN(coords[1])) 
        {
            console.error(`ERRO: Coordenadas inv√°lidas para feature no √≠ndice ${index}. Pulando este marcador.`);
            console.error('Coordenadas:', coords);
            console.error('Feature completa:', feature);
            // Retorna para pular este marcador problem√°tico e continuar com os outros
            return; 
        }

        const latlng = [coords[1], coords[0]];      

        const marker = L.circleMarker(latlng,{
            radius: props.tamanhoMarcador,
            fillColor: props.corMarcador,
            color: props.corMarcador,
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
        })
        
        // Tooltip
        let tooltipText = `${props.cidade}-${props.tipo}<br/>
        ${props.qtd_elev} elevadores - ${props.marcaLicitacao}<br/>
        ${props.regiao} - ${props.status}`;
        if(props.nElevadorParado && props.nElevadorParado > 0){
            tooltipText += `<br/><strong style="color: ${props.corMarcador ||'#dc3545'};">${props.nElevadorParado} parado(s)</strong>`;
        }
        marker.bindTooltip(tooltipText,{sticky:true});
        
        // Popup
        let popupContent = `<div style="font-family: Arial, sans-serif;">
            <h4 style="margin: 0 0 10px 0; color: #333;">${props.unidade}</h4>
            <p><strong>Cidade:</strong> ${props.cidade}</p>
            <p><strong>Endere√ßo:</strong> ${props.endereco}</p>
            <p><strong>Tipo:</strong> ${props.tipo}</p>
            <p><strong>Elevadores:</strong> ${props.qtd_elev}</p>
            <p><strong>Paradas:</strong> ${props.paradas}</p>
            <p><strong>Marca:</strong> ${props.marca}</p>
            <p><strong>Empresa:</strong> ${props.empresa}</p>
            <p><strong>Status:</strong> <span style="color: ${props.corMarcador};">${props.status}</span></p>`;
        
        if ((props.nElevadorParado && props.nElevadorParado > 0) || props.status && props.status.toLowerCase().includes('suspenso')) {    
            if (props.nElevadorParado && props.nElevadorParado > 0) {
                popupContent += `<hr style="margin: 10px 0;"><p style="color: #dc3545;"><strong>‚ö†Ô∏è Elevadores Parados:</strong> ${props.nElevadorParado}</p>`;
            }
            if (props.dataDeParada) {
                popupContent += `<p style="color: #dc3545;"><strong>üìÖ Data da Parada:</strong> ${props.dataDeParada}</p>`;
            }
            if (props.previsaoDeRetorno) {
                popupContent += `<p style="color: #dc3545;"><strong>üîÑ Previs√£o de Retorno:</strong> ${props.previsaoDeRetorno}</p>`;
            }
        }
        popupContent += '</div>';
        
        marker.bindPopup(popupContent, {maxWidth: 350});
        marker.addTo(mapaLeaflet);
        marcadoresAtuais.push(marker);
    });
}

// NOVO: Aplica filtros E atualiza o mapa
function aplicarFiltros() {
    console.log('√∞≈∏‚Äù¬ç Aplicando filtros v2.0 com atualiza√ß√£o do mapa...');
    
    const tipos = obterSelecionados('tipo');
    const regioes = obterSelecionados('regiao');
    const situacoes = obterSelecionados('situacao');
    
    console.log('Filtros selecionados:', {tipos, regioes, situacoes});
    
    // Mostra loading
    mostrarLoading(true);
    
    const params = new URLSearchParams();
    tipos.forEach(tipo => params.append('tipo', tipo));
    regioes.forEach(regiao => params.append('regiao', regiao));
    situacoes.forEach(situacao => params.append('situacao', situacao));
    
    // NOVO: Chama API que retorna dados filtrados
    fetch(`/v2/api/dados-elevadores-filtrados?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Atualiza estat√É¬≠sticas
                atualizarCards(data.data.stats);
                
                // NOVO: Atualiza estat√É¬≠sticas detalhadas
                if (data.data.stats_detalhadas) {
                    atualizarStatsDetalhadas(data.data.stats_detalhadas);
                }
                
                // NOVO: Atualiza o mapa com dados filtrados
                adicionarMarcadores(data.data.geojson);
                
                // Ajusta zoom se necess√É¬°rio
                if (data.data.geojson.features.length > 0) {
                    ajustarZoomParaDados(data.data.geojson);
                }
                
                console.log('Filtros aplicados e mapa atualizado');
            } else {
                alert('Erro ao aplicar filtros: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro ao aplicar filtros:', error);
            alert('Erro na requisi√ß√£o de filtros');
        })
        .finally(() => {
            mostrarLoading(false);
        });
}

// NOVO: Ajusta zoom para mostrar todos os dados
function ajustarZoomParaDados(geojsonData) {
    if (!geojsonData.features || geojsonData.features.length === 0) return;
    
    const group = new L.featureGroup(marcadoresAtuais);
    mapaLeaflet.fitBounds(group.getBounds(), {padding: [20, 20]});
}

// √¢≈ì‚Ä¶ NOVO: Mostra/esconde loading
function mostrarLoading(mostrar) {
    const btn = document.querySelector('button[onclick="aplicarFiltros()"]');
    if (btn) {
        if (mostrar) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Filtrando...';
            btn.disabled = true;
        } else {
            btn.innerHTML = '<i class="fas fa-search"></i> Aplicar Filtros';
            btn.disabled = false;
        }
    }
}

// Obt√É¬©m valores selecionados
function obterSelecionados(categoria) {
    const checkboxes = document.querySelectorAll(`input[id^="check-${categoria}-"]:checked`);
    return Array.from(checkboxes).map(cb => cb.value);
}

// Atualiza cards de estat√É¬≠sticas
function atualizarCards(stats) {
    const elementos = {
        'stat-predios': stats.total_predios || 0,
        'stat-elevadores': stats.total_elevadores || 0,
        'stat-cidades': stats.cidades || 0,
        'stat-regioes': stats.regioes || 0,
        'stat-ativos': stats.em_atividade || 0,
        'stat-parados': stats.elevadores_parados || 0,
        'stat-suspensos': stats.elevadores_suspensos || 0
    };
    
    for (let id in elementos) {
        const elem = document.getElementById(id);
        if (elem) {
            // √¢≈ì‚Ä¶ NOVO: Anima√ß√£o nos n√É¬∫meros
            animarNumero(elem, parseInt(elem.textContent) || 0, elementos[id]);
        }
    }
    
    // Atualiza contador
    document.getElementById('total-elevadores-filtro').textContent = stats.total_elevadores || 0;
    document.getElementById('total-locais-filtro').textContent = stats.total_predios || 0;
}

// √¢≈ì‚Ä¶ NOVO: Anima√ß√£o de n√É¬∫meros
function animarNumero(elemento, valorInicial, valorFinal) {
    const duracao = 500; // ms
    const passos = 20;
    const incremento = (valorFinal - valorInicial) / passos;
    let valorAtual = valorInicial;
    let passo = 0;
    
    const timer = setInterval(() => {
        passo++;
        valorAtual += incremento;
        
        if (passo >= passos) {
            elemento.textContent = valorFinal;
            clearInterval(timer);
        } else {
            elemento.textContent = Math.round(valorAtual);
        }
    }, duracao / passos);
}

// √¢≈ì‚Ä¶ NOVO: Seleciona todos os filtros
function selecionarTodos() {
    console.log('Selecionando todos os filtros...');
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
    aplicarFiltros(); // Aplica automaticamente
}

// √¢≈ì‚Ä¶ ATUALIZADO: Limpa filtros e restaura dados originais
function limparFiltros() {
    console.log('Limpando filtros e restaurando mapa...');
    
    // Limpa checkboxes
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    
    // Restaura dados originais no mapa
    adicionarMarcadores(dadosOriginais);
    
    // Restaura estat√É¬≠sticas originais
    fetch('/v2/api/dados-elevadores')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                atualizarCards(data.data.stats);
                ajustarZoomParaDados(data.data.geojson);
                atualizarStatsDetalhadas(data.data.stats_detalhadas);
            }
        })
        .catch(error => console.error('Erro ao restaurar dados:', error));
}

// √¢≈ì‚Ä¶ ATUALIZADO: Atualiza estat√É¬≠sticas detalhadas
function atualizarStatsDetalhadas(statsDetalhadas) {
    // Atualiza por tipo
    atualizarListaStats('stats-por-tipo', statsDetalhadas.por_tipo);
    
    // Atualiza por regi√£o
    atualizarListaStats('stats-por-regiao', statsDetalhadas.por_regiao);
    
    // Atualiza por marca
    atualizarListaStats('stats-por-marca', statsDetalhadas.por_marca);
    
    // Atualiza por status
    atualizarListaStatsComCor('stats-por-status', statsDetalhadas.por_status);
    
    // Atualiza elevadores parados
    atualizarElevadoresParados(statsDetalhadas.elevadores_parados);
}

function atualizarListaStats(elementId, dados) {
    const elemento = document.getElementById(elementId);
    if (!elemento || !dados) return;
    
    let html = '';
    for (const [chave, valor] of Object.entries(dados)) {
        html += `<div class="d-flex justify-content-between">
            <span>${chave}:</span>
            <strong>${valor}</strong>
        </div>`;
    }
    
    elemento.innerHTML = html || '<div class="text-muted">Nenhum dado</div>';
}

function atualizarListaStatsComCor(elementId, dados) {
    const elemento = document.getElementById(elementId);
    if (!elemento || !dados) return;
    
    let html = '';
    for (const [chave, valor] of Object.entries(dados)) {
        let classe = '';
        if (chave === 'Em atividade') classe = 'text-success';
        else if (chave === 'Parados') classe = 'text-danger';
        else classe = 'text-warning';
        
        html += `<div class="d-flex justify-content-between">
            <span class="${classe}">${chave}:</span>
            <strong>${valor}</strong>
        </div>`;
    }
    
    elemento.innerHTML = html || '<div class="text-muted">Nenhum dado</div>';
}

function atualizarElevadoresParados(elevadoresParados) {
    const tbody = document.getElementById('elevadores-parados-tbody');
    const section = document.getElementById('elevadores-parados-section');
    
    if (!tbody || !section) return;
    
    if (!elevadoresParados || elevadoresParados.length === 0) {
        section.style.display = 'none';
        return;
    }
    
    section.style.display = 'block';
    
    let html = '';
    elevadoresParados.forEach(elevador => {
        html += `<tr>
            <td>${elevador.unidade}</td>
            <td>${elevador.cidade}</td>
            <td>${elevador.tipo}</td>
            <td>${elevador.regiao}</td>
            <td class="text-danger"><strong>${elevador.quantidade_parada}</strong></td>
            <td>${elevador.total_elevadores}</td>
            <td>${elevador.marca}</td>
        </tr>`;
    });
    
    tbody.innerHTML = html;
}

// NOVO: Aplicar filtros automaticamente quando checkbox muda
function configurarFiltrosAutomaticos() {
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            // Aplica filtros automaticamente ap√É¬≥s 500ms de inatividade
            clearTimeout(window.filtroTimeout);
            window.filtroTimeout = setTimeout(aplicarFiltros, 500);
        });
    });
}

// Atualiza dados
function atualizarDados() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
    btn.disabled = true;
    
    fetch('/v2/atualizar-dados')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Dados atualizados!\n' + data.message);
                location.reload();
            } else {
                alert('Erro: ' + data.message);
            }
        })
        .catch(error => alert('Erro na requisi√ß√£o'))
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

// ATUALIZADO: Inicializa quando a p√°gina carrega
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard v2.0 carregado com filtros interativos');
    const mapaElement = document.getElementById('mapa');
    if (mapaElement) {
        // Verifique as dimens√µes do mapaElement ANTES de inicializar
        console.log('Dimens√µes do elemento #mapa:', mapaElement.offsetWidth, mapaElement.offsetHeight);
        if (mapaElement.offsetWidth === 0 || mapaElement.offsetHeight === 0) {
            console.error('Elemento #mapa est√° com dimens√µes zero. Isso pode causar problemas de renderiza√ß√£o do Leaflet.');
            // Tente for√ßar um pequeno delay para a inicializa√ß√£o do mapa
            setTimeout(function() {
                inicializarMapa();
                configurarFiltrosAutomaticos();
            }, 100); // Pequeno delay
        } else {
            inicializarMapa();
            configurarFiltrosAutomaticos();
        }
    } else {
        console.error('Elemento #mapa n√£o encontrado no DOM!');
    }
});
--- Fim do cÛdigo: dashboard_v2.js ---

--- InÌcio do cÛdigo: filtros_mapa.js ---
    // static/js/filtros_mapa.js - Vers√£o com captura melhorada

    let dadosOriginais = null;
    let dadosFiltrados = null;
    let mapaLeaflet = null;
    let marcadoresOriginais = [];

    console.log('√∞≈∏‚Äù¬ß Script de filtros carregado');

    // Fun√ß√£o para inicializar o sistema de filtros
    function inicializarFiltros(geojsonData) {
        console.log('√∞≈∏≈°‚Ç¨ Inicializando filtros...');
        console.log('√∞≈∏‚Äú≈† Dados recebidos:', geojsonData);
        
        dadosOriginais = geojsonData;
        dadosFiltrados = geojsonData;
        
        if (dadosOriginais && dadosOriginais.features) {
            console.log('√¢≈ì‚Ä¶ Features dispon√É¬≠veis:', dadosOriginais.features.length);
        } else {
            console.error('√¢¬ù≈í Nenhuma feature encontrada nos dados');
            return;
        }
        
        // Captura o mapa Leaflet com m√É¬∫ltiplas estrat√É¬©gias
        capturarMapaLeaflet();
    }

    // Fun√ß√£o para capturar o mapa Leaflet - VERS√É∆íO MELHORADA
    function capturarMapaLeaflet() {
        console.log('√∞≈∏‚Äî¬∫√Ø¬∏¬è Tentando capturar mapa Leaflet com m√É¬∫ltiplas estrat√É¬©gias...');
        
        let tentativas = 0;
        const maxTentativas = 15;
        
        const verificarMapa = () => {
            tentativas++;
            console.log(`√∞≈∏‚Äù¬ç Tentativa ${tentativas}/${maxTentativas} de capturar mapa...`);
            
            // ESTRAT√É‚Ä∞GIA 1: Procurar por vari√É¬°veis map_*
            const mapKeys = Object.keys(window).filter(key => key.startsWith('map_'));
            console.log('√Ø¬ø¬Ω√Ø¬ø¬Ω Chaves map_* encontradas:', mapKeys);
            
            for (let key of mapKeys) {
                const mapInstance = window[key];
                if (mapInstance && mapInstance._container) {
                    mapaLeaflet = mapInstance;
                    console.log('√¢≈ì‚Ä¶ Mapa capturado via map_*:', key);
                    finalizarCaptura();
                    return true;
                }
            }
            
            // ESTRAT√É‚Ä∞GIA 2: Procurar em todas as vari√É¬°veis globais
            for (let key in window) {
                const obj = window[key];
                if (obj && typeof obj === 'object' && obj._container && obj.addLayer) {
                    mapaLeaflet = obj;
                    console.log('√¢≈ì‚Ä¶ Mapa capturado via varredura global:', key);
                    finalizarCaptura();
                    return true;
                }
            }
            
            // ESTRAT√É‚Ä∞GIA 3: Usar DOM + Leaflet API
            const mapContainers = document.querySelectorAll('.folium-map');
            console.log('√Ø¬ø¬Ω√Ø¬ø¬Ω Containers .folium-map encontrados:', mapContainers.length);
            
            for (let container of mapContainers) {
                if (container._leaflet_id && window.L) {
                    // Tenta acessar o mapa via container
                    const maps = window.L._layer ? Object.values(window.L._layer) : [];
                    for (let map of maps) {
                        if (map._container === container) {
                            mapaLeaflet = map;
                            console.log('√¢≈ì‚Ä¶ Mapa capturado via DOM/Leaflet:', container.id);
                            finalizarCaptura();
                            return true;
                        }
                    }
                    
                    // Tenta acessar via _leaflet_id
                    if (window.L && window.L.map && container._leaflet_id) {
                        try {
                            const mapInstance = window.L.map(container);
                            if (mapInstance && mapInstance._container) {
                                mapaLeaflet = mapInstance;
                                console.log('√¢≈ì‚Ä¶ Mapa capturado via L.map()');
                                finalizarCaptura();
                                return true;
                            }
                        } catch (e) {
                            console.log('√¢≈°¬†√Ø¬∏¬è Erro ao tentar L.map():', e.message);
                        }
                    }
                }
            }
            
            // ESTRAT√É‚Ä∞GIA 4: Interceptar cria√ß√£o do mapa
            if (window.L && !window._mapInterceptorAdded) {
                window._mapInterceptorAdded = true;
                const originalMap = window.L.map;
                window.L.map = function(...args) {
                    const mapInstance = originalMap.apply(this, args);
                    console.log('√∞≈∏≈Ω¬Ø Mapa interceptado na cria√ß√£o!');
                    mapaLeaflet = mapInstance;
                    finalizarCaptura();
                    return mapInstance;
                };
            }
            
            // ESTRAT√É‚Ä∞GIA 5: Procurar inst√É¬¢ncias ativas do Leaflet
            if (window.L && window.L.Map) {
                const allMaps = [];
                
                // Tenta encontrar todas as inst√É¬¢ncias de L.Map
                document.querySelectorAll('div').forEach(div => {
                    if (div._leaflet && div._leaflet instanceof window.L.Map) {
                        allMaps.push(div._leaflet);
                    }
                });
                
                if (allMaps.length > 0) {
                    mapaLeaflet = allMaps[0];
                    console.log('√¢≈ì‚Ä¶ Mapa encontrado via inst√É¬¢ncia L.Map');
                    finalizarCaptura();
                    return true;
                }
            }
            
            if (tentativas < maxTentativas) {
                setTimeout(verificarMapa, 1000);
            } else {
                console.error('√¢¬ù≈í N√£o foi poss√É¬≠vel capturar o mapa ap√É¬≥s', maxTentativas, 'tentativas');
                console.log('√∞≈∏‚Äù¬ç Debug - window.L:', window.L);
                console.log('√∞≈∏‚Äù¬ç Debug - document.querySelectorAll(".folium-map"):', document.querySelectorAll('.folium-map'));
                
                // Como √É¬∫ltimo recurso, vamos trabalhar diretamente com o DOM
                usarFallbackDOM();
            }
        };
        
        verificarMapa();
    }

    // Fun√ß√£o para finalizar a captura do mapa
    function finalizarCaptura() {
        if (mapaLeaflet) {
            console.log('√∞≈∏≈Ω‚Ä∞ Mapa capturado com sucesso!');
            console.log('√∞≈∏‚Äú¬ç Container do mapa:', mapaLeaflet._container);
            
            // Salva marcadores originais
            salvarMarcadoresOriginais();
        }
    }

    // Fun√ß√£o FALLBACK - trabalha diretamente com DOM se n√£o conseguir capturar o mapa
    function usarFallbackDOM() {
        console.log('√Ø¬ø¬Ω√Ø¬ø¬Ω Usando fallback DOM...');
        
        // Se n√£o conseguir capturar o mapa, pelo menos atualiza visualmente
        window.atualizarMapaFallback = function() {
            console.log('√∞≈∏‚Äù‚Äû Atualizando mapa via fallback DOM...');
            
            const mapContainer = document.querySelector('.folium-map');
            if (mapContainer) {
                // Cria um overlay com informa√ß√É¬µes dos filtros
                let overlay = document.getElementById('filtro-overlay');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = 'filtro-overlay';
                    overlay.style.cssText = `
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0,0,0,0.8);
                        color: white;
                        padding: 20px;
                        border-radius: 10px;
                        z-index: 10000;
                        text-align: center;
                        font-family: Arial, sans-serif;
                    `;
                    mapContainer.style.position = 'relative';
                    mapContainer.appendChild(overlay);
                }
                
                const totalFiltrados = dadosFiltrados.features ? dadosFiltrados.features.length : 0;
                overlay.innerHTML = `
                    <h4>√∞≈∏‚Äù¬ç Filtros Ativos</h4>
                    <p>${totalFiltrados} locais selecionados</p>
                    <small>Mapa ser√É¬° recarregado automaticamente</small>
                `;
                
                // Remove o overlay ap√É¬≥s 3 segundos
                setTimeout(() => {
                    if (overlay) overlay.remove();
                }, 3000);
            }
        };
    }

    // Fun√ß√£o para salvar refer√É¬™ncias dos marcadores originais
    function salvarMarcadoresOriginais() {
        console.log('√∞≈∏‚Äô¬æ Salvando marcadores originais...');
        
        marcadoresOriginais = [];
        
        if (mapaLeaflet) {
            mapaLeaflet.eachLayer(function(layer) {
                // Ignora tiles e outras camadas n√£o-marcador
                if (layer.feature || layer._latlng || (layer._layers && Object.keys(layer._layers).length > 0)) {
                    marcadoresOriginais.push(layer);
                    console.log('√∞≈∏‚Äô¬æ Marcador salvo:', layer);
                }
            });
            
            console.log(`√¢≈ì‚Ä¶ ${marcadoresOriginais.length} marcadores originais salvos`);
        }
    }

    // Fun√ß√£o para obter valores selecionados
    function obterSelecionados(categoria) {
        const checkboxes = document.querySelectorAll(`input[id^="check-${categoria}-"]:checked`);
        const valores = Array.from(checkboxes).map(cb => cb.value);
        console.log(`√∞≈∏‚Äù¬ç Filtros selecionados para ${categoria}:`, valores);
        return valores;
    }

    // Fun√ß√£o para aplicar filtros - COM SITUA√É‚Ä°√É∆íO
    function aplicarFiltros() {
        console.log('√∞≈∏≈Ω¬Ø ========== APLICANDO FILTROS ==========');
        
        const tiposSelecionados = obterSelecionados('tipo');
        const regioesSelecionadas = obterSelecionados('regiao');
        const marcasSelecionadas = obterSelecionados('marca');
        const empresasSelecionadas = obterSelecionados('empresa');
        const situacoesSelecionadas = obterSelecionados('situacao'); // √∞≈∏‚Ä†‚Ä¢ NOVO FILTRO

        console.log('√∞≈∏‚Äú‚Äπ Resumo dos filtros:', {
            tipos: tiposSelecionados,
            regioes: regioesSelecionadas,
            marcas: marcasSelecionadas,
            empresas: empresasSelecionadas,
            situacoes: situacoesSelecionadas // √∞≈∏‚Ä†‚Ä¢ NOVO
        });

        if (!dadosOriginais || !dadosOriginais.features) {
            console.error('√¢¬ù≈í Dados originais n√£o dispon√É¬≠veis');
            return;
        }

        // Filtra os dados
        const featuresOriginal = dadosOriginais.features.length;
        
        dadosFiltrados = {
            ...dadosOriginais,
            features: dadosOriginais.features.filter(feature => {
                const props = feature.properties;
                
                const passaTipo = tiposSelecionados.length === 0 || tiposSelecionados.includes(props.tipo);
                const passaRegiao = regioesSelecionadas.length === 0 || regioesSelecionadas.includes(props.regiao);
                const passaMarca = marcasSelecionadas.length === 0 || marcasSelecionadas.includes(props.marcaLicitacao);
                const passaEmpresa = empresasSelecionadas.length === 0 || empresasSelecionadas.includes(props.empresa);
                
                // √∞≈∏‚Ä†‚Ä¢ NOVA L√É‚ÄúGICA DE FILTRO POR SITUA√É‚Ä°√É∆íO
                let passaSituacao = true;
                if (situacoesSelecionadas.length > 0) {
                    passaSituacao = false;
                    
                    // Verifica cada situa√ß√£o selecionada
                    situacoesSelecionadas.forEach(situacao => {
                        if (situacao === 'ativos') {
                            // Ativos: status ativo E sem elevadores parados
                            if (props.status && props.status.toLowerCase().includes('atividade') && 
                                (!props.nElevadorParado || props.nElevadorParado === 0)) {
                                passaSituacao = true;
                            }
                        } else if (situacao === 'suspensos') {
                            // Suspensos: status suspenso
                            if (props.status && props.status.toLowerCase().includes('suspenso')) {
                                passaSituacao = true;
                            }
                        } else if (situacao === 'parados') {
                            // Parados: tem elevadores parados
                            if (props.nElevadorParado && props.nElevadorParado > 0) {
                                passaSituacao = true;
                            }
                        }
                    });
                }
                
                return passaTipo && passaRegiao && passaMarca && passaEmpresa && passaSituacao;
            })
        };

        const featuresFiltradas = dadosFiltrados.features.length;
        console.log(`√∞≈∏‚Äú≈† Filtragem conclu√É¬≠da: ${featuresOriginal} √¢‚Ä†‚Äô ${featuresFiltradas} features`);

        // Atualiza o mapa
        atualizarMapa();
        
        // Atualiza contador
        atualizarContadorFiltros();
        
        // Atualiza estat√É¬≠sticas
        atualizarEstatisticasDashboard();
        
        console.log('√¢≈ì‚Ä¶ ========== FILTROS APLICADOS ==========');
    }

    // Fun√ß√£o para criar um marcador
    function criarMarcador(feature) {
        const props = feature.properties;
        const coords = feature.geometry.coordinates;
        const latlng = [coords[1], coords[0]]; // Leaflet usa [lat, lng]
        
        // √∞≈∏≈Ω¬® NOVA L√É‚ÄúGICA DE CORES - PRIORIDADE: Parados > Suspensos > Ativos
        let cor = '#6c757d'; // Cinza padr√£o
        
        if (props.temElevadorParado || (props.nElevadorParado && props.nElevadorParado > 0)) {
            cor = '#dc3545'; // √∞≈∏‚Äù¬¥ Vermelho para elevadores parados
        } else if (props.status && props.status.toLowerCase().includes('suspenso')) {
            cor = '#ffc107'; // √∞≈∏≈∏¬° Amarelo para suspensos (CORRIGIDO)
        } else if (props.status && props.status.toLowerCase().includes('atividade')) {
            cor = '#28a745'; // √∞≈∏≈∏¬¢ Verde para ativos
        }
        
        // Define tamanho baseado na quantidade
        const radius = props.qtd_elev >= 5 ? 10 : (props.qtd_elev >= 3 ? 8 : 6);
        
        // Cria o marcador
        const marker = L.circleMarker(latlng, {
            radius: radius,
            fillColor: cor,
            color: cor,
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
        });
        
        // √∞≈∏‚Äú¬ù TOOLTIP ATUALIZADO
        let tooltipText = `${props.cidade} - ${props.tipo}<br/>
            ${props.qtd_elev} elevadores - ${props.marcaLicitacao}<br/>
            ${props.regiao} - ${props.status}`;
        
        if (props.nElevadorParado && props.nElevadorParado > 0) {
            tooltipText += `<br/><strong style="color: #dc3545;">√¢≈°¬†√Ø¬∏¬è ${props.nElevadorParado} parado(s)</strong>`;
        }

        marker.bindTooltip(tooltipText, {sticky: true});
        
        // √∞≈∏‚Äú¬ù POPUP ATUALIZADO
        let popupContent = `<div style="font-family: Arial, sans-serif;">
                <h4 style="margin: 0 0 10px 0; color: #333;">${props.unidade}</h4>
                <p><strong>Cidade:</strong> ${props.cidade}</p>
                <p><strong>Endere√ßo:</strong> ${props.endereco}</p>
                <p><strong>Tipo:</strong> ${props.tipo}</p>
                <p><strong>Elevadores:</strong> ${props.qtd_elev}</p>
                <p><strong>Paradas:</strong> ${props.paradas}</p>
                <p><strong>Marca:</strong> ${props.marca}</p>
                <p><strong>Empresa:</strong> ${props.empresa}</p>
                <p><strong>Status:</strong> ${props.status}</p>`;
        
        // √∞≈∏‚Ä†‚Ä¢ ADICIONA INFORMA√É‚Ä°√É‚Ä¢ES DE ELEVADORES PARADOS E SUSPENSOS
        
        if ((props.nElevadorParado && props.nElevadorParado > 0)) {
            popupContent += `
                <hr style="margin: 10px 0;">
                <p style="color: #dc3545;"><strong>√¢≈°¬†√Ø¬∏¬è Elevadores Parados:</strong> ${props.nElevadorParado}</p>`;
        }
        if ((props.nElevadorParado && props.nElevadorParado > 0) || props.status && props.status.toLowerCase().includes('suspenso')) {    
            if (props.dataDeParada) {
                popupContent += `<p style="color: #dc3545;"><strong>√∞≈∏‚Äú‚Ä¶ Data da Parada:</strong> ${props.dataDeParada}</p>`;
            }
            
            if (props.previsaoDeRetorno) {
                popupContent += `<p style="color: #dc3545;"><strong>√∞≈∏‚Äù‚Äû Previs√£o de Retorno:</strong> ${props.previsaoDeRetorno}</p>`;
            }
        }
        
        popupContent += '</div>';
        
        marker.bindPopup(popupContent, {maxWidth: 350});
        
        return marker;
    }

    // Fun√ß√£o para atualizar contador
    function atualizarContadorFiltros() {
        if (!dadosFiltrados.features) return;
        
        const totalElevadores = dadosFiltrados.features.reduce((total, feature) => {
            return total + feature.properties.qtd_elev;
        }, 0);

        const totalLocais = dadosFiltrados.features.length;

        const elemElevadores = document.getElementById('total-elevadores-filtro');
        const elemLocais = document.getElementById('total-locais-filtro');
        
        if (elemElevadores) elemElevadores.textContent = totalElevadores;
        if (elemLocais) elemLocais.textContent = totalLocais;

        const contadorElement = document.getElementById('contador-resultados');
        if (contadorElement) {
            if (totalElevadores === 0) {
                contadorElement.style.background = '#ffebee';
                contadorElement.style.color = '#c62828';
                contadorElement.style.borderColor = '#ef9a9a';
            } else {
                contadorElement.style.background = '#e8f5e8';
                contadorElement.style.color = '#2e7d32';
                contadorElement.style.borderColor = '#a5d6a7';
            }
        }
        
        console.log(`√∞≈∏‚Äú≈† Contador atualizado: ${totalElevadores} elevadores em ${totalLocais} locais`);
    }

    // Fun√ß√£o para atualizar estat√É¬≠sticas da dashboard - COM SITUA√É‚Ä°√É∆íO
    function atualizarEstatisticasDashboard() {
        const tiposSelecionados = obterSelecionados('tipo');
        const regioesSelecionadas = obterSelecionados('regiao');
        const marcasSelecionadas = obterSelecionados('marca');
        const empresasSelecionadas = obterSelecionados('empresa');
        const situacoesSelecionadas = obterSelecionados('situacao'); // √∞≈∏‚Ä†‚Ä¢ NOVO

        // Se nenhum filtro ativo, limpa todos os filtros
        if (tiposSelecionados.length === 0 && regioesSelecionadas.length === 0 && 
            marcasSelecionadas.length === 0 && empresasSelecionadas.length === 0 &&
            situacoesSelecionadas.length === 0) { // √∞≈∏‚Ä†‚Ä¢ INCLUIR NOVO FILTRO
            console.log('√¢¬è¬≠√Ø¬∏¬è Nenhum filtro ativo, limpando todos os filtros');
            limparFiltros();
            return;
        }

        // Monta par√É¬¢metros
        const params = new URLSearchParams();
        tiposSelecionados.forEach(tipo => params.append('tipo', tipo));
        regioesSelecionadas.forEach(regiao => params.append('regiao', regiao));
        marcasSelecionadas.forEach(marca => params.append('marca', marca));
        empresasSelecionadas.forEach(empresa => params.append('empresa', empresa));
        situacoesSelecionadas.forEach(situacao => params.append('situacao', situacao)); // √∞≈∏‚Ä†‚Ä¢ NOVO

        console.log('√∞≈∏‚Äú¬° Fazendo requisi√ß√£o para API...');

        // Mostra loading
        const loadingElement = document.getElementById('loading-stats');
        if (loadingElement) loadingElement.style.display = 'block';

        // Faz requisi√ß√£o
        fetch('/api/filtrar?' + params.toString())
            .then(response => response.json())
            .then(data => {
                if (loadingElement) loadingElement.style.display = 'none';
                
                console.log('√∞≈∏‚Äú¬° Resposta da API:', data);
                
                if (data.success) {
                    // Atualiza cards
                    const elementos = {
                        'stat-predios': data.stats.total_predios,
                        'stat-elevadores': data.stats.total_elevadores,
                        'stat-cidades': data.stats.cidades,
                        'stat-regioes': data.stats.regioes,
                        'stat-ativos': data.stats.em_atividade,
                        'stat-suspensos': data.stats.suspensos,
                        'stat-parados': data.stats.elevadores_parados
                    };
                    
                    for (let id in elementos) {
                        const elem = document.getElementById(id);
                        if (elem) {
                            elem.textContent = elementos[id];
                            console.log(`√∞≈∏‚Äú≈† Card ${id} atualizado para:`, elementos[id]);
                        }
                    }

                    // Atualiza estat√É¬≠sticas detalhadas
                    mostrarEstatisticasDetalhadas(data.stats);
                }
            })
            .catch(error => {
                if (loadingElement) loadingElement.style.display = 'none';
                console.error('√¢¬ù≈í Erro ao carregar estat√É¬≠sticas:', error);
            });
    }

    // Fun√ß√£o para mostrar estat√É¬≠sticas detalhadas
    function mostrarEstatisticasDetalhadas(stats) {
        const container = document.getElementById('stats-detalhadas');
        if (!container) return;
        
        let html = '<div class="row">';
        
        const categorias = [
            {titulo: 'Por Tipo', dados: stats.por_tipo},
            {titulo: 'Por Regi√£o', dados: stats.por_regiao},
            {titulo: 'Por Marca', dados: stats.por_marca},
            {titulo: 'Por Status', dados: stats.por_status}
        ];
        
        categorias.forEach(categoria => {
            html += `<div class="col-md-3"><h6>${categoria.titulo}</h6><ul class="list-unstyled">`;
            for (let [key, value] of Object.entries(categoria.dados)) {
                html += `<li><strong>${key}:</strong> ${value}</li>`;
            }
            html += '</ul></div>';
        });
        
        html += '</div>';
        container.innerHTML = html;
    }

    // Fun√ß√É¬µes auxiliares
    function limparFiltros() {
        console.log('√∞≈∏¬ß¬π Limpando todos os filtros...');
        
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
        
        dadosFiltrados = dadosOriginais;
        atualizarMapa();
        atualizarContadorFiltros();
        
        // Restaura valores originais dos cards
        const valoresOriginais = window.statsOriginais || {};
        for (let id in valoresOriginais) {
            const elem = document.getElementById(id);
            if (elem) elem.textContent = valoresOriginais[id];
        }
        
        const statsContainer = document.getElementById('stats-detalhadas');
        if (statsContainer) {
            statsContainer.innerHTML = '<p class="text-muted">Use os filtros no mapa para ver estat√É¬≠sticas espec√É¬≠ficas.</p>';
        }
        
        console.log('√¢≈ì‚Ä¶ Filtros limpos');
    }

    function selecionarTodos() {
        console.log('√¢≈ì‚Ä¶ Selecionando todos os filtros...');
        
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = true);
        aplicarFiltros();
    }

    function toggleCategoria(categoria) {
        const div = document.getElementById(`filtros-${categoria}`);
        const button = document.getElementById(`toggle-${categoria}`);

        if (div && button) {
            if (div.style.display === 'none') {
                div.style.display = 'block';
                button.textContent = '√¢≈æ‚Äì';
            } else {
                div.style.display = 'none';
                button.textContent = '√¢≈æ‚Ä¢';
            }
        }
    }

    function atualizarDados() {
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
        btn.disabled = true;
        
        fetch('/atualizar')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Dados atualizados!\n' + data.message);
                    location.reload();
                } else {
                    alert('Erro: ' + data.message);
                }
            })
            .catch(error => {
                alert('Erro na requisi√ß√£o');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    }

    // Adiciona event listener para debug quando a p√É¬°gina carrega
    document.addEventListener('DOMContentLoaded', function() {
        console.log('√Ø¬ø¬Ω√Ø¬ø¬Ω DOM carregado, aguardando inicializa√ß√£o...');
    });
--- Fim do cÛdigo: filtros_mapa.js ---

